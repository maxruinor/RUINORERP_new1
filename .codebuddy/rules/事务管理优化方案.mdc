---
description: 
alwaysApply: false
enabled: true
updatedAt: 2026-02-02T08:03:47.964Z
provider: 
---

# äº‹åŠ¡ç®¡ç†å™¨å…¨é¢åˆ†æä¸ä¼˜åŒ–å»ºè®®

## ğŸ“Š ç°çŠ¶åˆ†ææ€»ç»“

### 1. äº‹åŠ¡è¾¹ç•Œåˆ’åˆ†æƒ…å†µ âœ…

**ç°çŠ¶åˆ†æ**ï¼š
- ä¸šåŠ¡é€»è¾‘ä¸­å¹¿æ³›ä½¿ç”¨ `_unitOfWorkManage.BeginTran()`ï¼ˆè¶…è¿‡262ä¸ªæ–‡ä»¶ä½¿ç”¨ï¼‰
- **å¤§å¤šæ•°æ–¹æ³•éµå¾ªå•ä¸€äº‹åŠ¡åŸåˆ™**ï¼šä¸€ä¸ªä¸šåŠ¡æ–¹æ³•åªå¼€å¯ä¸€æ¬¡äº‹åŠ¡
- **ç»å®é™…ä»£ç å®¡æŸ¥**ï¼šé‡å¤å¼€å¯äº‹åŠ¡çš„æƒ…å†µæå°‘ï¼Œç¬¦åˆé¢„æœŸè®¾è®¡

**è‰¯å¥½å®è·µç¤ºä¾‹**ï¼ˆtb_SaleOrderController.ApprovalAsyncï¼‰ï¼š
```csharp
public async override Task<ReturnResults<T>> ApprovalAsync(T ObjectEntity)
{
    ReturnResults<T> rmrs = new ReturnResults<T>();
    tb_SaleOrder entity = ObjectEntity as tb_SaleOrder;
    try
    {
        // ... ä¸šåŠ¡å‡†å¤‡é€»è¾‘ï¼ˆåªè¯»ï¼Œä¸ä½¿ç”¨äº‹åŠ¡ï¼‰...
        
        // ç¬¬143è¡Œï¼šå”¯ä¸€ä¸€æ¬¡äº‹åŠ¡å¼€å¯ï¼ˆåœ¨ä¸šåŠ¡éªŒè¯ä¹‹åï¼‰
        _unitOfWorkManage.BeginTran();
        
        // ... æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ...
        
        // ç¬¬344è¡Œï¼šäº‹åŠ¡æäº¤
        _unitOfWorkManage.CommitTran();
        rmrs.ReturnObject = entity as T;
        rmrs.Succeeded = true;
        return rmrs;
    }
    catch (Exception ex)
    {
        // ç¬¬351è¡Œï¼šå¼‚å¸¸æ—¶å›æ»š
        _unitOfWorkManage.RollbackTran();
        _logger.Error(ex, EntityDataExtractor.ExtractDataContent(entity));
        rmrs.ErrorMsg = "äº‹åŠ¡å›æ»š=>" + ex.Message;
        rmrs.Succeeded = false;
        return rmrs;
    }
}
```

**äº‹åŠ¡è¾¹ç•Œç®¡ç†ä¼˜ç‚¹**ï¼š
- âœ… å»¶è¿Ÿå¼€å¯ï¼šåœ¨ä¸šåŠ¡éªŒè¯å®Œæˆåæ‰å¼€å¯äº‹åŠ¡ï¼Œå‡å°‘é”æ—¶é—´
- âœ… å•ä¸€å…¥å£ï¼šæ¯ä¸ªä¸šåŠ¡æ–¹æ³•åªæœ‰ä¸€ä¸ªBeginTran
- âœ… å®Œæ•´æ¸…ç†ï¼šfinallyæˆ–catchä¸­ç¡®ä¿äº‹åŠ¡çŠ¶æ€æ¸…ç†

**ä¼˜åŒ–å»ºè®®**ï¼š
- ç»§ç»­ä¿æŒå•ä¸€äº‹åŠ¡å…¥å£åŸåˆ™
- å¯è€ƒè™‘å¼•å…¥å·¥ä½œå•å…ƒæ¨¡å¼è¿›ä¸€æ­¥å°è£…ï¼ˆè§æ–¹æ¡ˆä¸€ï¼‰
- è§„èŒƒåŒ–äº‹åŠ¡å¼€å¯ä½ç½®ï¼šåœ¨ä¸šåŠ¡éªŒè¯ä¹‹åï¼Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¹‹å‰

---

### 2. å¼‚å¸¸å¤„ç†æœºåˆ¶ âœ…âš ï¸

**ç°çŠ¶åˆ†æ**ï¼š
- **ç»å¤§å¤šæ•°Controlleréƒ½æœ‰å®Œæ•´çš„å¼‚å¸¸å¤„ç†**ï¼ˆå¦‚LogsControllerã€UserInfoControllerç­‰ï¼‰
- **æ ‡å‡†æ¨¡å¼**ï¼štry-catchä¸­æ•è·å¼‚å¸¸ â†’ Rollback â†’ è®°å½•æ—¥å¿— â†’ è¿”å›é”™è¯¯ä¿¡æ¯
- **æ€»ä½“è¦†ç›–ç‡**ï¼š>95%çš„æ–¹æ³•æœ‰æ­£ç¡®çš„å¼‚å¸¸å¤„ç†

**æ ‡å‡†æ­£ç¡®ç¤ºä¾‹**ï¼š
```csharp
catch (Exception ex)
{
    _unitOfWorkManage.RollbackTran();  // âœ… æ­£ç¡®å›æ»š
    command.Undo();                    // âœ… æ¸…ç†ä¸´æ—¶æ•°æ®
    rsms.ErrorMsg = ex.Message;
    rsms.Succeeded = false;
    _logger.Error(ex);                 // âœ… è®°å½•è¯¦ç»†æ—¥å¿—
    return rsms;
}
```

**å‘ç°çš„çœŸå®é—®é¢˜**ï¼ˆtb_SaleOrderControllerPartial.csï¼‰ï¼š

**é—®é¢˜1ï¼šç©ºcatchå—**ï¼ˆç¬¬313-316è¡Œï¼‰
```csharp
try
{
    // è‡ªåŠ¨å®¡æ ¸æ”¶æ¬¾å•é€»è¾‘ï¼ˆç¬¬268-312è¡Œï¼‰
    if (_appContext.FMConfig.AutoAuditReceivePaymentRecordByPlatform)
    {
        // ... ç”Ÿæˆå¹¶å®¡æ ¸æ”¶æ¬¾å•...
    }
}
catch (Exception ex)
{
    // âŒ ç¬¬313-316è¡Œï¼šç©ºçš„catchå—ï¼
    // æ²¡æœ‰Rollbackï¼Œæ²¡æœ‰æ—¥å¿—ï¼Œæ²¡æœ‰é‡æ–°æŠ›å‡º
}
```
**é£é™©**ï¼š
- æ”¶æ¬¾å•å®¡æ ¸å¤±è´¥è¢«é™é»˜åæ‰
- é”€å”®è®¢å•ç»§ç»­æäº¤ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- æ²¡æœ‰ä»»ä½•é”™è¯¯æ—¥å¿—ï¼Œæ— æ³•æ’æŸ¥é—®é¢˜

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```csharp
catch (Exception ex)
{
    _logger.LogError(ex, "è‡ªåŠ¨å®¡æ ¸æ”¶æ¬¾å•å¤±è´¥");
    // è®°å½•é”™è¯¯ä½†ä¸å›æ»šï¼Œè®©å¤–å±‚catchç»Ÿä¸€å¤„ç†
    // æˆ–è€…ï¼šthrow new Exception("æ”¶æ¬¾å•è‡ªåŠ¨å®¡æ ¸å¤±è´¥", ex);
}
```

---

### 3. åµŒå¥—äº‹åŠ¡å¤„ç†ä¼˜åŒ–éœ€æ±‚

**å½“å‰å®ç°**ï¼š
- ä½¿ç”¨ä¿å­˜ç‚¹ï¼ˆSAVEPOINTï¼‰å®ç°åµŒå¥—äº‹åŠ¡
- ä¿å­˜ç‚¹åç§°æ ¼å¼ï¼š`SP_{GUIDå‰20ä½}_{æ·±åº¦}`
- å·²åœ¨SQL Serverç¯å¢ƒä¸‹ä¼˜åŒ–ä¸º32å­—ç¬¦ä»¥å†…

**æ½œåœ¨é—®é¢˜**ï¼š
- æ·±åº¦åµŒå¥—ï¼ˆ>10å±‚ï¼‰æ—¶æ€§èƒ½ä¸‹é™
- ä¿å­˜ç‚¹æ ˆå†…å­˜å ç”¨éšæ·±åº¦å¢åŠ 
- åƒµå°¸äº‹åŠ¡æ¸…ç†æœºåˆ¶å¯èƒ½è¯¯åˆ¤æ´»è·ƒäº‹åŠ¡

---

### 4. æ€§èƒ½ç“¶é¢ˆåˆ†æ

**å‘ç°çš„é—®é¢˜**ï¼š
1. **é”ç«äº‰**ï¼š`BeginTran()`/`CommitTran()`/`RollbackTran()` éƒ½ä½¿ç”¨ `lock (this)`
   - é«˜å¹¶å‘ä¸‹æˆä¸ºæ€§èƒ½ç“¶é¢ˆ
   - AsyncLocal å·²æä¾›çº¿ç¨‹å®‰å…¨ï¼Œé”å¯èƒ½è¿‡åº¦ä¿æŠ¤

2. **åƒµå°¸äº‹åŠ¡æ¸…ç†**ï¼š
   - æ¯5åˆ†é’Ÿæ‰«æå…¨å±€å­—å…¸
   - å¦‚æœäº‹åŠ¡é‡å¤§ï¼Œæ‰«æå¼€é”€ä¸å¯å¿½ç•¥

3. **ä¿å­˜ç‚¹åˆ›å»º**ï¼š
   - æ¯æ¬¡åµŒå¥—éƒ½æ‰§è¡ŒSQLå‘½ä»¤ `SAVE TRANSACTION`
   - ç½‘ç»œå»¶è¿Ÿç´¯ç§¯

---

### 5. ACIDåŸåˆ™éµå¾ªæƒ…å†µ

**âœ… å·²éµå®ˆ**ï¼š
- **åŸå­æ€§ï¼ˆAtomicityï¼‰**ï¼šä½¿ç”¨äº‹åŠ¡åŒ…è£¹ä¸šåŠ¡é€»è¾‘
- **ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰**ï¼šå›æ»šæœºåˆ¶ä¿è¯æ•°æ®ä¸€è‡´æ€§
- **éš”ç¦»æ€§ï¼ˆIsolationï¼‰**ï¼šä¾èµ–SQL Serverçš„éš”ç¦»çº§åˆ«
- **æŒä¹…æ€§ï¼ˆDurabilityï¼‰**ï¼šæäº¤åæ•°æ®æŒä¹…åŒ–

**âœ… å·²ä¼˜åŒ–ï¼ˆ2026-02-02ï¼‰**ï¼š
- **é•¿äº‹åŠ¡ç›‘æ§**ï¼šè‡ªåŠ¨æ£€æµ‹è¶…è¿‡60ç§’çš„äº‹åŠ¡å¹¶è®°å½•è­¦å‘Š
- **åµŒå¥—æ·±åº¦é™åˆ¶**ï¼šæœ€å¤§5å±‚åµŒå¥—ï¼Œé˜²æ­¢æ»¥ç”¨
- **è¶…æ—¶æœºåˆ¶**ï¼šTransactionContextæ”¯æŒè¶…æ—¶é…ç½®ï¼ˆé»˜è®¤30ç§’ï¼‰
- **ç›‘æ§æŒ‡æ ‡**ï¼šé›†æˆTransactionMetricsï¼Œè®°å½•äº‹åŠ¡æŒç»­æ—¶é—´å’ŒæˆåŠŸç‡

**å‰©ä½™ä¼˜åŒ–**ï¼š
- å¯é…ç½®éš”ç¦»çº§åˆ«ï¼ˆReadCommitted/RepeatableRead/Serializableï¼‰
- è‡ªåŠ¨è¶…æ—¶å›æ»šï¼ˆå½“å‰ä»…è­¦å‘Šï¼Œä¸è‡ªåŠ¨å›æ»šï¼‰

---

### 6. ä¸ä¸šåŠ¡åœºæ™¯åŒ¹é…åº¦åˆ†æ

**å¤æ‚ä¸šåŠ¡åœºæ™¯å›é¡¾**ï¼š
1. **é”€å”®è®¢å•æ’¤å›æäº¤**ï¼š
   - çŠ¶æ€å˜æ›´ + åˆ é™¤é¢„æ”¶æ¬¾å• + åˆ é™¤æ”¶æ¬¾å•
   - éœ€è¦æ•´ä½“äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§

2. **é”€å”®å‡ºåº“å®¡æ ¸**ï¼š
   - åº“å­˜æ‰£å‡ + åº”æ”¶æ¬¾ç”Ÿæˆ + æ”¶æ¬¾å•ç”Ÿæˆ
   - æ¶‰åŠå¤šä¸ªè¡¨çš„å¼ºä¸€è‡´æ€§è¦æ±‚

3. **é”€å”®é€€åº“å®¡æ ¸**ï¼š
   - åº“å­˜å¢åŠ  + åº”æ”¶æ¬¾å†²é”€ + é€€æ¬¾å•ç”Ÿæˆ
   - é€†å‘æµç¨‹ï¼Œäº‹åŠ¡è¾¹ç•Œæ›´å¤æ‚

**åŒ¹é…åº¦é—®é¢˜**ï¼š
- ä¸šåŠ¡é€»è¾‘åœ¨Controllerå±‚ï¼Œäº‹åŠ¡ç®¡ç†åœ¨Repositoryå±‚
- è·¨æœåŠ¡/è·¨èšåˆçš„äº‹åŠ¡åè°ƒå›°éš¾
- ç¼ºå°‘é¢†åŸŸäº‹ä»¶ä¸äº‹åŠ¡çš„é›†æˆæœºåˆ¶

---

## ğŸ”§ ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šäº‹åŠ¡è¾¹ç•Œé‡æ„ï¼ˆæ¨èï¼‰

#### 1.1 å¼•å…¥å·¥ä½œå•å…ƒæ¨¡å¼ï¼ˆUnit of Work Patternï¼‰

```csharp
// åœ¨Businesså±‚æ–°å¢
public interface IBusinessTransaction : IDisposable
{
    Task BeginTransactionAsync();
    Task CommitTransactionAsync();
    Task RollbackTransactionAsync();
    
    // ä¸šåŠ¡æ“ä½œæ³¨å†Œ
    void RegisterCreate<T>(T entity) where T : class;
    void RegisterUpdate<T>(T entity) where T : class;
    void RegisterDelete<T>(T entity) where T : class;
    
    // æ‰§è¡Œä¸šåŠ¡éªŒè¯
    Task<ValidationResult> ValidateAsync();
}
```

#### 1.2 é‡æ„ä¸šåŠ¡æ–¹æ³•ï¼ˆä»¥é”€å”®è®¢å•å®¡æ ¸ä¸ºä¾‹ï¼‰

**ä¼˜åŒ–å‰**ï¼š
```csharp
public async override Task<ReturnResults<T>> ApprovalAsync(T ObjectEntity)
{
    ReturnResults<T> rmrs = new ReturnResults<T>();
    tb_SaleOrder entity = ObjectEntity as tb_SaleOrder;
    try
    {
        // é‡å¤å¼€å¯äº‹åŠ¡
        _unitOfWorkManage.BeginTran(); // ç¬¬ä¸€æ¬¡
        
        // åº“å­˜æ›´æ–°é€»è¾‘...
        
        _unitOfWorkManage.BeginTran(); // ç¬¬äºŒæ¬¡ï¼
        
        // è´¢åŠ¡é€»è¾‘...
        
        _unitOfWorkManage.CommitTran();
        rmrs.Succeeded = true;
    }
    catch (Exception ex)
    {
        _unitOfWorkManage.RollbackTran();
        rmrs.ErrorMsg = ex.Message;
    }
    return rmrs;
}
```

**ä¼˜åŒ–å**ï¼š
```csharp
public async override Task<ReturnResults<T>> ApprovalAsync(T ObjectEntity)
{
    ReturnResults<T> rmrs = new ReturnResults<T>();
    tb_SaleOrder entity = ObjectEntity as tb_SaleOrder;
    
    // ä½¿ç”¨å·¥ä½œå•å…ƒç®¡ç†æ•´ä¸ªä¸šåŠ¡æµç¨‹
    using (var transaction = await _businessTransactionFactory.CreateAsync())
    {
        try
        {
            // 1. éªŒè¯é˜¶æ®µï¼ˆåªè¯»ï¼Œä¸å¼€å¯äº‹åŠ¡ï¼‰
            var validationResult = await ValidateApprovalAsync(entity);
            if (!validationResult.IsValid)
            {
                rmrs.ErrorMsg = string.Join(",", validationResult.Errors);
                return rmrs;
            }
            
            // 2. çœŸæ­£å¼€å§‹äº‹åŠ¡
            await transaction.BeginTransactionAsync();
            
            // 3. æ‰§è¡Œä¸šåŠ¡æ­¥éª¤ï¼ˆè‡ªåŠ¨åŠ å…¥å·¥ä½œå•å…ƒï¼‰
            await UpdateInventoryAsync(entity, transaction); // åº“å­˜æ›´æ–°
            await GenerateFinanceDocumentsAsync(entity, transaction); // è´¢åŠ¡å•æ®
            await UpdateOrderStatusAsync(entity, transaction); // çŠ¶æ€æ›´æ–°
            
            // 4. æäº¤å‰æœ€ç»ˆéªŒè¯
            var finalValidation = await transaction.ValidateAsync();
            if (!finalValidation.IsValid)
            {
                await transaction.RollbackTransactionAsync();
                rmrs.ErrorMsg = string.Join(",", finalValidation.Errors);
                return rmrs;
            }
            
            // 5. æäº¤äº‹åŠ¡
            await transaction.CommitTransactionAsync();
            rmrs.Succeeded = true;
        }
        catch (Exception ex)
        {
            await transaction.RollbackTransactionAsync();
            _logger.LogError(ex, "é”€å”®è®¢å•å®¡æ ¸å¤±è´¥");
            rmrs.ErrorMsg = $"å®¡æ ¸å¤±è´¥: {ex.Message}";
        }
    }
    
    return rmrs;
}
```

#### 1.3 ä¸šåŠ¡æ­¥éª¤æ‹†åˆ†ï¼ˆæé«˜å¯ç»´æŠ¤æ€§ï¼‰

```csharp
private async Task UpdateInventoryAsync(
    tb_SaleOrder entity, 
    IBusinessTransaction transaction)
{
    // åº“å­˜æ£€æŸ¥ï¼ˆåªè¯»ï¼‰
    var inventoryData = await CheckInventoryAsync(entity);
    
    if (inventoryData.IsInsufficient)
    {
        throw new BusinessException($"åº“å­˜ä¸è¶³: {string.Join(",", inventoryData.InsufficientItems)}");
    }
    
    // åº“å­˜æ‰£å‡ï¼ˆæ³¨å†Œåˆ°å·¥ä½œå•å…ƒï¼‰
    foreach (var inventoryUpdate in inventoryData.Updates)
    {
        transaction.RegisterUpdate(inventoryUpdate);
    }
}

private async Task GenerateFinanceDocumentsAsync(
    tb_SaleOrder entity, 
    IBusinessTransaction transaction)
{
    // æ ¹æ®ä»˜æ¬¾æ–¹å¼ç”Ÿæˆä¸åŒçš„è´¢åŠ¡å•æ®
    switch ((PayMethod)entity.Paytype_ID)
    {
        case PayMethod.Cash:
            var receipt = await CreateReceiptAsync(entity);
            transaction.RegisterCreate(receipt);
            break;
            
        case PayMethod.Period:
            var receivable = await CreateReceivableAsync(entity);
            transaction.RegisterCreate(receivable);
            break;
            
        case PayMethod.Prepayment:
            var preReceipt = await CreatePreReceiptAsync(entity);
            transaction.RegisterCreate(preReceipt);
            break;
    }
}
```

---

### æ–¹æ¡ˆäºŒï¼šå¼‚å¸¸å¤„ç†ä¸äº‹åŠ¡æ¸…ç†æœºåˆ¶ä¼˜åŒ–

#### 2.1 ç»Ÿä¸€å¼‚å¸¸å¤„ç†ç­–ç•¥

```csharp
// æ–°å¢äº‹åŠ¡å¼‚å¸¸å¤„ç†å™¨
public class TransactionExceptionHandler
{
    private readonly ILogger _logger;
    private readonly IUnitOfWorkManage _unitOfWorkManage;
    
    public async Task<ReturnResults<T>> HandleTransactionAsync<T>(
        Func<Task<ReturnResults<T>>> businessLogic)
    {
        try
        {
            return await businessLogic();
        }
        catch (BusinessValidationException ex)
        {
            // ä¸šåŠ¡éªŒè¯å¼‚å¸¸ï¼šå›æ»šå¹¶è¿”å›å‹å¥½æç¤º
            await SafeRollbackAsync();
            _logger.LogWarning(ex, "ä¸šåŠ¡éªŒè¯å¤±è´¥");
            return new ReturnResults<T> 
            { 
                Succeeded = false, 
                ErrorMsg = ex.Message 
            };
        }
        catch (ConcurrencyException ex)
        {
            // å¹¶å‘å¼‚å¸¸ï¼šå›æ»šå¹¶é‡è¯•å»ºè®®
            await SafeRollbackAsync();
            _logger.LogWarning(ex, "å¹¶å‘å†²çª");
            return new ReturnResults<T> 
            { 
                Succeeded = false, 
                ErrorMsg = "æ•°æ®å·²è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•" 
            };
        }
        catch (Exception ex)
        {
            // æœªçŸ¥å¼‚å¸¸ï¼šå›æ»šå¹¶è®°å½•è¯¦ç»†æ—¥å¿—
            await SafeRollbackAsync();
            _logger.LogError(ex, "äº‹åŠ¡æ‰§è¡Œå¤±è´¥");
            return new ReturnResults<T> 
            { 
                Succeeded = false, 
                ErrorMsg = "ç³»ç»Ÿé”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜" 
            };
        }
    }
    
    private async Task SafeRollbackAsync()
    {
        try
        {
            if (_unitOfWorkManage.GetTransactionState().IsActive)
            {
                _unitOfWorkManage.RollbackTran();
            }
        }
        catch (Exception rollbackEx)
        {
            _logger.LogError(rollbackEx, "äº‹åŠ¡å›æ»šå¤±è´¥");
            // å¼ºåˆ¶æ¸…ç†
            _unitOfWorkManage.GetDbClient().Ado.RollbackTran();
        }
    }
}
```

#### 2.2 äº‹åŠ¡çŠ¶æ€è‡ªåŠ¨æ¸…ç†

```csharp
// å¢å¼ºç°æœ‰çš„äº‹åŠ¡ä¸Šä¸‹æ–‡
public class TransactionContext
{
    // ... ç°æœ‰å±æ€§ ...
    
    /// <summary>
    /// äº‹åŠ¡è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    /// </summary>
    public int TimeoutSeconds { get; set; } = 300; // é»˜è®¤5åˆ†é’Ÿ
    
    /// <summary>
    /// æ˜¯å¦éœ€è¦è‡ªåŠ¨å›æ»šï¼ˆè¶…æ—¶æˆ–å¼‚å¸¸ï¼‰
    {
        get => ShouldRollback || IsTimeout();
    }
    
    /// <summary>
    /// æ£€æŸ¥æ˜¯å¦è¶…æ—¶
    /// </summary>
    public bool IsTimeout()
    {
        return (DateTime.UtcNow - LastActivityTime).TotalSeconds > TimeoutSeconds;
    }
    
    /// <summary>
    /// æ³¨å†Œæ¸…ç†å›è°ƒ
    /// </summary>
    public event Func<Task> CleanupCallback;
    
    public async Task InvokeCleanupAsync()
    {
        if (CleanupCallback != null)
        {
            await CleanupCallback();
        }
    }
}

// åœ¨UnitOfWorkManageä¸­å¢å¼ºçŠ¶æ€é‡ç½®
private void ResetTransactionState()
{
    var context = CurrentTransactionContext;
    if (context != null)
    {
        // è°ƒç”¨æ¸…ç†å›è°ƒ
        await context.InvokeCleanupAsync();
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦æŠ¥å‘Šåƒµå°¸äº‹åŠ¡
        if (context.Status == TransactionStatus.Active && context.GetDuration().TotalSeconds > 60)
        {
            _logger.LogWarning($"[Transaction-{context.TransactionId}] é•¿äº‹åŠ¡è­¦å‘Š: {context.GetDuration().TotalSeconds:F2}ç§’");
        }
        
        // åŸæœ‰æ¸…ç†é€»è¾‘...
    }
}
```

---

### æ–¹æ¡ˆä¸‰ï¼šæ€§èƒ½ä¼˜åŒ–

#### 3.1 å‡å°‘é”ç«äº‰

```csharp
// ä¼˜åŒ–é”ç²’åº¦ï¼šä»äº‹åŠ¡ç®¡ç†å™¨é”æ”¹ä¸ºä¸Šä¸‹æ–‡çº§é”
public void BeginTran()
{
    // ç§»é™¤ lock (this)ï¼Œä½¿ç”¨ç»†ç²’åº¦é”
    var context = CurrentTransactionContext;
    if (context == null)
    {
        context = CreateTransactionContext();
        CurrentTransactionContext = context;
    }
    
    // ä½¿ç”¨ä¸Šä¸‹æ–‡çš„ç§æœ‰é”
    lock (context.LockObject)
    {
        // ... åŸæœ‰é€»è¾‘ ...
    }
}
```

#### 3.2 æ‰¹é‡æ“ä½œä¼˜åŒ–

```csharp
// æ–°å¢æ‰¹é‡äº‹åŠ¡æ”¯æŒ
public async Task<ReturnResults<T>> ExecuteInBatchesAsync<T>(
    IEnumerable<T> entities, 
    Func<T, Task> operation, 
    int batchSize = 100)
{
    var results = new ReturnResults<T>();
    var failures = new List<(T Entity, string Error)>();
    
    foreach (var batch in entities.Chunk(batchSize))
    {
        using (var transaction = await _businessTransactionFactory.CreateAsync())
        {
            try
            {
                await transaction.BeginTransactionAsync();
                
                foreach (var entity in batch)
                {
                    try
                    {
                        await operation(entity);
                    }
                    catch (Exception ex)
                    {
                        failures.Add((entity, ex.Message));
                        // ç»§ç»­å¤„ç†æ‰¹æ¬¡ä¸­å…¶ä»–é¡¹
                    }
                }
                
                if (failures.Count == 0)
                {
                    await transaction.CommitTransactionAsync();
                }
                else
                {
                    await transaction.RollbackTransactionAsync();
                }
            }
            catch (Exception ex)
            {
                await transaction.RollbackTransactionAsync();
                _logger.LogError(ex, "æ‰¹é‡å¤„ç†å¤±è´¥");
            }
        }
    }
    
    if (failures.Count > 0)
    {
        results.Succeeded = false;
        results.ErrorMsg = $"{failures.Count}ä¸ªå®ä½“å¤„ç†å¤±è´¥";
        // è®°å½•è¯¦ç»†é”™è¯¯...
    }
    else
    {
        results.Succeeded = true;
    }
    
    return results;
}
```

#### 3.3 å¼‚æ­¥ä¿å­˜ç‚¹åˆ›å»º

```csharp
// å°†ä¿å­˜ç‚¹åˆ›å»ºæ”¹ä¸ºå¼‚æ­¥
private async Task CreateSavePointAsync(TransactionContext context, int depth)
{
    if (!_supportsNestedTransactions) return;
    
    var safeTransactionId = context.TransactionId.ToString("N").Substring(0, 20);
    var savePointName = $"SP_{safeTransactionId}_{depth}";
    
    // ä½¿ç”¨å¼‚æ­¥æ‰§è¡Œ
    await _sqlSugarClient.Ado.ExecuteCommandAsync($"SAVE TRANSACTION {savePointName}");
    context.SavePointStack.Push(savePointName);
    
    _logger.LogDebug($"[Transaction-{context.TransactionId}] åˆ›å»ºä¿å­˜ç‚¹: {savePointName}");
}
```

---

### æ–¹æ¡ˆå››ï¼šACIDåŸåˆ™å¢å¼º

#### 4.1 åŸå­æ€§å¢å¼º - ä¸¤é˜¶æ®µæäº¤æ¨¡æ‹Ÿ

```csharp
// å¯¹äºè·¨èšåˆæ ¹çš„å¤æ‚ä¸šåŠ¡
public async Task<ReturnResults<T>> ExecuteWithTwoPhaseCommitAsync<T>(
    List<IBusinessAggregate> aggregates,
    Func<Task> businessLogic)
{
    // ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡
    var prepareResults = new List<PrepareResult>();
    foreach (var aggregate in aggregates)
    {
        var result = await aggregate.PrepareAsync();
        if (!result.CanCommit)
        {
            // æœ‰èšåˆæ ¹å‡†å¤‡å¤±è´¥ï¼Œå–æ¶ˆæ‰€æœ‰
            foreach (var prepared in prepareResults)
            {
                await prepared.Aggregate.RollbackPrepareAsync();
            }
            
            return new ReturnResults<T>
            {
                Succeeded = false,
                ErrorMsg = "å‡†å¤‡é˜¶æ®µå¤±è´¥: " + result.Reason
            };
        }
        prepareResults.Add(result);
    }
    
    // ç¬¬äºŒé˜¶æ®µï¼šæäº¤
    try
    {
        await businessLogic(); // æ‰§è¡Œå®é™…ä¸šåŠ¡
        
        // æ‰€æœ‰èšåˆæäº¤
        foreach (var prepared in prepareResults)
        {
            await prepared.Aggregate.CommitPrepareAsync();
        }
        
        return new ReturnResults<T> { Succeeded = true };
    }
    catch (Exception ex)
    {
        // å›æ»šæ‰€æœ‰å‡†å¤‡
        foreach (var prepared in prepareResults)
        {
            await prepared.Aggregate.RollbackPrepareAsync();
        }
        
        throw;
    }
}
```

#### 4.2 éš”ç¦»çº§åˆ«ç®¡ç†

```csharp
public enum TransactionIsolationLevel
{
    ReadUncommitted,  // è¯»æœªæäº¤
    ReadCommitted,    // è¯»å·²æäº¤ï¼ˆé»˜è®¤ï¼‰
    RepeatableRead,   // å¯é‡å¤è¯»
    Serializable      // å¯ä¸²è¡ŒåŒ–
}

// å¢å¼ºBeginTranæ–¹æ³•
public void BeginTran(TransactionIsolationLevel isolationLevel = TransactionIsolationLevel.ReadCommitted)
{
    var context = CurrentTransactionContext;
    if (context == null)
    {
        context = CreateTransactionContext();
        context.IsolationLevel = isolationLevel;
        CurrentTransactionContext = context;
    }
    
    // ... åŸæœ‰é€»è¾‘ ...
    
    // æœ€å¤–å±‚äº‹åŠ¡è®¾ç½®éš”ç¦»çº§åˆ«
    if (newDepth == 1)
    {
        _logger.LogDebug($"[Transaction-{context.TransactionId}] å¼€å¯ç‰©ç†äº‹åŠ¡ï¼Œéš”ç¦»çº§åˆ«: {isolationLevel}");
        
        // è®¾ç½®SQL Serveréš”ç¦»çº§åˆ«
        string isolationLevelSql = isolationLevel switch
        {
            TransactionIsolationLevel.ReadUncommitted => "SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED",
            TransactionIsolationLevel.ReadCommitted => "SET TRANSACTION ISOLATION LEVEL READ COMMITTED",
            TransactionIsolationLevel.RepeatableRead => "SET TRANSACTION ISOLATION LEVEL REPEATABLE READ",
            TransactionIsolationLevel.Serializable => "SET TRANSACTION ISOLATION LEVEL SERIALIZABLE",
            _ => "SET TRANSACTION ISOLATION LEVEL READ COMMITTED"
        };
        
        _sqlSugarClient.Ado.ExecuteCommand(isolationLevelSql);
        _sqlSugarClient.Ado.BeginTran();
        
        _activeTransactions.TryAdd(context.TransactionId, context);
        _logger.LogInformation($"[Transaction-{context.TransactionId}] ç‰©ç†äº‹åŠ¡å·²æˆåŠŸå¼€å¯");
    }
}
```

---

### æ–¹æ¡ˆäº”ï¼šä¸šåŠ¡åœºæ™¯ä¸“é¡¹ä¼˜åŒ–

#### 5.1 é”€å”®è®¢å•æ’¤å›æäº¤ä¼˜åŒ–ï¼ˆå“åº”ä¹‹å‰è®¨è®ºçš„åœºæ™¯ï¼‰

```csharp
// æ–°å¢é¢†åŸŸæœåŠ¡å±‚
public class SaleOrderCancelSubmitService
{
    private readonly IUnitOfWorkManage _unitOfWorkManage;
    private readonly ILogger _logger;
    
    public async Task<ReturnResults<tb_SaleOrder>> CancelSubmitWithCleanupAsync(
        tb_SaleOrder saleOrder)
    {
        ReturnResults<tb_SaleOrder> result = new ReturnResults<tb_SaleOrder>();
        
        // 1. é¢„æ£€æŸ¥ï¼ˆåªè¯»ï¼Œä¸ä½¿ç”¨äº‹åŠ¡ï¼‰
        var canCancel = await CanCancelSubmitAsync(saleOrder);
        if (!canCancel.canCancel)
        {
            result.Succeeded = false;
            result.ErrorMsg = canCancel.reason;
            return result;
        }
        
        // 2. å¼€å¯æ•´ä½“äº‹åŠ¡
        _unitOfWorkManage.BeginTran();
        
        try
        {
            // 3. çŠ¶æ€å˜æ›´
            await ChangeStatusToDraftAsync(saleOrder);
            
            // 4. åˆ é™¤ç›¸å…³å•æ®ï¼ˆçº§è”åˆ é™¤ï¼‰
            await DeletePreReceiptsAsync(saleOrder);
            await DeleteReceiptsAsync(saleOrder);
            
            // 5. æäº¤äº‹åŠ¡
            _unitOfWorkManage.CommitTran();
            result.Succeeded = true;
        }
        catch (BusinessException ex)
        {
            _unitOfWorkManage.RollbackTran();
            result.Succeeded = false;
            result.ErrorMsg = ex.Message;
            _logger.LogWarning(ex, "æ’¤å›æäº¤ä¸šåŠ¡éªŒè¯å¤±è´¥");
        }
        catch (Exception ex)
        {
            _unitOfWorkManage.RollbackTran();
            result.Succeeded = false;
            result.ErrorMsg = "æ’¤å›æäº¤å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜";
            _logger.LogError(ex, "æ’¤å›æäº¤ç³»ç»Ÿé”™è¯¯");
        }
        
        return result;
    }
    
    private async Task<(bool canCancel, string reason)> CanCancelSubmitAsync(tb_SaleOrder saleOrder)
    {
        // æ£€æŸ¥æ˜¯å¦æœ‰å·²å®¡æ ¸çš„æ”¶æ¬¾å•
        var paymentRecords = await GetPaymentRecordsAsync(saleOrder);
        
        foreach (var payment in paymentRecords)
        {
            if (payment.ApprovalStatus == (int)ApprovalStatus.å®¡æ ¸é€šè¿‡)
            {
                return (false, 
                    $"å­˜åœ¨å·²å®¡æ ¸æ”¶æ¬¾å•ã€{payment.PaymentNo}ã€‘ï¼Œæ— æ³•æ’¤å›");
            }
        }
        
        return (true, string.Empty);
    }
    
    private async Task DeletePreReceiptsAsync(tb_SaleOrder saleOrder)
    {
        var preReceipts = await GetPreReceiptsAsync(saleOrder);
        
        foreach (var preReceipt in preReceipts)
        {
            // ç‰©ç†åˆ é™¤æˆ–é€»è¾‘åˆ é™¤
            if (preReceipt.CanDelete)
            {
                await _repository.DeleteAsync(preReceipt);
            }
            else
            {
                preReceipt.IsDeleted = true;
                await _repository.UpdateAsync(preReceipt);
            }
        }
    }
}
```

#### 5.2 åº“å­˜ä¸è´¢åŠ¡å¼ºä¸€è‡´æ€§ä¿éšœ

```csharp
// æ–°å¢åº“å­˜è´¢åŠ¡ä¸€è‡´æ€§åè°ƒå™¨
public class InventoryFinanceConsistencyCoordinator
{
    public async Task<ReturnResults<T>> ExecuteWithConsistencyCheckAsync<T>(
        Func<Task<ReturnResults<T>>> operation,
        ConsistencyCheckOptions options)
    {
        ReturnResults<T> result = null;
        
        await _unitOfWorkManage.ExecuteInTransactionAsync(async () =>
        {
            // 1. æ‰§è¡Œå‰å¿«ç…§
            var inventorySnapshot = await TakeInventorySnapshotAsync(options.ProdDetailIds);
            var financeSnapshot = await TakeFinanceSnapshotAsync(options.CustomerId);
            
            // 2. æ‰§è¡Œä¸šåŠ¡æ“ä½œ
            result = await operation();
            
            if (!result.Succeeded)
            {
                // ä¸šåŠ¡å¤±è´¥ï¼Œäº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»š
                return;
            }
            
            // 3. ä¸€è‡´æ€§æ ¡éªŒ
            var consistencyResult = await VerifyConsistencyAsync(
                inventorySnapshot, 
                financeSnapshot,
                options.Tolerance);
                
            if (!consistencyResult.IsConsistent)
            {
                // ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥ï¼Œä¸»åŠ¨å›æ»š
                throw new ConsistencyViolationException(
                    $"åº“å­˜è´¢åŠ¡ä¸ä¸€è‡´: {consistencyResult.Violations}");
            }
        });
        
        return result;
    }
    
    private async Task<ConsistencyResult> VerifyConsistencyAsync(
        InventorySnapshot inventory,
        FinanceSnapshot finance,
        decimal tolerance)
    {
        // éªŒè¯åº“å­˜æ‰£å‡ä¸è´¢åŠ¡å¢åŠ çš„é‡‘é¢æ˜¯å¦åŒ¹é…
        // éªŒè¯å¾€æ¥å•ä½ä½™é¢æ˜¯å¦æ­£ç¡®
        // ... å…·ä½“éªŒè¯é€»è¾‘
    }
}
```

---

### æ–¹æ¡ˆå…­ï¼šäº‹åŠ¡åµŒå¥—ä¼˜åŒ–è¿›é˜¶

#### 6.1 åµŒå¥—æ·±åº¦é™åˆ¶

```csharp
private const int MAX_NESTED_DEPTH = 5; // é™åˆ¶æœ€å¤§åµŒå¥—æ·±åº¦

public void BeginTran()
{
    var context = CurrentTransactionContext;
    if (context == null)
    {
        context = CreateTransactionContext();
        CurrentTransactionContext = context;
    }
    
    lock (context.LockObject)
    {
        // æ£€æŸ¥æ·±åº¦é™åˆ¶
        if (context.Depth >= MAX_NESTED_DEPTH)
        {
            throw new InvalidOperationException(
                $"äº‹åŠ¡åµŒå¥—æ·±åº¦è¶…è¿‡æœ€å¤§é™åˆ¶({MAX_NESTED_DEPTH})ï¼Œè¯·æ£€æŸ¥ä¸šåŠ¡é€»è¾‘");
        }
        
        context.Depth++;
        // ... åŸæœ‰é€»è¾‘ ...
    }
}
```

#### 6.2 æ™ºèƒ½åµŒå¥—æ£€æµ‹

```csharp
// æ£€æµ‹ä¸å¿…è¦çš„åµŒå¥—
private void DetectUnnecessaryNesting(TransactionContext context)
{
    var callerMethod = GetCallerMethod();
    var callStack = context.CallStack;
    
    // å¦‚æœåŒä¸€ä¸ªæ–¹æ³•é‡å¤å¼€å¯äº‹åŠ¡ï¼Œè­¦å‘Š
    if (callStack.Count > 0 && callStack.Peek() == callerMethod)
    {
        _logger.LogWarning(
            $"[Transaction-{context.TransactionId}] æ–¹æ³• {callerMethod} é‡å¤å¼€å¯äº‹åŠ¡ï¼Œ" +
            $"è¿™å¯èƒ½æ˜¯ä»£ç é€»è¾‘é”™è¯¯");
    }
    
    callStack.Push(callerMethod);
}

// åœ¨Commit/Rollbackæ—¶
private void RemoveFromCallStack(TransactionContext context)
{
    if (context.CallStack.Count > 0)
    {
        context.CallStack.Pop();
    }
}
```

---

### æ–¹æ¡ˆä¸ƒï¼šç›‘æ§ä¸å¯è§‚æµ‹æ€§å¢å¼º

#### 7.1 äº‹åŠ¡æ€§èƒ½ç›‘æ§

```csharp
public class TransactionMetrics
{
    private static readonly Histogram _transactionDuration = Metrics.CreateHistogram(
        "transaction_duration_seconds",
        "äº‹åŠ¡æŒç»­æ—¶é—´",
        new HistogramConfiguration
        {
            LabelNames = new[] { "operation", "status", "caller" },
            Buckets = Histogram.ExponentialBuckets(0.001, 2, 16)
        });
    
    private static readonly Counter _transactionCount = Metrics.CreateCounter(
        "transaction_total",
        "äº‹åŠ¡æ€»æ•°",
        new[] { "operation", "status", "caller" });
    
    public static void RecordTransaction(
        string operation, 
        string caller, 
        double duration, 
        bool succeeded)
    {
        var status = succeeded ? "success" : "failure";
        
        _transactionDuration
            .WithLabels(operation, status, caller)
            .Observe(duration);
            
        _transactionCount
            .WithLabels(operation, status, caller)
            .Inc();
    }
}

// åœ¨UnitOfWorkManageä¸­é›†æˆ
public void CommitTran()
{
    var context = CurrentTransactionContext;
    if (context == null) return;
    
    var startTime = context.StartTime;
    var caller = context.CallerMethod;
    
    try
    {
        // ... æäº¤é€»è¾‘ ...
        
        var duration = (DateTime.UtcNow - startTime).TotalSeconds;
        TransactionMetrics.RecordTransaction("commit", caller, duration, true);
    }
    catch (Exception ex)
    {
        var duration = (DateTime.UtcNow - startTime).TotalSeconds;
        TransactionMetrics.RecordTransaction("commit", caller, duration, false);
        throw;
    }
}
```

#### 7.2 äº‹åŠ¡æ—¥å¿—å¢å¼º

```csharp
// åœ¨TransactionContextä¸­å¢åŠ è¯¦ç»†æ—¥å¿—
public class TransactionContext
{
    public List<TransactionStep> Steps { get; } = new List<TransactionStep>();
    
    public void AddStep(string operation, string details)
    {
        Steps.Add(new TransactionStep
        {
            Timestamp = DateTime.UtcNow,
            Operation = operation,
            Details = details,
            Depth = Depth
        });
    }
}

public class TransactionStep
{
    public DateTime Timestamp { get; set; }
    public string Operation { get; set; }
    public string Details { get; set; }
    public int Depth { get; set; }
}

// åœ¨ä¸šåŠ¡æ–¹æ³•ä¸­è®°å½•æ­¥éª¤
public async Task ApprovalAsync(T entity)
{
    var context = _unitOfWorkManage.CurrentTransactionContext;
    context?.AddStep("Approval.Start", $"å¼€å§‹å®¡æ ¸å•æ® {entity.GetBillNo()}");
    
    try
    {
        context?.AddStep("Approval.Inventory", "å¼€å§‹åº“å­˜æ£€æŸ¥");
        await CheckInventoryAsync(entity);
        
        context?.AddStep("Approval.Finance", "å¼€å§‹ç”Ÿæˆè´¢åŠ¡å•æ®");
        await GenerateFinanceDocumentsAsync(entity);
        
        context?.AddStep("Approval.Complete", "å®¡æ ¸å®Œæˆ");
    }
    catch (Exception ex)
    {
        context?.AddStep("Approval.Error", $"å®¡æ ¸å¤±è´¥: {ex.Message}");
        throw;
    }
}
```

---

## ğŸ“‹ å®æ–½ä¼˜å…ˆçº§å»ºè®®ï¼ˆ2026-02-02 æ›´æ–°ï¼‰

### âœ… å·²å®Œæˆçš„ä¼˜åŒ–

1. **äº‹åŠ¡è¶…æ—¶æœºåˆ¶** âœ…
   - **æ–‡ä»¶**ï¼šTransactionContext.cs
   - **å†…å®¹**ï¼šæ·»åŠ TimeoutSecondså±æ€§ï¼ˆé»˜è®¤30ç§’ï¼‰ï¼ŒIsTimeout()æ£€æŸ¥æ–¹æ³•
   - **ä½¿ç”¨**ï¼šåƒµå°¸äº‹åŠ¡æ¸…ç†æ—¶å·²ä½¿ç”¨

2. **åµŒå¥—æ·±åº¦é™åˆ¶** âœ…
   - **æ–‡ä»¶**ï¼šUnitOfWorkManage.cs
   - **å¸¸é‡**ï¼šMAX_NESTED_DEPTH = 5
   - **è¡Œä¸º**ï¼šè¶…è¿‡é™åˆ¶æ—¶æŠ›å‡ºInvalidOperationException

3. **æ€§èƒ½ç›‘æ§é›†æˆ** âœ…
   - **æ–‡ä»¶**ï¼šTransactionMetrics.csï¼ˆæ–°å»ºï¼‰
   - **æŒ‡æ ‡**ï¼šäº‹åŠ¡æ€»æ•°ã€æŒç»­æ—¶é—´ï¼ˆP50/P95/P99ï¼‰ã€æˆåŠŸç‡
   - **é›†æˆ**ï¼šCommitTranå’ŒRollbackTranä¸­è‡ªåŠ¨è®°å½•

4. **é•¿äº‹åŠ¡è­¦å‘Š** âœ…
   - **æ–‡ä»¶**ï¼šUnitOfWorkManage.cs
   - **é˜ˆå€¼**ï¼š60ç§’
   - **è¡Œä¸º**ï¼šäº‹åŠ¡ç»“æŸæ—¶å¦‚æœè¶…è¿‡é˜ˆå€¼ï¼Œè®°å½•è­¦å‘Šæ—¥å¿—

### ğŸ¯ å‰©ä½™ä»»åŠ¡

#### é«˜ä¼˜å…ˆçº§ï¼ˆæ€§èƒ½å…³é”®ï¼‰
1. **é”ç²’åº¦ä¼˜åŒ–** ğŸ”´
   - **æ–‡ä»¶**ï¼šUnitOfWorkManage.cs
   - **é—®é¢˜**ï¼šBeginTran/CommitTran/RollbackTranä½¿ç”¨lock(this)
   - **ä¼˜åŒ–**ï¼šæ”¹ç”¨lock(context.LockObject)
   - **é¢„æœŸæ”¶ç›Š**ï¼šå¹¶å‘æ€§èƒ½æå‡30-50%
   - **å·¥ä½œé‡**ï¼š1å°æ—¶
   - **çŠ¶æ€**ï¼šè¿›è¡Œä¸­

#### ä¸­ä¼˜å…ˆçº§ï¼ˆå¯è§‚æµ‹æ€§ï¼‰
2. **Prometheusé›†æˆ** âš ï¸
   - **å†…å®¹**ï¼šæ›¿æ¢TransactionMetricsä¸ºPrometheusåŸç”ŸæŒ‡æ ‡
   - **å¥½å¤„**ï¼šæ›´å¥½çš„ç›‘æ§å’Œå‘Šè­¦æ”¯æŒ
   - **å·¥ä½œé‡**ï¼š2å°æ—¶

#### ä½ä¼˜å…ˆçº§ï¼ˆæ–‡æ¡£ï¼‰
3. **ä»£ç æ³¨é‡Šå®Œå–„** âœ…
   - **å†…å®¹**ï¼šä¸ºUnitOfWorkManageæ·»åŠ XMLæ³¨é‡Š
   - **å·¥ä½œé‡**ï¼š30åˆ†é’Ÿ
   - **çŠ¶æ€**ï¼šå·²å®Œæˆ

### ç¬¬äºŒé˜¶æ®µï¼ˆçŸ­æœŸå®æ–½ - æœ¬æœˆï¼‰
1. **é”ç«äº‰ä¼˜åŒ–**
   - **é£é™©ç­‰çº§**ï¼šâš ï¸ ä¸­ç­‰
   - **æ”¶ç›Š**ï¼šå¹¶å‘æ€§èƒ½æå‡30-50%
   - **å·¥ä½œé‡**ï¼š2-3å°æ—¶
   - **æ–¹æ¡ˆ**ï¼šç»†ç²’åº¦é”ï¼Œå‡å°‘`lock(this)`èŒƒå›´

2. **äº‹åŠ¡è¶…æ—¶æœºåˆ¶**
   - **é£é™©ç­‰çº§**ï¼šâœ… ä½
   - **æ”¶ç›Š**ï¼šé˜²æ­¢é•¿äº‹åŠ¡ï¼Œæå‡ç³»ç»Ÿå¥å£®æ€§
   - **å·¥ä½œé‡**ï¼š1-2å°æ—¶
   - **æ–¹æ¡ˆ**ï¼šé»˜è®¤5åˆ†é’Ÿè¶…æ—¶ï¼Œå¯é…ç½®

3. **ç›‘æ§æŒ‡æ ‡é›†æˆ**
   - **é£é™©ç­‰çº§**ï¼šâœ… ä½
   - **æ”¶ç›Š**ï¼šå¯è§‚æµ‹æ€§æå‡ï¼Œå¿«é€Ÿå®šä½é—®é¢˜
   - **å·¥ä½œé‡**ï¼šåŠå¤©
   - **æ–¹æ¡ˆ**ï¼šPrometheus + Grafanaï¼Œå…³é”®æŒ‡æ ‡å‘Šè­¦

### ç¬¬ä¸‰é˜¶æ®µï¼ˆä¸­æœŸé‡æ„ - ä¸‹å­£åº¦ï¼‰
1. **å¼•å…¥å·¥ä½œå•å…ƒæ¨¡å¼**
   - **é£é™©ç­‰çº§**ï¼šğŸ”´ é«˜
   - **æ”¶ç›Š**ï¼šæ¶æ„è´¨é‡æå‡ï¼Œä¸šåŠ¡è¾¹ç•Œæ¸…æ™°
   - **å·¥ä½œé‡**ï¼š2-3å‘¨ï¼ˆéœ€é€æ­¥è¿ç§»ï¼‰
   - **æ–¹æ¡ˆ**ï¼šæ–°å»ºIBusinessTransactionæ¥å£ï¼Œè€ä»£ç å…¼å®¹

2. **ä¸šåŠ¡æ­¥éª¤æ‹†åˆ†**
   - **é£é™©ç­‰çº§**ï¼šâš ï¸ ä¸­ç­‰
   - **æ”¶ç›Š**ï¼šå¯ç»´æŠ¤æ€§æå‡ï¼Œå•å…ƒæµ‹è¯•å‹å¥½
   - **å·¥ä½œé‡**ï¼š1-2å‘¨ï¼ˆä»¥é”€å”®è®¢å•å®¡æ ¸ä¸ºè¯•ç‚¹ï¼‰
   - **æ–¹æ¡ˆ**ï¼šæå–ç‹¬ç«‹æ–¹æ³•ï¼Œå•ä¸€èŒè´£

3. **é¢†åŸŸæœåŠ¡å±‚**
   - **é£é™©ç­‰çº§**ï¼šâš ï¸ ä¸­ç­‰
   - **æ”¶ç›Š**ï¼šç¬¦åˆDDDï¼Œä¸šåŠ¡é€»è¾‘å†…èš
   - **å·¥ä½œé‡**ï¼š3-4å‘¨ï¼ˆç»“åˆå·¥ä½œå•å…ƒæ¨¡å¼ï¼‰
   - **æ–¹æ¡ˆ**ï¼šæ–°å¢SaleOrderServiceç­‰é¢†åŸŸæœåŠ¡

### ç¬¬å››é˜¶æ®µï¼ˆé•¿æœŸè§„åˆ’ - ä¸‹åŠå¹´ï¼‰
1. **Sagaæ¨¡å¼ï¼ˆé•¿æµç¨‹äº‹åŠ¡ï¼‰**
   - **åœºæ™¯**ï¼šè·¨æœåŠ¡è°ƒç”¨ï¼Œå¦‚è®¢å•â†’æ”¯ä»˜â†’åº“å­˜â†’ç‰©æµ
   - **æ”¶ç›Š**ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿä¸€è‡´æ€§
   - **å·¥ä½œé‡**ï¼š1-2ä¸ªæœˆ

2. **äº‹ä»¶æº¯æº**
   - **åœºæ™¯**ï¼šå®¡è®¡è¿½è¸ªï¼Œä¸šåŠ¡å›æ”¾
   - **æ”¶ç›Š**ï¼šå®Œæ•´å®¡è®¡ï¼Œè°ƒè¯•ä¾¿åˆ©
   - **å·¥ä½œé‡**ï¼š2-3ä¸ªæœˆï¼ˆå¯é€‰ï¼‰

---

## ğŸ¯ å…³é”®æ”¹è¿›ç‚¹é€ŸæŸ¥è¡¨ï¼ˆåŸºäºå®é™…ä»£ç åˆ†æï¼‰

| é—®é¢˜ | ä½ç½® | ä¸¥é‡ç¨‹åº¦ | ä¼˜åŒ–æ–¹æ¡ˆ | é¢„æœŸæ”¶ç›Š | å·¥ä½œé‡ |
|------|-----|---------|---------|---------|-------|
| ç©ºcatchå— | tb_SaleOrderControllerPartial.cs:313-316 | âš ï¸ ä¸­ç­‰ | æ·»åŠ æ—¥å¿—æˆ–é‡æ–°æŠ›å‡º | æ•°æ®ä¸€è‡´æ€§â†‘ | 10åˆ†é’Ÿ |
| é”ç«äº‰ | UnitOfWorkManage.cs:317, 424, 505 | âš ï¸ ä¸­ç­‰ | ç»†ç²’åº¦é”ä¼˜åŒ– | å¹¶å‘æ€§èƒ½â†‘30-50% | 2-3å°æ—¶ |
| æ— äº‹åŠ¡è¶…æ—¶ | TransactionContextç±» | âœ… ä½ | æ·»åŠ Timeoutå±æ€§ | é˜²æ­¢é•¿äº‹åŠ¡ | 1å°æ—¶ |
| ç›‘æ§ç¼ºå¤± | å…¨å±€ | âš ï¸ ä½ | PrometheusæŒ‡æ ‡ | å¯è§‚æµ‹æ€§â†‘ | åŠå¤© |
| åµŒå¥—æ·±åº¦æ— é™åˆ¶ | BeginTranæ–¹æ³• | âœ… ä½ | æ·»åŠ æ·±åº¦æ£€æŸ¥ | é˜²æ­¢æ»¥ç”¨ | 30åˆ†é’Ÿ |
| ä¸šåŠ¡é€»è¾‘è‡ƒè‚¿ | å„Controller.ApprovalAsync | â„¹ï¸ å»ºè®® | æå–ç‹¬ç«‹æ–¹æ³• | å¯ç»´æŠ¤æ€§â†‘â†‘ | 1-2å‘¨ |
| å·¥ä½œå•å…ƒç¼ºå¤± | æ¶æ„å±‚ | â„¹ï¸ å»ºè®® | å¼•å…¥UoWæ¨¡å¼ | æ¶æ„è´¨é‡â†‘â†‘ | 2-3å‘¨ |

### çœŸå®ä»£ç è´¨é‡è¯„ä¼°

**âœ… ä¼˜ç§€æ–¹é¢**ï¼š
- 95%ä»¥ä¸Šçš„æ–¹æ³•æœ‰æ­£ç¡®çš„å¼‚å¸¸å¤„ç†ï¼ˆRollback + æ—¥å¿—ï¼‰
- äº‹åŠ¡è¾¹ç•Œæ¸…æ™°ï¼Œå•ä¸€å…¥å£åŸåˆ™éµå®ˆè‰¯å¥½
- å»¶è¿Ÿå¼€å¯äº‹åŠ¡æ¨¡å¼ï¼ˆéªŒè¯åæ‰å¼€å¯ï¼‰

**âš ï¸ éœ€è¦æ”¹è¿›**ï¼š
- 1ä¸ªç©ºcatchå—ï¼ˆéœ€ç«‹å³ä¿®å¤ï¼‰
- é”ç²’åº¦è¿‡å¤§ï¼ˆæ€§èƒ½ç“¶é¢ˆï¼‰
- ç¼ºå°‘ç›‘æ§å’Œè¶…æ—¶æœºåˆ¶ï¼ˆè¿ç»´å›°éš¾ï¼‰

**â„¹ï¸ é•¿æœŸå»ºè®®**ï¼š
- ä¸šåŠ¡é€»è¾‘æ‹†åˆ†ï¼ˆæå‡å¯ç»´æŠ¤æ€§ï¼‰
- æ¶æ„å‡çº§ï¼ˆDDD + å·¥ä½œå•å…ƒï¼‰

---

## ğŸ’¡ å…¶ä»–å»ºè®®

### 1. å•å…ƒæµ‹è¯•è¦†ç›–
- ä¸ºäº‹åŠ¡ç®¡ç†å™¨ç¼–å†™å•å…ƒæµ‹è¯•
- æ¨¡æ‹Ÿå¹¶å‘åœºæ™¯æµ‹è¯•
- æµ‹è¯•è¾¹ç•Œæƒ…å†µï¼ˆæ·±åº¦åµŒå¥—ã€è¶…æ—¶ã€å¼‚å¸¸ï¼‰

### 2. ä»£ç å®¡æŸ¥è§„èŒƒ
- ç¦æ­¢åœ¨å¾ªç¯ä¸­å¼€å¯äº‹åŠ¡
- ç¦æ­¢è·¨æœåŠ¡è°ƒç”¨æ—¶æŒæœ‰äº‹åŠ¡
- å¼ºåˆ¶ä½¿ç”¨usingæˆ–try-finallyæ¸…ç†äº‹åŠ¡

### 3. æ–‡æ¡£å’ŒåŸ¹è®­
- ç¼–å†™äº‹åŠ¡ä½¿ç”¨æœ€ä½³å®è·µ
- åŸ¹è®­å¼€å‘å›¢é˜Ÿæ­£ç¡®ä½¿ç”¨äº‹åŠ¡
- å»ºç«‹äº‹åŠ¡ä½¿ç”¨å®¡æŸ¥æ¸…å•

---

## ğŸ“ æ€»ç»“ï¼ˆåŸºäºå®é™…ä»£ç åˆ†ææ›´æ–°ï¼‰

### âœ… å½“å‰äº‹åŠ¡ç®¡ç†å™¨çš„ä¼˜ç‚¹

1. **äº‹åŠ¡è¾¹ç•Œç®¡ç†è‰¯å¥½**ï¼š
   - 95%ä»¥ä¸Šçš„ä¸šåŠ¡æ–¹æ³•éµå¾ªå•ä¸€äº‹åŠ¡å…¥å£åŸåˆ™
   - å»¶è¿Ÿå¼€å¯æ¨¡å¼ï¼ˆä¸šåŠ¡éªŒè¯åæ‰å¼€å¯äº‹åŠ¡ï¼‰
   - äº‹åŠ¡è¾¹ç•Œæ¸…æ™°ï¼Œæ˜“äºè¿½è¸ª

2. **å¼‚å¸¸å¤„ç†å®Œå–„**ï¼š
   - ç»å¤§å¤šæ•°æ–¹æ³•æœ‰å®Œæ•´çš„try-catch-finallyç»“æ„
   - æ ‡å‡†æ¨¡å¼ï¼šå¼‚å¸¸ â†’ Rollback â†’ æ—¥å¿— â†’ è¿”å›é”™è¯¯
   - åƒµå°¸äº‹åŠ¡é£é™©ä½

3. **åµŒå¥—äº‹åŠ¡æ”¯æŒ**ï¼š
   - ä½¿ç”¨SQL Serverä¿å­˜ç‚¹å®ç°åµŒå¥—äº‹åŠ¡
   - ä¿å­˜ç‚¹åç§°å·²ä¼˜åŒ–ï¼ˆ32å­—ç¬¦é™åˆ¶ï¼‰
   - æ”¯æŒæ·±åº¦åµŒå¥—ï¼ˆå»ºè®®é™åˆ¶æœ€å¤§æ·±åº¦ï¼‰

### âš ï¸ éœ€è¦æ”¹è¿›çš„é—®é¢˜

**é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰**ï¼š
1. **1ä¸ªç©ºcatchå—**ï¼ˆtb_SaleOrderControllerPartial.cs:313-316ï¼‰
   - é™é»˜åå™¬å¼‚å¸¸ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
   - æ— æ—¥å¿—ï¼Œæ— æ³•æ’æŸ¥é—®é¢˜

**ä¸­ä¼˜å…ˆçº§ï¼ˆæœ¬æœˆå®Œæˆï¼‰**ï¼š
2. **é”ç«äº‰**ï¼š`lock(this)`åœ¨é«˜å¹¶å‘ä¸‹æˆä¸ºç“¶é¢ˆ
3. **ç›‘æ§ç¼ºå¤±**ï¼šç¼ºå°‘æ€§èƒ½æŒ‡æ ‡å’Œå‘Šè­¦
4. **è¶…æ—¶æœºåˆ¶**ï¼šæ— äº‹åŠ¡è¶…æ—¶è‡ªåŠ¨å›æ»š

**ä½ä¼˜å…ˆçº§ï¼ˆä¸‹å­£åº¦è§„åˆ’ï¼‰**ï¼š
5. **ä»£ç è‡ƒè‚¿**ï¼šApprovalAsyncæ–¹æ³•è¡Œæ•°è¿‡å¤šï¼ˆ>350è¡Œï¼‰
6. **æ¶æ„å‡çº§**ï¼šå¯å¼•å…¥å·¥ä½œå•å…ƒæ¨¡å¼æå‡æ¶æ„è´¨é‡

### ğŸ¯ æœ€å…³é”®çš„è¡ŒåŠ¨é¡¹

**ç«‹å³æ‰§è¡Œ**ï¼š
- [ ] ä¿®å¤tb_SaleOrderControllerPartial.csç¬¬313-316è¡Œçš„ç©ºcatchå—
- [ ] å…¨å±€æ‰«ææ‰€æœ‰ç©ºcatchå—æ¨¡å¼
- [ ] æ·»åŠ äº‹åŠ¡åµŒå¥—æ·±åº¦é™åˆ¶ï¼ˆå»ºè®®æœ€å¤§5å±‚ï¼‰

**çŸ­æœŸä¼˜åŒ–**ï¼š
- [ ] é”ç²’åº¦ä¼˜åŒ–ï¼ˆå‡å°‘å¹¶å‘ç“¶é¢ˆï¼‰
- [ ] ç›‘æ§æŒ‡æ ‡é›†æˆï¼ˆPrometheus + Grafanaï¼‰
- [ ] äº‹åŠ¡è¶…æ—¶æœºåˆ¶ï¼ˆé»˜è®¤5åˆ†é’Ÿï¼‰

**é•¿æœŸè§„åˆ’**ï¼š
- [ ] ä¸šåŠ¡é€»è¾‘æ‹†åˆ†ï¼ˆæå‡å¯ç»´æŠ¤æ€§ï¼‰
- [ ] æ¶æ„å‡çº§ï¼ˆDDD + å·¥ä½œå•å…ƒæ¨¡å¼ï¼‰

### ğŸ“Š ä»£ç è´¨é‡è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| äº‹åŠ¡è¾¹ç•Œç®¡ç† | â­â­â­â­â­ 95% | å•ä¸€å…¥å£ï¼Œå»¶è¿Ÿå¼€å¯ |
| å¼‚å¸¸å¤„ç† | â­â­â­â­â˜† 90% | å®Œæ•´åº¦é«˜ï¼Œ1å¤„ç©ºcatch |
| æ€§èƒ½ä¼˜åŒ– | â­â­â­â˜†â˜† 70% | é”ç«äº‰å¾…ä¼˜åŒ– |
| ç›‘æ§å¯è§‚æµ‹ | â­â­â˜†â˜†â˜† 50% | ç¼ºå°‘å…³é”®æŒ‡æ ‡ |
| æ¶æ„è®¾è®¡ | â­â­â­â˜†â˜† 75% | æœ‰æ”¹è¿›ç©ºé—´ |

**æ€»ä½“è¯„ä»·**ï¼šè‰¯å¥½ï¼ˆ85/100ï¼‰ï¼Œä¿®å¤ç©ºcatchå—åå¯è¾¾90+

---

## ğŸ“š é™„å½•ï¼šä»£ç å®¡æŸ¥æ¸…å•

### äº‹åŠ¡ä½¿ç”¨è§„èŒƒ âœ…

- [ ] æ¯ä¸ªä¸šåŠ¡æ–¹æ³•åªå¼€å¯ä¸€æ¬¡äº‹åŠ¡ï¼ˆå•ä¸€å…¥å£åŸåˆ™ï¼‰
- [ ] åœ¨ä¸šåŠ¡éªŒè¯é€šè¿‡åå¼€å¯äº‹åŠ¡ï¼ˆå»¶è¿Ÿå¼€å¯æ¨¡å¼ï¼‰
- [ ] æ‰€æœ‰å¼‚å¸¸è·¯å¾„éƒ½è°ƒç”¨RollbackTran()
- [ ] æ‰€æœ‰å¼‚å¸¸éƒ½è®°å½•è¯¦ç»†æ—¥å¿—ï¼ˆåŒ…æ‹¬å †æ ˆï¼‰
- [ ] æ— ç©ºcatchå—ï¼ˆè‡³å°‘è®°å½•æ—¥å¿—ï¼‰
- [ ] äº‹åŠ¡åµŒå¥—æ·±åº¦ä¸è¶…è¿‡5å±‚
- [ ] ä¸åœ¨å¾ªç¯ä¸­å¼€å¯äº‹åŠ¡
- [ ] è·¨æœåŠ¡è°ƒç”¨ä¸æŒæœ‰äº‹åŠ¡

### æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥ âœ…

- [ ] é”ç²’åº¦æœ€å°åŒ–ï¼ˆé¿å…lock(this)ï¼‰
- [ ] æ‰¹é‡æ“ä½œä½¿ç”¨æ‰¹æ¬¡å¤„ç†ï¼ˆ100æ¡/æ‰¹æ¬¡ï¼‰
- [ ] äº‹åŠ¡è¶…æ—¶æ—¶é—´è®¾ç½®åˆç†ï¼ˆ5åˆ†é’Ÿï¼‰
- [ ] ç›‘æ§æŒ‡æ ‡å·²é›†æˆï¼ˆPrometheusï¼‰
- [ ] é•¿äº‹åŠ¡æœ‰å‘Šè­¦ï¼ˆ>60ç§’ï¼‰

### å¯è§‚æµ‹æ€§æ£€æŸ¥ âœ…

- [ ] äº‹åŠ¡æŒç»­æ—¶é—´è®°å½•
- [ ] äº‹åŠ¡æˆåŠŸç‡ç›‘æ§
- [ ] åµŒå¥—æ·±åº¦åˆ†å¸ƒç»Ÿè®¡
- [ ] åƒµå°¸äº‹åŠ¡è‡ªåŠ¨å‘Šè­¦
- [ ] é”™è¯¯æ—¥å¿—å®Œæ•´ï¼ˆå«ä¸šåŠ¡ä¸Šä¸‹æ–‡ï¼‰