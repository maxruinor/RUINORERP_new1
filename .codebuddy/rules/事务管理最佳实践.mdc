---
description: 
alwaysApply: true
enabled: true
updatedAt: 2026-02-02T08:35:08.897Z
provider: 
---

# äº‹åŠ¡ç®¡ç†æœ€ä½³å®è·µè§„èŒƒ

## ğŸ“‹ æ ¸å¿ƒåŸåˆ™

### 1. å•ä¸€å…¥å£åŸåˆ™ âœ…
- **æ¯ä¸ªä¸šåŠ¡æ–¹æ³•åªå¼€å¯ä¸€æ¬¡äº‹åŠ¡**
- åœ¨ä¸šåŠ¡éªŒè¯é€šè¿‡åå¼€å¯äº‹åŠ¡ï¼ˆå»¶è¿Ÿå¼€å¯æ¨¡å¼ï¼‰
- ç¦æ­¢åœ¨åŒä¸ªæ–¹æ³•ä¸­å¤šæ¬¡è°ƒç”¨`BeginTran()`

### 2. å¼‚å¸¸å¤„ç†è§„èŒƒ âœ…
```csharp
// âœ… æ­£ç¡®ç¤ºä¾‹
try
{
    _unitOfWorkManage.BeginTran();
    // ... ä¸šåŠ¡é€»è¾‘ ...
    _unitOfWorkManage.CommitTran();
    return ReturnResults.Success();
}
catch (Exception ex)
{
    _unitOfWorkManage.RollbackTran();  // å¿…é¡»å›æ»š
    _logger.LogError(ex, "ä¸šåŠ¡æ“ä½œå¤±è´¥");  // å¿…é¡»è®°å½•æ—¥å¿—
    return ReturnResults.Error($"æ“ä½œå¤±è´¥: {ex.Message}");
}

// âŒ é”™è¯¯ç¤ºä¾‹
try
{
    _unitOfWorkManage.BeginTran();
    // ... ä¸šåŠ¡é€»è¾‘ ...
    _unitOfWorkManage.CommitTran();
}
catch (Exception ex)
{
    // ç¼ºå°‘Rollback
    _logger.LogError(ex);  // åªæœ‰æ—¥å¿—
}
```

### 3. ç¦æ­¢ç©ºcatchå— âœ…
```csharp
// âŒ ç»å¯¹ç¦æ­¢
catch (Exception ex)
{
    // ç©ºçš„ï¼
}

// âœ… è‡³å°‘è®°å½•æ—¥å¿—
catch (Exception ex)
{
    _logger.LogError(ex, "æ“ä½œå¤±è´¥");
}

// âœ… æˆ–è€…é‡æ–°æŠ›å‡º
catch (Exception ex)
{
    _logger.LogWarning(ex, "éå…³é”®é”™è¯¯");
    throw new BusinessException("æ“ä½œå¤±è´¥", ex);
}
```

### 4. å»¶è¿Ÿå¼€å¯äº‹åŠ¡ âœ…
```csharp
// âœ… æ­£ç¡®ï¼šå…ˆéªŒè¯ï¼Œå†å¼€äº‹åŠ¡
public async Task<ReturnResults> BusinessOperation(Entity entity)
{
    // 1. åªè¯»éªŒè¯ï¼ˆæ— äº‹åŠ¡ï¼‰
    var validation = await ValidateAsync(entity);
    if (!validation.IsValid)
        return ReturnResults.Error(validation.Errors);
    
    // 2. éªŒè¯é€šè¿‡åæ‰å¼€å¯äº‹åŠ¡
    _unitOfWorkManage.BeginTran();
    try
    {
        await CoreBusinessLogicAsync(entity);
        _unitOfWorkManage.CommitTran();
        return ReturnResults.Success();
    }
    catch (Exception ex)
    {
        _unitOfWorkManage.RollbackTran();
        _logger.LogError(ex);
        return ReturnResults.Error(ex.Message);
    }
}

// âŒ é”™è¯¯ï¼šè¿‡æ—©å¼€å¯äº‹åŠ¡
public async Task<ReturnResults> BusinessOperation(Entity entity)
{
    _unitOfWorkManage.BeginTran();  // è¿‡æ—©å¼€å¯ï¼Œå¢åŠ é”æ—¶é—´
    try
    {
        var validation = await ValidateAsync(entity);  // éªŒè¯ä¹ŸæŒæœ‰äº‹åŠ¡
        if (!validation.IsValid)
        {
            _unitOfWorkManage.RollbackTran();  // ä¸å¿…è¦çš„å›æ»š
            return ReturnResults.Error(validation.Errors);
        }
        
        await CoreBusinessLogicAsync(entity);
        _unitOfWorkManage.CommitTran();
        return ReturnResults.Success();
    }
    catch (Exception ex)
    {
        _unitOfWorkManage.RollbackTran();
        _logger.LogError(ex);
        return ReturnResults.Error(ex.Message);
    }
}
```

### 5. åµŒå¥—æ·±åº¦é™åˆ¶ âœ…
- **æœ€å¤§æ·±åº¦**ï¼š5å±‚
- **è¶…è¿‡é™åˆ¶**ï¼šæŠ›å‡º`InvalidOperationException`
- **ç›®çš„**ï¼šé˜²æ­¢æ»¥ç”¨ï¼Œæå‡æ€§èƒ½

```csharp
private const int MAX_NESTED_DEPTH = 5;

public void BeginTran()
{
    if (CurrentTransactionContext?.Depth >= MAX_NESTED_DEPTH)
    {
        throw new InvalidOperationException(
            $"äº‹åŠ¡åµŒå¥—æ·±åº¦è¶…è¿‡æœ€å¤§é™åˆ¶({MAX_NESTED_DEPTH})ï¼Œè¯·æ£€æŸ¥ä¸šåŠ¡é€»è¾‘");
    }
    // ... åŸæœ‰é€»è¾‘ ...
}
```

### 6. æ€§èƒ½ä¼˜åŒ– âœ…

#### 6.1 é”ç²’åº¦æœ€å°åŒ–
```csharp
// âŒ é”™è¯¯ï¼šlockæ•´ä¸ªæ–¹æ³•
public void BeginTran()
{
    lock (this)  // é”å¤ªå¤§ï¼
    {
        // ... æ‰€æœ‰é€»è¾‘ ...
    }
}

// âœ… æ­£ç¡®ï¼šç»†ç²’åº¦é”
public void BeginTran()
{
    var context = CurrentTransactionContext;
    if (context == null)
    {
        context = CreateTransactionContext();
        CurrentTransactionContext = context;
    }
    
    lock (context.LockObject)  // åªé”å¿…è¦éƒ¨åˆ†
    {
        // ... ä¸´ç•ŒåŒºä»£ç  ...
    }
}
```

#### 6.2 æ‰¹é‡æ“ä½œ
```csharp
// âŒ é”™è¯¯ï¼šå¾ªç¯ä¸­å¼€å¯äº‹åŠ¡
foreach (var item in items)
{
    _unitOfWorkManage.BeginTran();  // æ€§èƒ½å·®ï¼
    await ProcessItemAsync(item);
    _unitOfWorkManage.CommitTran();
}

// âœ… æ­£ç¡®ï¼šæ‰¹é‡äº‹åŠ¡
_unitOfWorkManage.BeginTran();
try
{
    foreach (var item in items)
    {
        await ProcessItemAsync(item);
    }
    _unitOfWorkManage.CommitTran();
}
catch (Exception ex)
{
    _unitOfWorkManage.RollbackTran();
    _logger.LogError(ex);
}
```

### 7. è·¨æœåŠ¡è°ƒç”¨è§„èŒƒ âœ…
```csharp
// âŒ é”™è¯¯ï¼šè·¨æœåŠ¡è°ƒç”¨æŒæœ‰äº‹åŠ¡
_unitOfWorkManage.BeginTran();
try
{
    await UpdateDatabaseAsync();  // æœ¬åœ°æ•°æ®åº“æ“ä½œ
    await CallRemoteServiceAsync();  // é•¿æ—¶é—´è¿œç¨‹è°ƒç”¨ï¼Œå ç”¨è¿æ¥ï¼
    _unitOfWorkManage.CommitTran();
}
catch (Exception ex)
{
    _unitOfWorkManage.RollbackTran();
}

// âœ… æ­£ç¡®ï¼šå…ˆå®Œæˆæœ¬åœ°äº‹åŠ¡
_unitOfWorkManage.BeginTran();
try
{
    await UpdateDatabaseAsync();  // æœ¬åœ°æ“ä½œ
    _unitOfWorkManage.CommitTran();
}
catch (Exception ex)
{
    _unitOfWorkManage.RollbackTran();
    return ReturnResults.Error(ex.Message);
}

// å†è°ƒç”¨è¿œç¨‹æœåŠ¡
var remoteResult = await CallRemoteServiceAsync();
if (!remoteResult.Succeeded)
{
    // è¿œç¨‹è°ƒç”¨å¤±è´¥ï¼Œéœ€è¦è¡¥å¿æœ¬åœ°æ“ä½œ
    await CompensateLocalOperationAsync();
}
```

### 8. ç›‘æ§ä¸æ—¥å¿— âœ…

#### 8.1 å¿…è®°å½•çš„ä¿¡æ¯
```csharp
catch (Exception ex)
{
    _logger.LogError(ex, "ä¸šåŠ¡æ“ä½œå¤±è´¥è¯¦æƒ…", new
    {
        EntityId = entity.ID,
        BillNo = entity.BillNo,
        UserId = CurrentUser.UserId,
        TransactionId = _unitOfWorkManage.CurrentTransactionContext?.TransactionId,
        Duration = _unitOfWorkManage.CurrentTransactionContext?.GetDuration()
    });
}
```

#### 8.2 å…³é”®æŒ‡æ ‡
- äº‹åŠ¡æŒç»­æ—¶é—´ï¼ˆhistogramï¼‰
- äº‹åŠ¡æˆåŠŸç‡ï¼ˆcounterï¼‰
- åµŒå¥—æ·±åº¦åˆ†å¸ƒï¼ˆhistogramï¼‰
- åƒµå°¸äº‹åŠ¡æ•°é‡ï¼ˆgaugeï¼‰
- é•¿äº‹åŠ¡å‘Šè­¦ï¼ˆ>60ç§’ï¼‰

### 9. å•å…ƒæµ‹è¯• âœ…
```csharp
[Fact]
public async Task ApprovalAsync_WithValidEntity_ShouldCommitTransaction()
{
    // Arrange
    var entity = CreateValidEntity();
    
    // Act
    var result = await _controller.ApprovalAsync(entity);
    
    // Assert
    Assert.True(result.Succeeded);
    Assert.Equal(0, _unitOfWorkManage.TranCount);  // äº‹åŠ¡å·²æ¸…ç†
}

[Fact]
public async Task ApprovalAsync_WithInvalidEntity_ShouldRollbackTransaction()
{
    // Arrange
    var entity = CreateInvalidEntity();
    
    // Act
    var result = await _controller.ApprovalAsync(entity);
    
    // Assert
    Assert.False(result.Succeeded);
    Assert.Equal(0, _unitOfWorkManage.TranCount);  // äº‹åŠ¡å·²æ¸…ç†
}
```

### 10. ä»£ç å®¡æŸ¥æ£€æŸ¥æ¸…å• âœ…

#### å®¡æŸ¥æ¯ä¸ªä½¿ç”¨äº‹åŠ¡çš„æ–¹æ³•ï¼š
- [ ] åªæœ‰ä¸€ä¸ª`BeginTran()`è°ƒç”¨
- [ ] `BeginTran()`åœ¨ä¸šåŠ¡éªŒè¯ä¹‹å
- [ ] æ‰€æœ‰å¼‚å¸¸è·¯å¾„éƒ½æœ‰`RollbackTran()`
- [ ] catchå—ä¸ä¸ºç©ºï¼ˆè‡³å°‘è®°å½•æ—¥å¿—ï¼‰
- [ ] æ—¥å¿—åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- [ ] äº‹åŠ¡æ·±åº¦ä¸è¶…è¿‡5å±‚
- [ ] æ²¡æœ‰åœ¨å¾ªç¯ä¸­å¼€å¯äº‹åŠ¡
- [ ] æ²¡æœ‰è·¨æœåŠ¡è°ƒç”¨æŒæœ‰äº‹åŠ¡
- [ ] ä½¿ç”¨`try-finally`æˆ–`using`ç¡®ä¿æ¸…ç†

## ğŸ“Š ä»£ç è´¨é‡ç›®æ ‡

- **äº‹åŠ¡è¾¹ç•Œæ¸…æ™°**ï¼š100%çš„æ–¹æ³•éµå¾ªå•ä¸€å…¥å£åŸåˆ™
- **å¼‚å¸¸å¤„ç†å®Œæ•´**ï¼š100%çš„catchå—éç©º
- **ç›‘æ§è¦†ç›–ç‡**ï¼š100%çš„å…³é”®ä¸šåŠ¡æ–¹æ³•æœ‰æŒ‡æ ‡è®°å½•
- **å•å…ƒæµ‹è¯•è¦†ç›–ç‡**ï¼š>80%çš„äº‹åŠ¡ç›¸å…³ä»£ç 
- **é•¿äº‹åŠ¡**ï¼š0ä¸ªï¼ˆ>5åˆ†é’Ÿçš„äº‹åŠ¡ï¼‰

## ğŸ”¥ çº¢çº¿è§„åˆ™ï¼ˆç»å¯¹ä¸èƒ½è¿åï¼‰

1. **ç¦æ­¢ç©ºcatchå—** âŒ
2. **ç¦æ­¢åœ¨å¾ªç¯ä¸­å¼€å¯äº‹åŠ¡** âŒ
3. **ç¦æ­¢è·¨æœåŠ¡è°ƒç”¨æŒæœ‰äº‹åŠ¡** âŒ
4. **ç¦æ­¢äº‹åŠ¡æ·±åº¦è¶…è¿‡5å±‚** âŒ
5. **ç¦æ­¢åªè®°å½•æ—¥å¿—ä¸å›æ»š** âŒ

---

**æœ€åæ›´æ–°**ï¼š2026-02-02
**åŸºäºå®é™…ä»£ç åˆ†æä¿®è®¢**