# 销售订单和采购订单结案功能预付款处理增强方案

## 需求分析

### 1. 当前问题
1. **销售订单结案功能**：缺少预收付款处理逻辑，无法在结案前处理相关预收款项
2. **采购订单结案功能**：需要添加预付款检测机制，确保作废结案前完成退款流程
3. **销售订单结案**：同样需要遵循预付款处理原则，结案前检查并处理预收款项

### 2. 业务场景
- 销售订单：已有预收款单时，结案前需要检查并处理预收款
- 采购订单：已有预付款单时，作废结案前需要检查并处理预付款
- 需要支持自动退款功能（如果启用了EnableAutoRefundOnOrderCancel）

## 修复方案

### 1. 销售订单结案功能增强
在`tb_SaleOrderControllerPartial.cs`的`BatchCloseCaseAsync`方法中添加：
- 启用财务模块检测
- 检测销售订单关联的预收款单
- 根据预收款单状态进行不同处理：
  - 草稿、待审核、已生效状态：检查收款单后删除
  - 已核销、部分核销状态：不允许结案，提示用户撤销核销
  - 待核销状态：根据配置决定是否自动退款

### 2. 采购订单结案功能增强
在`tb_PurOrderControllerPartial.cs`的`BatchCloseCaseAsync`方法中添加：
- 启用财务模块检测
- 检测采购订单关联的预付款单
- 根据预付款单状态进行不同处理：
  - 草稿、待审核状态：检查付款单后删除
  - 已生效状态：提示需要先退款
  - 已核销、部分核销状态：不允许结案，提示用户撤销核销
  - 待核销状态：根据配置决定是否自动付款退款

### 3. 公共方法抽取
创建通用的预付款处理方法，减少代码重复：
- `HandlePrePaymentForCancellationAsync` - 处理预付款/预收款取消
- `CheckPrePaymentStatusForCloseCaseAsync` - 检查预付款状态是否允许结案

### 4. 错误处理增强
- 添加清晰的错误提示信息
- 确保事务正确回滚
- 记录详细的操作日志

## 实现步骤

### 步骤1：修改销售订单结案功能
1. 在`BatchCloseCaseAsync`方法中添加财务模块检测
2. 添加预收款单查询和处理逻辑
3. 根据预收款单状态进行不同处理
4. 支持自动退款功能（如果启用了EnableAutoRefundOnOrderCancel）

### 步骤2：修改采购订单结案功能
1. 在`BatchCloseCaseAsync`方法中添加财务模块检测
2. 添加预付款单查询和处理逻辑
3. 根据预付款单状态进行不同处理
4. 支持自动付款退款功能

### 步骤3：测试验证
1. 测试销售订单结案时的预收款处理
2. 测试采购订单作废结案时的预付款处理
3. 验证自动退款功能是否正常工作
4. 验证各种状态组合下的处理逻辑

## 预期效果
- 销售订单结案前会自动检查并处理预收款
- 采购订单作废结案前会强制要求处理预付款
- 支持自动退款功能，简化操作流程
- 提供清晰的错误提示，引导用户正确操作