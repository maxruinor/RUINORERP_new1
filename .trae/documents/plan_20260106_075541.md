# BuildPaymentRecord 方法优化方案

## 1. 优化目标

### 1.1 当前代码问题

1. **代码结构松散**：验证逻辑、明细转换、汇总计算都混在一起
2. **注释不够规范**：部分注释使用中文，缺乏统一格式
3. **方法过长**：整个方法近150行，可读性差
4. **重复逻辑**：验证逻辑与 `StatementToPaymentRecordConverter` 中的 `ValidateConversionAsync` 类似但未复用
5. **代码组织**：功能相关的代码块未集中组织

### 1.2 优化内容

#### 1.2.1 代码重构

将 `BuildPaymentRecord` 方法拆分为以下私有方法：

1. **`ValidateStatements`** - 验证对账单列表
   - 检查列表是否为空
   - 检查每张对账单的状态是否符合转换条件
   - 返回验证结果和有效对账单列表

2. **`InitializePaymentRecord`** - 初始化收付款单基本信息
   - 基础字段映射
   - 状态重置
   - 客户/员工信息设置

3. **`ConvertStatementDetails`** - 转换对账单明细
   - 遍历对账单列表
   - 设置来源业务类型和摘要
   - 处理金额（确保为正数）
   - 关联到收付款单

4. **`RecalculateSummaryFields`** - 重新计算汇总字段
   - 计算外币总金额
   - 计算本币总金额
   - 计算应付总金额

5. **`ValidateNoDuplicates`** - 验证明细中是否有重复单据
   - 按业务类型和单据ID分组
   - 检查是否有重复
   - 抛出异常或返回错误信息

6. **`GeneratePaymentNo`** - 生成收付款单号
   - 根据收付款类型生成单号
   - 设置平台标识

#### 1.2.2 注释优化

- 添加XML文档注释
- 关键逻辑添加详细说明
- 统一使用中文注释（与项目保持一致）

#### 1.2.3 代码结构优化

- 功能相关的代码块集中组织
- 减少嵌套层级
- 提高可读性

## 2. 优化后的代码结构

```csharp
/// <summary>
/// 由对账单创建收付款单
/// </summary>
/// <param name="entities">对账单列表</param>
/// <returns>收付款单</returns>
public async Task<tb_FM_PaymentRecord> BuildPaymentRecord(List<tb_FM_Statement> entities)
{
    // 1. 验证输入参数
    // 2. 验证对账单状态
    // 3. 初始化收付款单
    // 4. 转换明细
    // 5. 计算汇总字段
    // 6. 验证重复单据
    // 7. 生成单号
    // 8. 初始化实体
}

// 私有验证方法
private (bool isValid, List<tb_FM_Statement> validStatements, string errorMessage) ValidateStatements(List<tb_FM_Statement> entities);

// 私有初始化方法
private void InitializePaymentRecord(tb_FM_PaymentRecord paymentRecord, tb_FM_Statement firstStatement);

// 私有明细转换方法
private List<tb_FM_PaymentRecordDetail> ConvertStatementDetails(List<tb_FM_Statement> statements, long currencyId);

// 私有汇总计算方法
private void RecalculateSummaryFields(tb_FM_PaymentRecord paymentRecord);

// 私有验证重复方法
private void ValidateNoDuplicates(tb_FM_PaymentRecord paymentRecord);

// 私有单号生成方法
private async Task GeneratePaymentNo(tb_FM_PaymentRecord paymentRecord, tb_FM_Statement firstStatement);
```

## 3. 实施步骤

1. 添加验证方法 `ValidateStatements`
2. 添加初始化方法 `InitializePaymentRecord`
3. 添加明细转换方法 `ConvertStatementDetails`
4. 添加汇总计算方法 `RecalculateSummaryFields`
5. 添加重复验证方法 `ValidateNoDuplicates`
6. 添加单号生成方法 `GeneratePaymentNo`
7. 重构 `BuildPaymentRecord` 方法调用上述私有方法
8. 更新调用方代码使用优化后的方法

## 4. 注意事项

- 保持方法签名不变
- 保留原有的业务逻辑
- 确保验证逻辑与 `StatementToPaymentRecordConverter.ValidateConversionAsync` 保持一致
- 保持错误处理方式不变
- 不改变现有业务逻辑的正确性和完整性