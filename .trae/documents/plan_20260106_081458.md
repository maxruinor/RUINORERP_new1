# 单据转换逻辑统一方案

## 1. 目标
统一两种单据转换方式，确保都使用经过长期验证的 `BuildPaymentRecord` 方法作为核心逻辑。

## 2. 实施方案

### 2.1 修改 StatementToPaymentRecordConverter

**修改文件**：`RUINORERP.Business\Document\Converters\StatementToPaymentRecordConverter.cs`

**修改内容**：
1. 注入 `ITb_FM_PaymentRecordController<tb_FM_PaymentRecord>` 依赖
2. 在 `PerformConversionAsync` 方法中直接调用 `BuildPaymentRecord` 方法
3. 简化或移除重复的转换逻辑

### 2.2 代码示例

```csharp
public class StatementToPaymentRecordConverter : DocumentConverterBase<tb_FM_Statement, tb_FM_PaymentRecord>
{
    private readonly ITb_FM_PaymentRecordController<tb_FM_PaymentRecord> _paymentController;
    
    // 修改 PerformConversionAsync 方法
    protected override async Task PerformConversionAsync(tb_FM_Statement source, tb_FM_PaymentRecord target)
    {
        // 直接调用经过验证的 BuildPaymentRecord 方法
        var paymentRecord = await _paymentController.BuildPaymentRecord(new List<tb_FM_Statement> { source });
        
        // 将结果映射到 target
        mapper.Map(paymentRecord, target);
    }
}
```

### 2.3 保留的功能

1. **验证逻辑**：保留 `ValidateConversionAsync` 方法，用于验证对账单是否符合转换条件
2. **错误处理**：保持原有的异常处理方式
3. **日志记录**：保留原有的日志记录

### 2.4 实施步骤

1. 修改 `StatementToPaymentRecordConverter` 构造函数，添加 `ITb_FM_PaymentRecordController<tb_FM_PaymentRecord>` 依赖
2. 修改 `PerformConversionAsync` 方法，直接调用 `BuildPaymentRecord`
3. 简化 `ConvertDetailsAsync`、`RecalculateSummaryFields`、`ValidateDuplicateDetails` 等方法（如果不再需要）
4. 保留 `ValidateConversionAsync` 方法用于验证

### 2.5 预期效果

- 两种转换方式使用相同的底层逻辑
- 减少重复代码，提高可维护性
- 保持转换结果的准确性和一致性
- 保留两种UI操作方式的用户体验