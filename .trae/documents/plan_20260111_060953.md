# 端口占用检测改进方案

## 问题分析
当前`NetworkServer.cs`的`GetPortProcessInfo`方法只能通过`netstat`命令获取端口占用信息，但无法直接获取占用进程的名称和路径，导致错误报告显示"无法获取进程信息"，不够直观。

## 改进方案
1. **改进GetPortProcessInfo方法**：解析netstat输出获取PID，然后通过Process.GetProcessById获取进程详细信息
2. **添加进程路径获取**：使用WMI或其他方式获取进程的完整路径
3. **增强错误报告**：将进程名称和路径整合到端口占用报告中

## 实现步骤

### 1. 改进GetPortProcessInfo方法
```csharp
private string GetPortProcessInfo(int port)
{
    try
    {
        var processInfo = new System.Text.StringBuilder();
        var pids = new List<int>();
        
        // 使用netstat命令获取端口占用信息，包括PID
        var startInfo = new ProcessStartInfo
        {
            FileName = "netstat",
            Arguments = $"-ano | findstr :{port}",
            UseShellExecute = false,
            RedirectStandardOutput = true,
            CreateNoWindow = true
        };
        
        using (var process = Process.Start(startInfo))
        {
            if (process != null)
            {
                var output = process.StandardOutput.ReadToEnd();
                process.WaitForExit();
                
                if (!string.IsNullOrEmpty(output))
                {
                    var lines = output.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
                    foreach (var line in lines)
                    {
                        if (line.Contains($":{port}"))
                        {
                            processInfo.AppendLine($"   {line.Trim()}");
                            
                            // 解析PID
                            var parts = line.Split(new[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);
                            if (parts.Length > 4 && int.TryParse(parts[parts.Length - 1], out int pid))
                            {
                                pids.Add(pid);
                            }
                        }
                    }
                }
            }
        }
        
        // 获取每个PID对应的进程信息
        if (pids.Count > 0)
        {
            processInfo.AppendLine();
            processInfo.AppendLine("进程详细信息：");
            
            foreach (var pid in pids.Distinct())
            {
                try
                {
                    var proc = Process.GetProcessById(pid);
                    processInfo.AppendLine($"   PID: {pid}, 名称: {proc.ProcessName}");
                    
                    // 获取进程路径
                    string processPath = GetProcessPath(pid);
                    if (!string.IsNullOrEmpty(processPath))
                    {
                        processInfo.AppendLine($"   路径: {processPath}");
                    }
                }
                catch (ArgumentException)
                {
                    processInfo.AppendLine($"   PID: {pid}, 无法获取进程信息（进程已结束）");
                }
                catch (Exception ex)
                {
                    processInfo.AppendLine($"   PID: {pid}, 获取进程信息失败: {ex.Message}");
                }
            }
        }
        
        return processInfo.Length > 0 ? processInfo.ToString() : "无法获取进程信息";
    }
    catch (Exception ex)
    {
        return $"获取进程信息失败: {ex.Message}";
    }
}
```

### 2. 添加GetProcessPath方法
```csharp
private string GetProcessPath(int pid)
{
    try
    {
        // 使用WMI获取进程路径
        var searcher = new System.Management.ManagementObjectSearcher(
            $"SELECT ExecutablePath FROM Win32_Process WHERE ProcessId = {pid}");
        
        foreach (var obj in searcher.Get())
        {
            return obj["ExecutablePath"]?.ToString();
        }
        
        // 备选方案：使用Process.MainModule
        var process = Process.GetProcessById(pid);
        return process.MainModule?.FileName;
    }
    catch (Exception)
    {
        return string.Empty;
    }
}
```

### 3. 确保项目引用System.Management
需要在项目中添加对System.Management.dll的引用，以便使用WMI功能。

## 预期效果
改进后，当端口被占用时，错误报告将显示：
```
检测结果：端口 3009 已被其他进程占用！

占用进程信息：
   TCP    0.0.0.0:3009           0.0.0.0:0              LISTENING       12345

进程详细信息：
   PID: 12345, 名称: RUINORERP.Server
   路径: E:\CodeRepository\SynologyDrive\RUINORERP\RUINORERP.Server\bin\Release\RUINORERP.Server.exe

解决方案：
1. 查看端口占用情况：
   netstat -ano | findstr :3009

2. 查看占用进程详情：
   for /f "tokens=5" %a in ('netstat -ano ^| findstr :3009') do tasklist | findstr %a

3. 终止占用进程（谨慎操作）：
   taskkill /PID 12345 /F
```

## 代码优化点
1. 使用异步方法避免阻塞主线程
2. 添加异常处理，确保在各种环境下都能正常工作
3. 兼容不同Windows版本的netstat输出格式
4. 优化错误信息的可读性