# 心跳机制优化计划

## 一、问题分析

### 1. 心跳启动时机问题
- **当前情况**：客户端连接到服务器后立即启动心跳
- **问题**：未登录用户也会发送心跳，浪费服务器资源
- **建议**：心跳应该在登录成功后才开始，只对合法用户启用心跳机制

### 2. 系统锁定逻辑问题
- **当前情况**：系统设计了基于Windows空闲时间的锁定功能
- **问题**：增加了系统复杂度，导致心跳、登录、锁定状态管理混乱
- **建议**：移除系统锁定相关的逻辑，简化状态管理

## 二、优化方案

### 1. 心跳启动时机优化

#### 1.1 客户端修改
- **文件**：`RUINORERP.UI\Network\ClientCommunicationService.cs`
- **修改点**：
  - 移除连接成功后自动启动心跳的逻辑
  - 在登录成功后手动启动心跳
  - 在登出时停止心跳

#### 1.2 服务器端修改
- **文件**：`RUINORERP.Server\Network\CommandHandlers\HeartbeatCommandHandler.cs`
- **修改点**：
  - 增强用户身份验证，确保只有登录用户的心跳才被处理
  - 对未登录用户的心跳请求返回明确的错误响应

### 2. 移除系统锁定逻辑

#### 2.1 客户端修改
- **文件**：`RUINORERP.UI\Network\ClientCommunicationService.cs`
- **修改点**：
  - 移除所有与系统锁定相关的代码
  - 简化心跳发送逻辑，移除锁定状态检查
  - 简化心跳状态管理，移除锁定相关的状态处理

- **文件**：`RUINORERP.UI\Network\ClientEventManager.cs`
- **修改点**：
  - 移除与系统锁定相关的事件处理

#### 2.2 服务器端修改
- **文件**：`RUINORERP.Server\Network\CommandHandlers\HeartbeatCommandHandler.cs`
- **修改点**：
  - 移除与系统锁定相关的响应逻辑

## 三、实施步骤

### 1. 第一步：修改客户端心跳启动逻辑
- 移除 `OnConnectionStateChangedForHeartbeat` 方法中自动启动心跳的代码
- 在登录成功的回调中添加启动心跳的代码
- 在登出方法中添加停止心跳的代码

### 2. 第二步：简化客户端心跳发送逻辑
- 移除 `HeartbeatLoopAsync` 方法中与系统锁定相关的检查
- 移除 `SendHeartbeatAsync` 方法中与系统锁定相关的检查
- 简化 `UpdateHeartbeatState` 方法，移除锁定相关的状态处理

### 3. 第三步：增强服务器端心跳验证
- 确保只有登录用户的心跳才被正常处理
- 对未登录用户的心跳请求返回明确的错误响应

### 4. 第四步：清理锁定相关代码
- 移除所有与系统锁定相关的事件和处理逻辑
- 简化状态管理，只保留核心的连接和心跳状态

## 四、预期效果

1. **资源优化**：只有登录用户才会发送心跳，减少服务器资源消耗
2. **状态简化**：移除了复杂的锁定状态管理，简化了系统架构
3. **逻辑清晰**：心跳机制与登录状态紧密关联，逻辑更加合理
4. **易于维护**：减少了代码复杂度，提高了系统的可维护性

## 五、风险评估

1. **低风险**：所有修改均为局部调整，不影响核心业务逻辑
2. **兼容性**：修改后的代码与现有客户端和服务器完全兼容
3. **性能影响**：减少了不必要的心跳发送，服务器性能将有所提升
4. **可维护性**：简化后的代码更易于理解和维护

通过以上优化，预计能够解决当前心跳机制中存在的问题，使心跳逻辑更加合理和高效。