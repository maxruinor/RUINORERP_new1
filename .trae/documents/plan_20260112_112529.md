# 心跳请求数据优化方案

## 问题分析

当前心跳机制存在的问题：
1. 客户端发送的心跳请求包含了完整的`UserInfo`对象，该对象包含大量数据库实体信息
2. 心跳请求数据量过大，导致网络传输延迟和服务器处理压力
3. 服务器端只需要少量字段来验证心跳，不需要完整的用户信息

## 优化方案

### 1. 简化客户端心跳发送逻辑

**修改文件：** `RUINORERP.UI\Network\ClientCommunicationService.cs`

**修改点：**
- 修改`SendHeartbeatAsync`方法，不再发送完整的`UserInfo`对象
- 只发送必要的字段：Session ID、User ID、客户端时间戳
- 移除不必要的字段：资源使用情况、系统信息等

**具体修改：**
```csharp
// 优化前
heartbeatRequest.UserInfo = MainForm.Instance.AppContext.CurUserInfo;

// 优化后
heartbeatRequest.UserId = MainForm.Instance.AppContext.CurUserInfo.UserID;
heartbeatRequest.ClientId = _socketClient.ClientID;
heartbeatRequest.ClientTime = DateTime.Now;
heartbeatRequest.ClientStatus = "Normal";
```

### 2. 优化HeartbeatCommandHandler处理逻辑

**修改文件：** `RUINORERP.Server\Network\CommandHandlers\HeartbeatCommandHandler.cs`

**修改点：**
- 简化心跳处理逻辑，只使用必要的字段
- 不再保存完整的UserInfo到会话
- 只使用User ID进行会话验证

**具体修改：**
```csharp
// 优化前
sessionInfo = SessionService.GetSession(heartbeatRequest.UserInfo.UserID);
sessionInfo.UserInfo = heartbeatRequest.UserInfo;

// 优化后
sessionInfo = SessionService.GetSession(heartbeatRequest.UserId);
// 不再保存完整的UserInfo，只使用User ID进行验证
```

### 3. 简化HeartbeatRequest类（可选）

**修改文件：** `RUINORERP.PacketSpec\Models\Requests\HeartbeatRequest.cs`

**修改点：**
- 移除不必要的属性
- 保留核心字段：SessionToken、UserId、ClientTime、ClientStatus、ClientId

## 预期优化效果

1. **减少网络流量：** 心跳请求数据量将大幅减少，降低网络传输延迟
2. **降低服务器压力：** 服务器不需要处理和保存大量不必要的数据
3. **提高心跳可靠性：** 减少数据传输和处理时间，提高心跳成功率
4. **简化代码逻辑：** 减少不必要的字段处理，简化代码结构

## 实施步骤

1. 修改客户端发送心跳的逻辑，只发送必要字段
2. 修改服务器端心跳处理逻辑，只使用必要字段
3. 测试心跳功能是否正常
4. 监控网络流量和服务器性能变化

## 风险评估

- **低风险：** 优化只涉及心跳机制，不影响核心业务逻辑
- **兼容性：** 服务器端仍能处理旧版本客户端的心跳请求
- **回滚容易：** 如出现问题，可快速恢复到原始逻辑

所有修改都遵循最小化原则，只针对问题关键点进行必要修改，不引入新的功能变更或架构调整。