# 用户操作界面信息实体设计与心跳传输机制优化方案

## 问题分析

当前服务器端在线用户管理界面存在的问题：
1. 用户操作界面信息与当前用户信息重合，导致数据显示混乱
2. 心跳数据中包含大量不必要的数据库实体信息
3. 服务器端无法准确获取用户操作界面的简要信息

## 解决方案

### 1. 创建新的实体类 `UserOperationInfo`

**目的**：专门用于传输用户操作界面的简要信息，与当前用户信息分离

**设计原则**：
- 只包含用户操作界面所需的简要信息
- 不包含完整的数据库实体信息
- 轻量级设计，适合在心跳中传输
- 能够被服务器端的用户管理系统使用

**实体结构**：
```csharp
namespace RUINORERP.Model.CommonModel
{
    /// <summary>
    /// 用户操作界面信息实体类
    /// 用于传输用户操作界面的简要信息，与当前用户信息分离
    /// </summary>
    [Serializable]
    public class UserOperationInfo
    {
        /// <summary>
        /// 当前模块
        /// </summary>
        public string CurrentModule { get; set; }

        /// <summary>
        /// 当前窗体
        /// </summary>
        public string CurrentForm { get; set; }

        /// <summary>
        /// 静止时间（秒）
        /// </summary>
        public long IdleTime { get; set; }

        /// <summary>
        /// 客户端版本
        /// </summary>
        public string ClientVersion { get; set; }

        /// <summary>
        /// 客户端IP
        /// </summary>
        public string ClientIp { get; set; }

        /// <summary>
        /// 操作系统
        /// </summary>
        public string OS { get; set; }

        /// <summary>
        /// 机器名
        /// </summary>
        public string MachineName { get; set; }

        /// <summary>
        /// CPU信息
        /// </summary>
        public string CpuInfo { get; set; }

        /// <summary>
        /// 内存大小
        /// </summary>
        public string MemorySize { get; set; }
    }
}
```

### 2. 调整 `HeartbeatRequest` 类

**修改**：添加 `UserOperationInfo` 属性，用于传输用户操作界面的简要信息

**具体修改**：
```csharp
// 在HeartbeatRequest类中添加新属性
/// <summary>
/// 用户操作界面信息
/// </summary>
public UserOperationInfo OperationInfo { get; set; }
```

### 3. 优化客户端心跳发送逻辑

**修改文件**：`RUINORERP.UI\Network\ClientCommunicationService.cs`

**修改点**：
- 在发送心跳时，创建并填充 `UserOperationInfo` 对象
- 只发送必要的操作界面信息，不发送完整的用户信息

**具体修改**：
```csharp
// 优化心跳请求：添加用户操作界面信息
heartbeatRequest.OperationInfo = new UserOperationInfo
{
    CurrentModule = MainForm.Instance.AppContext.CurUserInfo.当前模块,
    CurrentForm = MainForm.Instance.AppContext.CurUserInfo.当前窗体,
    IdleTime = MainForm.Instance.AppContext.CurUserInfo.静止时间,
    ClientVersion = MainForm.Instance.AppContext.CurUserInfo.客户端版本,
    ClientIp = MainForm.Instance.AppContext.CurUserInfo.客户端IP,
    OS = MainForm.Instance.AppContext.CurUserInfo.操作系统,
    MachineName = MainForm.Instance.AppContext.CurUserInfo.机器名,
    CpuInfo = MainForm.Instance.AppContext.CurUserInfo.CPU信息,
    MemorySize = MainForm.Instance.AppContext.CurUserInfo.内存大小
};
```

### 4. 优化服务器端心跳处理逻辑

**修改文件**：`RUINORERP.Server\Network\CommandHandlers\HeartbeatCommandHandler.cs`

**修改点**：
- 接收并处理 `UserOperationInfo` 对象
- 将操作界面信息保存到会话中，供用户管理系统使用
- 不保存完整的用户信息，只保存必要的操作界面信息

**具体修改**：
```csharp
// 处理用户操作界面信息
if (heartbeatRequest.OperationInfo != null)
{
    sessionInfo.OperationInfo = heartbeatRequest.OperationInfo;
}
```

### 5. 调整会话信息类 `SessionInfo`

**修改**：添加 `OperationInfo` 属性，用于保存用户操作界面信息

**具体修改**：
```csharp
// 在SessionInfo类中添加新属性
/// <summary>
/// 用户操作界面信息
/// </summary>
public UserOperationInfo OperationInfo { get; set; }
```

### 6. 优化服务器端用户管理界面

**修改文件**：`RUINORERP.Server\Controls\UserManagementControl.cs`

**修改点**：
- 使用 `OperationInfo` 对象获取用户操作界面信息
- 与当前用户信息分离，准确显示

**具体修改**：
```csharp
// 从OperationInfo获取操作界面信息
item.SubItems.Add(GetDisplayName(sessionInfo.OperationInfo?.CurrentModule)); // 当前模块
item.SubItems.Add(GetDisplayName(sessionInfo.OperationInfo?.CurrentForm)); // 当前窗体
item.SubItems.Add(FormatIdleTime(TimeSpan.FromSeconds(sessionInfo.OperationInfo?.IdleTime ?? 0))); // 静止时间
item.SubItems.Add(GetDisplayName(sessionInfo.OperationInfo?.ClientVersion)); // 客户端版本
item.SubItems.Add(GetDisplayName(sessionInfo.OperationInfo?.OS)); // 操作系统
item.SubItems.Add(GetDisplayName(sessionInfo.OperationInfo?.MachineName)); // 机器名
item.SubItems.Add(GetDisplayName(sessionInfo.OperationInfo?.CpuInfo)); // CPU信息
item.SubItems.Add(GetDisplayName(sessionInfo.OperationInfo?.MemorySize)); // 内存大小
```

## 预期效果

1. **数据分离**：用户操作界面信息与当前用户信息正确分离
2. **准确显示**：服务器端在线用户管理界面准确显示用户操作界面信息
3. **轻量级传输**：心跳数据中只包含必要的操作界面信息，减少网络流量
4. **专门应用**：服务器响应数据专门应用于服务器端的用户管理系统
5. **易于维护**：代码结构清晰，易于维护和扩展

## 实施步骤

1. 创建新的实体类 `UserOperationInfo`
2. 调整 `HeartbeatRequest` 类，添加 `UserOperationInfo` 属性
3. 优化客户端心跳发送逻辑，添加 `UserOperationInfo` 对象
4. 优化服务器端心跳处理逻辑，处理 `UserOperationInfo` 对象
5. 调整会话信息类 `SessionInfo`，添加 `OperationInfo` 属性
6. 优化服务器端用户管理界面，使用 `OperationInfo` 对象获取操作界面信息

## 风险评估

- **低风险**：修改只涉及数据传输和显示，不影响核心业务逻辑
- **兼容性**：支持向后兼容，旧版本客户端仍可正常工作
- **回滚容易**：如出现问题，可快速恢复到原始逻辑

所有修改均遵循最小化原则，只针对问题关键点进行必要修改，不引入新的功能变更或架构调整，确保了修改的安全性和可靠性。