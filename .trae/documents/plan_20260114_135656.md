# 问题分析

1. **问题现象**：在已缓存正确服务器IP、用户名、密码和端口的情况下，登录流程中仍执行断开连接再重新连接的操作。

2. **根本原因**：

   * 登录流程中存在重复连接逻辑，没有充分利用ConnectionManager的连接复用机制

   * FrmLogin.cs的btnok\_Click方法中，IP地址变更检测逻辑存在问题

   * 连接状态判断不够精确，导致不必要的连接断开

3. **代码问题定位**：

   * `FrmLogin.cs:476-508`：IP和端口变更检测逻辑存在问题

   * `FrmLogin.cs:1042-1056`：登录流程中没有充分利用现有连接

# 修复方案

1. **优化IP和端口变更检测逻辑**：

   * 修改`FrmLogin.cs`中的IP和端口变更检测，确保只在确实需要时才断开连接

   * 利用ConnectionManager的CurrentServerAddress和CurrentServerPort属性进行更精确的判断

2. **改进连接状态判断**：

   * 在登录流程中，充分利用ConnectionManager的IsConnected属性

   * 只有在连接确实无效或服务器信息变更时才重新连接

3. **避免重复连接**：

   * 优化`ExecuteNewLoginFlow`方法中的连接逻辑

   * 确保只在必要时调用ConnectAsync方法

# 修复具体步骤

1. **修改FrmLogin.cs中的IP和端口变更检测**：

   * 优化`btnok_Click`方法中的ipOrPortChanged判断逻辑

   * 确保只有当服务器信息确实变更时才断开现有连接

2. **改进ExecuteNewLoginFlow方法**：

   * 移除不必要的连接逻辑

   * 利用ConnectionManager的IsConnected属性和服务器信息判断

3. **验证修复**：

   * 确保修复后登录流程中不再出现无意义的"断开-连接"循环

   * 保持系统当前的正常运行状态

   * 确保MRP查询数据和默认策略加载功能正常

# 预期效果

1. 登录流程更加高效，避免不必要的连接断开和重新连接
2. 减少日志中的"主动断开连接"记录，只在确实需要时才断开连接
3. 提高系统的响应速度和稳定性
4. 保持现有功能和业务逻辑不变

