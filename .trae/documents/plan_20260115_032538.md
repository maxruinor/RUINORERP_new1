# 维修工单费用分摊逻辑优化

## 1. 问题分析

当前费用分摊逻辑使用了两个字段：
- `ExpenseAllocationMode`：费用承担模式（单一承担、多方分摊）
- `ExpenseBearerType`：费用承担方（客户、供应商、己方公司、混合分摊）

### 1.1 冗余分析
- 当 `ExpenseBearerType` 为 `客户`、`供应商` 或 `己方公司` 时，`ExpenseAllocationMode` 必然是 `单一承担`
- 当 `ExpenseBearerType` 为 `混合分摊` 时，`ExpenseAllocationMode` 必然是 `多方分摊`

因此，`ExpenseAllocationMode` 字段确实是冗余的，可以通过 `ExpenseBearerType` 直接判断费用分摊模式。

## 2. 优化方案

### 2.1 移除冗余判断
修改 `HandleExpenseAllocation` 方法，直接根据 `ExpenseBearerType` 判断费用分摊模式，移除对 `ExpenseAllocationMode` 的依赖。

### 2.2 简化逻辑分支
- 客户、供应商、己方公司：直接执行单一承担逻辑
- 混合分摊：执行多方分摊逻辑

### 2.3 更新相关代码
- 修改 `UCASRepairOrder.cs` 中的预览信息生成逻辑
- 修改 `tb_AS_RepairOrderControllerPartial.cs` 中的审核生成逻辑

## 3. 具体修改步骤

### 3.1 修改 `UCASRepairOrder.cs`
1. 更新 `ShowExpenseAllocationPreview` 方法，移除对 `ExpenseAllocationMode` 的判断
2. 直接根据 `ExpenseBearerType` 生成预览信息

### 3.2 修改 `tb_AS_RepairOrderControllerPartial.cs`
1. 更新 `HandleExpenseAllocation` 方法，移除对 `ExpenseAllocationMode` 的判断
2. 简化逻辑分支，直接根据 `ExpenseBearerType` 执行对应逻辑

## 4. 预期效果

1. **代码简化**：减少冗余字段和判断逻辑
2. **逻辑清晰**：直接根据费用承担方判断分摊模式
3. **维护方便**：减少字段间的依赖关系
4. **用户体验**：保持原有功能不变，用户操作无感知

## 5. 风险评估

- **低风险**：修改仅涉及逻辑判断，不影响数据结构
- **向后兼容**：原有数据仍可正常使用
- **易于回滚**：如出现问题，可快速恢复原有逻辑

## 6. 技术实现要点

### 6.1 代码修改范围
- `UCASRepairOrder.cs`：预览信息生成逻辑
- `tb_AS_RepairOrderControllerPartial.cs`：费用分摊处理逻辑

### 6.2 测试要点
- 测试所有四种费用承担方类型
- 确保预览信息正确
- 确保审核时单据生成正确
- 确保日志记录完整