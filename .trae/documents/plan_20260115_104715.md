# 帮助系统优化计划 - 改为F1触发模式

## 1. 系统分析与现状评估

### 1.1 当前实现
- 帮助系统目前使用鼠标悬停事件自动显示帮助提示
- 支持F1键触发帮助显示，但未关闭自动提示功能
- 缺少总帮助入口和焦点控件检测的优先级设置

### 1.2 用户需求
- 仅在用户按F1键时显示帮助
- 优先显示焦点光标捕捉到的字段或按钮的帮助
- 无指定帮助内容时显示总帮助
- 帮助面板中添加入口，可切换到总帮助

## 2. 实施计划

### 2.1 关闭自动智能提示

**任务**: 禁用鼠标悬停自动显示帮助功能

**步骤**:
1. 修改`HelpManager`类，将`EnableSmartTooltip`默认值设为`false`
2. 移除或注释掉`RegisterGlobalHelpEvents`中可能存在的自动提示注册
3. 确保`EnableSmartTooltipForControl`方法不会自动注册鼠标悬停事件

### 2.2 优化F1键触发机制

**任务**: 确保F1键能正确触发帮助显示

**步骤**:
1. 确保`FormHelpExtensions.Form_KeyDown`事件处理能正确捕获F1键
2. 优化`GetFocusedControl`方法，确保能准确获取当前焦点控件
3. 确保在没有焦点控件时显示总帮助

### 2.3 实现焦点优先的帮助显示

**任务**: 优先显示焦点控件的帮助内容

**步骤**:
1. 在`HelpManager.ShowHelp`方法中添加焦点控件检测
2. 当帮助上下文未指定控件时，自动获取当前焦点控件
3. 实现帮助内容优先级逻辑：焦点控件帮助 > 总帮助

### 2.4 添加总帮助入口

**任务**: 在帮助面板中添加切换到总帮助的入口

**步骤**:
1. 修改`HelpPanel`和`WebView2HelpPanel`，添加总帮助按钮
2. 实现总帮助内容的加载逻辑
3. 添加帮助类型切换机制

### 2.5 验证和测试

**任务**: 确保所有功能正常工作

**步骤**:
1. 测试F1键触发帮助功能
2. 测试焦点控件帮助优先显示
3. 测试无焦点控件时显示总帮助
4. 测试总帮助入口功能

## 3. 代码修改点

### 3.1 `HelpManager.cs`
- 修改`EnableSmartTooltip`默认值为`false`
- 优化`ShowHelp`方法，添加焦点检测逻辑
- 确保帮助内容优先级正确

### 3.2 `HelpExtensions.cs`
- 确保`Control_KeyDown`和`Form_KeyDown`事件能正确处理F1键
- 优化`GetFocusedControl`方法，确保准确获取焦点控件

### 3.3 `HelpPanel.cs`和`WebView2HelpPanel.cs`
- 添加总帮助按钮
- 实现切换到总帮助的逻辑

### 3.4 `BaseBillEditGeneric.cs`或相关基类
- 确保所有单据录入界面都启用了F1帮助

## 4. 预期效果

1. **F1触发**: 只有用户按F1键时才显示帮助
2. **焦点优先**: 优先显示当前焦点控件的帮助内容
3. **降级机制**: 无焦点或无指定帮助时显示总帮助
4. **总帮助入口**: 帮助面板中可切换到总帮助
5. **用户控制**: 用户完全控制帮助的显示时机

## 5. 实施时间

**预计总工时**: 3-4小时

**阶段时间分配**:
- 关闭自动智能提示: 0.5小时
- 优化F1键触发机制: 1小时
- 实现焦点优先的帮助显示: 1小时
- 添加总帮助入口: 0.5小时
- 验证和测试: 1小时

## 6. 风险评估

1. **焦点检测不准确**: 可能存在某些控件无法被正确检测为焦点的情况
2. **兼容性问题**: 修改可能影响现有帮助功能的正常使用
3. **性能影响**: 频繁的焦点检测可能对性能产生影响

## 7. 后续维护

1. 定期检查帮助系统的使用情况
2. 根据用户反馈调整帮助显示逻辑
3. 确保新添加的控件都能正确触发帮助
4. 定期更新总帮助内容