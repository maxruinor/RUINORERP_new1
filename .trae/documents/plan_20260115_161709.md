# 服务器端日志无法写入数据库问题修复计划

## 问题分析

通过分析代码和表结构，发现服务器端日志无法写入数据库的可能原因：

1. **User_ID参数类型不匹配**：
   - 数据库中User_ID是bigint类型
   - 代码中使用字符串类型设置User_ID属性
   - AddParameter方法中配置的是Int64类型，但使用了EnhancedCustomLayout

2. **EnhancedCustomLayout使用不当**：
   - 对于标准参数（如@log_date、@log_level、@logger）应使用PatternLayout
   - 只有自定义属性才需要使用EnhancedCustomLayout
   - EnhancedCustomLayout可能无法正确处理Int64类型参数

3. **CreateLoggerRepository方法未使用xmlElement参数**：
   - 构造函数接收了xmlElement参数但未使用
   - 直接创建新的AdoNetAppender，忽略了配置文件中的重要信息

4. **参数大小配置与数据库表不匹配**：
   - 代码中配置的参数大小与数据库表定义不一致
   - 例如ModName在代码中是50，数据库中是200

## 修复计划

### 1. 修复User_ID参数类型处理
- **修改文件**：`RUINORERP.Common\Log4Net\Log4NetLoggerByDb.cs`
- **实现内容**：
  - 直接将User_ID作为long类型设置到ThreadContext.Properties
  - 移除ToString()转换，保持原始类型
  - 确保类型匹配数据库bigint类型

### 2. 优化参数布局配置
- **修改文件**：`RUINORERP.Common\Log4Net\Log4NetLoggerByDb.cs`
- **实现内容**：
  - 对于标准参数（@log_date、@log_level、@logger）使用PatternLayout
  - 对于自定义属性参数使用EnhancedCustomLayout
  - 确保参数大小配置与数据库表定义一致

### 3. 完善AddParameter方法
- **修改文件**：`RUINORERP.Common\Log4Net\Log4NetLoggerByDb.cs`
- **实现内容**：
  - 添加日志输出，便于调试
  - 确保参数配置正确
  - 添加错误处理

### 4. 确保AdoNetAppender正确配置
- **修改文件**：`RUINORERP.Common\Log4Net\Log4NetLoggerByDb.cs`
- **实现内容**：
  - 检查ConnectionString是否正确
  - 确保CommandText中的参数顺序与数据库表匹配
  - 验证参数类型与数据库表类型一致

## 预期效果

1. 服务器端日志能够正确写入数据库
2. 日志属性正确映射到数据库字段
3. 类型匹配，避免转换错误
4. 配置更灵活，支持从配置文件读取配置
5. 代码更健壮，包含适当的错误处理

## 实施顺序

1. 首先修复参数类型不匹配问题
2. 然后优化参数布局配置
3. 完善AddParameter方法
4. 确保AdoNetAppender正确配置
5. 测试日志写入功能

通过以上修复，应该能够解决服务器端日志无法写入数据库的问题，同时保持客户端日志正常写入。