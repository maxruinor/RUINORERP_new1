# 产品多属性排列组合功能优化方案

## 问题分析
当前系统在处理产品多属性组合时，相同属性组合的不同排序（如"黑色+中文"与"中文+黑色"）被识别为不同组合，导致组合计算错误。这是因为：
1. 新组合生成时按属性组添加顺序排序
2. 现有组合从TreeGrid读取时顺序可能不同
3. 组合比较器按列表顺序逐元素比较

## 优化方案
### 核心思路
为所有属性组合实现统一的属性排序规则，确保相同属性组合的元素顺序一致。

### 实现步骤

#### 1. 设计统一排序规则
采用**属性ID（Property_ID）排序**，这是最可靠的唯一标识符，确保排序一致性。

#### 2. 在组合生成过程中应用排序
修改`GenerateAttributeCombinations`方法，在创建每个新组合后对其属性列表进行排序：
```csharp
// 在添加新属性后排序
newCombination.Properties.Add(new AttributeValuePair {...});
newCombination.Properties = newCombination.Properties
    .OrderBy(p => p.Property != null ? p.Property.Property_ID : long.MinValue)
    .ToList();
```

#### 3. 在现有组合读取时应用排序
修改`GetExistingAttributeCombinations`方法，在构建每个现有组合后对其属性列表进行排序：
```csharp
// 在添加所有属性后排序
combination.Properties = combination.Properties
    .OrderBy(p => p.Property != null ? p.Property.Property_ID : long.MinValue)
    .ToList();
```

#### 4. 确保排序机制一致性
- 使用`long.MinValue`处理空属性，避免空引用异常
- 排序逻辑统一应用于所有组合生成和读取场景

### 预期效果
- 相同属性组合无论顺序如何，都会被识别为同一组合
- `existingCombinations`与`newCombinations`中的组合具有一致排序
- 组合比较器能正确识别等效组合
- 待添加和待删除组合列表计算准确

### 代码修改点
1. `UCMultiPropertyEditor.cs`的`GenerateAttributeCombinations`方法（约第690行）
2. `UCMultiPropertyEditor.cs`的`GetExistingAttributeCombinations`方法（约第730行）

### 测试场景
- 测试"颜色+语言"不同顺序的属性组合
- 测试单属性添加到多属性的场景
- 测试现有组合修改场景
- 验证组合差异计算准确性

## 优势
- 最小化代码改动，仅在两个关键方法中添加排序逻辑
- 利用现有属性ID确保排序唯一性
- 不影响原有功能的正确性和性能
- 解决了组合识别不准确的核心问题