# 消息处理链路优化方案

## 1. 核心问题分析
- 消息内容生成逻辑简单，缺乏业务上下文
- 多个地方存在重复的消息处理代码
- 消息内容在不同环节被重复处理
- 消息标题和内容不够具体，用户体验差

## 2. 优化目标
- 实现消息数据体在构建初期即完成提示内容处理
- 统一消息生成和发送逻辑，减少重复代码
- 确保消息内容的准确性、完整性和及时性
- 优化消息处理链路的性能和可维护性

## 3. 具体优化措施

### 3.1 增强消息数据构建方法
**修改文件**：`RUINORERP.PacketSpec\Models\Message\MessageData.cs`
- 增强 `CreateTodoUpdateMessage` 方法，使其能够智能生成更详细的消息内容
- 根据 `TodoUpdateType` 和 `BusinessStatusValue` 生成具体的操作描述
- 利用 `BillNo` 和 `BusinessType` 生成更具体的消息标题
- 确保消息内容包含关键业务信息：单据编号、操作人、操作时间等

### 3.2 统一消息发送逻辑
**修改文件**：`RUINORERP.UI\BaseForm\BaseBillEditGeneric.cs` 和 `BaseBillQueryMC.cs`
- 提取公共消息发送方法，避免重复代码
- 确保消息发送逻辑的一致性
- 增强日志记录，便于跟踪消息发送状态

### 3.3 优化消息服务
**修改文件**：`RUINORERP.UI\Network\Services\MessageService.cs`
- 增强 `SendTodoNotificationAsync` 方法，确保消息正确发送到消息中心
- 优化错误处理和日志记录
- 确保消息内容在发送前不再被修改

### 3.4 减少消息内容重复处理
**修改文件**：`RUINORERP.UI\IM\MessagePrompt.cs` 和 `MessageListControl.cs`
- 移除消息显示时的内容处理逻辑
- 直接使用消息数据中预先生成的标题和内容
- 确保消息内容在整个链路中保持一致

### 3.5 优化消息命令处理
**修改文件**：`RUINORERP.UI\Network\ClientCommandHandlers\TodoCommandHandler.cs`
- 确保命令处理器直接使用消息数据中的内容
- 避免在命令处理过程中修改消息内容
- 增强日志记录，便于跟踪消息处理状态

## 4. 优化效果
- 消息内容在构建初期即完成处理，避免后续重复处理
- 消息标题和内容更具体、更有用，提升用户体验
- 减少重复代码，提高代码可维护性
- 优化消息处理链路，提高性能
- 增强日志记录，便于问题排查和跟踪

## 5. 实施步骤
1. 首先增强 `MessageData.CreateTodoUpdateMessage` 方法
2. 然后优化消息服务和命令处理器
3. 接着统一消息发送逻辑
4. 最后减少消息内容的重复处理
5. 测试整个消息处理链路，确保功能正常

## 6. 注意事项
- 确保消息内容的准确性，避免误导用户
- 保持消息处理链路的兼容性，不破坏现有功能
- 优化过程中要充分测试，确保稳定性
- 增强日志记录，但要避免过度日志影响性能