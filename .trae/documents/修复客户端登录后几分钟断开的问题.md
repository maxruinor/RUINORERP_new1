# 问题分析
从日志和代码分析来看，客户端登录成功后过几分钟就被断开的主要原因是：
1. 心跳请求超时，触发异常
2. 但IsConnected属性可能仍然返回true，导致系统认为连接还在
3. 心跳失败后没有及时触发重连机制
4. 连接状态检测不准确，存在假连接状态

# 修复方案

## 1. 优化心跳超时处理
- 修改ClientCommunicationService.cs的SendHeartbeatAsync方法
- 在心跳超时后主动检查并更新连接状态
- 区分网络断开和心跳超时，避免误判

## 2. 增强连接状态同步
- 修改ClientCommunicationService.cs的HeartbeatLoopAsync方法
- 在心跳失败后立即触发重连尝试
- 确保连接状态与实际网络状态保持一致

## 3. 改进IsConnected属性检测
- 调整SuperSocketClient.cs的IsConnected属性
- 优化Socket.Poll检测逻辑，避免误判
- 增加更可靠的连接状态检测

## 4. 优化重连触发机制
- 修改ClientCommunicationService.cs的UpdateHeartbeatState方法
- 在心跳失败时立即触发重连，而不是等待下次心跳周期

## 5. 增强日志记录
- 在关键位置添加更详细的连接状态日志
- 记录心跳超时和连接状态变化的详细信息

# 修复文件
1. **RUINORERP.UI\Network\ClientCommunicationService.cs** - 优化心跳处理和重连机制
2. **RUINORERP.UI\Network\SuperSocketClient.cs** - 改进IsConnected属性检测

# 预期效果
- 减少假连接状态
- 心跳超时时及时更新连接状态
- 心跳失败后立即触发重连
- 提高连接稳定性
- 便于调试分析连接问题