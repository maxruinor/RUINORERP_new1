# 单据操作逻辑统一重构方案

## 问题分析

当前系统中存在以下问题：
1. **代码冗余**：单据录入界面和查询界面均包含相同的业务操作（提交、审核、反审、结案等），但实现代码重复
2. **逻辑分散**：相同功能在不同基类体系中独立实现，导致维护困难
3. **一致性风险**：不同界面的相同操作可能存在逻辑差异，影响系统稳定性

## 解决方案

### 1. 创建统一业务操作处理基类

**设计新基类 `BaseBillOperation`**，作为所有单据操作的统一入口：

- **核心功能**：
  - 统一实现提交、审核、反审、结案等业务操作
  - 提供通用的操作状态验证和处理逻辑
  - 集成状态管理和防重复操作机制

- **关键方法**：
  - `Task<bool> SubmitAsync(IEnumerable<BaseEntity> entities)`
  - `Task<ApprovalEntity> ReviewAsync(IEnumerable<BaseEntity> entities, string approvalComment = null)`
  - `Task<bool> ReReviewAsync(IEnumerable<BaseEntity> entities)`
  - `Task<bool> CloseCaseAsync(IEnumerable<BaseEntity> entities)`
  - `Task<bool> AntiCloseCaseAsync(IEnumerable<BaseEntity> entities)`

### 2. 调整现有基类体系

**修改 `BaseBillEdit`**：
- 继承自 `BaseBillOperation`
- 调整按钮事件处理，调用统一的业务操作方法

**修改 `BaseQuery`**：
- 继承自 `BaseBillOperation`
- 调整查询界面的操作按钮事件，调用统一的业务操作方法

### 3. 统一操作流程

**标准化操作流程**：
1. 操作权限检查
2. 操作状态验证
3. 业务逻辑执行
4. 状态更新和通知
5. UI状态同步

**批量操作支持**：
- 统一处理单行和批量操作的逻辑
- 提供批量操作的状态验证和结果反馈

### 4. 最小化代码修改

**实现策略**：
- 保持现有基类的接口和方法签名不变
- 通过继承和方法重写实现逻辑统一
- 确保现有子类无需修改即可使用新的统一逻辑
- 逐步迁移现有实现到统一基类

## 实施步骤

1. **创建 `BaseBillOperation` 基类**
   - 实现核心业务操作方法
   - 集成状态管理和防重复操作

2. **修改基类继承关系**
   - `BaseBillEdit` 继承自 `BaseBillOperation`
   - `BaseQuery` 继承自 `BaseBillOperation`

3. **调整按钮事件处理**
   - 修改 `DoButtonClick` 方法，调用统一的业务操作
   - 确保批量操作和单行操作的一致性

4. **测试验证**
   - 验证录入界面操作功能
   - 验证查询界面操作功能
   - 验证批量操作功能
   - 验证状态更新和UI同步

## 预期成果

1. **消除代码冗余**：相同业务操作只需要维护一份代码
2. **统一业务逻辑**：录入和查询界面使用相同的操作逻辑
3. **简化维护**：业务规则变更只需修改统一基类
4. **提高一致性**：确保所有界面的操作行为一致
5. **最小化影响**：现有功能和子类无需修改

## 技术要点

- **面向对象设计**：利用继承和多态实现代码复用
- **异步编程**：统一使用异步方法处理业务操作
- **状态管理**：集成 `IUnifiedStateManager` 进行状态验证
- **防重复操作**：使用 `RepeatOperationGuardService` 防止重复提交
- **批量处理**：统一支持单行和批量操作模式