# 基本数据导入功能增强计划

## 1. 需求分析
- **现有功能**：固定模板数据导入，仅支持符合预期格式的数据
- **新增功能**：动态Excel文件导入，允许用户配置Excel列名与系统字段映射
- **UI要求**：在现有窗体中以Tab页形式添加，保持界面一致性
- **核心功能**：
  - 可配置的Excel列与系统字段映射
  - 直观的列匹配界面
  - 支持指定唯一序号/编号列
  - 与现有功能在同一窗体通过Tab页切换

## 2. 实现思路

### 2.1 UI设计
- 在现有`kryptonNavigator1`中添加新Tab页"动态导入"
- 动态导入Tab页包含：
  - 文件选择区域（浏览按钮、文件路径、解析按钮）
  - 列映射配置区域（双边列表或直接下拉选择）
  - 数据预览区域
  - 操作按钮（导入、重置、保存映射）

### 2.2 核心组件设计

#### 2.2.1 新增类
- **`DynamicExcelParser`**：解析Excel文件，提取列名和数据到DataTable
- **`ColumnMapping`**：列映射模型，包含Excel列名、系统字段名、是否为唯一标识
- **`ColumnMappingManager`**：管理列映射配置的保存与加载

#### 2.2.2 现有类扩展
- 复用现有`ExcelDataParser`的NPOI操作逻辑
- 复用现有`DataValidator`进行数据验证
- 复用现有`ProductImporter`进行数据导入

### 2.3 功能流程
1. **文件解析**：用户选择Excel文件，点击解析按钮，提取列名
2. **列映射配置**：
   - 显示Excel列列表和系统字段列表
   - 用户通过界面映射列关系
   - 用户指定唯一标识列
3. **数据预览**：显示映射后的数据，供用户确认
4. **数据导入**：验证并导入映射后的数据
5. **结果展示**：在现有结果页面展示导入结果

## 3. 实现步骤

### 3.1 设计UI界面
- 修改`UCBasicDataImport.Designer.cs`，添加新Tab页
- 设计动态导入UI布局，使用Krypton控件保持一致性

### 3.2 实现核心组件
- 创建`DynamicExcelParser.cs`：解析Excel文件为DataTable
- 创建`ColumnMapping.cs`：定义列映射模型
- 创建`ColumnMappingManager.cs`：管理映射配置

### 3.3 实现界面逻辑
- 修改`UCBasicDataImport.cs`，添加动态导入相关字段和方法
- 实现文件选择、解析、映射、预览、导入等事件处理
- 实现映射配置的保存与加载

### 3.4 集成导入流程
- 实现动态数据到ProductImportModel的转换
- 复用现有验证和导入逻辑
- 确保结果展示一致

## 4. 关键技术点

### 4.1 列映射界面
- 采用双边列表选择方式：左侧Excel列，右侧系统字段
- 支持双击映射/取消映射
- 支持通过下拉选择直接映射

### 4.2 映射配置管理
- 使用XML文件保存映射配置
- 支持按文件名或模板名保存/加载
- 提供默认映射模板

### 4.3 数据验证
- 验证必填字段是否已映射
- 验证唯一标识列是否唯一
- 验证数据类型兼容性

### 4.4 性能考虑
- 支持大数据量Excel文件解析
- 实现数据预览分页
- 使用异步操作提高UI响应性

## 5. 预期效果
- 保持现有固定模板导入功能不变
- 新增动态导入Tab页，支持自定义Excel列映射
- 提供直观易用的列映射配置界面
- 支持保存和加载映射配置
- 与现有功能保持一致的操作流程和结果展示

## 6. 参考文件
- `e:\CodeRepository\SynologyDrive\RUINORERP\RUINORERP.Plugin.OfficeAssistant\MainForm.cs`：Excel文件处理思路
- `e:\CodeRepository\SynologyDrive\RUINORERP\RUINORERP.UI\DevTools\frmDbColumnToExlColumnConfig.cs`：列映射界面设计
- `e:\CodeRepository\SynologyDrive\RUINORERP\RUINORERP.UI\DevTools\UCDataImportTool.cs`：数据导入实现思路

## 7. 代码修改范围
- `UCBasicDataImport.cs`：添加动态导入逻辑
- `UCBasicDataImport.Designer.cs`：添加新Tab页和UI控件
- 新增文件：
  - `DynamicExcelParser.cs`
  - `ColumnMapping.cs`
  - `ColumnMappingManager.cs`

## 8. 测试要点
- 不同结构的Excel文件导入
- 各种列映射场景
- 大数据量Excel文件处理
- 映射配置的保存与加载
- 与现有功能的切换和兼容性

通过以上实现，将在现有基本数据导入功能基础上，增强动态Excel文件导入能力，满足用户对不同格式Excel数据的导入需求，同时保持界面一致性和操作流畅性。