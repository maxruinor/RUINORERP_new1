# 完善价格调整单反审核功能计划

## 现状分析
当前`AntiApprovalAsync`方法已实现基本的反审核逻辑，但缺少对采购入库单价格调整时的库存成本恢复处理，以及对已关联付款单/收款单的应收/应付款单的处理。

## 完善计划

### 1. 增强应收/应付款单状态检查
- 检查应收/应付款单是否已关联生成付款单或收款单
- 如果已关联，则不允许反审核，返回错误信息
- 如果未关联，则执行删除操作

### 2. 恢复采购入库单的库存成本
- 对于采购入库单的价格调整，需要查询调整前的库存成本
- 调用成本调整方法，将库存成本恢复至调整前的状态
- 递归更新所有上级BOM的成本，确保成本链的一致性

### 3. 完善事务管理
- 确保所有操作都在事务中执行，保证数据一致性
- 增加异常处理，确保事务能够正确回滚

### 4. 优化错误提示
- 提供更详细、更专业的错误提示信息
- 确保错误信息能够清晰反映反审核失败的原因

### 5. 代码风格与现有系统保持一致
- 遵循项目的代码规范和格式要求
- 参考类似业务模块（如销售订单）的反审核实现方式

## 实现步骤

1. 修改`AntiApprovalAsync`方法，增加对采购入库单库存成本的恢复逻辑
2. 增强应收/应付款单状态检查，处理已关联付款单/收款单的情况
3. 完善事务管理和错误处理
4. 优化错误提示信息
5. 测试反审核功能，确保其能够正确处理各种场景

## 预期结果
- 价格调整单反审核功能能够正确处理各种业务场景
- 反审核操作与审核操作完全反向，包括所有相关业务数据的恢复
- 代码风格与现有系统保持一致，确保可维护性
- 错误提示信息专业、清晰，便于用户理解