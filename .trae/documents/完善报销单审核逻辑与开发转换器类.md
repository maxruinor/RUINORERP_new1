# 完善报销单审核逻辑与开发转换器类

## 一、完善报销单控制器中的审核方法和反审核方法

### 1. 审核方法（ApprovalAsync）检查与优化
- 确认 `fmConfig.AutoAuditExpensePaymentRecord` 配置项的正确性，确保自动审核功能正常工作
- 检查事务处理逻辑，确保数据一致性
- 验证 `BuildPaymentRecord` 方法的调用是否正确
- 优化日志记录，提高可维护性

### 2. 反审核方法（AntiApprovalAsync）完善
- 确保反审核时能正确处理已生成的付款单
- 检查付款单状态判断逻辑，确保只有未支付的付款单才能被删除
- 优化错误提示信息，提高用户体验
- 确保事务处理逻辑正确，避免数据不一致

## 二、开发报销单转换为付款单的转换器类

### 1. 创建转换器类
- 新建 `ExpenseClaimToPaymentRecordConverter.cs` 文件，继承自 `DocumentConverterBase<tb_FM_ExpenseClaim, tb_FM_PaymentRecord>`
- 实现 `IDocumentConverter<tb_FM_ExpenseClaim, tb_FM_PaymentRecord>` 接口

### 2. 实现核心转换逻辑
- 在构造函数中注入必要依赖：日志记录器和付款单控制器
- 重写 `ConvertAsync` 方法，直接调用业务层的 `BuildPaymentRecord` 方法
- 重写 `ValidateConversionAsync` 方法，验证报销单状态是否符合转换条件
- 确保转换器遵循现有代码规范和架构设计

### 3. 集成到系统架构
- 确保转换器能被 `DocumentConverterFactory` 自动发现和注册
- 验证转换器能正确处理报销单到付款单的转换

## 三、实现步骤

1. 首先完善报销单控制器的审核和反审核方法
2. 然后创建报销单到付款单的转换器类
3. 测试转换器是否能被正确注册和调用
4. 验证整个流程的完整性和正确性

## 四、技术要点

- 使用事务保证数据一致性
- 遵循依赖注入原则
- 实现完整的逆向操作流程
- 遵循现有代码规范和架构设计
- 确保自动审核功能在审核和反审核中都能正确处理