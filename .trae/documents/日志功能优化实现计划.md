# 日志功能优化实现计划

## 问题一：日志等级动态控制功能实现

### 1. 线程安全机制实现
- **修改文件**：`RUINORERP.Server\frmMainNew.cs`
- **实现内容**：
  - 添加 `private static readonly object _logLevelLock = new object();` 用于线程同步
  - 修改 `_currentLogLevel` 变量的读写操作，使用 `lock` 块保护

### 2. 日志等级变更记录
- **修改文件**：`RUINORERP.Server\frmMainNew.cs`
- **实现内容**：
  - 在 `SetGlobalLogLevel` 方法中添加日志记录，记录等级变更历史
  - 确保日志记录在等级变更后执行

### 3. 等级有效性验证
- **修改文件**：`RUINORERP.Server\frmMainNew.cs`
- **实现内容**：
  - 在 `SetGlobalLogLevel` 方法中添加等级范围验证
  - 确保只接受有效的 `LogLevel` 枚举值
  - 添加非法值处理逻辑

### 4. 与 Startup.cs 日志过滤集成
- **修改文件**：`RUINORERP.Server\Startup.cs`
- **实现内容**：
  - 修改日志过滤委托，使其使用 `frmMainNew.GetGlobalLogLevel()` 获取当前日志级别
  - 移除硬编码的日志级别过滤，实现动态日志级别控制

## 问题二：日志记录类优化

### 1. Log 方法参数处理逻辑优化
- **修改文件**：`RUINORERP.Common\Log4Net\Log4NetLoggerByDb.cs`
- **实现内容**：
  - 优化 `formatter` 委托调用逻辑，处理委托为 null 的情况
  - 当 `formatter` 无法生成消息时，直接使用 `state.ToString()` 作为日志内容
  - 确保异常信息正确记录，即使没有格式化器

### 2. 代码质量优化
- **修改文件**：`RUINORERP.Common\Log4Net\Log4NetLoggerByDb.cs`
- **实现内容**：
  - 添加详细注释说明参数处理逻辑
  - 优化异常处理，提供更明确的错误提示
  - 确保方法重载设计合理，接口易用

### 3. Startup.cs 日志配置检查
- **修改文件**：`RUINORERP.Server\Startup.cs`
- **实现内容**：
  - 检查日志配置，确保兼容优化后的日志记录功能
  - 验证 `Log4NetProviderByCustomeDb` 配置正确
  - 确保日志过滤规则与动态日志级别集成正常

## 实现顺序
1. 首先实现日志记录类优化（问题二）
2. 然后实现日志等级动态控制功能（问题一）
3. 最后测试两个功能的集成效果

## 预期效果
1. **动态日志级别控制**：
   - 支持通过 UI 实时调整日志级别
   - 调整后立即生效，无需重启服务器
   - 线程安全，防止并发问题
   - 记录等级变更历史

2. **优化后的日志记录**：
   - 支持直接传入字符串作为日志内容
   - 保持对异常对象的兼容
   - 提供明确的错误提示
   - 代码质量提高，易于维护

## 测试要点
1. 测试不同日志级别的切换效果
2. 测试只传入字符串时的日志记录
3. 测试同时传入字符串和异常时的日志记录
4. 测试并发环境下的日志级别变更
5. 测试日志级别变更的历史记录