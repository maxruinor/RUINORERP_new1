# 系统消息语音提醒功能实现计划

## 一、现状分析

### 1. TaskVoiceReminder.cs

* ✅ 已将命名空间修改为RUINORERP.UI.Common

* 已实现基本的语音提醒功能，使用System.Speech.Synthesis

* 包含消息队列管理，支持异步播放

* 但需增强以支持多种消息类型和配置选项

### 2. MessageListControl.cs

* 已实现消息列表显示和管理功能

* 包含消息通知机制（气泡通知、声音提示）

* 但声音提示仅使用系统默认声音，未集成语音合成

### 3. EnhancedMessageManager.cs

* 已实现消息接收、存储、处理的完整流程

* 包含多种消息类型的处理逻辑

* 但未集成语音提醒功能

## 二、实现方案

### 1. 增强 TaskVoiceReminder.cs

* **添加配置属性**：

  * IsEnabled：控制语音提醒开关（默认：true）

  * Volume：音量调节（0-100，默认：100）

  * Rate：语速调节（-10到10，默认：0）

  * VoiceGender：语音性别选择（默认：Female）

* **添加消息类型支持**：扩展AddRemindMessage方法，支持直接接收MessageData对象

* **优化消息队列**：添加消息去重机制，避免短时间内重复播放相同消息

### 2. 优化 EnhancedMessageManager.cs

* **集成语音提醒服务**：在构造函数中初始化TaskVoiceReminder实例

* **消息路由增强**：在所有消息处理方法中添加语音提醒触发

  * OnPopupMessageReceived

  * OnBusinessMessageReceived

  * OnDepartmentMessageReceived

  * OnBroadcastMessageReceived

  * OnSystemNotificationReceived

### 3. 完善 MessageListControl.cs

* **添加语音提醒触发**：在消息接收和状态变更时触发语音提醒

* **添加右键菜单选项**：允许用户手动触发语音提醒

## 三、具体实现步骤

### 步骤1：增强 TaskVoiceReminder.cs

1. 添加配置属性
2. 添加消息去重机制
3. 添加支持MessageData对象的重载方法
4. 添加日志记录

### 步骤2：优化 EnhancedMessageManager.cs

1. 在构造函数中初始化TaskVoiceReminder实例
2. 在所有消息处理方法中添加语音提醒调用
3. 实现消息类型到语音文本的转换逻辑

### 步骤3：完善 MessageListControl.cs

1. 在消息状态变更事件中添加语音提醒触发
2. 在右键菜单中添加"播放语音提醒"选项

## 四、关键代码实现

### 1. TaskVoiceReminder.cs 增强

```csharp
// 添加配置属性
public bool IsEnabled { get; set; } = true;
public int Volume { get; set; } = 100;
public int Rate { get; set; } = 0;
public VoiceGender VoiceGender { get; set; } = VoiceGender.Female;

// 添加消息去重机制
private readonly HashSet<string> _recentMessages = new HashSet<string>();
private readonly Timer _recentMessagesCleanupTimer;

// 添加支持MessageData的方法
public void AddRemindMessage(MessageData messageData)
{
    if (messageData == null) return;
    
    string voiceText = GenerateVoiceText(messageData);
    AddRemindMessage(voiceText);
}
```

### 2. EnhancedMessageManager.cs 集成

```csharp
// 添加语音提醒服务
private readonly TaskVoiceReminder _voiceReminder;

// 在构造函数中初始化
_voiceReminder = new TaskVoiceReminder();

// 在消息处理方法中添加
_voiceReminder.AddRemindMessage(messageData);
```

### 3. MessageListControl.cs 完善

```csharp
// 在消息状态变更事件中添加
_voiceReminder.AddRemindMessage(message);

// 添加右键菜单选项
menuPlayVoiceReminder = new ToolStripMenuItem("播放语音提醒");
menuPlayVoiceReminder.Click += MenuPlayVoiceReminder_Click;
contextMenuStripMessages.Items.Add(menuPlayVoiceReminder);
```

## 五、预期效果

1. **全面的消息覆盖**：支持所有系统消息类型的语音提醒
2. **灵活的配置选项**：允许用户开启/关闭语音提醒，调整音量和语速
3. **智能的消息处理**：根据消息类型生成合适的语音提示
4. **良好的用户体验**：异步播放，避免界面卡顿
5. **可扩展的架构**：支持未来添加更多消息类型和提醒方式

## 六、实现时间估计

* 增强 TaskVoiceReminder.cs：30分钟

* 优化 EnhancedMessageManager.cs：30分钟

* 完善 MessageListControl.cs：30分钟

* 测试和优化：30分钟

总计：约2小时
