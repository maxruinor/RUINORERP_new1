# 统一防重复操作服务改造计划

## 改造目标
将三个基类（BaseBillEditGeneric、BaseBillQueryMC、BaseListGeneric）中的防重复操作实现统一改为使用集中式的 RepeatOperationGuardService，减少代码重复，提高可维护性。

## 改造内容

### 1. BaseBillEditGeneric.cs 改造

#### 1.1 添加服务引用
- 引入 RUINORERP.UI.BusinessService 命名空间
- 添加 RepeatOperationGuardService 实例字段

#### 1.2 移除冗余代码
- 删除防重复操作相关字段：_buttonDebounceCache、_buttonDisabledState、_buttonDebounceLock、_lastTriggeredAction、_lastOperationEntityId、_lastOperationTime
- 删除相关方法：ShouldBlockButtonClick、RecordButtonClick、DisableButtonForOperation、EnableButtonAfterOperation、EnableAllButtonsAfterOperation、ClearButtonDebounceCache

#### 1.3 替换防重复逻辑
- 在 DoButtonClick 方法中使用 _guardService.ShouldBlockOperation 替代 ShouldBlockButtonClick
- 使用 _guardService.RecordOperation 替代 RecordButtonClick
- 保留按钮状态管理逻辑（根据状态管理系统更新按钮状态）

### 2. BaseBillQueryMC.cs 改造

#### 2.1 移除冗余代码
- 删除防重复操作相关字段：_buttonDebounceLock、_buttonDebounceCache、_buttonDisabledState、_lastTriggeredAction、_lastOperationEntityId、_lastOperationTime
- 删除相关方法：DisableButtonForOperation、EnableButtonAfterOperation、EnableAllButtonsAfterOperation、ClearButtonDebounceCache

#### 2.2 优化服务使用
- 确保 DoButtonClick 方法中正确使用 _guardService

### 3. BaseListGeneric.cs 检查
- 确认已正确使用 _guardService
- 检查是否有冗余代码需要清理

## 改造步骤

1. 首先改造 BaseBillEditGeneric.cs，这是最复杂的一个类
2. 然后改造 BaseBillQueryMC.cs
3. 最后检查 BaseListGeneric.cs

## 注意事项

1. 确保服务实例正确初始化（使用 Startup.GetFromFac 进行依赖注入）
2. 保持与现有代码的兼容性
3. 确保防重复操作的逻辑与原有实现一致
4. 保留必要的按钮状态管理逻辑
5. 确保使用当前类名作为操作源，以便于调试和日志记录

## 预期效果

1. 减少代码重复，提高可维护性
2. 统一防重复操作的实现逻辑
3. 便于后续扩展和优化防重复机制
4. 降低三个基类的复杂度