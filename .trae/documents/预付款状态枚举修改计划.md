# 预付款状态枚举修改计划

## 1. 修改内容

将当前的 `PrePaymentStatus` 枚举从7个状态扩展为8个状态，移除"已结案"状态，增加"部分退款"和"全额退款"两个状态，使退款流程更加精细化。

### 1.1 枚举定义修改

**当前定义：**
```csharp
public enum PrePaymentStatus
{
    [Description("草稿")] 草稿 = 1,
    [Description("待审核")] 待审核 = 2,
    [Description("已生效")] 已生效 = 3,
    [Description("待核销")] 待核销 = 4,
    [Description("部分核销")] 部分核销 = 5,
    [Description("全额核销")] 全额核销 = 6,
    [Description("已结案")] 已结案 = 7
}
```

**修改后定义：**
```csharp
/// <summary>预付款状态（仅1-8值，全额核销/全额退款为终态）</summary>
public enum PrePaymentStatus
{
    [Description("草稿")] 草稿 = 1,
    [Description("待审核")] 待审核 = 2,
    [Description("已生效")] 已生效 = 3,
    [Description("待核销")] 待核销 = 4,
    [Description("部分核销")] 部分核销 = 5,  // 过程态：可继续核销至全额，或发起退款
    [Description("全额核销")] 全额核销 = 6,  // 唯一终态1：核销流程结束
    [Description("部分退款")] 部分退款 = 7,  // 过程态：可继续退款至全额
    [Description("全额退款")] 全额退款 = 8   // 唯一终态2：退款流程结束
}
```

## 2. 影响范围分析

### 2.1 使用该枚举的文件

- **`RUINORERP.Global/EnumExt/FMEnums.cs`**：枚举定义
- **`RUINORERP.Business/tb_FM_PaymentRecordControllerPartial.cs`**：业务逻辑中设置状态为已结案
- **`RUINORERP.Model/Base/StatusManager/GlobalStateRulesManager.cs`**：状态转换规则、UI按钮规则、操作权限规则、终态判断、状态映射
- **`RUINORERP.Model/Base/StatusManager/UnifiedStateManager.cs`**：终态判断
- **`RUINORERP.UI/FM/FMBase/UCPreReceivedPayment.cs`**：预付款单编辑和管理
- **`RUINORERP.UI/FM/FMBase/UCPreReceivedPaymentQuery.cs`**：预付款单查询和处理

### 2.2 业务逻辑影响

1. **状态值变化**：
   - 原状态7（已结案）将变为新状态7（部分退款）
   - 新增状态8（全额退款）
   - 终态从单一的"已结案"变为"全额核销"和"全额退款"

2. **现有业务逻辑**：
   - 删除单据条件：`草稿 || 待审核 || 待核销` → 不受影响
   - 核销数据检查：`>= 部分核销` → 需确保新状态7（部分退款）和8（全额退款）的处理逻辑正确
   - 生成收付款单：`已生效` → 不受影响
   - 状态转换规则：需要更新所有涉及"已结案"的转换规则
   - UI按钮规则：需要为新状态添加按钮规则
   - 操作权限规则：需要为新状态添加操作权限规则
   - 终态判断：需要更新终态定义
   - 状态映射：需要更新"结案"操作的状态映射

3. **潜在问题**：
   - `UCPreReceivedPaymentQuery.cs` 中存在类型转换错误，将 `PrePaymentStatus` 转换为 `ARAPStatus`，需修复
   - 数据库中已有状态7的记录，需确保应用能正确处理

## 3. 修改步骤

### 3.1 步骤1：更新枚举定义

修改 `/e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Global/EnumExt/FMEnums.cs` 文件中的 `PrePaymentStatus` 枚举定义，按照新的设计更新。

### 3.2 步骤2：更新状态转换规则

修改 `GlobalStateRulesManager.cs` 中的 `InitializePrePaymentStatusTransitionRules` 方法，更新状态转换规则：

**当前规则：**
```csharp
[PrePaymentStatus.已生效] = new List<object> { PrePaymentStatus.待审核, PrePaymentStatus.待核销, PrePaymentStatus.部分核销, PrePaymentStatus.全额核销, PrePaymentStatus.已结案 },
[PrePaymentStatus.待核销] = new List<object> { PrePaymentStatus.部分核销, PrePaymentStatus.全额核销, PrePaymentStatus.已结案 },
[PrePaymentStatus.部分核销] = new List<object> { PrePaymentStatus.全额核销, PrePaymentStatus.已结案 },
[PrePaymentStatus.全额核销] = new List<object> { PrePaymentStatus.已结案 }
```

**修改后规则：**
```csharp
[PrePaymentStatus.已生效] = new List<object> { PrePaymentStatus.待审核, PrePaymentStatus.待核销 },
[PrePaymentStatus.待核销] = new List<object> { PrePaymentStatus.部分核销, PrePaymentStatus.全额核销, PrePaymentStatus.部分退款 },
[PrePaymentStatus.部分核销] = new List<object> { PrePaymentStatus.全额核销, PrePaymentStatus.部分退款 },
[PrePaymentStatus.全额核销] = new List<object> { }, // 终态，不可转换
[PrePaymentStatus.部分退款] = new List<object> { PrePaymentStatus.全额退款 },
[PrePaymentStatus.全额退款] = new List<object> { }  // 终态，不可转换
```

### 3.3 步骤3：更新UI按钮规则

修改 `GlobalStateRulesManager.cs` 中的 `InitializePrePaymentStatusUIButtonRules` 方法，为新状态添加按钮规则：

**当前规则：**
```csharp
AddStandardButtonRules(PrePaymentStatus.全额核销, addEnabled: false, modifyEnabled: false, saveEnabled: false, deleteEnabled: false, submitEnabled: false, reviewEnabled: false, reverseReviewEnabled: true, caseClosedEnabled: false, antiClosedEnabled: false);
AddStandardButtonRules(PrePaymentStatus.已结案, addEnabled: false, modifyEnabled: false, saveEnabled: false, deleteEnabled: false, submitEnabled: false, reviewEnabled: false, reverseReviewEnabled: false, caseClosedEnabled: false, antiClosedEnabled: false);
```

**修改后规则：**
```csharp
AddStandardButtonRules(PrePaymentStatus.全额核销, addEnabled: false, modifyEnabled: false, saveEnabled: false, deleteEnabled: false, submitEnabled: false, reviewEnabled: false, reverseReviewEnabled: true, caseClosedEnabled: false, antiClosedEnabled: false);
AddStandardButtonRules(PrePaymentStatus.部分退款, addEnabled: false, modifyEnabled: true, saveEnabled: true, deleteEnabled: false, submitEnabled: false, reviewEnabled: false, reverseReviewEnabled: false, caseClosedEnabled: false, antiClosedEnabled: false);
AddStandardButtonRules(PrePaymentStatus.全额退款, addEnabled: false, modifyEnabled: false, saveEnabled: false, deleteEnabled: false, submitEnabled: false, reviewEnabled: false, reverseReviewEnabled: false, caseClosedEnabled: false, antiClosedEnabled: false);
```

### 3.4 步骤4：更新操作权限规则

修改 `GlobalStateRulesManager.cs` 中的 `AddPrePaymentStatusActionPermissionRules` 方法，为新状态添加操作权限规则：

**当前规则：**
```csharp
[PrePaymentStatus.部分核销] = new List<MenuItemEnums> { },
[PrePaymentStatus.全额核销] = new List<MenuItemEnums> { },
[PrePaymentStatus.已结案] = new List<MenuItemEnums> { }
```

**修改后规则：**
```csharp
[PrePaymentStatus.部分核销] = new List<MenuItemEnums> { },
[PrePaymentStatus.全额核销] = new List<MenuItemEnums> { },
[PrePaymentStatus.部分退款] = new List<MenuItemEnums> { },
[PrePaymentStatus.全额退款] = new List<MenuItemEnums> { }
```

### 3.5 步骤5：更新终态判断

修改 `GlobalStateRulesManager.cs` 和 `UnifiedStateManager.cs` 中的终态判断逻辑：

**当前逻辑：**
```csharp
return prepayStatus == PrePaymentStatus.已结案;
```

**修改后逻辑：**
```csharp
return prepayStatus == PrePaymentStatus.全额核销 || prepayStatus == PrePaymentStatus.全额退款;
```

### 3.6 步骤6：更新状态映射

修改 `GlobalStateRulesManager.cs` 中的 `MapActionToStatusInternal` 方法，更新状态映射逻辑：

**当前逻辑：**
```csharp
if (action == MenuItemEnums.提交) return PrePaymentStatus.待审核;
if (action == MenuItemEnums.审核) return PrePaymentStatus.已生效;
if (action == MenuItemEnums.反审) return PrePaymentStatus.待审核;
if (action == MenuItemEnums.结案) return PrePaymentStatus.已结案;
```

**修改后逻辑：**
```csharp
if (action == MenuItemEnums.提交) return PrePaymentStatus.待审核;
if (action == MenuItemEnums.审核) return PrePaymentStatus.已生效;
if (action == MenuItemEnums.反审) return PrePaymentStatus.待审核;
// 移除结案操作映射，因为结案操作不再使用
```

### 3.7 步骤7：修复类型转换错误

修复 `UCPreReceivedPaymentQuery.cs` 中的类型转换错误，将 `((ARAPStatus)item.PrePaymentStatus)` 改为 `((PrePaymentStatus)item.PrePaymentStatus)`。

### 3.8 步骤8：更新业务逻辑

检查 `tb_FM_PaymentRecordControllerPartial.cs` 中的 `ApprovalAsync` 方法，更新设置状态的逻辑：

**当前逻辑：**
```csharp
prePayment.PrePaymentStatus = (int)PrePaymentStatus.已结案;
```

**修改后逻辑：**
根据业务需求，将状态设置为 `全额核销` 或 `全额退款`。

## 3. 测试要点

1. **功能测试**：
   - 验证预付款单的创建、审核、生效流程
   - 验证核销流程（部分核销、全额核销）
   - 验证退款流程（部分退款、全额退款）
   - 验证单据删除功能
   - 验证收付款单生成功能

2. **边界测试**：
   - 验证状态转换的正确性
   - 验证新状态7（部分退款）和8（全额退款）的处理
   - 验证数据库中已有状态7记录的处理

3. **异常测试**：
   - 验证各种状态下的操作限制
   - 验证错误提示信息的准确性

## 4. 风险评估

### 4.1 低风险

- 枚举定义更新：仅涉及代码修改，不影响数据库结构
- 状态显示逻辑：新状态有明确的描述，不会引起混淆

### 4.2 中风险

- 状态比较逻辑：需确保所有比较操作都能正确处理新状态
- 类型转换错误：已识别并计划修复

### 4.3 高风险

- 数据库中已有状态7记录：需确保应用能正确处理，避免业务中断
- 状态转换规则变更：需确保所有状态转换都符合业务逻辑
- 终态判断变更：需确保终态判断正确，避免业务流程混乱

## 5. 应急预案

1. **回滚计划**：
   - 保存原始枚举定义和所有修改的规则文件，以便在出现问题时快速回滚
   - 记录所有修改点，确保回滚时能恢复到原始状态

2. **监控计划**：
   - 在修改后密切监控系统日志，特别是与预付款相关的操作
   - 关注用户反馈，及时处理可能出现的问题

3. **数据备份**：
   - 在修改前备份相关数据库表，特别是 `tb_FM_PreReceivedPayment` 表

## 6. 修改文件清单

1. **`RUINORERP.Global/EnumExt/FMEnums.cs`**：更新枚举定义
2. **`RUINORERP.Business/tb_FM_PaymentRecordControllerPartial.cs`**：更新业务逻辑中的状态设置
3. **`RUINORERP.Model/Base/StatusManager/GlobalStateRulesManager.cs`**：更新状态转换规则、UI按钮规则、操作权限规则、终态判断、状态映射
4. **`RUINORERP.Model/Base/StatusManager/UnifiedStateManager.cs`**：更新终态判断
5. **`RUINORERP.UI/FM/FMBase/UCPreReceivedPaymentQuery.cs`**：修复类型转换错误

## 7. 预期效果

- 预付款状态管理更加精细化，区分了部分退款和全额退款
- 退款流程更加清晰，便于跟踪和管理
- 业务逻辑更加严谨，终态明确（全额核销和全额退款）
- 消除了原枚举中"已结案"状态的模糊性
- 状态转换规则更加符合实际业务流程

## 8. 后续建议

1. **文档更新**：更新相关业务文档，说明新的预付款状态流程
2. **培训**：对相关业务人员进行培训，确保他们理解新的状态定义
3. **监控**：持续监控系统运行情况，确保新状态流程正常运行
4. **优化**：根据实际使用情况，进一步优化预付款状态流程

通过以上修改，我们可以确保预付款状态枚举的修改能够平滑过渡，不影响现有业务逻辑，同时满足新的业务需求。