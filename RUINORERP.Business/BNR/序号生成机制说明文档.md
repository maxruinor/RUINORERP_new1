# ERP系统序号生成机制架构与使用文档

## 1. 架构概述

RUINORERP系统的序号生成机制采用了灵活的插件式架构设计，基于工厂模式和策略模式实现。主要由以下核心组件构成：

- **BNRFactory**: 序号生成工厂，负责管理和协调各种参数处理器
- **IParameterHandler**: 参数处理器接口，定义了所有处理器必须实现的方法
- **DatabaseSequenceService**: 基于数据库的序号管理服务，提供高性能的序号生成和管理功能
- **DatabaseSequenceParameter**: 基于数据库的序号参数处理器
- **RedisSequenceParameter**: 基于Redis的序号参数处理器
- **ConstantParameterHandler**: 常量参数处理器
- **DateParameterHandler**: 日期参数处理器
- **ChineseSpellCodeParameter**: 中文首字母参数处理器
- **HexDateSequenceParameter**: 十六进制日期参数处理器

## 2. 核心组件详解

### 2.1 BNRFactory

工厂类是整个序号生成机制的核心协调者，负责注册和管理各种参数处理器，并提供创建序号的统一入口。

```csharp
// 示例：创建BNR工厂实例（通过依赖注入获取）
var factory = new BNRFactory(databaseSequenceService, cacheManager);
// 初始化过程会自动注册所有默认处理器
```

**主要功能**：
- 注册和管理各种参数处理器
- 提供统一的序号生成接口
- 协调不同处理器之间的嵌套调用
- 支持通过特性自动注册参数处理器

**构造函数**：
```csharp
/// <summary>
/// 构造函数
/// </summary>
/// <param name="databaseSequenceService">数据库序列服务</param>
/// <param name="cacheManager">缓存管理器</param>
public BNRFactory(DatabaseSequenceService databaseSequenceService, ICacheManager<object> cacheManager)
{
    _databaseSequenceService = databaseSequenceService;
    _cacheManager = cacheManager;
    Initialize(); // 自动初始化并注册所有默认处理器
}
```

### 2.2 IParameterHandler

参数处理器接口定义了所有处理器必须实现的方法，是整个插件架构的基础。

```csharp
public interface IParameterHandler
{
    void Execute(StringBuilder sb, string value);
    BNRFactory Factory { get; set; }
}
```

**参数说明**：
- `sb`: 字符串构建器，用于存储生成的序号
- `value`: 参数值，根据不同处理器有不同的格式要求
- `Factory`: 对BNRFactory的引用，用于处理嵌套表达式

### 2.3 DatabaseSequenceService

数据库序号服务是系统的核心服务之一，负责基于数据库的序号生成、查询和管理功能。该服务采用高性能设计，包含内存缓存和批量更新机制。

**主要功能**：
- 序号表的创建和初始化
- 获取下一个序号值（支持高并发）
- 序号重置功能（支持按天/月/年重置）
- 序号查询和管理
- 内存缓存机制提升性能
- 批量更新机制减少数据库压力
- 支持动态调整批量更新阈值

**表结构**：

| 字段名 | 数据类型 | 说明 |
|-------|---------|------|
| Id | int | 主键ID，自增 |
| SequenceKey | nvarchar(255) | 序号键，唯一标识一个序号序列 |
| CurrentValue | bigint | 当前序号值 |
| LastUpdated | datetime2 | 最后更新时间 |
| CreatedAt | datetime2 | 创建时间 |
| ResetType | nvarchar(20) | 重置类型：None/Daily/Monthly/Yearly |
| FormatMask | nvarchar(50) | 格式化掩码，如000 |
| Description | nvarchar(255) | 序列描述 |
| BusinessType | nvarchar(100) | 业务类型 |

**核心方法**：
```csharp
/// <summary>
/// 获取下一个序列值（支持按时间单位重置）
/// </summary>
/// <param name="sequenceKey">序列键</param>
/// <param name="resetType">重置类型（None、Daily、Monthly、Yearly）</param>
/// <param name="formatMask">格式掩码</param>
/// <param name="description">描述</param>
/// <param name="businessType">业务类型</param>
/// <returns>下一个序列值</returns>
public long GetNextSequenceValue(string sequenceKey, string resetType = "None", string formatMask = null, string description = null, string businessType = null)

/// <summary>
/// 重置指定序列的值为1
/// </summary>
/// <param name="key">序列键</param>
public void ResetSequence(string key)

/// <summary>
/// 获取所有序列
/// </summary>
/// <returns>序列列表</returns>
public List<SequenceNumbers> GetAllSequences()

/// <summary>
/// 设置批量更新阈值
/// </summary>
/// <param name="threshold">新的阈值</param>
public static void SetBatchUpdateThreshold(int threshold)

/// <summary>
/// 获取当前批量更新阈值
/// </summary>
/// <returns>当前阈值</returns>
public static int GetBatchUpdateThreshold()
```

### 2.4 DatabaseSequenceParameter

基于数据库的序号参数处理器，支持嵌套表达式和动态序号重置功能。

**格式**：
- `{DB:key/format}` - 普通序号
- `{DB:key/format/daily}` - 按天重置序号
- `{DB:key/format/monthly}` - 按月重置序号
- `{DB:key/format/yearly}` - 按年重置序号

**示例**：
```csharp
// 普通序号
string rule = "{DB:ORDER/00000}";
string orderNo = factory.Create(rule); // 生成如 "00001", "00002" 等序号

// 按天重置的序号
string rule = "{DB:DAILY_ORDER/0000/daily}";
string dailyOrderNo = factory.Create(rule); // 每天从0001开始

// 嵌套表达式
string rule = "{DB:{CN:销售订单}_{D:yyyyMM}/0000}";
string salesOrderNo = factory.Create(rule); // 生成如 "XSDD_202401-0001" 的序号
```

### 2.5 ConstantParameterHandler

常量参数处理器，支持大写转换功能。

**格式**：`{S:xxx}` 或 `{S:xxx:upper}`

**示例**：
```csharp
// 普通常量
string rule = "{S:ORDER}";
string result = factory.Create(rule); // 输出: "ORDER"

// 大写转换
string rule = "{S:ord:upper}";
string result = factory.Create(rule); // 输出: "ORD"
```

### 2.6 DateParameterHandler

日期参数处理器，支持各种日期格式。

**格式**：`{D:dateFormat}`

**示例**：
```csharp
// 常用日期格式
string rule = "{D:yyyyMMdd}";
string result = factory.Create(rule); // 输出: "20240115"

string rule = "{D:yyyy-MM-dd}";
string result = factory.Create(rule); // 输出: "2024-01-15"
```

### 2.7 ChineseSpellCodeParameter

中文首字母参数处理器，用于将中文字符转换为首字母。

**格式**：`{CN:中文}`

**示例**：
```csharp
string rule = "{CN:销售订单}";
string result = factory.Create(rule); // 输出: "XDDD"
```

### 2.8 HexDateSequenceParameter

十六进制日期参数处理器，用一种简单方式编码日期。

**格式**：`{Hex:yyMM}`

**示例**：
```csharp
string rule = "{Hex:yyMM}";
string result = factory.Create(rule); // 输出十六进制日期编码
```

### 2.9 RedisSequenceParameter

Redis序号参数处理器，使用CacheManager来管理Redis连接和操作。

**格式**：`{redis:key/format}`

**示例**：
```csharp
string rule = "{redis:USER_ID/0000}";
string userId = factory.Create(rule); // 生成如 "0001", "0002" 等序号
```

## 3. 序号生成机制

### 3.1 基本序号生成

系统支持多种序号生成方式，主要分为以下几类：

#### 3.1.1 基于数据库的序号生成

**格式**：`{DB:key/format/resetType}`
- `key`: 序号序列的唯一标识
- `format`: 序号格式化掩码，如"0000"表示4位数字格式
- `resetType`: 重置类型（可选），支持none/daily/monthly/yearly

**示例**：
```csharp
string rule = "{DB:ORDER/00000}";
string orderNo = factory.Create(rule); // 生成如 "00001", "00002" 等序号

string rule = "{DB:DAILY_ORDER/0000/daily}";
string dailyOrderNo = factory.Create(rule); // 每天从0001开始重置
```

#### 3.1.2 基于Redis的序号生成

**格式**：`{redis:key/format}`
- `key`: Redis中的键名
- `format`: 序号格式化掩码

**示例**：
```csharp
string rule = "{redis:USER_ID/0000}";
string userId = factory.Create(rule); // 生成如 "0001", "0002" 等序号
```

#### 3.1.3 常量参数

**格式**：`{S:value}` 或 `{S:value:upper}`

**示例**：
```csharp
string rule = "{S:ORDER}";
string result = factory.Create(rule); // 输出: "ORDER"

string rule = "{S:ord:upper}";
string result = factory.Create(rule); // 输出: "ORD"
```

#### 3.1.4 日期参数

**格式**：`{D:dateFormat}`

**示例**：
```csharp
string rule = "{D:yyyyMMdd}";
string result = factory.Create(rule); // 输出: "20240115"
```

#### 3.1.5 中文首字母参数

**格式**：`{CN:中文}`

**示例**：
```csharp
string rule = "{CN:销售订单}";
string result = factory.Create(rule); // 输出: "XDDD"
```

#### 3.1.6 十六进制日期参数

**格式**：`{Hex:yyMM}`

**示例**：
```csharp
string rule = "{Hex:yyMM}";
string result = factory.Create(rule); // 输出十六进制日期编码
```

### 3.2 复合序号生成

系统支持将多种参数处理器组合使用，生成复杂的序号格式。

**示例**：
```csharp
// 组合常量、日期和序号
string rule = "{S:ORD-}{D:yyyyMMdd}-{DB:ORDER_NO/0000}";
string orderNo = factory.Create(rule); // 生成如 "ORD-20240115-0001" 的序号

// 组合中文首字母和序号
string rule = "{CN:销售订单}-{DB:SALES_ORDER/0000}";
string orderNo = factory.Create(rule); // 生成如 "XDDD-0001" 的序号

// 复杂组合
string rule = "{S:PRD-}{Hex:yyMM}{DB:{S:ProductNo}/000}";
string productNo = factory.Create(rule); // 生成如 "PRD-7D81001" 的序号
```

### 3.3 动态序号重置机制

系统提供了强大的序号重置功能，支持以下重置类型：

#### 3.3.1 序号重置类型

- **None**: 序号不会自动重置（默认）
- **Daily**: 每天自动重置序号从1开始
- **Monthly**: 每月自动重置序号从1开始
- **Yearly**: 每年自动重置序号从1开始

#### 3.3.2 动态序号格式

**格式**：`{DB:key/format/resetType}`
- `key`: 序号序列的唯一标识
- `format`: 序号格式化掩码
- `resetType`: 重置类型（daily/monthly/yearly）

**示例**：
```csharp
// 按天重置的订单号
string rule = "{D:yyyyMMdd}-{DB:DAILY_ORDER/0000/daily}";
// 生成如 "20240115-0001", "20240115-0002"，次日重置为 "20240116-0001"

// 按月重置的报表号
string rule = "{D:yyyyMM}-{DB:MONTHLY_REPORT/000/monthly}";
// 生成如 "202401-001", "202401-002"，次月重置为 "202402-001"
```

### 3.4 嵌套表达式支持

系统支持在参数中使用嵌套表达式，实现更灵活的序号生成。

**示例**：
```csharp
// 嵌套表达式生成动态键
string rule = "{DB:{CN:销售订单}_{D:yyyyMM}/0000}";
string salesOrderNo = factory.Create(rule); // 生成如 "XDDD_202401-0001" 的序号

// 多层嵌套
string rule = "{S:ORD-{D:yyyyMM}}";
string result = factory.Create(rule); // 生成如 "ORD-202401" 的序号
```

## 4. 序号管理功能

DatabaseSequenceService提供了完整的序号管理功能：

### 4.1 序号查询

```csharp
// 获取所有序号序列
List<SequenceNumbers> allSequences = sequenceService.GetAllSequences();

// 根据业务类型获取序号序列
List<SequenceNumbers> salesSequences = sequenceService.GetSequencesByBusinessType("SALES");

// 获取当前序号值（不增加）
long currentValue = sequenceService.GetCurrentSequenceValue("ORDER_KEY");

// 获取当前序号值（支持重置类型）
long currentValue = sequenceService.GetCurrentSequenceValue("ORDER_KEY", "daily");
```

### 4.2 序号重置

```csharp
// 重置指定序号序列的值为1
sequenceService.ResetSequence("ORDER_KEY");

// 设置序号为指定值
sequenceService.ResetSequenceValue("ORDER_KEY", 1000);
```

### 4.3 序号信息更新

```csharp
// 更新序号序列的格式、描述和业务类型
sequenceService.UpdateSequenceInfo(
    "ORDER_KEY",
    resetType: "daily",     // 重置类型
    formatMask: "000000",   // 新格式
    description: "销售订单序号", // 描述
    businessType: "SALES"   // 业务类型
);
```

### 4.4 高级功能

```csharp
// 检查序号是否存在
bool exists = sequenceService.SequenceExists("ORDER_KEY");

// 删除序号记录
sequenceService.DeleteSequence("ORDER_KEY");

// 测试序号表功能
string testResult = sequenceService.TestSequenceTable();

// 设置批量更新阈值（动态调整批量写入条数）
DatabaseSequenceService.SetBatchUpdateThreshold(10);

// 获取当前批量更新阈值
int currentThreshold = DatabaseSequenceService.GetBatchUpdateThreshold();
```

## 5. 使用示例

### 5.1 基本用法

```csharp
// 1. 创建BNR工厂实例（通常通过依赖注入获取）
var factory = new BNRFactory(databaseSequenceService, cacheManager);
// 注意：构造函数会自动调用Initialize()方法

// 2. 定义序号生成规则
string orderRule = "{CN:销售}-{D:yyyyMMdd}-{DB:SO/0000}";

// 3. 生成序号
string orderNo = factory.Create(orderRule);
Console.WriteLine(orderNo); // 例如："XS-20240115-0001"
```

### 5.2 动态序号示例

```csharp
// 按天重置的序号
string dailyRule = "{D:yyyyMMdd}-{DB:DAILY_NO/0000/daily}";

// 按月重置的序号
string monthlyRule = "{D:yyyyMM}-{DB:MONTHLY_NO/0000/monthly}";

// 按年重置的序号
string yearlyRule = "{D:yyyy}-{DB:YEARLY_NO/000000/yearly}";
```

### 5.3 复杂组合示例

```csharp
// 包含多种参数的复杂规则
string complexRule = "{CN:采购}-{S:PO}-{D:yyyyMMdd}-{DB:PURCHASE/0000}";
string purchaseNo = factory.Create(complexRule);
// 生成如："CG-PO-20240115-0001"

// 嵌套表达式示例
string nestedRule = "{DB:{CN:销售}_{D:yyyyMM}/0000}";
string salesNo = factory.Create(nestedRule);
// 生成如："XS_202401-0001"，其中序列键为"XS_202401"
```

### 5.4 BizCodeGenerateService使用示例

BizCodeGenerateService是业务编码服务实现，包装了BNRFactory功能，提供业务编码生成服务。

```csharp
// 生成业务单据编号（支持BizType枚举）
string orderNo = bizCodeGenerateService.GenerateBizBillNo(BizType.销售订单);
// 生成如："SO240115001"

// 生成基础信息编号
string employeeNo = bizCodeGenerateService.GenerateBaseInfoNo("EMPLOYEE");
// 生成如："EMP001"

// 生成产品编码
string productNo = bizCodeGenerateService.GenerateProductNo();
// 生成如："P7D81001"

// 生成产品SKU编码
string skuNo = bizCodeGenerateService.GenerateProductSKUNo();
// 生成如："SK7D80001"

// 根据自定义规则生成编号
string customNo = bizCodeGenerateService.GenerateByRule("{S:CUS-}{D:yyMM}{DB:CUSTOM/000}");
// 生成如："CUS-2401001"
```

## 6. 序号表结构SQL

以下是序号表的完整创建SQL：

```sql
-- 创建序号表
CREATE TABLE SequenceNumbers (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    SequenceKey NVARCHAR(255) NOT NULL UNIQUE,  -- 序号键，唯一标识一个序号序列
    CurrentValue BIGINT NOT NULL DEFAULT 0,     -- 当前序号值
    LastUpdated DATETIME2 NOT NULL DEFAULT GETDATE(), -- 最后更新时间
    CreatedAt DATETIME2 NOT NULL DEFAULT GETDATE(),    -- 创建时间
    ResetType NVARCHAR(20) NULL,                -- 重置类型: None, Daily, Monthly, Yearly
    FormatMask NVARCHAR(50) NULL,               -- 格式化掩码，如 000
    Description NVARCHAR(255) NULL,             -- 序列描述
    BusinessType NVARCHAR(100) NULL             -- 业务类型
);

-- 创建索引以提高查询性能
CREATE INDEX IX_SequenceNumbers_SequenceKey ON SequenceNumbers (SequenceKey);
```

## 7. 动态控制批量写入条数

DatabaseSequenceService支持动态调整批量写入条数，类似于日志级别的动态控制。可以通过以下方式调整批量更新阈值：

### 7.1 通过代码设置

```csharp
// 设置批量更新阈值为10
DatabaseSequenceService.SetBatchUpdateThreshold(10);

// 获取当前批量更新阈值
int currentThreshold = DatabaseSequenceService.GetBatchUpdateThreshold();
```

### 7.2 通过UI界面控制

在服务器管理端的调试模式下拉菜单中，新增了"批量更新阈值"选项，可以动态调整批量写入条数：
- 预设值：1, 5, 10, 20, 50
- 自定义值：可以输入任意正整数

这种动态控制机制允许在运行时根据系统负载和性能需求调整批量写入条数，优化数据库性能。

## 8. 最佳实践

### 8.1 序号键命名规范

- 使用有意义的名称，反映业务场景
- 使用大写字母和下划线
- 避免使用特殊字符
- 对于动态序号，可以使用前缀+日期格式

### 8.2 序号格式选择

- 根据业务需求选择适当的数字位数
- 考虑未来业务量增长，预留足够的位数
- 对于按时间重置的序号，可以在格式中包含日期信息

### 8.3 性能优化

- 对于高并发场景，考虑使用Redis序号
- 定期清理不再使用的序号序列
- 避免在短时间内生成大量序号
- 根据系统负载动态调整批量更新阈值

### 8.4 错误处理

```csharp
try 
{
    string orderNo = factory.Create(rule);
}
catch (ArgumentNullException ex)
{
    // 处理规则为空的情况
    Console.WriteLine($"编号规则不能为空: {ex.Message}");
}
catch (InvalidOperationException ex)
{
    // 处理编号生成失败的情况
    Console.WriteLine($"编号生成失败: {ex.Message}");
}
```

## 9. 故障排除

### 9.1 序号重复问题

- 检查数据库事务是否正常工作
- 确认序号键的唯一性
- 对于高并发场景，考虑使用Redis序号或增加数据库隔离级别

### 9.2 序号不按预期重置

- 检查resetType参数拼写是否正确（daily/monthly/yearly）
- 验证动态键生成逻辑是否正确
- 确认系统日期时间设置正确

### 9.3 数据库连接问题

- 验证数据库连接字符串是否正确
- 检查数据库用户权限
- 确认数据库服务器状态

## 10. 序号管理用户界面

RUINORERP系统提供了直观的序号管理用户界面，方便用户查看、管理和操作序号序列。序号管理界面已集成到系统主窗体中，可通过以下方式访问：

### 10.1 访问方式

系统提供了三种便捷的方式访问序号管理功能：

#### 10.1.1 菜单访问
在系统主菜单的「管理」下拉菜单中，点击「序号管理」菜单项即可打开序号管理界面。

#### 10.1.2 工具栏访问
在系统主工具栏中，点击「序号管理」按钮即可快速打开序号管理界面。

#### 10.1.3 导航面板访问
在系统左侧导航面板中，点击「序号管理」按钮可直接打开序号管理界面。

### 10.2 界面功能

序号管理用户界面（SequenceManagementControl）提供以下功能：

- **序号序列列表展示**：显示所有已配置的序号序列及其当前值、格式化掩码、重置类型等信息
- **序号查询**：支持根据序号键、业务类型等条件筛选序号序列
- **序号重置**：可以手动重置指定序号序列的值
- **序号修改**：支持更新序号序列的格式化掩码、描述和业务类型等信息
- **动态序号管理**：可视化管理按日、月、年重置的序号序列

### 10.3 使用场景

#### 10.3.1 初始化业务序号
在系统上线或新业务模块启用时，可以通过序号管理界面预先设置各种业务序号序列。

#### 10.3.2 序号异常处理
当序号生成出现异常或需要调整序号值时，可以通过管理界面进行手动干预。

#### 10.3.3 序号规则调整
业务规则变更时，可以通过界面更新序号的格式化掩码和重置类型等属性。

---

本文档详细介绍了RUINORERP系统的序号生成机制，包括架构设计、核心组件、使用方法、最佳实践和用户界面操作。通过灵活的配置和友好的界面，可以满足各种复杂的业务序号需求，提升系统使用效率。