# 序号生成机制说明文档

## 概述

RUINOR ERP系统的序号生成机制基于DatabaseSequenceService实现，支持多种序号格式和重置策略，并引入了业务类型概念，便于对不同业务场景的序号进行分类管理。

## 核心组件

### 1. DatabaseSequenceService
数据库序号服务，负责序号的生成、存储和管理。

### 2. BNRFactory
序号生成工厂，负责解析序号规则并调用相应的处理器。

### 3. DatabaseSequenceParameter
数据库序号参数处理器，处理{DB:...}格式的序号生成。

## 序号格式支持

### 基本格式
```
{DB:key/format}
```

### 支持的重置类型
- `{DB:key/format}` - 普通序号，不重置
- `{DB:key/format/daily}` - 按天重置序号
- `{DB:key/format/monthly}` - 按月重置序号
- `{DB:key/format/yearly}` - 按年重置序号

### 示例
```
{DB:SALES_ORDER/00000}        // 销售订单序号，如 00001, 00002...
{DB:DAILY_REPORT/000/daily}   // 日报序号，每天从001开始
```

## 业务类型功能

### 功能说明
业务类型功能允许为不同业务场景的序号添加分类标识，便于后续查询和管理。

### 使用方法

#### 1. 设置当前业务类型
在生成序号前，通过BNRFactory设置当前业务类型：

```csharp
// 设置当前业务类型
BNRFactory.SetCurrentBusinessType("SalesOrder");

try
{
    // 生成序号
    string rule = "{S:SO}{D:yyyyMMdd}{DB:SALES_ORDER/00000}";
    string orderNumber = bnrFactory.Create(rule);
    
    // 序号记录会自动关联到"SalesOrder"业务类型
}
finally
{
    // 清除业务类型设置
    BNRFactory.SetCurrentBusinessType(null);
}
```

#### 2. 直接指定业务类型
在调用序号服务方法时直接指定业务类型：

```csharp
// 直接调用序号服务生成序号，并指定业务类型
long nextValue = sequenceService.GetNextSequenceValue(
    "INVENTORY_CHECK", 
    "None", 
    "0000", 
    "库存盘点序号", 
    "InventoryCheck");
```

#### 3. 查询特定业务类型的序号
```csharp
// 查询销售订单相关的序号
var salesSequences = sequenceService.GetSequencesByBusinessType("SalesOrder");
```

## 主要API说明

### DatabaseSequenceService

#### GetNextSequenceValue
获取下一个序列值
```csharp
public long GetNextSequenceValue(
    string sequenceKey, 
    string resetType = "None", 
    string formatMask = null, 
    string description = null, 
    string businessType = null)
```

#### UpdateSequenceInfo
更新序列信息
```csharp
public void UpdateSequenceInfo(
    string key, 
    string resetType = null, 
    string formatMask = null, 
    string description = null, 
    string businessType = null)
```

#### ResetSequenceValue
重置序列号到指定值
```csharp
public void ResetSequenceValue(
    string key, 
    long newValue, 
    string businessType = null)
```

#### GetSequencesByBusinessType
根据业务类型获取序列
```csharp
public List<SequenceNumbers> GetSequencesByBusinessType(string businessType)
```

## 使用示例

### 销售订单编号生成
```csharp
// 设置当前业务类型
BNRFactory.SetCurrentBusinessType("SalesOrder");

try
{
    // 生成销售订单编号
    // 格式: SO + 年月日 + 5位序号
    string rule = "{S:SO}{D:yyyyMMdd}{DB:SALES_ORDER/00000}";
    string orderNumber = bnrFactory.Create(rule);
    
    Console.WriteLine($"生成的销售订单编号: {orderNumber}");
}
finally
{
    // 清除业务类型设置
    BNRFactory.SetCurrentBusinessType(null);
}
```

### 按天重置的序号
```csharp
// 设置当前业务类型
BNRFactory.SetCurrentBusinessType("DailyReport");

try
{
    // 生成按天重置的序号
    // 格式: DR + 年月日 + 3位序号，每天从1开始
    string rule = "{S:DR}{D:yyyyMMdd}{DB:DAILY_REPORT/000/daily}";
    string reportNumber = bnrFactory.Create(rule);
    
    Console.WriteLine($"生成的日报编号: {reportNumber}");
}
finally
{
    // 清除业务类型设置
    BNRFactory.SetCurrentBusinessType(null);
}
```

## 注意事项

1. 业务类型会在序号首次生成时保存到数据库，后续更新时如果原记录没有业务类型且新业务类型不为空，则会更新业务类型字段。

2. 建议在生成序号前设置业务类型，并在生成完成后清除，避免影响其他序号的生成。

3. 业务类型主要用于序号的分类管理和查询，不会影响序号的生成逻辑。

4. 序号服务支持高并发场景，使用内存缓存和批量更新机制提高性能。