<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>财务审批工作流系统 - RUINORERP</title>
    <style>
        body { font-family: "Microsoft YaHei", sans-serif; margin: 20px; line-height: 1.6; }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        h3 { color: #2c3e50; margin-top: 20px; }
        .code { background: #f8f9fa; border: 1px solid #e9ecef; padding: 15px; border-radius: 5px; font-family: Consolas, monospace; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        .tip { background: #e8f4fd; border-left: 4px solid #3498db; padding: 10px; margin: 15px 0; }
        .workflow { background: #f0f8ff; border: 1px solid #b0c4de; padding: 15px; margin: 20px 0; border-radius: 5px; }
    </style>
</head>
<body>

<h1>财务审批工作流系统</h1>

<h2>1. 系统概述</h2>
<p>财务审批工作流模块是RUINORERP系统的核心组件，负责管理企业内部的财务审批流程，包括费用报销、采购付款、合同审批等业务流程。系统采用灵活的工作流引擎，支持自定义审批路径和权限控制。</p>

<h2>2. 核心审批类型</h2>

<h3>2.1 费用报销审批</h3>
<table>
    <tr><th>审批环节</th><th>审批人</th><th>审批权限</th><th>时间要求</th></tr>
    <tr><td>部门主管审批</td><td>部门经理</td><td>≤5000元</td><td>24小时内</td></tr>
    <tr><td>财务初审</td><td>财务专员</td><td>票据合规性</td><td>12小时内</td></tr>
    <tr><td>财务经理审批</td><td>财务经理</td><td>5000-20000元</td><td>24小时内</td></tr>
    <tr><td>总经理审批</td><td>总经理</td><td>≥20000元</td><td>48小时内</td></tr>
</table>

<h3>2.2 采购付款审批</h3>
<table>
    <tr><th>审批环节</th><th>审批人</th><th>审批重点</th><th>关联单据</th></tr>
    <tr><td>采购经理审批</td><td>采购经理</td><td>采购合规性</td><td>采购订单</td></tr>
    <tr><td>仓库验收确认</td><td>仓库主管</td><td>货物验收</td><td>入库单</td></tr>
    <tr><td>财务审核</td><td>财务专员</td><td>发票匹配</td><td>发票信息</td></tr>
    <tr><td>财务总监审批</td><td>财务总监</td><td>资金安排</td><td>资金计划</td></tr>
</table>

<h2>3. 工作流引擎设计</h2>

<h3>3.1 工作流定义数据模型</h3>
<div class="code">
// 工作流定义表
public class WorkflowDefinition
{
    public int Id { get; set; }
    public string WorkflowName { get; set; }         // 工作流名称
    public string WorkflowType { get; set; }         // 工作流类型
    public string Description { get; set; }          // 描述
    public bool IsActive { get; set; }               // 是否启用
    public DateTime CreateTime { get; set; }         // 创建时间
}

// 工作流节点定义
public class WorkflowNode
{
    public int Id { get; set; }
    public int WorkflowId { get; set; }              // 工作流ID
    public string NodeName { get; set; }             // 节点名称
    public int NodeOrder { get; set; }               // 节点顺序
    public string ApproverType { get; set; }         // 审批人类型
    public string ApproverRole { get; set; }         // 审批角色
    public decimal? AmountLimit { get; set; }        // 金额限制
    public string ConditionExpression { get; set; }  // 条件表达式
}

// 工作流实例
public class WorkflowInstance
{
    public int Id { get; set; }
    public int WorkflowId { get; set; }              // 工作流定义ID
    public string BusinessKey { get; set; }          // 业务单据号
    public string CurrentNode { get; set; }          // 当前节点
    public string Status { get; set; }               // 状态
    public DateTime StartTime { get; set; }          // 开始时间
    public DateTime? EndTime { get; set; }           // 结束时间
}
</div>

<h2>4. 审批流程设计</h2>

<h3>4.1 标准审批流程</h3>
<div class="workflow">
<strong>费用报销标准流程：</strong>
1. 员工提交报销申请 → 2. 部门主管审批 → 3. 财务专员审核票据 → 4. 财务经理审批（根据金额）→ 5. 出纳付款 → 6. 流程结束
</div>

<div class="workflow">
<strong>采购付款标准流程：</strong>
1. 采购员提交付款申请 → 2. 采购经理审批 → 3. 仓库确认收货 → 4. 财务审核发票 → 5. 财务总监审批 → 6. 出纳付款 → 7. 流程结束
</div>

<h3>4.2 条件分支流程</h3>
<div class="code">
// 条件审批逻辑示例
public class ConditionalApprovalService
{
    public List<WorkflowNode> GetNextNodes(WorkflowInstance instance, decimal amount)
    {
        var nodes = new List<WorkflowNode>();
        
        // 根据金额确定审批路径
        if (amount <= 5000)
        {
            // 部门主管审批 → 财务专员审核 → 结束
            nodes.Add(GetNode("部门主管审批"));
            nodes.Add(GetNode("财务专员审核"));
        }
        else if (amount <= 20000)
        {
            // 部门主管审批 → 财务专员审核 → 财务经理审批 → 结束
            nodes.Add(GetNode("部门主管审批"));
            nodes.Add(GetNode("财务专员审核"));
            nodes.Add(GetNode("财务经理审批"));
        }
        else
        {
            // 部门主管审批 → 财务专员审核 → 财务经理审批 → 总经理审批 → 结束
            nodes.Add(GetNode("部门主管审批"));
            nodes.Add(GetNode("财务专员审核"));
            nodes.Add(GetNode("财务经理审批"));
            nodes.Add(GetNode("总经理审批"));
        }
        
        return nodes;
    }
}
</div>

<h2>5. 技术实现</h2>

<h3>5.1 审批控制器设计</h3>
<div class="code">
public class ApprovalController : BaseController
{
    private readonly IApprovalService _approvalService;
    private readonly IWorkflowEngine _workflowEngine;
    
    public ApprovalController(IApprovalService approvalService, IWorkflowEngine workflowEngine)
    {
        _approvalService = approvalService;
        _workflowEngine = workflowEngine;
    }
    
    // 提交审批申请
    [HttpPost]
    public ActionResult SubmitApproval(ApprovalRequestDto request)
    {
        var result = _approvalService.SubmitApproval(request);
        return Json(result);
    }
    
    // 审批操作
    [HttpPost]
    public ActionResult ProcessApproval(int instanceId, string action, string comment)
    {
        var result = _approvalService.ProcessApproval(instanceId, action, comment);
        return Json(result);
    }
    
    // 获取待审批列表
    [HttpGet]
    public ActionResult GetPendingApprovals(int userId)
    {
        var approvals = _approvalService.GetPendingApprovals(userId);
        return Json(approvals);
    }
}
</div>

<h3>5.2 工作流引擎实现</h3>
<div class="code">
public class WorkflowEngine : IWorkflowEngine
{
    private readonly IRepository<WorkflowInstance> _instanceRepo;
    private readonly IRepository<WorkflowNode> _nodeRepo;
    
    public WorkflowResult StartWorkflow(int workflowId, string businessKey)
    {
        // 创建工作流实例
        var instance = new WorkflowInstance
        {
            WorkflowId = workflowId,
            BusinessKey = businessKey,
            CurrentNode = "开始",
            Status = "进行中",
            StartTime = DateTime.Now
        };
        
        _instanceRepo.Insert(instance);
        
        // 获取第一个审批节点
        var firstNode = GetNextNode(workflowId, "开始");
        if (firstNode != null)
        {
            instance.CurrentNode = firstNode.NodeName;
            _instanceRepo.Update(instance);
        }
        
        return WorkflowResult.Success("工作流启动成功");
    }
    
    public WorkflowResult MoveToNextNode(int instanceId, string action)
    {
        var instance = _instanceRepo.Get(instanceId);
        if (instance == null)
            return WorkflowResult.Fail("工作流实例不存在");
            
        // 根据当前节点和操作确定下一个节点
        var nextNode = GetNextNode(instance.WorkflowId, instance.CurrentNode, action);
        if (nextNode != null)
        {
            instance.CurrentNode = nextNode.NodeName;
            _instanceRepo.Update(instance);
            
            // 发送通知给下一个审批人
            SendNotificationToNextApprover(instance, nextNode);
        }
        else
        {
            // 没有下一个节点，工作流结束
            instance.Status = "已完成";
            instance.EndTime = DateTime.Now;
            _instanceRepo.Update(instance);
        }
        
        return WorkflowResult.Success("流程推进成功");
    }
}
</div>

<h2>6. 权限控制机制</h2>

<h3>6.1 审批权限矩阵</h3>
<table>
    <tr><th>角色</th><th>审批权限</th><th>金额限制</th><th>特殊权限</th></tr>
    <tr><td>部门主管</td><td>本部门费用报销</td><td>≤5000元</td><td>查看本部门审批记录</td></tr>
    <tr><td>财务专员</td><td>票据合规性审核</td><td>无限制</td><td>查看所有报销记录</td></tr>
    <tr><td>财务经理</td><td>财务审批</td><td>≤20000元</td><td>审批流程配置</td></tr>
    <tr><td>总经理</td><td>最终审批</td><td>无限制</td><td>查看全公司审批记录</td></tr>
</table>

<h3>6.2 权限验证逻辑</h3>
<div class="code">
public class ApprovalPermissionService
{
    public bool HasApprovalPermission(int userId, int instanceId, string action)
    {
        var instance = GetWorkflowInstance(instanceId);
        var userRoles = GetUserRoles(userId);
        
        // 检查用户是否有当前节点的审批权限
        var currentNode = GetCurrentNode(instance);
        if (currentNode.ApproverRole != null && 
            !userRoles.Contains(currentNode.ApproverRole))
        {
            return false;
        }
        
        // 检查金额权限
        if (currentNode.AmountLimit.HasValue)
        {
            var amount = GetBusinessAmount(instance.BusinessKey);
            if (amount > currentNode.AmountLimit.Value)
                return false;
        }
        
        return true;
    }
}
</div>

<h2>7. 通知提醒机制</h2>

<h3>7.1 通知类型</h3>
<ul>
    <li><strong>待办提醒</strong>：新的审批任务到达时发送通知</li>
    <li><strong>超时提醒</strong>：审批任务即将超时时发送提醒</li>
    <li><strong>结果通知</strong>：审批完成后通知申请人</li>
    <li><strong>紧急通知</strong>：紧急审批任务的特殊提醒</li>
</ul>

<h3>7.2 通知发送逻辑</h3>
<div class="code">
public class ApprovalNotificationService
{
    public void SendApprovalNotification(int instanceId, string notificationType)
    {
        var instance = GetWorkflowInstance(instanceId);
        var approvers = GetNextApprovers(instance);
        
        foreach (var approver in approvers)
        {
            var message = BuildNotificationMessage(instance, notificationType, approver);
            
            // 发送系统消息
            SendSystemMessage(approver.UserId, message);
            
            // 发送邮件通知
            if (approver.EmailNotificationEnabled)
                SendEmailNotification(approver.Email, message);
            
            // 发送短信通知（紧急任务）
            if (notificationType == "紧急")
                SendSmsNotification(approver.Phone, message);
        }
    }
}
</div>

<h2>8. 最佳实践</h2>

<div class="tip">
<strong>审批时效管理</strong>：建议设置各环节的审批时限，如一般审批24小时内完成，紧急审批4小时内完成。
</div>

<div class="tip">
<strong>权限分级控制</strong>：根据组织架构设置合理的审批权限矩阵，确保审批流程的合规性。
</div>

<div class="tip">
<strong>流程优化</strong>：定期分析审批流程的效率和瓶颈，优化审批路径和条件设置。
</div>

<h2>9. 常见问题</h2>

<h3>Q: 如何配置自定义审批流程？</h3>
<p>A: 在系统管理模块的工作流配置界面，可以拖拽方式配置审批节点和流转条件。</p>

<h3>Q: 审批人不在时如何处理？</h3>
<p>A: 系统支持设置审批代理人，当审批人不在时自动转交给代理人处理。</p>

<h3>Q: 如何查看审批历史记录？</h3>
<p>A: 在审批记录查询界面，可以按时间、申请人、审批状态等条件查询历史记录。</p>

</body>
</html>