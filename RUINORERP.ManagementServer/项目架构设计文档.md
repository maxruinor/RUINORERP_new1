# RUINORERP 管理服务器架构设计文档

## 项目概述

RUINORERP.ManagementServer 是 RUINORERP 系统的顶级管理服务器，负责管理所有业务服务器实例的注册、监控和管理。

## 架构设计

### 三级客户端-服务器架构

```
RUINORERP.UI (客户端) → RUINORERP.Server (业务服务器) → RUINORERP.ManagementServer (管理服务器)
```

### 架构特点

1. **层次化设计**：三层架构确保系统模块化和可扩展性
2. **职责分离**：每个层级有明确的职责分工
3. **独立性**：各项目独立运行，避免循环依赖

## 核心组件

### 1. 服务器会话管理 (ServerSession)

**位置**: `Network/ServerSession.cs`

**功能**:
- 管理业务服务器与顶级管理服务器之间的会话
- 提供会话状态跟踪和心跳检测
- 支持会话属性存储和用户信息管理

**关键属性**:
- `SessionID`: 唯一会话标识
- `ClientIp/ClientPort`: 客户端连接信息
- `UserInfo`: 用户身份信息
- `ServerInstance`: 关联的服务器实例信息
- `Status`: 会话状态管理

### 2. 服务器实例管理 (ServerManager)

**位置**: `ServerManagement/ServerManager.cs`

**功能**:
- 管理所有注册的服务器实例
- 提供实例注册、注销和状态更新功能
- 实现心跳检测和健康状态监控
- 支持事件驱动的状态变更通知

**核心功能**:
- `RegisterServerInstance()`: 注册新服务器实例
- `UnregisterServerInstance()`: 注销服务器实例
- `UpdateHeartbeat()`: 更新心跳状态
- `CheckHeartbeatTimeout()`: 心跳超时检查

### 3. 服务器实例信息 (ServerInstanceInfo)

**位置**: `AppManager.cs` (已存在)

**功能**:
- 定义服务器实例的基本信息结构
- 包含实例状态、版本、连接信息等

## 技术实现

### 依赖关系

```xml
<ProjectReference Include="..\RUINORERP.PacketSpec\RUINORERP.PacketSpec.csproj" />
<ProjectReference Include="..\RUINORERP.Global\RUINORERP.Global.csproj" />
<ProjectReference Include="..\RUINORERP.Model\RUINORERP.Model.csproj" />
```

### 关键技术

1. **SuperSocket**: 用于网络通信和会话管理
2. **并发字典**: 用于线程安全的会话和实例管理
3. **定时器**: 用于心跳检测和状态监控
4. **事件驱动**: 用于状态变更通知

## 会话状态管理

### 会话状态枚举 (SessionStatus)

- `Connected`: 已连接
- `Authenticated`: 已认证
- `Active`: 活动中
- `Idle`: 空闲中
- `Disconnected`: 已断开
- `Error`: 错误状态
- `Timeout`: 超时状态

### 服务器实例状态 (ServerInstanceStatus)

- `Online`: 在线
- `Offline`: 离线
- `Exception`: 异常

## 心跳机制

### 心跳检测流程

1. **注册心跳**: 服务器实例注册时设置初始心跳时间
2. **心跳更新**: 定期接收业务服务器的心跳包
3. **超时检查**: 定时检查心跳是否超时
4. **状态更新**: 根据心跳状态更新实例状态

### 心跳超时设置

```csharp
private const int HEARTBEAT_TIMEOUT = 30000; // 30秒超时
```

## 事件系统

### 支持的事件类型

1. **ServerInstanceRegistered**: 服务器实例注册事件
2. **ServerInstanceUnregistered**: 服务器实例注销事件
3. **ServerInstanceStatusChanged**: 服务器实例状态变化事件

## 数据模型

### 核心数据类

- `ServerSession`: 会话信息模型
- `ServerInstanceInfo`: 服务器实例信息模型
- `SessionPerformanceStats`: 会话性能统计
- `SessionStatistics`: 会话统计信息

## 配置管理

项目使用标准 .NET 配置系统，支持：
- 应用设置 (appsettings.json)
- 环境变量配置
- 命令行参数

## 监控和诊断

### 内置监控功能

1. **会话统计**: 连接数、断开数、当前连接数等
2. **性能监控**: 吞吐量、请求处理速度等
3. **健康检查**: 系统健康状态评估
4. **错误统计**: 错误计数和分类

## 扩展性设计

### 插件化架构

- 支持通过接口扩展功能
- 模块化设计便于功能扩展
- 事件系统支持自定义处理程序

### 配置驱动

- 关键参数可通过配置文件调整
- 支持动态配置更新
- 环境特定的配置支持

## 安全性考虑

1. **会话验证**: 确保会话有效性检查
2. **心跳安全**: 防止恶意心跳攻击
3. **状态隔离**: 不同服务器实例的状态隔离
4. **错误处理**: 完善的异常处理机制

## 部署说明

### 系统要求

- .NET 8.0 运行时
- Windows 服务器环境
- 网络端口配置

### 部署步骤

1. 编译项目生成可执行文件
2. 配置应用设置文件
3. 设置网络端口和防火墙规则
4. 启动管理服务器

## 故障排除

### 常见问题

1. **会话断开**: 检查网络连接和心跳设置
2. **状态异常**: 验证实例注册流程
3. **性能问题**: 监控系统资源使用情况

### 日志记录

- 详细的会话操作日志
- 错误和异常记录
- 性能指标日志

---

*此文档为框架性说明，具体实现细节和配置参数需要根据实际使用场景进行补充。*

**文档版本**: 1.0  
**最后更新**: 2026-01-02  
**维护者**: RUINORERP 开发团队


需要在当前项目中添加目录：Model
有用户注册表，这个用户是指软件使用公司的信息。
并且有保存注册时的信息，这个项目会能提供注册功能
所以需要实现一个 根据 中间业务层服务器提供的机器码。生成注册码的功能。并且能检测查验，并且有更新的功能。如因为服务器硬件问题。客户的中间业务服务器的电脑需要更换，则原来的整个注册过程生成的机器码也能重新生成。重新更新注册信息。