# 状态管理系统 V3增强版 - 业务性状态动态管理

## 概述

状态管理系统V3增强版在原有基础上增加了对业务性状态(BusinessStatus)的动态支持，使系统能够更好地适应不同业务场景下的状态管理需求。业务性状态是指在特定业务场景下，不同单据或实体所具有的业务状态，如付款状态、退款状态、审批状态等。

## 业务性状态动态管理架构

### 核心组件

#### 1. IBusinessStatusManager 接口

`IBusinessStatusManager` 是业务性状态管理的核心接口，定义了业务性状态动态管理的基本功能：

- **业务状态类型注册**: `RegisterBusinessStatusType` - 注册业务状态类型及其配置
- **状态转换规则注册**: `RegisterBusinessTransitionRule` - 注册业务状态转换规则
- **状态转换验证**: `ValidateBusinessTransition` - 验证业务状态转换是否允许
- **状态转换执行**: `ExecuteBusinessTransition` - 执行业务状态转换
- **操作权限管理**: `RegisterBusinessActionRule`, `CheckBusinessActionPermission` - 管理业务状态下的操作权限
- **状态信息获取**: `GetBusinessStatusDisplayInfo`, `GetBusinessStatusMetadata` - 获取业务状态的显示信息和元数据

#### 2. BusinessStatusManager 实现类

`BusinessStatusManager` 是 `IBusinessStatusManager` 接口的默认实现，提供了完整的业务性状态动态管理功能：

- 支持多种业务状态类型的动态注册和管理
- 提供灵活的状态转换规则定义和验证机制
- 支持基于角色的操作权限控制
- 提供业务上下文感知的状态管理

#### 3. UnifiedStateManagerExtensions 扩展类

`UnifiedStateManagerExtensions` 为统一状态管理器添加了业务性状态动态支持的扩展方法：

- 将业务性状态管理集成到统一状态管理框架中
- 提供业务性状态与数据状态、审批状态的统一管理
- 支持实体状态信息的统一获取和操作

### 关键数据结构

#### 1. BusinessContext

```csharp
public class BusinessContext
{
    public string CurrentUser { get; set; }          // 当前用户
    public string[] UserRoles { get; set; }          // 用户角色
    public string CurrentModule { get; set; }         // 当前模块
    public string CurrentOperation { get; set; }     // 当前操作
    public object Entity { get; set; }               // 当前实体
    public string BusinessType { get; set; }         // 业务类型
    public string Department { get; set; }           // 部门
    public bool IsUrgent { get; set; }               // 是否紧急
    public decimal Amount { get; set; }              // 金额
    public Dictionary<string, object> AdditionalData { get; set; }  // 附加数据
}
```

#### 2. BusinessStatusTypeConfiguration

```csharp
public class BusinessStatusTypeConfiguration
{
    public string Name { get; set; }                  // 状态类型名称
    public string Description { get; set; }          // 描述
    public string[] ApplicableModules { get; set; }   // 适用模块
    public bool SupportsDynamicStatus { get; set; }  // 是否支持动态状态
    public IBusinessStatusValueProvider StatusValueProvider { get; set; }  // 状态值提供程序
}
```

#### 3. BusinessTransitionRule

```csharp
public class BusinessTransitionRule
{
    public string Name { get; set; }                 // 规则名称
    public string Description { get; set; }          // 规则描述
    public Func<BusinessContext, bool> Validator { get; set; }  // 验证函数
    public bool RequiresApproval { get; set; }       // 是否需要审批
    public Func<BusinessContext, BusinessTransitionResult> PreTransitionHandler { get; set; }  // 前置处理
    public Func<BusinessContext, BusinessTransitionResult> PostTransitionHandler { get; set; }  // 后置处理
}
```

#### 4. BusinessActionRule

```csharp
public class BusinessActionRule
{
    public string ActionName { get; set; }           // 操作名称
    public string Description { get; set; }           // 操作描述
    public string[] ApplicableRoles { get; set; }    // 适用角色
    public Func<BusinessContext, bool> PermissionValidator { get; set; }  // 权限验证函数
}
```

## 业务性状态动态管理功能

### 1. 业务状态类型注册

系统支持动态注册业务状态类型，每种状态类型可以有自己的配置和状态值提供程序：

```csharp
// 注册付款状态类型
var paymentStatusConfig = new BusinessStatusTypeConfiguration
{
    Name = "付款状态",
    Description = "付款单的状态管理",
    ApplicableModules = new[] { "财务", "付款管理" },
    SupportsDynamicStatus = false,
    StatusValueProvider = new EnumStatusValueProvider<PaymentStatus>()
};

businessStatusManager.RegisterBusinessStatusType(typeof(PaymentStatus), paymentStatusConfig);
```

### 2. 状态转换规则定义

系统支持为业务状态类型定义灵活的状态转换规则：

```csharp
// 注册付款状态转换规则
businessStatusManager.RegisterBusinessTransitionRule(
    typeof(PaymentStatus), 
    PaymentStatus.草稿, 
    PaymentStatus.待审核, 
    new BusinessTransitionRule
    {
        Name = "提交审核",
        Description = "提交付款单进行审核",
        Validator = ctx => ctx.UserRoles.Contains("财务员"),
        RequiresApproval = true
    });
```

### 3. 操作权限管理

系统支持为业务状态下的操作定义权限规则：

```csharp
// 注册付款状态操作权限规则
businessStatusManager.RegisterBusinessActionRule(
    typeof(PaymentStatus), 
    PaymentStatus.草稿, 
    "编辑", 
    new BusinessActionRule
    {
        ActionName = "编辑",
        Description = "编辑草稿状态的付款单",
        PermissionValidator = ctx => ctx.UserRoles.Contains("财务员"),
        ApplicableRoles = new[] { "财务员", "财务主管" }
    });
```

### 4. 状态转换验证与执行

系统提供状态转换验证和执行功能，支持业务上下文感知：

```csharp
// 创建业务上下文
var context = new BusinessContext
{
    CurrentUser = "张三",
    UserRoles = new[] { "财务员" },
    CurrentModule = "付款管理",
    CurrentOperation = "提交审核",
    BusinessType = "付款单",
    Amount = 10000m
};

// 验证状态转换
var validationResult = businessStatusManager.ValidateBusinessTransition(
    typeof(PaymentStatus), 
    PaymentStatus.草稿, 
    PaymentStatus.待审核, 
    context);

if (validationResult.IsAllowed)
{
    // 执行状态转换
    var transitionResult = businessStatusManager.ExecuteBusinessTransition(
        typeof(PaymentStatus), 
        paymentEntity, 
        PaymentStatus.草稿, 
        PaymentStatus.待审核, 
        context);
}
```

## 与统一状态管理器的集成

业务性状态动态管理通过 `UnifiedStateManagerExtensions` 扩展类与统一状态管理器集成，提供以下功能：

### 1. 统一状态管理

```csharp
// 注册业务状态类型到统一状态管理器
unifiedStateManager.RegisterBusinessStatusType(typeof(PaymentStatus), paymentStatusConfig);

// 注册业务状态转换规则到统一状态管理器
unifiedStateManager.RegisterBusinessTransitionRule(
    typeof(PaymentStatus), 
    PaymentStatus.草稿, 
    PaymentStatus.待审核, 
    transitionRule);
```

### 2. 实体状态信息获取

```csharp
// 获取实体的所有状态信息
var entityStatuses = unifiedStateManager.GetEntityStatuses(paymentEntity, context);

foreach (var statusInfo in entityStatuses)
{
    Console.WriteLine($"属性: {statusInfo.PropertyName}, 状态: {statusInfo.DisplayInfo.DisplayText}");
}
```

### 3. 实体可用操作获取

```csharp
// 获取实体的可用操作列表
var availableActions = unifiedStateManager.GetEntityAvailableActions(paymentEntity, context);

foreach (var actionInfo in availableActions)
{
    if (actionInfo.IsAllowed)
    {
        Console.WriteLine($"可用操作: {actionInfo.ActionName}");
    }
}
```

## 默认业务状态类型

系统预注册了以下默认业务状态类型：

### 1. 付款状态 (PaymentStatus)

- 草稿 → 待审核 → 已支付
- 支持编辑、删除、审核等操作

### 2. 预付款状态 (PrePaymentStatus)

- 草稿 → 待审核 → 已生效 → 待核销 → 部分核销 → 全额核销 → 已结案
- 支持编辑、删除、审核、核销等操作

### 3. 应收应付状态 (ARAPStatus)

- 草稿 → 待审核 → 待支付 → 部分支付 → 全部支付 → 已冲销
- 支持编辑、删除、审核、支付、冲销等操作

### 4. 退款状态 (RefundStatus)

- 未退款等待退货 → 已退款等待退货 / 未退款已退货 → 已退款已退货
- 支持退款、退货等操作

### 5. 审批状态 (ApprovalStatus)

- 未审核 → 已审核
- 支持审核操作

## 业务上下文感知

业务性状态动态管理支持业务上下文感知，可以根据不同的业务场景提供不同的状态管理行为：

### 1. 基于角色的权限控制

```csharp
var rule = new BusinessTransitionRule
{
    Validator = ctx => ctx.UserRoles.Contains("财务主管"),
    // ...
};
```

### 2. 基于业务类型的规则

```csharp
var rule = new BusinessTransitionRule
{
    Validator = ctx => ctx.BusinessType == "紧急付款" ? ctx.Amount <= 50000 : true,
    // ...
};
```

### 3. 基于部门的权限控制

```csharp
var rule = new BusinessActionRule
{
    PermissionValidator = ctx => ctx.Department == "财务部",
    // ...
};
```

## 扩展性

业务性状态动态管理具有良好的扩展性，支持：

### 1. 自定义状态值提供程序

```csharp
public class CustomStatusValueProvider : IBusinessStatusValueProvider
{
    public IEnumerable<object> GetAllStatusValues(BusinessContext context)
    {
        // 根据业务上下文返回动态状态值
        return context.BusinessType == "特殊业务" 
            ? new[] { "特殊状态1", "特殊状态2" } 
            : new[] { "常规状态1", "常规状态2" };
    }
    
    // 实现其他接口方法...
}
```

### 2. 动态状态类型

系统支持动态状态类型，可以根据业务上下文动态生成状态值：

```csharp
var dynamicStatusConfig = new BusinessStatusTypeConfiguration
{
    Name = "动态状态",
    Description = "根据业务上下文动态生成的状态",
    SupportsDynamicStatus = true,
    StatusValueProvider = new DynamicStatusValueProvider()
};
```

### 3. 自定义转换规则

系统支持复杂的转换规则定义，包括前置和后置处理：

```csharp
var complexRule = new BusinessTransitionRule
{
    Name = "复杂转换",
    Description = "包含前置和后置处理的复杂转换",
    Validator = ctx => ctx.Amount <= 10000 && ctx.UserRoles.Contains("财务主管"),
    RequiresApproval = true,
    PreTransitionHandler = ctx => {
        // 前置处理逻辑
        return new BusinessTransitionResult { IsSuccess = true };
    },
    PostTransitionHandler = ctx => {
        // 后置处理逻辑
        return new BusinessTransitionResult { IsSuccess = true };
    }
};
```

## 总结

状态管理系统V3增强版通过引入业务性状态动态管理功能，使系统能够更好地适应不同业务场景下的状态管理需求。该架构具有以下优势：

1. **灵活性**: 支持动态注册业务状态类型和转换规则
2. **扩展性**: 支持自定义状态值提供程序和转换规则
3. **上下文感知**: 根据业务上下文提供不同的状态管理行为
4. **统一管理**: 与统一状态管理器集成，提供一致的状态管理接口
5. **权限控制**: 支持基于角色和业务场景的细粒度权限控制

通过这些功能，系统可以更好地支持企业复杂的业务流程和状态管理需求。