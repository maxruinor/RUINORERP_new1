# 网络服务器端口占用检查功能

## 概述

为了提高用户体验，我们在 NetworkServer.cs 中添加了端口占用检查功能，当服务器启动时如果发现端口已被占用，会提供友好的错误信息和解决方案。

## 功能特点

1. **启动前端口检查**：在服务器启动前检查所有配置的端口是否已被占用
2. **友好的错误提示**：提供清晰的错误信息和多种解决方案
3. **动态端口支持**：支持检查配置文件中定义的所有端口
4. **详细的解决方案**：提供检查端口占用、查看进程、终止进程等具体命令

## 实现细节

### 新增方法

1. **GetConfiguredPorts()**：获取所有配置的端口列表
   - 主端口 (Serverport)
   - 配置文件中的监听器端口
   - SuperSocket配置的端口

2. **IsPortInUse(int port)**：检查指定端口是否已被占用
   - 使用TcpClient尝试连接端口
   - 检查所有网络接口的TCP连接

3. **HandlePortAlreadyInUse(int port)**：处理端口已被占用的情况
   - 显示友好的错误信息
   - 提供多种解决方案
   - 在控制台显示彩色错误信息

4. **IsPortOccupiedException(Exception ex)**：检查异常是否为端口占用异常
   - 检查SocketException错误码10048
   - 检查异常消息中的关键字

5. **HandlePortOccupiedException(Exception ex)**：处理端口占用异常
   - 显示详细的错误信息和解决方案

### 修改方法

1. **StartAsync()**：在启动前添加端口检查逻辑
2. **异常处理**：增强异常处理，提供更友好的错误信息

## 使用方法

### 配置文件示例

在 appsettings.json 中配置端口：

```json
{
  "serverOptions": {
    "listeners": [
      {
        "ip": "Any",
        "port": 3009
      },
      {
        "ip": "192.168.3.1",
        "port": 2020
      }
    ],
    "superSocket": {
      "port": 6666
    }
  }
}
```

### 错误信息示例

当端口被占用时，系统会显示以下错误信息：

```
=========================================
端口已被占用！

当前尝试使用的端口: 3009

解决方案:
1. 检查端口占用情况:
   netstat -ano | findstr :3009

2. 查看占用端口的进程:
   for /f "tokens=5" %a in ('netstat -ano ^| findstr :3009') do tasklist | findstr %a

3. 终止占用端口的进程(可选):
   taskkill /PID [进程ID] /F

4. 或者修改配置文件中的端口设置:
   配置文件路径: RUINORERP.Server/appsettings.json
   当前使用端口: 3009

5. 重启应用程序
=========================================
```

## 测试工具

我们提供了两个测试工具：

1. **PortCheckTest.cs**：端口检查测试类
   - 测试常见端口的占用情况
   - 显示端口占用的详细信息

2. **ConsoleApp**：简单的控制台应用程序
   - 运行端口检查测试
   - 提供交互式界面

### 运行测试

```bash
cd RUINORERP.Server/ConsoleApp
dotnet run
```

## 注意事项

1. 端口检查在服务器启动前进行，可以提前发现问题
2. 所有配置的端口都会被检查，确保没有冲突
3. 错误信息同时输出到日志和控制台，便于用户查看
4. 提供的解决方案都是Windows系统下的命令，其他系统需要相应调整

## 后续改进

1. 可以添加自动端口选择功能，当端口被占用时自动选择可用端口
2. 可以添加端口释放功能，自动终止占用端口的非关键进程
3. 可以添加更多操作系统的支持，提供跨平台的解决方案