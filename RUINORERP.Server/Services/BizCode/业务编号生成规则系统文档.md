# 业务编号生成规则系统文档

## 概述

本文档详细介绍了RUINORERP系统中的业务编号生成规则系统的结构、实现和使用方法。该系统负责生成各类业务单据和基础信息的唯一编号，如订单号、产品编号、员工编号等。

## 系统结构

业务编号生成规则系统主要由以下几个核心组件构成：

1. **tb_sys_BillNoRule模型**：存储编号规则配置的数据库模型
2. **BNRFactory**：编号生成的核心工厂类
3. **RuleAnalysis**：规则字符串的解析类
4. **ServerBizCodeGenerateService**：业务编号生成服务，提供各种类型编号的生成方法

## 规则类型区分

为了更好地区分不同类型的编号生成规则，系统中引入了两种规则类型：

### 1. 单据类规则（BillRule）

- 规则类型值：0
- 适用场景：各类业务单据编号，如订单号、发票号、入库单号等
- 特点：通常包含日期信息，按日期或周期重置流水号
- 示例：订单号 `SO20231101001`，包含前缀、日期和流水号

### 2. 基础类规则（BaseInfoRule）

- 规则类型值：1
- 适用场景：基础信息编号，如产品编号、SKU编号、员工编号、部门编号等
- 特点：通常不包含日期信息，流水号全局递增
- 示例：产品编号 `P001`，员工编号 `EMP001`

## tb_sys_BillNoRule模型字段说明

| 字段名 | 数据类型 | 说明 | 默认值 |
|--------|----------|------|--------|
| BillNoRuleID | bigint | 主键ID | - |
| RuleName | varchar(200) | 规则名称 | - |
| BizType | int | 业务类型 | - |
| Prefix | varchar(200) | 前缀 | - |
| DateFormat | int | 日期格式 | - |
| SequenceLength | int | 流水号长度 | - |
| UseCheckDigit | bit | 是否使用校验位 | - |
| RedisKeyPattern | varchar(3000) | Redis键模式 | NULL |
| ResetMode | int | 重置模式 | - |
| IsActive | bit | 是否启用 | true |
| Description | varchar(200) | 规则描述 | NULL |
| RuleType | int | 规则类型：0-单据类规则，1-基础类规则 | 0 (单据类规则) |
| Created_at | datetime | 创建时间 | NULL |
| Created_by | bigint | 创建人 | NULL |
| Modified_at | datetime | 修改时间 | NULL |
| Modified_by | bigint | 修改人 | NULL |

## 使用方法

### 生成单据类编号

```csharp
// 生成订单编号
string orderNo = await _bizCodeGenerateService.GenerateBizBillNoAsync(BizType.SaleOrder);

// 生成入库单号
string inboundNo = await _bizCodeGenerateService.GenerateBizBillNoAsync(BizType.StockInbound);
```

### 生成基础类编号

```csharp
// 生成员工编号
string employeeNo = await _bizCodeGenerateService.GenerateBaseInfoNoAsync(BaseInfoType.Employee);

// 生成部门编号
string departmentNo = await _bizCodeGenerateService.GenerateBaseInfoNoAsync(BaseInfoType.Department);
```

### 生成产品相关编号

```csharp
// 生成产品编号（指定类别ID）
string productNo = await _bizCodeGenerateService.GenerateProductNoAsync(categoryId, customPrefix: "P", includeDate: true);

// 生成SKU编号
string skuNo = await _bizCodeGenerateService.GenerateProductSKUNoAsync(productId, productCode);
```

## 规则配置示例

### 1. 配置单据类规则（以销售订单为例）

```csharp
// 创建规则配置对象
var ruleConfig = new tb_sys_BillNoRule
{
    RuleName = "销售订单编号规则",
    BizType = (int)BizType.SaleOrder,
    Prefix = "SO",
    DateFormat = 1, // 表示yyyyMMdd格式
    SequenceLength = 4,
    UseCheckDigit = false,
    ResetMode = 1, // 表示每天重置
    IsActive = true,
    Description = "销售订单编号生成规则",
    RuleType = (int)RuleType.BillRule // 单据类规则
};

// 保存规则配置
await _bizCodeGenerateService.SaveRuleConfigAsync(ruleConfig);
```

### 2. 配置基础类规则（以产品编号为例）

```csharp
// 创建规则配置对象
var ruleConfig = new tb_sys_BillNoRule
{
    RuleName = "产品编号规则",
    BizType = (int)BaseInfoType.ProductNo,
    Prefix = "P",
    SequenceLength = 6,
    UseCheckDigit = true,
    IsActive = true,
    Description = "产品编号生成规则",
    RuleType = (int)RuleType.BaseInfoRule // 基础类规则
};

// 保存规则配置
await _bizCodeGenerateService.SaveRuleConfigAsync(ruleConfig);
```

## 规则格式说明

业务编号生成规则使用特定格式的字符串表示，支持以下参数类型：

- `{S:value}`: 常量值，直接插入到生成的编号中
- `{D:format}`: 日期值，format为日期格式字符串
- `{Hex:format}`: 十六进制日期值
- `{DB:pattern}`: 数据库递增序号，pattern为序号模式

### 规则示例

1. 销售订单号：`{S:SO}{D:yyyyMMdd}{DB:SO/0000}`
   - 生成结果：`SO202311010001`

2. 产品编号：`{S:P}{DB:P/000000}`
   - 生成结果：`P000001`

3. 员工编号：`{S:EMP}{DB:EMP/000}`
   - 生成结果：`EMP001`

## 性能优化建议

1. **引入缓存机制**
   - 在`GetBillNoRuleFromDatabaseAsync`、`GetBaseInfoRuleFromDatabaseAsync`等方法中可以添加缓存机制，减少数据库查询
   - 建议使用内存缓存或分布式缓存如Redis存储规则配置

2. **批量生成优化**
   - 对于需要批量生成编号的场景，建议优化实现方式，减少重复操作

3. **错误处理**
   - 系统已经添加了完善的错误处理机制，确保在任何情况下都能生成有效的编号

## 常见问题与解决方案

1. **编号冲突**
   - 原因：多线程并发生成或缓存不一致
   - 解决：使用数据库事务或分布式锁确保唯一性

2. **规则更新不生效**
   - 原因：可能存在缓存未刷新
   - 解决：更新规则时清除相关缓存

3. **性能问题**
   - 原因：频繁查询数据库或复杂规则计算
   - 解决：实现缓存机制，优化规则解析算法

## 注意事项

1. 数据库表结构变更后，需要确保执行数据库迁移脚本，添加RuleType字段
2. 现有规则记录会默认使用RuleType=0（单据类规则），可根据需要手动调整
3. 新增规则时，务必明确指定RuleType字段，避免混淆
4. 对于自定义的编号生成需求，建议遵循系统设计的规则格式，以保持一致性