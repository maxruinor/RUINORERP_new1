所谓的红字冲销，红字单，比方  收款单的红字单， 就是创建一个对应的 收款单，只是金额为负数 并且状态标记为红冲或冲销


一、核销记录的核心作用
记录资金与业务的关联：明确每一笔收付款如何冲抵预收预付或应收应付。

支持反向操作：退款、红冲时需依赖核销记录进行逆向处理。

财务对账与审计：提供完整的资金流转证据链。

二、需要生成核销记录的场景
1. 预收款抵扣应收款
场景：客户预付订金，后续销售订单生成应收单，用预收款核销应收款。

操作流程：

预收款单审核后生成收款单（记录资金到账）。

不需要立即生成核销记录（此时仅完成收款，尚未关联业务单据）。

销售订单出库生成应收单后，手动或自动核销预收款。

此时生成核销记录，关联预收款单、应收单、收款单。

核销表记录：

sql
INSERT INTO tb_FM_PaymentSettlement 
(SettlementType, SourceId, TargetId, Amount, Currency)
VALUES 
('预收冲应收', @预收单ID, @应收单ID, @核销金额, 'CNY');
2. 收款单直接核销应收款
场景：客户按账期付款，直接支付应收款（无预收款）。

操作流程：

收款单审核后，手动或自动关联应收单。

需要生成核销记录，表明收款金额冲抵了应收款。

核销表记录：

sql
INSERT INTO tb_FM_PaymentSettlement 
(SettlementType, SourceId, TargetId, Amount, Currency)
VALUES 
('收款冲应收', @收款单ID, @应收单ID, @核销金额, 'CNY');
3. 预付冲应付
场景：预付供应商订金，后续采购入库生成应付单，用预付款冲抵应付。

操作流程：

预付款单审核后生成付款单（记录资金支出）。

采购入库生成应付单后，手动或自动核销预付款。

生成核销记录，关联预付款单、应付单、付款单。

核销表记录：

sql
INSERT INTO tb_FM_PaymentSettlement 
(SettlementType, SourceId, TargetId, Amount, Currency)
VALUES 
('预付冲应付', @预付单ID, @应付单ID, @核销金额, 'CNY');
三、不需要生成核销记录的场景
1. 预收款单生成收款单
场景：预收款单审核后，生成收款单并记录资金到账。

逻辑说明：

收款单仅记录资金流动（银行账户增加），此时尚未与业务单据（如应收单）关联。

无需生成核销记录，核销记录应在后续冲抵应收时生成。

2. 现金销售即时收款
场景：销售订单现金收款，直接完成资金核销（无挂账）。

逻辑说明：

应收单与收款单自动关联，核销由系统隐式完成。

可选生成核销记录（若需完整跟踪，建议生成）。

3. 预付款单生成付款单
场景：预付款单审核后，生成付款单记录资金支出。

逻辑说明：

付款单仅记录资金流出，核销记录应在后续冲抵应付单时生成。

四、核销记录的字段设计
表名：tb_FM_PaymentSettlement

sql
CREATE TABLE tb_FM_PaymentSettlement (
    SettlementId BIGINT PRIMARY KEY,
    SettlementType VARCHAR(20) NOT NULL,  -- 核销类型（预收冲应收、收款冲应收、预付冲应付等）
    SourceId BIGINT NOT NULL,             -- 来源单据ID（预收单/付款单/收款单）
    TargetId BIGINT NOT NULL,             -- 目标单据ID（应收单/应付单）
    Amount DECIMAL(18,2) NOT NULL,        -- 核销金额（原币）
    Currency VARCHAR(10) NOT NULL,        -- 币种
    SettlementDate DATETIME NOT NULL,     -- 核销日期
    IsReversed BIT DEFAULT 0,             -- 是否反向冲销（退款/红冲）
    ReversedSettlementId BIGINT           -- 关联的反向核销记录ID
);
五、关键设计原则
明确核销时机：

仅在资金与业务单据（应收/应付）关联时生成核销记录。

收付款单审核仅记录资金流动，不直接触发核销。

状态联动更新：

核销记录生成后，需更新预收/预付款单的 RemainAmount 和应收/应付单的 SettledAmount。

支持反向操作：

退款或红冲时，生成反向核销记录（IsReversed=1），并关联原记录。

多币种处理：

核销金额按原币记录，汇兑差异单独核算（如财务费用科目）。

六、用户操作示例
案例：预收款核销应收款
预收款单审核 → 生成收款单 → 资金到账（银行账户+1000 CNY）。

销售出库生成应收单 → 应收金额1000 CNY。

核销操作：选择预收款单与应收单，核销金额1000 CNY。

系统生成核销记录：

sql
INSERT INTO tb_FM_PaymentSettlement 
(SettlementType, SourceId, TargetId, Amount, Currency, SettlementDate)
VALUES 
('预收冲应收', 1, 1, 1000, 'CNY', GETDATE());
状态更新：

预收款单：RemainAmount -= 1000，状态更新为 全额核销。

应收单：SettledAmount += 1000，状态更新为 已结清。

总结
需要生成核销记录：资金与业务单据（应收/应付）直接冲抵时。

不需要生成核销记录：单纯记录资金流动（收付款）且未关联业务单据时。

设计核心：通过核销记录建立资金与业务的关联，确保财务数据可追溯，同时避免冗余记录。