# WebView2 集成和 URL 路由实施完成

## 实施时间
2026年1月15日

## 实施范围
本次实施完成了智能帮助系统的中期规划核心功能，包括：
1. ✅ WebView2 集成 - 实现富文本帮助显示
2. ✅ Markdown 渲染 - 支持 Markdown 格式
3. ✅ 代码语法高亮 - 增强代码块显示
4. ✅ URL 路由设计 - 为远程帮助做准备

## 新增文件

### 1. WebView2HelpPanel.cs
**位置**: `RUINORERP.UI/HelpSystem/Components/WebView2HelpPanel.cs`

**主要功能**:
- 使用 Microsoft Edge WebView2 控件替代传统 WebBrowser
- 支持 Markdown 内容自动识别和渲染
- 实现代码语法高亮
- 提供增强的导航功能（后退、前进、刷新）
- 支持页面缩放（Ctrl +/-）
- 自动降级到传统 WebBrowser（WebView2 不可用时）

**特性**:
```csharp
// 使用 WebView2 帮助面板
var helpPanel = new WebView2HelpPanel(content, context);

// 加载远程 URL
await helpPanel.LoadUrlAsync("https://help.example.com");

// 刷新内容
await helpPanel.RefreshContentAsync();
```

### 2. MarkdownRenderer.cs
**位置**: `RUINORERP.UI/HelpSystem/Components/MarkdownRenderer.cs`

**主要功能**:
- Markdown 到 HTML 的完整转换
- 支持标题、列表、代码块、表格等
- 支持行内格式（粗体、斜体、删除线）
- 支持链接和图片
- 支持特殊提示框

**支持的 Markdown 语法**:
```markdown
# 标题 1
## 标题 2
### 标题 3

**粗体**
*斜体*
~~删除线~~

`行内代码`

```csharp
// 代码块
```

> 引用块

- 无序列表项
1. 有序列表项

| 列1 | 列2 |
|------|------|
| 值1 | 值2 |

[链接](https://example.com)
![图片](image.png)

> [NOTE] 提示信息
> [WARNING] 警告信息
```

### 3. HelpUrlRouter.cs
**位置**: `RUINORERP.UI/HelpSystem/Core/HelpUrlRouter.cs`

**主要功能**:
- URL 路由系统（基于正则表达式）
- 可扩展的路由规则注册机制
- 支持本地文件和远程 URL
- 自动 URL 解析和处理

**支持的路由模式**:

本地文件路由:
- `help://local/form/{formName}` - 窗体帮助
- `help://local/control/{formName}/{controlName}` - 控件帮助
- `help://local/field/{entityName}/{fieldName}` - 字段帮助
- `help://local/module/{moduleName}` - 模块帮助
- `help://file/{path}` - 直接文件路径

远程帮助路由:
- `help://remote/api/help/{helpKey}` - 远程 API
- `help://remote/page/{pagePath}` - 远程页面

HTTP 远程链接:
- `https://example.com/help/*` - 自定义帮助服务器
- `https://*.github.io/ruinorerp-help/*` - GitHub Pages

## 修改文件

### 1. HelpManager.cs
**主要更改**:

添加的新功能:
```csharp
// WebView2 支持
public bool UseWebView2 { get; set; }

// 远程帮助支持
public bool EnableRemoteHelp { get; set; }
public string RemoteHelpUrl { get; set; }

// 显示 URL 帮助
public async Task ShowUrlHelpAsync(string url)

// 构建帮助 URL
public string BuildHelpUrl(string helpKey, HelpLevel level, bool useRemote = false)
```

### 2. HelpContext.cs
**主要更改**:

新增静态工厂方法:
```csharp
// 从 URL 创建帮助上下文
public static HelpContext FromUrl(string url)
```

## 编译错误修复

修复了以下编译错误:

1. **CS0023**: `result.IsSuccess` → `result.Success`
2. **CS0029/CS0030**: WebView2HelpPanel 类型转换问题 - 已通过正确使用 Form 基类解决
3. **CS0103**: `_cacheLock` 未找到 - 字段已存在，无需修改
4. **CS0117**: `HelpLevel.Entity` → 改为 `HelpLevel.Field`
5. **CS0266**: `TargetForm` → 改为 `FormType`
6. **CS0712/CS0723**: HelpContentMonitor 实例化 - 改为静态类调用
7. **CS1061**: 扩展方法调用 - 改为直接调用标准方法

## 使用示例

### 1. 基本使用

```csharp
// 显示帮助内容
HelpManager.Instance.ShowFormHelp(this);
HelpManager.Instance.ShowControlHelp(txtCustomerName);
```

### 2. 启用 WebView2

```csharp
// 在应用程序启动时配置
var helpManager = HelpManager.Instance;

// 启用 WebView2
helpManager.UseWebView2 = true;

// 启用远程帮助（可选）
helpManager.EnableRemoteHelp = true;
helpManager.RemoteHelpUrl = "https://help.yourdomain.com/";
```

### 3. 显示 URL 帮助

```csharp
// 显示本地文件帮助
await HelpManager.Instance.ShowUrlHelpAsync("help://local/form/UCSaleOrder");

// 显示远程帮助
await HelpManager.Instance.ShowUrlHelpAsync("help://remote/api/help/UCSaleOrder");

// 显示 HTTP 远程链接
await HelpManager.Instance.ShowUrlHelpAsync("https://help.example.com/sales/order");
```

### 4. 构建帮助 URL

```csharp
// 构建本地帮助 URL
string localUrl = HelpManager.Instance.BuildHelpUrl(
    "UCSaleOrder",
    HelpLevel.Form,
    useRemote: false
);

// 构建远程帮助 URL
string remoteUrl = HelpManager.Instance.BuildHelpUrl(
    "UCSaleOrder",
    HelpLevel.Form,
    useRemote: true
);
```

### 5. 创建 Markdown 帮助内容

在 `HelpContent/forms/UCSaleOrder.md` 文件中：

```markdown
# 销售订单

## 概述
销售订单模块用于管理客户订单信息，包括订单创建、修改、审批等功能。

## 主要功能

### 创建订单
1. 点击"新建"按钮
2. 填写客户信息
3. 添加订单明细
4. 保存订单

### 订单状态
- **草稿**: 订单创建后的初始状态
- **已提交**: 订单已提交审批
- **已审批**: 订单已通过审批
- **已拒绝**: 订单审批未通过

## 字段说明

| 字段名 | 说明 | 必填 |
|--------|------|------|
| 订单号 | 系统自动生成的唯一标识 | 是 |
| 客户名称 | 下单客户 | 是 |
| 订单日期 | 订单创建日期 | 是 |
| 总金额 | 订单总金额 | 是 |

## 代码示例

```csharp
// 创建销售订单
var order = new tb_SaleOrder();
order.CustomerID = customerId;
order.OrderDate = DateTime.Now;
order.TotalAmount = totalAmount;

await _saleOrderService.AddAsync(order);
```

> [NOTE] 订单编号由系统自动生成，无需手动输入。

> [WARNING] 删除订单将同时删除所有关联的订单明细。
```

## 文件结构

```
RUINORERP.UI/HelpSystem/
├── Components/
│   ├── WebView2HelpPanel.cs       [新增] WebView2 帮助面板
│   ├── MarkdownRenderer.cs         [新增] Markdown 渲染器
│   ├── HelpPanel.cs                [保留] 传统 WebBrowser 面板
│   ├── HelpTooltip.cs              智能提示
│   ├── DefaultHelpContentGenerator.cs
│   └── FieldNameRecognizer.cs
├── Core/
│   ├── HelpManager.cs              [更新] 帮助管理器
│   ├── HelpContext.cs              [更新] 帮助上下文
│   ├── HelpUrlRouter.cs            [新增] URL 路由管理器
│   ├── HelpLevel.cs
│   ├── HelpSearchResult.cs
│   ├── IHelpProvider.cs
│   ├── LocalHelpProvider.cs
│   ├── SmartHelpResolver.cs
│   ├── SmartHelpResolverEnhanced.cs
│   └── HelpContentMonitor.cs
└── Extensions/
    ├── HelpExtensions.cs
    └── KryptonHelpExtensions.cs
```

## 技术特性

### 1. WebView2 集成

**优势**:
- 更好的渲染性能
- 现代 CSS/JavaScript 支持
- 更好的安全性和稳定性
- 支持最新的 Web 标准

**兼容性**:
- 自动降级到 WebBrowser（WebView2 不可用时）
- 最小要求: .NET Framework 4.6.2
- 需要: Microsoft Edge WebView2 Runtime

### 2. Markdown 渲染

**特性**:
- 完整的 CommonMark 支持
- 扩展语法（表格、提示框）
- 代码语法高亮
- 响应式样式

### 3. URL 路由系统

**灵活性**:
- 可扩展的路由规则
- 支持多种 URL 类型
- 正则表达式匹配
- 自定义处理器

## 性能优化

1. **异步加载**
   - WebView2 异步初始化
   - 帮助内容异步加载

2. **缓存机制**
   - 帮助内容缓存
   - Markdown 渲染结果缓存

3. **资源管理**
   - 正确释放 WebView2 资源
   - 防止内存泄漏

## 下一步计划

### 短期（1-2周）
- [ ] 测试 WebView2 集成
- [ ] 测试 Markdown 渲染
- [ ] 测试 URL 路由
- [ ] 性能优化和调整

### 中期（1-2月）
- [ ] 远程帮助 API 集成
- [ ] 帮助内容在线更新
- [ ] 帮助搜索优化
- [ ] 离线模式支持

### 长期（3-6月）
- [ ] 模块化管理界面
- [ ] 用户反馈系统
- [ ] 帮助内容版本管理
- [ ] 多语言支持

## 总结

本次实施成功完成了 WebView2 集成和 URL 路由设计，为智能帮助系统提供了：

1. ✅ **现代化的帮助显示体验** - WebView2 提供更好的渲染性能
2. ✅ **灵活的内容格式** - 支持 Markdown、HTML 等多种格式
3. ✅ **强大的路由系统** - 支持本地文件和远程帮助
4. ✅ **良好的兼容性** - 自动降级机制确保系统稳定
5. ✅ **易于扩展** - 模块化设计便于后续功能开发

系统架构具有良好的扩展性，为后续功能开发奠定了坚实基础。

## 注意事项

### WebView2 Runtime

如果目标机器未安装 WebView2 Runtime：
- 系统会自动降级到传统 WebBrowser
- 远程帮助功能将不可用
- 建议用户安装 WebView2 Runtime

下载地址: https://go.microsoft.com/fwlink/p/?LinkId=2124703

### 远程帮助

远程帮助功能需要：
- 服务器端 API 支持
- 网络连接
- 正确的 RemoteHelpUrl 配置

建议先部署本地帮助，再逐步迁移到远程。

---

**实施完成时间**: 2026年1月15日  
**编译状态**: ✅ 无错误  
**测试状态**: ⏳ 待测试
