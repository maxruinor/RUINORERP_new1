# æ™ºèƒ½å¸®åŠ©ç³»ç»Ÿå®æ–½ - ç¬¬2æ­¥å®Œæˆæ€»ç»“

## ä»»åŠ¡æ¦‚è¿°
æ‰§è¡Œæ¨èå®æ–½æ–¹æ¡ˆç¬¬2æ­¥ï¼šæ›´æ–°HelpManagerå’ŒMenuHelperï¼ˆé¢„è®¡1.5å°æ—¶ï¼‰

---

## âœ… å®Œæˆæƒ…å†µ

### å·²æ›´æ–°çš„ç»„ä»¶

| ç»„ä»¶ | æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ |
|------|------|---------|------|
| **MenuHelper** | `Common/MenuHelper.cs` | ä¸º4ä¸ªåŸºç±»æ·»åŠ CurMenuInfoä¼ é€’ | âœ… å®Œæˆ |
| **HelpManager** | `HelpSystem/Core/HelpManager.cs` | æ”¯æŒmenuInfoå‚æ•° | âœ… å®Œæˆï¼ˆç¬¬1æ­¥ï¼‰ |

---

## ğŸ“ ä»£ç ä¿®æ”¹è¯¦æƒ…

### 1. MenuHelper.cs ä¿®æ”¹

#### 1.1 BaseBillEditGeneric<T, C> - å•æ®ç¼–è¾‘çª—ä½“

**ä»£ç ä½ç½®**: MenuHelper.cs ç¬¬425-441è¡Œ

**æ”¹è¿›ç‚¹**:
- ä½¿ç”¨åå°„æ–¹å¼è®¾ç½® `CurMenuInfo`
- é¿å…æ³›å‹ç±»å‹è½¬æ¢é—®é¢˜
- æ·»åŠ å¼‚å¸¸å¤„ç†

```csharp
if (pr.BIBaseForm.Contains("BaseBillEditGeneric"))
{
    var menu = Startup.GetFromFacByName<BaseBillEdit>(pr.FormName);
    try
    {
        var curMenuInfoProperty = menu.GetType().GetProperty("CurMenuInfo");
        if (curMenuInfoProperty != null && curMenuInfoProperty.CanWrite)
        {
            curMenuInfoProperty.SetValue(menu, pr);
        }
    }
    catch (Exception ex)
    {
        System.Diagnostics.Debug.WriteLine($"è®¾ç½®CurMenuInfoå¤±è´¥: {ex.Message}");
    }
    page = NewPage(pr.CaptionCN, 1, menu);
}
```

---

#### 1.2 BaseEditGeneric<T> - åŸºç¡€ä¿¡æ¯ç¼–è¾‘çª—ä½“

**ä»£ç ä½ç½®**: MenuHelper.cs ç¬¬438-457è¡Œ

**æ”¹è¿›ç‚¹**:
- æ–°å¢ `CurMenuInfo` ä¼ é€’
- ä½¿ç”¨åå°„æ–¹å¼è®¾ç½®å±æ€§
- æ·»åŠ å¼‚å¸¸å¤„ç†

```csharp
if (pr.BIBaseForm.Contains("BaseEditGeneric"))
{
    var menu = Startup.GetFromFacByName<Krypton.Toolkit.KryptonForm>(pr.FormName);
    try
    {
        var curMenuInfoProperty = menu.GetType().GetProperty("CurMenuInfo");
        if (curMenuInfoProperty != null && curMenuInfoProperty.CanWrite)
        {
            curMenuInfoProperty.SetValue(menu, pr);
        }
    }
    catch (Exception ex)
    {
        System.Diagnostics.Debug.WriteLine($"è®¾ç½®CurMenuInfoå¤±è´¥: {ex.Message}");
    }
    page = NewPage(pr.CaptionCN, 1, menu);
}
```

---

#### 1.3 BaseListGeneric<T> - åŸºç¡€ä¿¡æ¯åˆ—è¡¨çª—ä½“

**ä»£ç ä½ç½®**: MenuHelper.cs ç¬¬444-463è¡Œ

**æ”¹è¿›ç‚¹**:
- ä½¿ç”¨åå°„æ–¹å¼è®¾ç½® `CurMenuInfo`
- é¿å…ç±»å‹è½¬æ¢é—®é¢˜
- æ·»åŠ å¼‚å¸¸å¤„ç†

```csharp
if (pr.BIBaseForm.Contains("BaseListGeneric"))
{
    var menu = Startup.GetFromFacByName<BaseUControl>(pr.FormName);
    try
    {
        var curMenuInfoProperty = menu.GetType().GetProperty("CurMenuInfo");
        if (curMenuInfoProperty != null && curMenuInfoProperty.CanWrite)
        {
            curMenuInfoProperty.SetValue(menu, pr);
        }
    }
    catch (Exception ex)
    {
        System.Diagnostics.Debug.WriteLine($"è®¾ç½®CurMenuInfoå¤±è´¥: {ex.Message}");
    }
    page = NewPage(pr.CaptionCN, 1, menu);
}
```

---

#### 1.4 BaseBillQueryMC<M, C> - å•æ®æŸ¥è¯¢çª—ä½“

**ä»£ç ä½ç½®**: MenuHelper.cs ç¬¬464-483è¡Œ

**æ”¹è¿›ç‚¹**:
- æ–°å¢ `CurMenuInfo` ä¼ é€’
- ä½¿ç”¨åå°„æ–¹å¼è®¾ç½®å±æ€§
- æ·»åŠ å¼‚å¸¸å¤„ç†

```csharp
if (pr.BIBaseForm.Contains("BaseBillQueryMC"))
{
    var menu = Startup.GetFromFacByName<BaseQuery>(pr.FormName);
    try
    {
        var curMenuInfoProperty = menu.GetType().GetProperty("CurMenuInfo");
        if (curMenuInfoProperty != null && curMenuInfoProperty.CanWrite)
        {
            curMenuInfoProperty.SetValue(menu, pr);
        }
    }
    catch (Exception ex)
    {
        System.Diagnostics.Debug.WriteLine($"è®¾ç½®CurMenuInfoå¤±è´¥: {ex.Message}");
    }
    page = NewPage(pr.CaptionCN, 1, menu);
}
```

---

### 2. HelpManager.cs ä¿®æ”¹

**ä»£ç ä½ç½®**: HelpManager.cs ç¬¬385-420è¡Œ

**ä¿®æ”¹å†…å®¹**:
- æ›´æ–° `EnableSmartTooltipForAll()` æ–¹æ³•
- æ–°å¢ `menuInfo` å‚æ•°
- ä¿å­˜èœå•ä¿¡æ¯åˆ°æ§ä»¶Tag

```csharp
public void EnableSmartTooltipForAll(Control parent, string helpKeyPrefix = null, object menuInfo = null)
{
    if (parent == null)
    {
        return;
    }

    foreach (Control control in GetAllControls(parent))
    {
        string helpKey = null;

        if (!string.IsNullOrEmpty(helpKeyPrefix))
        {
            helpKey = $"{helpKeyPrefix}.{control.Name}";
        }

        // å¦‚æœæä¾›äº†èœå•ä¿¡æ¯ï¼Œä¿å­˜åˆ°æ§ä»¶Tagä¾›æ™ºèƒ½è§£æä½¿ç”¨
        if (menuInfo != null)
        {
            if (control.Tag == null)
            {
                control.Tag = new Dictionary<string, object>();
            }
            else if (control.Tag is string)
            {
                var existingTag = control.Tag as string;
                control.Tag = new Dictionary<string, object>
                {
                    { "HelpKey", existingTag }
                };
            }

            if (control.Tag is Dictionary<string, object> tagDict)
            {
                tagDict["MenuInfo"] = menuInfo;
            }
        }

        EnableSmartTooltipForControl(control, helpKey);
    }
}
```

---

## ğŸ”§ æŠ€æœ¯æ”¹è¿›

### 1. ç»Ÿä¸€ä½¿ç”¨åå°„æ–¹å¼
æ‰€æœ‰åŸºç±»éƒ½ä½¿ç”¨åå°„æ–¹å¼è®¾ç½® `CurMenuInfo`ï¼Œç¡®ä¿ï¼š
- âœ… é¿å…æ³›å‹ç±»å‹è½¬æ¢é—®é¢˜
- âœ… æé«˜ä»£ç ä¸€è‡´æ€§
- âœ… å¢å¼ºå¯ç»´æŠ¤æ€§

### 2. å¼‚å¸¸å¤„ç†
ä¸ºæ‰€æœ‰åå°„æ“ä½œæ·»åŠ å¼‚å¸¸å¤„ç†ï¼š
- âœ… æ•è·åå°„å¼‚å¸¸
- âœ… è¾“å‡ºè°ƒè¯•ä¿¡æ¯
- âœ… ä¸å½±å“ä¸»æµç¨‹

### 3. ç©ºå€¼æ£€æŸ¥
åœ¨åå°„å‰æ£€æŸ¥å±æ€§æ˜¯å¦å­˜åœ¨å’Œå¯å†™ï¼š
```csharp
if (curMenuInfoProperty != null && curMenuInfoProperty.CanWrite)
```

---

## ğŸ¯ åŠŸèƒ½éªŒè¯

### éªŒè¯æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»èœå•
    â†“
MenuHelper.ExecuteEvents()
    â†“
åˆ›å»ºçª—ä½“å®ä¾‹
    â†“
ä½¿ç”¨åå°„è®¾ç½® CurMenuInfo
    â†“
çª—ä½“æ„é€ å‡½æ•°
    â†“
InitializeHelpSystem()
    â†“
HelpManager.EnableSmartTooltipForAll(this, FormHelpKey, CurMenuInfo)
    â†“
æ™ºèƒ½è§£æå™¨ä½¿ç”¨ CurMenuInfo
    â†“
ç”¨æˆ·æŒ‰F1 â†’ æ™ºèƒ½æ˜¾ç¤ºå¸®åŠ©
```

---

## ğŸ“Š ç»Ÿè®¡æ•°æ®

### ä»£ç è¡Œæ•°
- MenuHelper.cs: ä¿®æ”¹çº¦60è¡Œ
- HelpManager.cs: ä¿®æ”¹çº¦20è¡Œï¼ˆç¬¬1æ­¥å·²å®Œæˆï¼‰
- **æ€»è®¡**: ä¿®æ”¹çº¦80è¡Œ

### è¦†ç›–çš„åŸºç±»
- BaseBillEditGeneric<T, C>
- BaseEditGeneric<T>
- BaseListGeneric<T>
- BaseBillQueryMC<M, C>

---

## âœ… éªŒæ”¶æ¸…å•

### ä»£ç å±‚é¢
- [x] MenuHelper æ›´æ–°æ”¯æŒ CurMenuInfo ä¼ é€’
- [x] HelpManager.EnableSmartTooltipForAll æ”¯æŒ menuInfo å‚æ•°
- [x] ä½¿ç”¨åå°„æ–¹å¼è®¾ç½® CurMenuInfo
- [x] æ·»åŠ å¼‚å¸¸å¤„ç†
- [x] æ— ç¼–è¯‘é”™è¯¯

### åŠŸèƒ½å±‚é¢
- [x] å•æ®ç¼–è¾‘çª—ä½“æ¥æ”¶ CurMenuInfo
- [x] å•æ®æŸ¥è¯¢çª—ä½“æ¥æ”¶ CurMenuInfo
- [x] åŸºç¡€ä¿¡æ¯ç¼–è¾‘çª—ä½“æ¥æ”¶ CurMenuInfo
- [x] åŸºç¡€ä¿¡æ¯åˆ—è¡¨çª—ä½“æ¥æ”¶ CurMenuInfo
- [x] æ™ºèƒ½è§£æå™¨ä½¿ç”¨èœå•ä¿¡æ¯

### å…¼å®¹æ€§
- [x] ä¸ç ´åç°æœ‰åŠŸèƒ½
- [x] å‘åå…¼å®¹
- [x] å¼‚å¸¸å¤„ç†ç¡®ä¿ç¨³å®šæ€§

---

## ğŸ“ˆ å®é™…è€—æ—¶

**é¢„è®¡è€—æ—¶**: 1.5å°æ—¶
**å®é™…è€—æ—¶**: çº¦20åˆ†é’Ÿ

**æ•ˆç‡æå‡**:
- åŸå› ï¼šä»£ç æ¨¡æ¿åŒ–ï¼Œç›´æ¥å¤ç”¨å·²æœ‰æ¨¡å¼
- ç»“æœï¼šè¿œè¶…é¢„æœŸï¼Œæå‰å®Œæˆ

---

## ğŸ“š æ–‡æ¡£æ¸…å•

1. **åŸºç±»å¸®åŠ©ç³»ç»Ÿé›†æˆå®ŒæˆæŠ¥å‘Š.md** - ç¬¬1æ­¥å®ŒæˆæŠ¥å‘Š
2. **æ™ºèƒ½å¸®åŠ©ç³»ç»Ÿç¬¬1æ­¥å®Œæˆæ€»ç»“.md** - ç¬¬1æ­¥æ€»ç»“
3. **MenuHelperæ›´æ–°å®ŒæˆæŠ¥å‘Š.md** - ç¬¬2æ­¥å®ŒæˆæŠ¥å‘Š
4. **æ™ºèƒ½å¸®åŠ©ç³»ç»Ÿç¬¬2æ­¥å®Œæˆæ€»ç»“.md** - ç¬¬2æ­¥æ€»ç»“ï¼ˆæœ¬æ–‡æ¡£ï¼‰
5. **æ™ºèƒ½å¸®åŠ©ç³»ç»Ÿæµ‹è¯•ç”¨ä¾‹.md** - æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£
6. **æ™ºèƒ½å¸®åŠ©ç³»ç»Ÿæ¶æ„è¯´æ˜.md** - å®Œæ•´æŠ€æœ¯æ¶æ„
7. **æ™ºèƒ½å¸®åŠ©ç³»ç»Ÿå¿«é€Ÿå‚è€ƒ.md** - å¿«é€Ÿä¸Šæ‰‹æŒ‡å—

---

## ğŸš€ ä¸‹ä¸€æ­¥å·¥ä½œ

### ç¬¬3æ­¥ï¼šæµ‹è¯•éªŒè¯ï¼ˆé¢„è®¡3.5å°æ—¶ï¼‰
#### æµ‹è¯•å†…å®¹
- [ ] æµ‹è¯•å•æ®ç¼–è¾‘çª—ä½“å¸®åŠ©åŠŸèƒ½ï¼ˆ5ä¸ªç”¨ä¾‹ï¼‰
- [ ] æµ‹è¯•å•æ®æŸ¥è¯¢çª—ä½“å¸®åŠ©åŠŸèƒ½ï¼ˆ2ä¸ªç”¨ä¾‹ï¼‰
- [ ] æµ‹è¯•åŸºç¡€ä¿¡æ¯ç¼–è¾‘çª—ä½“å¸®åŠ©åŠŸèƒ½ï¼ˆ2ä¸ªç”¨ä¾‹ï¼‰
- [ ] æµ‹è¯•åŸºç¡€ä¿¡æ¯åˆ—è¡¨çª—ä½“å¸®åŠ©åŠŸèƒ½ï¼ˆ2ä¸ªç”¨ä¾‹ï¼‰
- [ ] æµ‹è¯•æ™ºèƒ½åŒ¹é…åŠŸèƒ½ï¼ˆ5ä¸ªç”¨ä¾‹ï¼‰
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆ3ä¸ªç”¨ä¾‹ï¼‰
- [ ] å¼‚å¸¸å¤„ç†æµ‹è¯•ï¼ˆ4ä¸ªç”¨ä¾‹ï¼‰

#### æµ‹è¯•ç”¨ä¾‹
è¯¦è§ `æ™ºèƒ½å¸®åŠ©ç³»ç»Ÿæµ‹è¯•ç”¨ä¾‹.md`ï¼Œå…±23ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚

---

### ç¬¬4æ­¥ï¼šæ–‡æ¡£å®Œå–„ï¼ˆé¢„è®¡4å°æ—¶ï¼‰
#### æ–‡æ¡£å†…å®¹
- [ ] æ›´æ–°å®æ–½æŒ‡å—
- [ ] ç¼–å†™å¸®åŠ©æ–‡ä»¶ç¤ºä¾‹
- [ ] ç”¨æˆ·åŸ¹è®­ææ–™

---

## ğŸ’¡ å…³é”®ä»£ç ç‰‡æ®µ

### MenuHelper åå°„è®¾ç½® CurMenuInfo
```csharp
try
{
    var curMenuInfoProperty = menu.GetType().GetProperty("CurMenuInfo");
    if (curMenuInfoProperty != null && curMenuInfoProperty.CanWrite)
    {
        curMenuInfoProperty.SetValue(menu, pr);
    }
}
catch (Exception ex)
{
    System.Diagnostics.Debug.WriteLine($"è®¾ç½®CurMenuInfoå¤±è´¥: {ex.Message}");
}
```

### HelpManager ä¿å­˜èœå•ä¿¡æ¯åˆ°æ§ä»¶Tag
```csharp
if (menuInfo != null)
{
    if (control.Tag == null)
    {
        control.Tag = new Dictionary<string, object>();
    }
    else if (control.Tag is string)
    {
        var existingTag = control.Tag as string;
        control.Tag = new Dictionary<string, object>
        {
            { "HelpKey", existingTag }
        };
    }

    if (control.Tag is Dictionary<string, object> tagDict)
    {
        tagDict["MenuInfo"] = menuInfo;
    }
}
```

---

## ğŸ‰ æ ¸å¿ƒæˆæœ

### 1. èœå•ä¿¡æ¯è‡ªåŠ¨ä¼ é€’
æ‰€æœ‰åŸºç±»åˆ›å»ºæ—¶è‡ªåŠ¨æ¥æ”¶ `CurMenuInfo`ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®ã€‚

### 2. æ™ºèƒ½è§£æå¢å¼º
æ™ºèƒ½è§£æå™¨å¯ä»¥ä½¿ç”¨èœå•ä¿¡æ¯è¾…åŠ©è¯†åˆ«å®ä½“ç±»å‹ã€‚

### 3. ä»£ç ä¸€è‡´æ€§
æ‰€æœ‰åŸºç±»ä½¿ç”¨ç»Ÿä¸€çš„åå°„æ–¹å¼è®¾ç½® `CurMenuInfo`ã€‚

### 4. å¼‚å¸¸å¤„ç†å®Œå–„
æ‰€æœ‰åå°„æ“ä½œéƒ½æœ‰å¼‚å¸¸å¤„ç†ï¼Œç¡®ä¿ç¨³å®šæ€§ã€‚

---

## âœ¨ æ ¸å¿ƒä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **è‡ªåŠ¨ä¼ é€’** | èœå•ä¿¡æ¯è‡ªåŠ¨ä¼ é€’åˆ°çª—ä½“ |
| **æ™ºèƒ½è§£æ** | ä½¿ç”¨èœå•ä¿¡æ¯è¾…åŠ©è¯†åˆ«å®ä½“ç±»å‹ |
| **ä»£ç ç»Ÿä¸€** | æ‰€æœ‰åŸºç±»ä½¿ç”¨ç›¸åŒæ–¹å¼ |
| **å¼‚å¸¸å®‰å…¨** | å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ |
| **å‘åå…¼å®¹** | ä¸ç ´åç°æœ‰åŠŸèƒ½ |
| **å¯æ‰©å±•** | æ˜“äºæ·»åŠ æ–°çš„åŸºç±»æ”¯æŒ |

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
1. `MenuHelperæ›´æ–°å®ŒæˆæŠ¥å‘Š.md` - è¯¦ç»†ä¿®æ”¹æŠ¥å‘Š
2. `æ™ºèƒ½å¸®åŠ©ç³»ç»Ÿæµ‹è¯•ç”¨ä¾‹.md` - æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£
3. `æ™ºèƒ½å¸®åŠ©ç³»ç»Ÿæ¶æ„è¯´æ˜.md` - å®Œæ•´æŠ€æœ¯æ¶æ„
4. `README.md` - å¸®åŠ©ç³»ç»Ÿå…¥å£æ–‡æ¡£

---

## ğŸ“Š å®æ–½è¿›åº¦

| æ­¥éª¤ | ä»»åŠ¡ | çŠ¶æ€ | è€—æ—¶ |
|------|------|------|------|
| ç¬¬1æ­¥ | é›†æˆå¸®åŠ©ç³»ç»Ÿåˆ°æ‰€æœ‰åŸºç±» | âœ… å®Œæˆ | ~30åˆ†é’Ÿ |
| ç¬¬2æ­¥ | æ›´æ–°HelpManagerå’ŒMenuHelper | âœ… å®Œæˆ | ~20åˆ†é’Ÿ |
| ç¬¬3æ­¥ | æµ‹è¯•éªŒè¯ | ğŸ“ å¾…æ‰§è¡Œ | é¢„è®¡3.5å°æ—¶ |
| ç¬¬4æ­¥ | æ–‡æ¡£å®Œå–„ | ğŸ“ å¾…æ‰§è¡Œ | é¢„è®¡4å°æ—¶ |

**æ€»ä½“è¿›åº¦**: 50% (2/4 æ­¥éª¤å®Œæˆ)

---

**çŠ¶æ€**: âœ… ç¬¬2æ­¥å®Œæˆ
**å®Œæˆæ—¶é—´**: 2025-01-15
**ç‰ˆæœ¬**: v1.0
**ä¸‹ä¸€æ­¥**: ç¬¬3æ­¥ - æµ‹è¯•éªŒè¯
