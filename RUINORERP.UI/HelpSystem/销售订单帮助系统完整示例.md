# 销售订单帮助系统 - 完整示例

## 一、帮助系统架构概览

### 1.1 四级帮助体系
```
模块级 (SalesManagement.md)
    ↓
窗体级 (UCSaleOrder.md)
    ↓
控件级 (txtCustomerName.md)
    ↓
字段级 (tb_SaleOrder.CustomerID.md)
```

### 1.2 文件目录结构
```
HelpContent/
├── index.md                          # 帮助系统首页
├── Modules/                          # 模块级帮助
│   └── SalesManagement.md            # 销售管理模块
├── Forms/                            # 窗体级帮助
│   ├── UCSaleOrder.md               # 销售订单窗体
│   └── UCSaleOrderQuery.md          # 销售订单查询窗体
└── Fields/                           # 字段级帮助
    └── tb_SaleOrder/                # 销售订单实体
        ├── CustomerID.md             # 客户字段
        ├── OrderNo.md               # 订单编号字段
        ├── OrderDate.md             # 订单日期字段
        └── DeliveryDate.md          # 交货日期字段
```

---

## 二、UCSaleOrder 窗体帮助配置

### 2.1 窗体代码中的帮助配置

```csharp
using RUINORERP.UI.HelpSystem.Core;
using RUINORERP.UI.HelpSystem.Extensions;

namespace RUINORERP.UI.PSI.SAL
{
    [MenuAttrAssemblyInfo("销售订单", ModuleMenuDefine.模块定义.进销存管理,
        ModuleMenuDefine.进销存管理.销售管理, BizType.销售订单)]
    public partial class UCSaleOrder : BaseBillEditGeneric<tb_SaleOrder, tb_SaleOrderDetail>, IPublicEntityObject
    {
        public UCSaleOrder()
        {
            InitializeComponent();

            // ✅ 关键配置: 设置窗体帮助键
            // 这个键将用于定位帮助文件: HelpContent/Forms/UCSaleOrder.md
            FormHelpKey = "UCSaleOrder";

            // ✅ 关键配置: 启用智能帮助
            // BaseBillEditGeneric已自动集成帮助系统
            EnableSmartHelp = true;

            // ✅ 可选: 为特定控件设置帮助键
            // 如果字段名称与帮助键不一致,可以手动指定
            txtCustomerID.SetHelpKey("tb_SaleOrder.CustomerID");
            txtOrderDate.SetHelpKey("tb_SaleOrder.OrderDate");
        }
    }
}
```

### 2.2 自动帮助键映射规则

如果不手动设置帮助键,系统会根据控件名称自动匹配:

| 控件名称 | 自动帮助键 | 帮助文件路径 |
|---------|-----------|-------------|
| txtCustomerID | tb_SaleOrder.CustomerID | Fields/tb_SaleOrder/CustomerID.md |
| txtOrderNo | tb_SaleOrder.OrderNo | Fields/tb_SaleOrder/OrderNo.md |
| txtOrderDate | tb_SaleOrder.OrderDate | Fields/tb_SaleOrder/OrderDate.md |

---

## 三、帮助内容示例

### 3.1 窗体级帮助 (UCSaleOrder.md)

```markdown
# 销售订单管理

## 概述
销售订单管理模块用于创建、修改、查询和审核销售订单。订单审核后可以进行出库操作。

## 功能说明

### 主要功能
1. **新建订单**: 创建新的销售订单
2. **修改订单**: 修改未审核或已反审核的订单
3. **查询订单**: 根据多种条件查询订单
4. **审核订单**: 提交订单到审核流程
5. **反审核**: 撤销审核,允许修改

### 工具栏按钮说明

| 按钮 | 功能 | 说明 |
|------|------|------|
| 新增 | 创建新订单 | 点击后打开空白的订单编辑界面 |
| 修改 | 修改订单 | 修改当前选中的订单 |
| 保存 | 保存订单 | 保存当前编辑的订单 |
| 提交 | 提交审核 | 将订单提交到审核流程 |
| 审核 | 审核订单 | 审核人员使用,审核通过后订单生效 |
| 反审 | 反审核 | 撤销审核,允许修改 |

## 操作流程

### 创建销售订单
1. 点击"新增"按钮
2. 选择客户(必填)
3. 选择产品并输入数量
4. 设置单价和折扣(可选)
5. 选择交货日期(必填)
6. 点击"保存"按钮
7. 点击"提交"按钮发送审核

## 注意事项
1. **必填字段**: 客户、交货日期、产品、数量
2. **数量验证**: 数量必须大于0
3. **价格验证**: 单价不能为负数
4. **审核规则**:
   - 金额小于5000元: 自动审核
   - 金额大于等于5000元: 需要主管审核
   - 金额大于等于10000元: 需要经理审核

## 常见问题

### Q: 为什么有些订单无法修改?
A: 已审核且未反审核的订单无法修改。需要先点击"反审核"按钮。

### Q: 订单审核后可以修改吗?
A: 审核后需要先反审核才能修改。反审核需要相应的权限。

## 相关功能
- [销售出库](../Modules/SalesManagement.md#销售出库)
- [客户管理](./UCCustomerList.md)
- [产品管理](./UCProdList.md)
```

### 3.2 字段级帮助 (CustomerID.md)

```markdown
# 客户

## 说明
选择订单的客户。客户信息影响价格政策、付款条件等。

## 使用方法
1. 点击客户输入框右侧的"..."按钮
2. 在弹出的客户列表中选择客户
3. 可以通过客户名称或编码快速搜索

## 注意事项
1. **必填项**: 客户为必填字段
2. **客户状态**: 只能选择"正常"状态的客户
3. **信用检查**: 如果客户信用超限,会显示警告提示
4. **价格政策**: 不同客户可能享受不同的价格折扣

## 快捷键
- `F4`: 打开客户选择列表
- `F1`: 查看帮助

## 相关信息
- [客户管理](../../Forms/UCCustomerList.md)
- [信用管理](../../Modules/CreditManagement.md)
```

---

## 四、帮助系统使用方式

### 4.1 F1键帮助
**操作**: 在任何界面按 `F1` 键

**效果**:
- 如果焦点在某个控件上,显示该控件的帮助
- 如果焦点在窗体,显示整个窗体的帮助

**示例场景**:
```
用户在UCSaleOrder窗体中
1. 将光标放在"客户"输入框
2. 按F1键
3. 显示 HelpContent/Fields/tb_SaleOrder/CustomerID.md
```

### 4.2 智能提示
**触发条件**: 鼠标悬停在控件上约500毫秒

**显示效果**: 简短的帮助气泡提示

**配置代码**:
```csharp
// 在窗体构造函数中自动调用
HelpManager.Instance.EnableSmartTooltipForAll(this, FormHelpKey);
```

**关闭智能提示**:
```csharp
// 如果用户不想要智能提示,可以禁用
EnableSmartHelp = false;
```

### 4.3 帮助按钮
**位置**: 各个输入框右侧的帮助图标按钮

**功能**: 点击显示详细帮助面板

**自动集成**:
```csharp
// BaseEdit.cs 中已集成
private void Bsa_Click(object sender, EventArgs e)
{
    if (EnableSmartHelp)
    {
        ButtonSpecAny bsa = sender as ButtonSpecAny;
        KryptonTextBox ktb = bsa.Owner as KryptonTextBox;
        ShowControlHelp(ktb);
    }
}
```

### 4.4 手动触发帮助
**场景**: 在代码中需要主动显示帮助

**代码示例**:
```csharp
// 显示窗体帮助
this.ShowFormHelp();

// 显示控件帮助
txtCustomerID.ShowHelp();

// 显示字段帮助
this.ShowFieldHelp(typeof(tb_SaleOrder), "CustomerID");
```

---

## 五、帮助内容管理

### 5.1 创建新的帮助文件

**步骤**:
1. 确定帮助级别(模块/窗体/字段)
2. 在对应目录创建 `.md` 文件
3. 使用Markdown格式编写内容
4. 文件命名规则:
   - 模块: `ModuleName.md`
   - 窗体: `FormName.md`
   - 字段: `Entity.FieldName.md`

### 5.2 帮助文件格式

**标准模板**:
```markdown
# 帮助标题

## 说明
帮助内容说明

## 使用方法
1. 第一步
2. 第二步
3. 第三步

## 注意事项
1. 注意事项1
2. 注意事项2

## 快捷键
- `F1`: 查看帮助
- `F4`: 快速选择

## 常见问题

### Q: 问题?
A: 答案

## 相关信息
- [相关帮助1](路径)
- [相关帮助2](路径)
```

### 5.3 帮助内容更新

**更新流程**:
1. 修改对应的 `.md` 文件
2. 保存文件
3. 重新加载帮助索引(可选):
   ```csharp
   HelpManager.Instance.ReloadHelpIndex();
   ```

**实时生效**: 帮助文件修改后会立即生效,无需重启应用

---

## 六、调试与故障排除

### 6.1 帮助不显示

**检查清单**:
1. ✅ 帮助文件路径是否正确
2. ✅ 帮助键是否匹配
3. ✅ EnableSmartHelp 是否为 true
4. ✅ 帮助文件是否存在

**调试代码**:
```csharp
// 检查帮助文件路径
string helpPath = HelpManager.Instance.HelpContentRootPath;
System.Diagnostics.Debug.WriteLine($"帮助路径: {helpPath}");

// 检查帮助数量
int count = HelpManager.Instance.GetHelpCount();
System.Diagnostics.Debug.WriteLine($"帮助数量: {count}");
```

### 6.2 帮助键不匹配

**问题**: 点击控件显示的帮助不正确

**解决方案**:
```csharp
// 方法1: 自动映射(推荐)
// 控件名称自动转换为帮助键
// txtCustomerID → tb_SaleOrder.CustomerID

// 方法2: 手动设置
txtCustomerID.SetHelpKey("自定义帮助键");
```

### 6.3 智能提示不工作

**检查点**:
1. EnableSmartTooltip 是否为 true
2. TooltipDelay 延迟时间设置
3. 控件是否启用了MouseHover事件

**配置代码**:
```csharp
// 延迟时间设置(毫秒)
HelpManager.Instance.TooltipDelay = 500;

// 启用/禁用
HelpManager.Instance.EnableSmartTooltip = true/false;
```

---

## 七、完整示例: 添加新字段帮助

### 场景: 为"折扣率"字段添加帮助

**步骤1**: 创建帮助文件
```
HelpContent/Fields/tb_SaleOrder/DiscountRate.md
```

**步骤2**: 编写内容
```markdown
# 折扣率

## 说明
订单的整体折扣率,以百分比表示。折扣率会影响订单的总金额计算。

## 使用方法
1. 直接输入折扣率数值
2. 或者从下拉列表选择常用折扣率

## 注意事项
1. **取值范围**: 0-100
2. **计算公式**: 折扣后金额 = 原金额 × (1 - 折扣率%)
3. **权限控制**: 折扣率可能需要主管审批
4. **折扣历史**: 系统会记录折扣历史

## 示例
| 原金额 | 折扣率 | 折扣后金额 |
|--------|--------|-----------|
| 1000 | 10% | 900 |
| 5000 | 5% | 4750 |
| 10000 | 15% | 8500 |

## 相关信息
- [价格管理](../../Modules/PriceManagement.md)
- [审批管理](../../Modules/ApprovalManagement.md)
```

**步骤3**: 验证帮助
```csharp
// 在窗体中测试
txtDiscountRate.Focus();
// 按F1键,应显示DiscountRate.md的内容
```

---

## 八、总结

### 关键点
1. ✅ **自动集成**: BaseBillEditGeneric已自动集成帮助系统
2. ✅ **智能匹配**: 控件名称自动映射到帮助键
3. ✅ **多级帮助**: 模块、窗体、控件、字段四级帮助
4. ✅ **Markdown格式**: 使用Markdown编写帮助内容
5. ✅ **实时生效**: 修改帮助文件后无需重启

### 快速开始
1. 在窗体中设置 `FormHelpKey`
2. 在 `HelpContent` 目录创建对应的 `.md` 文件
3. 按 `F1` 键查看帮助

### 后续改进
- 添加图片支持
- 添加视频教程
- 添加搜索功能
- 添加用户反馈
- 支持多语言
