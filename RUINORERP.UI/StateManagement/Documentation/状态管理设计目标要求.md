/**
 * 文件: 状态管理设计目标要求.md
 * 版本: V3 - 状态管理设计目标要求文档
 * 说明: RUINOR ERP状态管理系统设计目标和技术要求文档，定义V3版本架构设计原则
 * 创建日期: 2024年
 * 作者: RUINOR ERP开发团队
 * 
 * 版本标识：
 * V3: 状态管理系统设计目标和技术要求，包含架构设计原则、技术要求和UI集成要求
 * 公共文档: 状态管理系统设计规范，所有版本通用
 */

# 状态管理设计目标要求

## 1. 状态管理场景

用户在单据的录入，修改，保存，提交，审核时，需要根据当前状态进行判断和处理，以确保数据的一致性和业务流程的正确性。同时状态要与UI界面的按钮和label控件进行同步。

### 1.1 业务场景
1. **数据性状态 (DataStatus)**: 表示实体的数据生命周期状态
   - 草稿: 新创建但未提交的数据
   - 新建: 已提交但未确认的数据
   - 确认: 已确认但未完成的数据
   - 完结: 已完成的数据
   - 作废: 已作废的数据

2. **操作性状态 (ActionStatus)**: 表示对实体的操作类型
   - 无操作: 当前无操作
   - 新增: 正在新增实体
   - 修改: 正在修改实体
   - 删除: 正在删除实体
   - 加载: 正在加载实体
   - 复制: 正在复制实体

3. **业务性状态 (BusinessStatus)**: 表示实体的业务状态，由具体业务模块定义
   - 支持动态添加不同类型的业务状态
   - 每种业务状态类型可以有多个状态值
关键业务财务数据状态
    // 定义对账类型枚举
    public enum StatementType
    {
        余额对账=1,
        收款对账=2,
        付款对账=3
    }

操作性的关联了业务性的。如结案的。不能修改不能删除。不能提交不能审核。

- **新增后**：可以保存，保存后可以修改，保存后可以删除
- **修改后**：可以保存，保存后可以删除
- **删除后**：不能再进行修改
- **保存后**：可以提交，提交后可以审核，审核后可以作废，作废后可以重新编辑
- **提交后**：可以审核，审核时可以驳回，驳回后可以重新编辑
- **审核后**：审核时可以驳回，驳回后可以重新编辑

- **UI状态同步**：
  - 新增后：新增按钮灰色
  - 保存后：新增按钮变为可用
  - 修改后：保存按钮变为可用
  - 删除后：新增按钮变为可用，保存按钮变为灰色

**核心设计理念**：以上所有状态控制和管理都可以在V状态管理架构中在底层定义好。这就是状态控制和管理！而不是具体的每个单据业务都要控制。状态的验证和转换都只是状态本身，与单据、实体本身的数据验证无关。系统架构已经完成数据性保存的验证了。

## 2. 状态管理目标

具体的业务类中不负责状态的验证和转换。基类负责状态的保存和加载。状态的验证和转换都在状态管理系统中完成。特殊的情况提供注册等扩展。

### 2.1 核心目标
1. **确保状态的一致性和准确性**，避免数据不一致和错误的状态转换
2. **提供灵活的状态管理机制**，支持不同业务模块的状态定义和转换
3. **优化状态管理系统的性能和资源利用率**，确保在高并发场景下的稳定运行
4. **提供完善的状态管理文档和开发工具**，方便开发人员理解和使用状态管理系统
5. **状态管理是统一的**，而不是分散的
6. **降低业务代码的复杂度**，将状态逻辑从业务类中分离出来
7. **提高系统的可维护性**，集中管理所有状态相关逻辑

## 3. 设计原则

### 3.1 架构设计原则
1. **单一文件原则**：一个文件只包含一个类或一个接口
2. **统一性**：提供统一的状态管理接口，减少学习成本
3. **可扩展性**：支持自定义状态类型和转换规则
4. **可维护性**：集中管理状态逻辑，降低维护成本
5. **类型安全**：使用强类型状态枚举，减少运行时错误
6. **事件驱动**：支持状态变更事件（StatusChanged），使用StateTransitionEventArgs参数，便于解耦业务逻辑
7. **历史记录**：完整记录状态变更历史，满足审计需求

### 3.2 技术设计原则
1. **松耦合**：状态管理组件与业务组件解耦
2. **依赖注入**：通过IoC容器管理状态管理组件的生命周期
3. **反射优化**：使用缓存机制优化反射性能
4. **异步支持**：支持异步状态转换操作
5. **异常处理**：提供完善的异常处理和错误恢复机制

## 4. 技术要求

### 4.1 状态类型定义
1. **数据性状态 (DataStatus)**
   - 草稿、新建、确认、完结、作废
   - 表示实体的数据生命周期状态
   - 所有实体的基础状态类型

2. **操作状态 (ActionStatus)**  
   - 无操作、新增、修改、删除、加载、复制
   - 表示对实体的操作类型
   - 反映当前正在执行的操作

3. **业务性状态 (BusinessStatus)**
   - 根据不同业务模块定义
   - 表示业务流程状态
   - 动态可扩展的业务状态枚举
   - 支持多种业务状态类型，如PaymentStatus、PrePaymentStatus、ARAPStatus等

4. **统一实体状态 (EntityStatus)**
   - 包含所有状态信息的统一容器
   - 支持多种状态类型的组合管理
   - 包含数据状态、操作状态和业务状态集合

### 4.2 状态转换规则
1. **数据性状态转换规则**
   ```
   草稿 -> [新建, 作废]
   新建 -> [确认, 作废] 
   确认 -> [完结, 作废]
   完结 -> []
   作废 -> [草稿]
   ```

2. **操作状态转换规则**
   ```
   无操作 -> [新增, 加载, 复制]
   新增 -> [修改, 删除]
   修改 -> [修改, 删除]
   删除 -> [新增]
   加载 -> [修改, 删除, 复制]
   复制 -> [新增, 修改, 删除]
   ```

### 4.3 核心接口要求
1. **IUnifiedStateManager**：统一状态管理器接口
   - GetEntityStatus：获取实体的状态信息
   - GetDataStatus：获取当前数据性状态
   - SetDataStatusAsync：设置数据性状态
   - SetEntityDataStatus：设置实体数据状态（同步版本）
   - GetBusinessStatus：获取业务性状态
   - SetBusinessStatusAsync：设置业务性状态
   - GetActionStatus：获取当前操作状态
   - SetActionStatusAsync：设置操作状态
   - ValidateDataStatusTransitionAsync：验证数据性状态转换（已优化，委托给StatusTransitionEngine）
   - ValidateBusinessStatusTransitionAsync：验证业务性状态转换（已优化，委托给StatusTransitionEngine）
   - ValidateActionStatusTransitionAsync：验证操作状态转换（已优化，委托给StatusTransitionEngine）
   - GetAvailableDataStatusTransitions：获取可转换的数据性状态列表
   - GetAvailableBusinessStatusTransitions：获取可转换的业务性状态列表
   - GetAvailableActionStatusTransitions：获取可转换的操作状态列表
   - CanTransitionToDataStatus：检查是否可以转换到目标数据性状态
   - CanTransitionToBusinessStatus：检查是否可以转换到目标业务性状态
   - CanTransitionToActionStatus：检查是否可以转换到目标操作状态
   - RequestTransition：请求状态转换
   - SetStatesAsync：批量设置实体状态
   - CanChangeStatus：检查实体是否可以更改为目标状态
   - StatusChanged：状态变更事件
   - ClearCache：清理缓存

2. **IStatusTransitionEngine**：状态转换引擎接口
   - ExecuteTransitionAsync<T>：执行状态转换
   - ValidateTransitionAsync<T>：验证状态转换
   - GetAvailableTransitions<T>：获取可转换状态列表

3. **IStatusTransitionContext**：状态转换上下文接口
   - StatusChanged：状态变化事件
   - Entity：实体对象
   - StatusType：状态类型
   - CurrentStatus：当前状态
   - Reason：转换原因
   - UserId：用户ID
   - TransitionTime：转换时间
   - AdditionalData：附加数据
   - GetCurrentStatus：获取当前状态
   - GetDataStatus：获取数据性状态
   - GetBusinessStatus：获取业务性状态
   - GetActionStatus：获取操作状态
   - LogTransition：记录转换
   - TransitionTo：转换到指定状态
   - GetAvailableTransitions：获取可转换状态列表
   - CanTransitionTo：检查是否可以转换到指定状态

**重要注意**：实际系统中只实现了StatusChanged事件和StateTransitionEventArgs类，不存在StateChanged、StateChanging和ActionPermissionsChanged事件及其对应的事件参数类。

在V3版本的状态管理系统中，系统使用StateTransitionEventArgs作为标准的事件参数类，用于传递状态转换的相关信息，包括实体对象、状态类型、旧状态、新状态、转换原因、用户ID、转换时间和附加数据等。

## 5. UI集成要求

### 5.1 控件状态同步
1. **按钮状态管理**
   - 根据状态自动启用/禁用按钮
   - 支持自定义按钮状态规则
   - 提供状态变更事件通知

2. **UI控件适配**
   - 支持标准Windows Forms控件
   - 提供状态感知控件基类
   - 支持Krypton Toolkit控件

3. **视觉反馈**
   - 状态变更时的视觉提示
   - 支持自定义状态显示样式
   - 提供状态变更动画效果

4. **UI状态控制器**
   - 使用IStatusUIController接口管理UI状态
   - 支持数据状态、操作状态和业务状态的UI控制
   - 提供DefaultUIStatusRule默认规则实现

### 5.2 窗体集成
1. **BaseBillEdit集成**
   - 基础单据编辑类的状态管理集成
   - 自动状态同步机制
   - 支持泛型版本

2. **基类扩展**
   - 提供状态管理扩展点
   - 支持自定义状态处理逻辑
   - 保持向后兼容性


### 6.3 缓存策略
- 反射结果缓存
- 状态转换规则缓存（已增强，添加缓存字段和缓存逻辑）
- 业务状态字典缓存
- UI控件状态规则缓存（已增强，添加缓存字段和缓存逻辑）
- 状态管理器实例缓存
- 自定义验证规则缓存
- 操作规则缓存
- 缓存的转换规则结果
- 缓存的UI控件规则结果

## 7. 扩展性要求

### 7.1 自定义状态
- 支持自定义状态枚举
- 支持动态状态注册
- 提供状态验证器扩展点

### 7.2 业务扩展
- 支持业务特定的状态规则
- 提供状态转换自定义验证
- 支持状态变更事件处理
- 支持自定义UI状态规则
- 提供StateRuleConfiguration配置中心




## 9. 安全性要求

### 9.1 状态安全
- 防止非法状态转换
- 提供状态访问权限控制
- 支持状态变更审计

### 9.2 数据安全
- 状态数据加密存储
- 防止状态数据篡改
- 提供状态备份和恢复

### 9.3 操作安全
- 支持状态变更审批流程
- 提供操作日志记录
- 支持异常状态检测
- 支持用户身份验证和授权

## 10. 监控和诊断

### 10.1 性能监控
- 状态操作性能指标
- 内存使用监控
- 错误率和异常监控

### 10.2 调试支持
- 提供详细的状态变更日志
- 支持状态追踪和回溯
- 集成诊断工具和界面
- 支持实时状态监控

### 10.3 预警机制
- 状态异常预警
- 性能瓶颈预警
- 资源使用预警
- 状态转换失败预警

