# 多属性产品导入功能实现总结

## 已完成的工作

### 1. 核心配置模型

#### MultiAttributeImportConfig.cs
多属性产品导入配置模型，包含：
- `IsEnabled`: 是否启用多属性导入
- `GroupByField`: 产品分组字段
- `BaseProductFields`: 基础产品字段映射
- `AttributeExtractionRules`: 属性提取规则列表
- `SKUDetailFields`: SKU明细字段映射
- `AttributeValueMappings`: 属性值标准化映射

#### BaseProductFieldMapping
基础产品字段映射：
- `ProductNoColumn`: 品号列
- `CNNameColumn`: 品名列
- `SpecificationsColumn`: 规格列
- `UnitColumn`: 单位列
- `CNNameCleanupPattern`: 品名清理规则（正则表达式）

#### AttributeExtractionRule
属性提取规则：
- `AttributeName`: 属性名称（系统中的名称）
- `ExcelColumn`: Excel列名（空表示从品名列提取）
- `Pattern`: 正则表达式
- `GroupIndex`: 正则分组索引
- `IsRequired`: 是否必填
- `ExtractValue()`: 提取属性值的方法

#### SKUDetailFieldMapping
SKU明细字段映射：
- `SystemField`: 系统字段名
- `ExcelColumn`: Excel列名
- `DataType`: 数据类型

#### AttributeValueMapping
属性值标准化映射：
- `AttributeName`: 属性名称
- `OriginalValue`: 原始值
- `StandardizedValue`: 标准化值

### 2. 导入服务

#### MultiAttributeProductImporter.cs
多属性产品导入器，主要功能：

**ImportAsync()**
- 按分组字段对Excel数据分组
- 逐组导入基础产品及其SKU明细

**核心流程：**
1. **分组**: `GroupByField()` - 按指定字段分组
2. **提取基础信息**: `ExtractBaseProduct()` - 提取品号、品名、规格等
3. **提取属性**: `ExtractAttributes()` - 从文本中提取属性信息
4. **标准化属性**: `StandardizeAttributeValue()` - 统一属性值
5. **导入基础产品**: 保存到tb_Prod表，PropertyType设为多属性
6. **导入属性类型和值**: 保存到tb_ProdPropertyType和tb_ProdPropertyValue表
7. **导入SKU明细**: 保存到tb_ProdDetail表，包含属性组合

**关键方法：**
- `ExtractAttributeCombination()`: 提取并格式化属性组合
- `ImportAttributeTypesAndValues()`: 导入属性类型和属性值
- `ImportSKUDetail()`: 导入SKU明细

### 3. UI配置界面

#### FrmMultiAttributeImportConfig.cs (主配置窗体)
多属性产品导入主配置窗体，包含：
- 启用/禁用多属性导入复选框
- 基础产品字段映射输入（品号、品名、规格、单位）
- 品名清理规则输入
- 产品分组字段输入
- 配置属性规则按钮
- 配置SKU映射按钮

#### FrmAttributeRulesConfig.cs (属性规则配置)
属性提取规则配置窗体，包含：
- 规则列表（DataGridView）
- 添加、编辑、删除规则按钮
- 添加常用规则按钮（颜色、规格）

#### FrmAttributeRuleEdit.cs (属性规则编辑)
单个属性规则编辑窗体，包含：
- 属性名称输入
- Excel列选择（可从品名列提取）
- 正则表达式输入
- 正则表达式测试功能
- 必填复选框

### 4. 集成到导入配置

#### ImportConfiguration.cs
添加了 `MultiAttributeImportConfig` 属性：
```csharp
public MultiAttributeImportConfig MultiAttributeImportConfig { get; set; }
```

### 5. 配置示例

创建了一个完整的配置示例文档：`多属性产品导入配置示例.md`

包含：
- XML配置示例
- 配置说明
- 导入流程说明
- 数据示例

## 待集成的工作

### 1. FrmColumnPropertyConfig集成
需要在FrmColumnPropertyConfig中添加多属性配置入口：
- 添加"配置多属性导入"按钮
- 当目标实体类型为tb_Prod时显示该按钮
- 打开FrmMultiAttributeImportConfig窗体

### 2. UCBasicDataImport集成
需要在UCBasicDataImport中集成多属性导入逻辑：

**导入流程修改：**
```csharp
private async Task ExecuteImportAsync()
{
    // 检查是否启用多属性导入
    if (_currentConfig.MultiAttributeImportConfig != null && 
        _currentConfig.MultiAttributeImportConfig.IsEnabled &&
        _selectedEntityType == typeof(tb_Prod))
    {
        // 使用多属性导入器
        var multiAttrImporter = new MultiAttributeProductImporter(_db, _currentConfig.MultiAttributeImportConfig);
        var result = await multiAttrImporter.ImportAsync(_parsedImportData);
        
        // 显示导入结果
        ShowMultiAttributeImportResult(result);
    }
    else
    {
        // 使用普通导入器
        await _dynamicImporter.ImportAsync(_parsedImportData);
    }
}
```

### 3. frmColumnMappingConfig集成
需要在列映射配置界面添加多属性配置入口：
- 添加"配置多属性导入"按钮
- 打开FrmMultiAttributeImportConfig窗体
- 保存配置到ImportConfiguration.MultiAttributeImportConfig

## 配置步骤

### 步骤1：创建导入配置
1. 打开列映射配置界面
2. 选择目标实体类型为"产品基本信息表"
3. 点击"配置多属性导入"按钮

### 步骤2：配置基础产品字段
1. 勾选"启用多属性产品导入"
2. 输入品号列名（如：雷阳货号）
3. 输入品名列名（如：供货商来货品名）
4. 输入规格列名（如：雷阳品名规格）
5. 输入单位列名（如：单位（含采购运费））
6. 输入品名清理规则（正则表达式）

### 步骤3：配置分组字段
输入产品分组字段（如：末位流水编号）

### 步骤4：配置属性提取规则
1. 点击"配置属性规则"按钮
2. 添加属性规则：
   - 属性名称：颜色
   - 正则表达式：`颜色:\s*([\u4e00-\u9fa5\w\s\-\(\)]+)`
   - 勾选必填
3. 可以添加更多规则（如规格）

### 步骤5：配置SKU明细字段
1. 点击"配置SKU映射"按钮
2. 添加SKU字段映射：
   - SKUCode -> 雷阳货号
   - PurchasePrice -> 单价（含采购运费）
   - CostPrice -> 成本价（含打包费用及发货运费等）

### 步骤6：配置列映射
按照常规方式配置其他列的映射（如供应商外键映射）

### 步骤7：保存并导入
1. 保存配置
2. 选择Excel文件
3. 点击导入

## 数据示例

### 输入数据（CSV片段）
```
末位流水编号,供货商来货品名,雷阳货号,单价,成本价
0009,37格蜂窝冰格绿色,BG010009,1.95,2.18
0009,37格蜂窝冰格粉色-3PCs,T3-BG010009-FEN,5.85,6.55
0009,37格蜂窝冰格蓝色-3PCs,T3-BG010009-LAN,5.85,6.55
```

### 输出结果
**tb_Prod（基础产品）**
- ProdBaseID: 1001
- ProductNo: BG010009
- CNName: 37格蜂窝冰格
- PropertyType: 2 (多属性)

**tb_ProdPropertyType（属性类型）**
- PropertyTypeID: 1, ProdBaseID: 1001, PropertyName: 颜色

**tb_ProdPropertyValue（属性值）**
- PropertyValueID: 1, PropertyTypeID: 1, PropertyValueName: 绿色
- PropertyValueID: 2, PropertyTypeID: 1, PropertyValueName: 粉色
- PropertyValueID: 3, PropertyTypeID: 1, PropertyValueName: 蓝色

**tb_ProdDetail（SKU明细）**
- ProdDetailID: 1, ProdBaseID: 1001, SKUCode: BG010009, PurchasePrice: 1.95, AttributeCombination: "颜色:绿色:1"
- ProdDetailID: 2, ProdBaseID: 1001, SKUCode: T3-BG010009-FEN, PurchasePrice: 5.85, AttributeCombination: "颜色:粉色:2"
- ProdDetailID: 3, ProdBaseID: 1001, SKUCode: T3-BG010009-LAN, PurchasePrice: 5.85, AttributeCombination: "颜色:蓝色:3"

## 技术特性

1. **正则表达式提取**: 灵活匹配各种格式的属性描述
2. **属性值标准化**: 统一不同表述的属性值
3. **智能分组**: 按指定字段识别同一产品的不同SKU
4. **品名清理**: 自动移除品名中的属性信息
5. **完整数据关联**: 基础产品-属性类型-属性值-SKU明细完整关联
6. **可配置性**: 通过UI配置，无需修改代码

## 使用场景

此功能适用于以下场景：
1. 从电商平台导出的产品数据包含多属性SKU
2. 产品品名中包含属性信息（颜色、规格等）
3. 同一基础产品有多个SKU（不同颜色、规格、包装等）
4. 需要将扁平的Excel数据导入为EAV模型的产品结构
