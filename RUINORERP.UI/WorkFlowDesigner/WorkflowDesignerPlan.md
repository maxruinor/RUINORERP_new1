# 工作流设计器会签/或签功能实现计划

## 1. 项目概述

本项目旨在为现有的基于Netron控件的工作流设计器添加会签(All Approve)和或签(Any Approve)功能。当前系统只支持单人审批的线性流程，需要扩展以支持多人协同审批的复杂流程。

项目工作目录：`e:\CodeRepository\SynologyDrive\RUINORERP\RUINORERP.UI\WorkFlowDesigner`

## 2. 功能需求

### 2.1 核心功能
- 支持会签节点：需要所有指定审批人都通过才能继续流程
- 支持或签节点：只需要任意一个指定审批人通过即可继续流程
- 可视化设计会签/或签节点
- 与现有ERP系统集成
- 与WorkflowCore引擎集成

### 2.2 用户角色
- 系统管理员：前期主要用户，负责流程设计
- 一般用户：经过培训后可使用流程设计器

## 3. 技术架构

### 3.1 现有技术栈
- Netron图形控件
- C# WinForms
- .NET Framework 4.8
- WorkflowCore工作流引擎
- SqlSugar ORM
- 分布式系统架构

### 3.2 系统组件
- 图形化流程设计器（基于Netron）
- 流程定义转换器（转换为WorkflowCore可识别格式）
- 流程执行引擎（WorkflowCore）
- 业务集成模块（与ERP模块集成）

## 4. 详细设计

### 4.1 节点类型扩展
当前已有的节点类型：
- 开始节点
- 结束节点
- 审批节点
- 提交节点
- 通知节点
- 条件判断节点

需要新增的节点类型：
- 会签节点（所有人员通过）
- 或签节点（任一人员通过）

### 4.2 数据模型扩展

#### 4.2.1 审批节点属性扩展
现有节点属性：
- 节点ID
- 节点名称
- 下一步节点

需要扩展的属性：
- 审批人员列表
- 审批类型（单人审批/会签/或签）
- 审批状态
- 已审批人员列表
- 超时处理机制
- 通知机制

#### 4.2.2 流程定义结构
需要支持的流程结构：
- 线性流程（现有功能）
- 并行审批流程（新增功能）
- 条件分支流程（现有功能）

### 4.3 与WorkflowCore集成

#### 4.3.1 流程定义转换
将图形化设计的流程转换为WorkflowCore可识别的JSON/XML格式

#### 4.3.2 执行时集成
通过数据库表与现有ERP业务模块集成

## 5. 实现步骤

### 5.1 第一阶段：基础架构准备
1. 分析现有代码结构
2. 确定扩展点
3. 设计扩展方案

### 5.2 第二阶段：节点类型实现
1. 创建会签节点类 - **已完成**
2. 创建或签节点类 - **已完成**
3. 实现节点属性编辑器 - **已完成部分**

### 5.3 第三阶段：数据模型扩展
1. 扩展节点数据模型 - **已完成**
2. 修改序列化逻辑 - **已完成**
3. 实现数据持久化 - **已完成部分**

### 5.4 第四阶段：WorkflowCore集成
1. 实现流程定义转换器 - **已完成**
2. 集成执行引擎
3. 实现与ERP模块的集成

### 5.5 第五阶段：测试与优化
1. 单元测试
2. 集成测试
3. 性能优化

## 6. 风险评估与应对

### 6.1 技术风险
- WorkflowCore集成复杂度高
- 数据一致性保证
- 性能问题

### 6.2 应对措施
- 分阶段实现，逐步集成
- 增加数据校验机制
- 进行充分的性能测试

## 7. 验收标准

### 7.1 功能验收
- 能够设计包含会签/或签节点的流程
- 流程能正确转换为WorkflowCore格式
- 流程能在ERP系统中正确执行

### 7.2 性能验收
- 流程设计器响应时间小于2秒
- 流程执行效率满足业务要求

## 8. 已完成工作

### 8.1 创建了业务逻辑类
- `Entities/CountersignStep.cs` - 会签步骤实体类，实现需要所有审批人都通过才能继续流程的逻辑
- `Entities/OrSignStep.cs` - 或签步骤实体类，实现任一审批人通过即可继续流程的逻辑
- `Entities/ApprovalUser.cs` - 审批用户实体类，包含用户基本信息

### 8.2 扩展了节点属性
- 修改了 `Nodes/CountersignNode.cs` 和 `Nodes/OrSignNode.cs`，添加了审批人员配置相关属性
- 实现了节点属性在属性面板中的显示和编辑功能

### 8.3 实现了序列化逻辑
- 创建了 `Service/WorkflowDefinitionConverter.cs` 类，用于将图形化设计的流程转换为WorkflowCore可识别的XML/JSON格式

### 8.4 添加了数据库实体类
- `Entities/WorkflowDefinition.cs` - 工作流定义实体类，用于持久化存储流程配置
- `Entities/WorkflowStep.cs` - 工作流步骤实体类，表示流程中的步骤节点
- `Entities/WorkflowConnection.cs` - 工作流连接实体类，表示步骤节点间的连接关系

### 8.5 完善UI交互
- 创建了 `UI/ApprovalUserListEditor.cs` - 审批用户列表编辑器
- 创建了 `UI/ApprovalUserListEditorForm.cs` - 审批用户列表编辑器窗体
- 创建了 `UI/ApprovalUserListEditorForm.Designer.cs` - 审批用户列表编辑器窗体设计器文件
- 实现了审批人员列表的可视化配置界面

### 8.6 集成数据库操作
- 创建了 `Service/WorkflowDefinitionService.cs` - 工作流定义服务类
- 实现了流程定义的保存和加载功能

## 9. 最新更新

### 9.1 添加了扩展属性支持
- 创建了 `Entities/CountersignStepExtension.cs` - 会签步骤扩展属性类，包含超时处理和通知机制
- 创建了 `Entities/OrSignStepExtension.cs` - 或签步骤扩展属性类，包含超时处理和通知机制
- 更新了 `Nodes/CountersignNode.cs` 和 `Nodes/OrSignNode.cs`，添加了扩展属性支持和可视化标记

## 10. 下一步计划

### 10.1 完善测试用例
按照之前编写的测试计划进行全面测试

### 10.2 与现有系统集成
将这些功能集成到现有的ERP系统中