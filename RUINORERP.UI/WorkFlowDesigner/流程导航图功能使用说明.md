# æµç¨‹å¯¼èˆªå›¾åŠŸèƒ½ä½¿ç”¨è¯´æ˜

## æ¦‚è¿°

æµç¨‹å¯¼èˆªå›¾åŠŸèƒ½æ˜¯ERPç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œé€šè¿‡å¯è§†åŒ–çš„æ–¹å¼å±•ç¤ºä¸šåŠ¡æµç¨‹ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿç†è§£å’Œæ“ä½œç³»ç»Ÿã€‚è¯¥åŠŸèƒ½æ”¯æŒå¤šçº§å¯¼èˆªå›¾è®¾è®¡ï¼ŒåŒ…æ‹¬ç³»ç»Ÿæ€»è§ˆå›¾ã€æ¨¡å—çº§å¯¼èˆªå›¾å’Œå…·ä½“ä¸šåŠ¡æµç¨‹å›¾ã€‚

## åŠŸèƒ½ç‰¹ç‚¹

### 1. åˆ†çº§å¯¼èˆªä½“ç³»
- **æ€»å›¾ï¼ˆçº§åˆ«0ï¼‰**ï¼šå±•ç¤ºæ•´ä¸ªERPç³»ç»Ÿçš„ä¸»è¦æ¨¡å—å’Œä¸šåŠ¡æµå‘
- **æ¨¡å—å›¾ï¼ˆçº§åˆ«1ï¼‰**ï¼šå±•ç¤ºç‰¹å®šä¸šåŠ¡æ¨¡å—å†…çš„ä¸»è¦æµç¨‹
- **ä¸šåŠ¡å›¾ï¼ˆçº§åˆ«2ï¼‰**ï¼šå±•ç¤ºå…·ä½“çš„ä¸šåŠ¡æ“ä½œæµç¨‹
- **å­æµç¨‹å›¾ï¼ˆçº§åˆ«3ï¼‰**ï¼šå±•ç¤ºæ›´ç»†ç²’åº¦çš„å­æµç¨‹
- **æ“ä½œå›¾ï¼ˆçº§åˆ«4ï¼‰**ï¼šå±•ç¤ºå…·ä½“æ“ä½œæ­¥éª¤

### 2. åˆ†çº§ç®¡ç†åŠŸèƒ½
- **å±‚çº§å…³ç³»ç®¡ç†**ï¼šæ”¯æŒè®¾ç½®çˆ¶æµç¨‹ã€è·å–å­æµç¨‹ã€å±‚çº§è·¯å¾„æŸ¥è¯¢
- **å±‚çº§ç»“æ„æ“ä½œ**ï¼šæ”¯æŒæµç¨‹åœ¨å±‚çº§ä¸­çš„æ’åºã€ç§»åŠ¨å’Œåˆ›å»ºå‰¯æœ¬
- **éªŒè¯æ£€æŸ¥**ï¼šè‡ªåŠ¨æ£€æµ‹å¾ªç¯å¼•ç”¨å’Œå±‚çº§æ·±åº¦é™åˆ¶ï¼ˆæœ€å¤§5çº§ï¼‰
- **æ ‘å½¢ç»“æ„å±•ç¤º**ï¼šæ”¯æŒä»¥æ ‘å½¢ç»“æ„æŸ¥çœ‹å®Œæ•´æµç¨‹å±‚çº§å…³ç³»
- **é»˜è®¤æµç¨‹è®¾ç½®**ï¼šå¯ä¸ºæ¯ä¸ªå±‚çº§è®¾ç½®é»˜è®¤æµç¨‹
- **æ¨¡å—å…³è”æŸ¥è¯¢**ï¼šæ”¯æŒæŒ‰æ¨¡å—æŸ¥è¯¢ç›¸å…³æµç¨‹

### 2. ä¸šåŠ¡èŠ‚ç‚¹ç±»å‹
- **èœå•èŠ‚ç‚¹**ï¼šç›´æ¥å…³è”åˆ°ç³»ç»Ÿèœå•ï¼Œç‚¹å‡»å¯æ‰“å¼€å¯¹åº”åŠŸèƒ½
- **æ¨¡å—èŠ‚ç‚¹**ï¼šå…³è”åˆ°ä¸šåŠ¡æ¨¡å—ï¼Œç‚¹å‡»å¯è¿›å…¥æ¨¡å—çº§å¯¼èˆªå›¾
- **æµç¨‹èŠ‚ç‚¹**ï¼šå…³è”åˆ°å­æµç¨‹å¯¼èˆªå›¾ï¼Œæ”¯æŒæµç¨‹åµŒå¥—
- **é€šç”¨èŠ‚ç‚¹**ï¼šå¼€å§‹ã€ç»“æŸç­‰é€šç”¨æµç¨‹èŠ‚ç‚¹

### 3. å¯è§†åŒ–è®¾è®¡
- æ‹–æ‹½å¼èŠ‚ç‚¹è®¾è®¡
- è¿æ¥çº¿ç»˜åˆ¶
- èŠ‚ç‚¹å±æ€§é…ç½®
- é¢œè‰²å’Œæ ·å¼è‡ªå®šä¹‰

## ä½¿ç”¨æµç¨‹

### 1. ç³»ç»Ÿå¯åŠ¨æ—¶çš„å¯¼èˆªå›¾åŠ è½½

#### è‡ªåŠ¨åŠ è½½é€»è¾‘
1. **ä¼˜å…ˆçº§1**ï¼šåŠ è½½ç³»ç»Ÿé»˜è®¤æ€»è§ˆå›¾
2. **ä¼˜å…ˆçº§2**ï¼šåŠ è½½ç¬¬ä¸€ä¸ªå¯ç”¨çš„æ€»è§ˆå›¾
3. **ä¼˜å…ˆçº§3**ï¼šæ ¹æ®ç”¨æˆ·æƒé™åŠ è½½æ¨¡å—çº§å¯¼èˆªå›¾

#### ä»£ç é›†æˆ
åœ¨ä¸»çª—ä½“å¯åŠ¨æ—¶è°ƒç”¨ï¼š
```csharp
// åœ¨MainFormçš„Loadäº‹ä»¶ä¸­
private async void MainForm_Load(object sender, EventArgs e)
{
    // å…¶ä»–åˆå§‹åŒ–ä»£ç ...
    
    // åˆå§‹åŒ–æµç¨‹å¯¼èˆªå›¾åŠŸèƒ½
    await InitializeProcessNavigationAsync();
}
```

### 2. æµç¨‹å¯¼èˆªå›¾è®¾è®¡

#### æ‰“å¼€è®¾è®¡å™¨
```csharp
// æ˜¾ç¤ºå¯¼èˆªè®¾è®¡å™¨
ToggleNavigationDesigner();
```

#### è®¾è®¡å™¨ç•Œé¢
- **å·¦ä¾§æ¨¡æ¿é¢æ¿**ï¼šåŒ…å«é¢„å®šä¹‰çš„ä¸šåŠ¡èŠ‚ç‚¹æ¨¡æ¿
- **å³ä¾§è®¾è®¡é¢æ¿**ï¼šå¯è§†åŒ–æµç¨‹è®¾è®¡åŒºåŸŸ
- **é¡¶éƒ¨å·¥å…·æ **ï¼šæ–°å»ºã€æ‰“å¼€ã€ä¿å­˜ã€æ¨¡å¼åˆ‡æ¢ç­‰æ“ä½œ

#### èŠ‚ç‚¹æ‹–æ‹½è®¾è®¡
1. ä»å·¦ä¾§æ¨¡æ¿é¢æ¿é€‰æ‹©èŠ‚ç‚¹
2. æ‹–æ‹½åˆ°å³ä¾§è®¾è®¡é¢æ¿
3. è°ƒæ•´èŠ‚ç‚¹ä½ç½®å’Œå¤§å°
4. é…ç½®èŠ‚ç‚¹å±æ€§
5. ç»˜åˆ¶è¿æ¥çº¿

#### èŠ‚ç‚¹å±æ€§é…ç½®
åŒå‡»èŠ‚ç‚¹æˆ–å³é”®é€‰æ‹©"å±æ€§"å¯é…ç½®ï¼š
- èŠ‚ç‚¹åç§°å’Œæè¿°
- ä¸šåŠ¡ç±»å‹
- å…³è”èœå•/æ¨¡å—/æµç¨‹
- èŠ‚ç‚¹é¢œè‰²
- ä½ç½®å’Œå¤§å°

### 3. ä¸šåŠ¡æ¨¡å—å…³è”

#### æ¨¡å—å®šä¹‰
ç³»ç»Ÿé€šè¿‡ `tb_ModuleDefinition` è¡¨å®šä¹‰ä¸šåŠ¡æ¨¡å—ï¼š
```sql
-- ç¤ºä¾‹æ¨¡å—æ•°æ®
INSERT INTO tb_ModuleDefinition (ModuleNo, ModuleName, Visible, Available) VALUES
('M001', 'é‡‡è´­ç®¡ç†', 1, 1),
('M002', 'é”€å”®ç®¡ç†', 1, 1),
('M003', 'åº“å­˜ç®¡ç†', 1, 1),
('M004', 'è´¢åŠ¡ç®¡ç†', 1, 1),
('M005', 'ç”Ÿäº§ç®¡ç†', 1, 1);
```

#### èœå•å…³è”
èŠ‚ç‚¹å¯ä»¥å…³è”åˆ°å…·ä½“èœå•ï¼š
```csharp
// åˆ›å»ºèœå•èŠ‚ç‚¹æ¨¡æ¿
var menuTemplate = new BusinessNodeTemplate
{
    Name = "é‡‡è´­ç”³è¯·",
    BusinessType = ProcessNavigationNodeBusinessType.èœå•èŠ‚ç‚¹,
    MenuID = 1001, // å¯¹åº”çš„èœå•ID
    FormName = "FrmPurchaseRequest",
    ClassPath = "RUINORERP.UI.Purchase.FrmPurchaseRequest"
};
```

### 4. å¯¼èˆªå›¾ä¿å­˜å’ŒåŠ è½½

#### ä¿å­˜å¯¼èˆªå›¾
```csharp
// ä¿å­˜å½“å‰å¯¼èˆªå›¾
private async void SaveNavigation()
{
    if (CurrentNavigation == null) return;
    
    // ç”ŸæˆXML
    var xml = GenerateGraphXml();
    
    // ä¿å­˜åˆ°æ•°æ®åº“
    CurrentNavigation.GraphXml = xml;
    CurrentNavigation.UpdateTime = DateTime.Now;
    
    await _processNavigationService.UpdateAsync(CurrentNavigation);
}
```

#### åŠ è½½å¯¼èˆªå›¾
```csharp
// åŠ è½½å¯¼èˆªå›¾å†…å®¹
private void LoadNavigationContent()
{
    if (string.IsNullOrEmpty(CurrentNavigation.GraphXml))
    {
        _graphControl.Clear();
        return;
    }
    
    using (var stringReader = new StringReader(CurrentNavigation.GraphXml))
    {
        _graphControl.Load(stringReader);
    }
}
```

## æ•°æ®åº“ç»“æ„

### ä¸»è¦è¡¨ç»“æ„

#### tb_ProcessNavigationï¼ˆæµç¨‹å¯¼èˆªå›¾å®šä¹‰è¡¨ï¼‰
| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| ProcessNavigationID | bigint | ä¸»é”®ID |
| NavigationName | varchar(200) | å¯¼èˆªå›¾åç§° |
| Description | varchar(500) | æè¿° |
| ModuleID | bigint | å…³è”æ¨¡å—ID |
| NavigationLevel | int | å¯¼èˆªå›¾çº§åˆ«ï¼ˆ0-æ€»å›¾ï¼Œ1-æ¨¡å—å›¾ï¼Œ2-ä¸šåŠ¡å›¾ï¼Œ3-å­æµç¨‹å›¾ï¼Œ4-æ“ä½œå›¾ï¼‰ |
| ParentNavigationID | bigint | çˆ¶çº§å¯¼èˆªå›¾IDï¼ˆè‡ªå¼•ç”¨å¤–é”®ï¼‰ |
| HierarchyLevel | int | å±‚çº§æ·±åº¦ï¼ˆ0-4çº§ï¼‰ |
| SortOrder | int | åœ¨åŒçº§ä¸­çš„æ’åºåºå· |
| GraphXml | text | å›¾å½¢XMLå†…å®¹ |
| IsActive | bit | æ˜¯å¦æ¿€æ´» |
| IsDefault | bit | æ˜¯å¦é»˜è®¤ |

### å±‚çº§å…³ç³»å®Œæ•´æ€§çº¦æŸ

ä¸ºç¡®ä¿æµç¨‹å¯¼èˆªå›¾å±‚çº§ç»“æ„çš„å®Œæ•´æ€§ï¼Œç³»ç»Ÿå®ç°äº†ä»¥ä¸‹çº¦æŸï¼š

- å±‚çº§æ·±åº¦é™åˆ¶ï¼šæœ€å¤§æ”¯æŒ5çº§æ·±åº¦ï¼ˆ0-4ï¼‰
- ç¦æ­¢å¾ªç¯å¼•ç”¨ï¼šç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹å¹¶é˜»æ­¢åˆ›å»ºå¾ªç¯å¼•ç”¨å…³ç³»
- å¤–é”®çº¦æŸï¼šParentNavigationIDå­—æ®µå¼•ç”¨ProcessNavigationID
- ç´¢å¼•ä¼˜åŒ–ï¼šä¸ºParentNavigationIDå’ŒNavigationLevelå­—æ®µåˆ›å»ºç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½
- å±‚çº§å®Œæ•´æ€§ä¿éšœï¼šæ–°å¢å­˜å‚¨è¿‡ç¨‹å’Œè§¦å‘å™¨ç¡®ä¿å±‚çº§æ•°æ®çš„ä¸€è‡´æ€§

### æ–°å¢å­˜å‚¨è¿‡ç¨‹å’Œè§¦å‘å™¨

#### å­˜å‚¨è¿‡ç¨‹

1. **SP_SetProcessNavigationHierarchy**ï¼šè®¾ç½®æµç¨‹å¯¼èˆªå›¾å±‚çº§å…³ç³»
   - å‚æ•°ï¼š@ProcessNavigationID, @ParentNavigationID
   - åŠŸèƒ½ï¼šè‡ªåŠ¨è®¡ç®—å¹¶è®¾ç½®å±‚çº§æ·±åº¦ï¼Œæ£€æµ‹å¾ªç¯å¼•ç”¨

2. **SP_GetProcessNavigationHierarchy**ï¼šè·å–å¯¼èˆªå›¾çš„å®Œæ•´å±‚çº§è·¯å¾„
   - å‚æ•°ï¼š@ProcessNavigationID
   - åŠŸèƒ½ï¼šè¿”å›ä»æ ¹èŠ‚ç‚¹åˆ°æŒ‡å®šèŠ‚ç‚¹çš„å®Œæ•´è·¯å¾„

3. **SP_GetChildProcessNavigations**ï¼šè·å–æ‰€æœ‰å­å¯¼èˆªå›¾
   - å‚æ•°ï¼š@ParentNavigationID
   - åŠŸèƒ½ï¼šé€’å½’è·å–æŒ‡å®šçˆ¶å¯¼èˆªå›¾çš„æ‰€æœ‰å­å¯¼èˆªå›¾

#### è§¦å‘å™¨

1. **TR_ProcessNavigation_AfterUpdate**ï¼šå±‚çº§æ›´æ–°è§¦å‘å™¨
   - åŠŸèƒ½ï¼šçˆ¶å¯¼èˆªå›¾æ›´æ–°æ—¶è‡ªåŠ¨æ›´æ–°ç›¸å…³å­å¯¼èˆªå›¾çš„å±‚çº§ä¿¡æ¯

2. **TR_ProcessNavigationNode_UpdateChildNav**ï¼šèŠ‚ç‚¹æ›´æ–°è§¦å‘å™¨
   - åŠŸèƒ½ï¼šç¡®ä¿èŠ‚ç‚¹å¼•ç”¨çš„å­å¯¼èˆªå›¾ä¸å½“å‰å¯¼èˆªå›¾çš„å±‚çº§å…³ç³»æ­£ç¡®

#### tb_ProcessNavigationNodeï¼ˆæµç¨‹å¯¼èˆªå›¾èŠ‚ç‚¹è¡¨ï¼‰
| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| NodeID | bigint | ä¸»é”®ID |
| ProcessNavID | bigint | æµç¨‹å¯¼èˆªå›¾ID |
| BusinessType | int | ä¸šåŠ¡ç±»å‹ |
| MenuID | bigint | å…³è”èœå•ID |
| ModuleID | bigint | å…³è”æ¨¡å—ID |
| ChildNavigationID | bigint | å­æµç¨‹å¯¼èˆªå›¾ID |
| NodeColor | varchar(50) | èŠ‚ç‚¹é¢œè‰² |
| PositionX | float | Xåæ ‡ |
| PositionY | float | Yåæ ‡ |

## æƒé™æ§åˆ¶

### åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
```csharp
// è·å–ç”¨æˆ·å¯è®¿é—®çš„æ¨¡å—
private async Task<List<long>> GetUserAccessibleModulesAsync()
{
    var userId = ApplicationContext.Current.UserID;
    
    // æ ¹æ®ç”¨æˆ·è§’è‰²è·å–å¯è®¿é—®æ¨¡å—
    var accessibleModules = await _userModuleService.QueryableAsync()
        .Where(x => x.UserID == userId && x.HasPermission)
        .Select(x => x.ModuleID)
        .ToListAsync();
    
    return accessibleModules;
}
```

### å¯¼èˆªå›¾æƒé™è¿‡æ»¤
```csharp
// åŠ è½½ç”¨æˆ·å¯è®¿é—®çš„å¯¼èˆªå›¾
var navigations = await _processNavigationService.QueryableAsync()
    .Where(x => x.IsActive && 
               (x.NavigationLevel == 0 || // æ€»å›¾æ‰€æœ‰äººå¯è§
                accessibleModules.Contains(x.ModuleID.Value))) // æ¨¡å—å›¾éœ€è¦æƒé™
    .ToListAsync();
```

## åˆ†çº§ç®¡ç†åŠŸèƒ½ä½¿ç”¨æŒ‡å—

### 1. è®¾ç½®æµç¨‹å±‚çº§å…³ç³»

#### åˆ›å»ºçˆ¶å­æµç¨‹å…³ç³»
```csharp
// è®¾ç½®æµç¨‹å±‚çº§å…³ç³»
private async Task SetProcessHierarchy(long parentProcessNavID, long childProcessNavID)
{
    await _processNavigationHierarchyManager.SetParentProcessAsync(childProcessNavID, parentProcessNavID);
    
    // åˆ·æ–°ç•Œé¢æ˜¾ç¤º
    RefreshHierarchyTree();
}
```

#### æŸ¥çœ‹æµç¨‹å±‚çº§æ ‘
```csharp
// æ˜¾ç¤ºæµç¨‹å±‚çº§æ ‘
private void ShowProcessHierarchyTree()
{
    // è·å–å®Œæ•´å±‚çº§æ ‘
    var hierarchyTree = _processNavigationHierarchyManager.GetHierarchyTree();
    
    // ç»‘å®šåˆ°TreeViewæ§ä»¶
    BindHierarchyToTreeView(hierarchyTree, tvHierarchy);
}
```

### 2. æµç¨‹å±‚çº§æ“ä½œ

#### ç§»åŠ¨æµç¨‹åˆ°æ–°å±‚çº§
```csharp
// ç§»åŠ¨æµç¨‹åˆ°æ–°çš„çˆ¶çº§
private async Task MoveProcessToNewParent(long processNavID, long newParentProcessNavID)
{
    try
    {
        // éªŒè¯ç§»åŠ¨çš„æœ‰æ•ˆæ€§
        if (await _processNavigationHierarchyManager.ValidateMoveAsync(processNavID, newParentProcessNavID))
        {
            // æ‰§è¡Œç§»åŠ¨
            await _processNavigationHierarchyManager.MoveProcessAsync(processNavID, newParentProcessNavID);
            MessageBox.Show("æµç¨‹ç§»åŠ¨æˆåŠŸï¼");
        }
        else
        {
            MessageBox.Show("æ— æ³•ç§»åŠ¨æµç¨‹ï¼Œå¯èƒ½å¯¼è‡´å¾ªç¯å¼•ç”¨æˆ–è¶…å‡ºå±‚çº§é™åˆ¶ï¼");
        }
    }
    catch (Exception ex)
    {
        MessageBox.Show($"ç§»åŠ¨å¤±è´¥ï¼š{ex.Message}");
    }
}
```

#### ä¿®æ”¹åŒçº§æµç¨‹æ’åº
```csharp
// ä¿®æ”¹åŒçº§æµç¨‹æ’åº
private async Task UpdateProcessSortOrder(long processNavID, int newSortOrder)
{
    await _processNavigationHierarchyManager.UpdateSortOrderAsync(processNavID, newSortOrder);
}
```

### 3. å±‚çº§å¯¼èˆªæ“ä½œ

#### è·å–æµç¨‹å®Œæ•´è·¯å¾„
```csharp
// è·å–æµç¨‹å®Œæ•´è·¯å¾„
private string GetProcessFullPath(long processNavID)
{
    var path = _processNavigationHierarchyManager.GetProcessPath(processNavID);
    return string.Join(" / ", path);
}
```

#### åœ¨å±‚çº§é—´å¯¼èˆª
```csharp
// å¯¼èˆªåˆ°çˆ¶æµç¨‹
private async void NavigateToParentProcess()
{
    if (CurrentProcessNavigation == null) return;
    
    var parentId = await _processNavigationHierarchyManager.GetParentProcessIdAsync(CurrentProcessNavigation.ProcessNavID);
    if (parentId.HasValue)
    {
        var parentProcess = await _processNavigationService.GetByIdAsync(parentId.Value);
        if (parentProcess != null)
        {
            await LoadProcessNavigation(parentProcess);
        }
    }
}

// å¯¼èˆªåˆ°å­æµç¨‹
private async void NavigateToChildProcess(long childProcessNavID)
{
    var childProcess = await _processNavigationService.GetByIdAsync(childProcessNavID);
    if (childProcess != null)
    {
        await LoadProcessNavigation(childProcess);
    }
}
```

### 4. å±‚çº§ç®¡ç†ç›¸å…³API

#### æ£€æŸ¥å¾ªç¯å¼•ç”¨
```csharp
// æ£€æŸ¥æ˜¯å¦ä¼šé€ æˆå¾ªç¯å¼•ç”¨
private bool CheckForCircularReference(long childProcessNavID, long parentProcessNavID)
{
    return _processNavigationHierarchyManager.CheckCircularReference(childProcessNavID, parentProcessNavID);
}
```

#### è·å–æŒ‡å®šå±‚çº§çš„æµç¨‹åˆ—è¡¨
```csharp
// è·å–æŒ‡å®šå±‚çº§çš„æ‰€æœ‰æµç¨‹
private async Task<List<tb_ProcessNavigation>> GetProcessByLevel(int hierarchyLevel)
{
    return await _processNavigationHierarchyManager.GetProcessesByLevelAsync(hierarchyLevel);
}
```

### 5. å±‚çº§ç»“æ„ç»´æŠ¤

#### åˆ›å»ºæµç¨‹å‰¯æœ¬åˆ°æ–°å±‚çº§
```csharp
// åˆ›å»ºæµç¨‹å‰¯æœ¬å¹¶è®¾ç½®å±‚çº§
private async Task<long> CreateProcessCopyInHierarchy(long sourceProcessNavID, long parentProcessNavID, string newName)
{
    // åˆ›å»ºå‰¯æœ¬
    var newProcessId = await _processNavigationService.CreateCopyAsync(sourceProcessNavID, newName);
    
    // è®¾ç½®å±‚çº§å…³ç³»
    if (newProcessId > 0 && parentProcessNavID > 0)
    {
        await _processNavigationHierarchyManager.SetParentProcessAsync(newProcessId, parentProcessNavID);
    }
    
    return newProcessId;
}
```

## æ‰©å±•å¼€å‘

### 1. æ·»åŠ æ–°çš„ä¸šåŠ¡èŠ‚ç‚¹ç±»å‹

#### æ‰©å±•æšä¸¾
```csharp
public enum ProcessNavigationNodeBusinessType
{
    é€šç”¨èŠ‚ç‚¹ = 0,
    èœå•èŠ‚ç‚¹ = 1,
    æ¨¡å—èŠ‚ç‚¹ = 2,
    æµç¨‹èŠ‚ç‚¹ = 3,
    å¤–éƒ¨ç³»ç»ŸèŠ‚ç‚¹ = 4,  // æ–°å¢
    æ•°æ®æºèŠ‚ç‚¹ = 5,    // æ–°å¢
    APIèŠ‚ç‚¹ = 6        // æ–°å¢
}
```

#### æ·»åŠ èŠ‚ç‚¹æ¨¡æ¿
```csharp
// åœ¨BusinessNodeTemplateManagerä¸­æ·»åŠ æ–°æ¨¡æ¿
_moduleTemplates[ERPBusinessModule.ç³»ç»Ÿç®¡ç†] = new List<BusinessNodeTemplate>
{
    new BusinessNodeTemplate
    {
        Name = "APIæ¥å£",
        Description = "è°ƒç”¨å¤–éƒ¨APIæ¥å£",
        BusinessType = ProcessNavigationNodeBusinessType.APIèŠ‚ç‚¹,
        DefaultColor = Color.Purple,
        Icon = "ğŸ”—",
        Category = "æ¥å£ç®¡ç†"
    }
};
```

### 2. è‡ªå®šä¹‰èŠ‚ç‚¹è¡Œä¸º

#### é‡å†™èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶
```csharp
private void ExecuteNodeAction(ProcessNavigationNode node)
{
    switch (node.BusinessType)
    {
        case ProcessNavigationNodeBusinessType.APIèŠ‚ç‚¹:
            ExecuteApiNode(node);
            break;
        case ProcessNavigationNodeBusinessType.å¤–éƒ¨ç³»ç»ŸèŠ‚ç‚¹:
            OpenExternalSystem(node);
            break;
        // å…¶ä»–ç±»å‹...
    }
}
```

### 3. æ·»åŠ æ–°çš„å¯¼èˆªå›¾çº§åˆ«

#### æ‰©å±•çº§åˆ«æšä¸¾
```csharp
public enum ProcessNavigationLevel
{
    æ€»å›¾ = 0,
    æ¨¡å—å›¾ = 1,
    ä¸šåŠ¡å›¾ = 2,
    å­æµç¨‹å›¾ = 3,  // æ–°å¢
    æ“ä½œå›¾ = 4     // æ–°å¢
}
```

## å¸¸è§é—®é¢˜

### 1. å¯¼èˆªå›¾ä¸æ˜¾ç¤º
- æ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
- ç¡®è®¤ `tb_ProcessNavigation` è¡¨ä¸­æœ‰æ•°æ®
- æ£€æŸ¥ç”¨æˆ·æƒé™è®¾ç½®

### 2. èŠ‚ç‚¹ç‚¹å‡»æ— å“åº”
- ç¡®è®¤èŠ‚ç‚¹å·²æ­£ç¡®å…³è”èœå•æˆ–æ¨¡å—
- æ£€æŸ¥ `MenuHelper.OpenMenu()` æ–¹æ³•æ˜¯å¦æ­£å¸¸å·¥ä½œ
- éªŒè¯çª—ä½“ç±»è·¯å¾„æ˜¯å¦æ­£ç¡®

### 3. è®¾è®¡å™¨æ— æ³•ä¿å­˜
- æ£€æŸ¥æ•°æ®åº“å†™å…¥æƒé™
- ç¡®è®¤XMLç”Ÿæˆæ˜¯å¦æ­£å¸¸
- éªŒè¯äº‹åŠ¡æäº¤æ˜¯å¦æˆåŠŸ

### 4. æ¨¡æ¿æ‹–æ‹½å¤±è´¥
- ç¡®è®¤ `BusinessNodeTemplateManager` å·²æ­£ç¡®åˆå§‹åŒ–
- æ£€æŸ¥æ‹–æ‹½äº‹ä»¶æ˜¯å¦æ­£ç¡®ç»‘å®š
- éªŒè¯èŠ‚ç‚¹æ³¨å†Œæ˜¯å¦æˆåŠŸ

### 5. åˆ†çº§ç®¡ç†ç›¸å…³é—®é¢˜
- **æ— æ³•è®¾ç½®çˆ¶æµç¨‹**ï¼šæ£€æŸ¥ç›®æ ‡æµç¨‹æ˜¯å¦å­˜åœ¨ä¸”å¤„äºæ¿€æ´»çŠ¶æ€
- **å±‚çº§æ·±åº¦è¶…å‡ºé™åˆ¶**ï¼šç³»ç»Ÿé™åˆ¶æœ€å¤§å±‚çº§æ·±åº¦ä¸º5çº§ï¼ˆ0-4ï¼‰
- **å¾ªç¯å¼•ç”¨é”™è¯¯**ï¼šæ£€æŸ¥æ˜¯å¦å°è¯•åˆ›å»ºå¾ªç¯å¼•ç”¨å…³ç³»
- **æ’åºåºå·å†²çª**ï¼šåŒçº§æµç¨‹ä¸èƒ½æœ‰é‡å¤çš„æ’åºåºå·
- **å±‚çº§ç§»åŠ¨å¤±è´¥**ï¼šå¯èƒ½æ˜¯æƒé™é—®é¢˜æˆ–è¿åå±‚çº§è§„åˆ™

## æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®ç¼“å­˜
```csharp
// ç¼“å­˜å¯¼èˆªå›¾æ•°æ®
private readonly IMemoryCache _cache;

public async Task<List<tb_ProcessNavigation>> GetCachedNavigationsAsync()
{
    var cacheKey = "ProcessNavigation_List";
    
    if (!_cache.TryGetValue(cacheKey, out List<tb_ProcessNavigation> navigations))
    {
        navigations = await _processNavigationService.QueryableAsync()
            .Where(x => x.IsActive)
            .ToListAsync();
            
        _cache.Set(cacheKey, navigations, TimeSpan.FromMinutes(30));
    }
    
    return navigations;
}
```

### 2. å»¶è¿ŸåŠ è½½
```csharp
// å»¶è¿ŸåŠ è½½èŠ‚ç‚¹è¯¦æƒ…
private async void LoadNodeDetailsAsync(ProcessNavigationNode node)
{
    if (node.MenuID.HasValue)
    {
        node.MenuInfo = await _menuInfoService.QueryableByIDAsync(node.MenuID.Value);
    }
}
```

### 3. å¼‚æ­¥æ“ä½œ
```csharp
// ä½¿ç”¨å¼‚æ­¥æ“ä½œé¿å…UIé˜»å¡
private async void RefreshNavigationAsync()
{
    try
    {
        this.Cursor = Cursors.WaitCursor;
        
        await _processNavigationManager.RefreshAsync();
        
        this.Cursor = Cursors.Default;
    }
    catch (Exception ex)
    {
        this.Cursor = Cursors.Default;
        MessageBox.Show($"åˆ·æ–°å¤±è´¥ï¼š{ex.Message}");
    }
}
```

## æ€»ç»“

æµç¨‹å¯¼èˆªå›¾åŠŸèƒ½ä¸ºERPç³»ç»Ÿæä¾›äº†ç›´è§‚çš„ä¸šåŠ¡æµç¨‹å±•ç¤ºå’Œå¯¼èˆªèƒ½åŠ›ã€‚é€šè¿‡åˆç†çš„è®¾è®¡å’Œå®ç°ï¼Œå¯ä»¥æ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒå’Œæ“ä½œæ•ˆç‡ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œéœ€è¦æ ¹æ®å…·ä½“ä¸šåŠ¡éœ€æ±‚è¿›è¡Œå®šåˆ¶å’Œæ‰©å±•ã€‚