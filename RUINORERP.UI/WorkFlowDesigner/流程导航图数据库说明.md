# 流程导航图数据库说明

## 概述

流程导航图功能使用符合项目规范的数据库表结构，所有表名都以`tb_`开头，遵循项目的命名约定和操作体系。

## 数据库表结构

### 1. tb_ProcessNavigation (流程导航图定义表)

**表名：** `tb_ProcessNavigation`

**用途：** 存储流程导航图的基本定义信息

**字段说明：**

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| ProcessNavID | bigint | - | NOT NULL | IDENTITY(1,1) | 主键，流程导航图ID |
| ProcessNavName | varchar | 200 | NULL | - | 流程导航图名称 |
| Description | varchar | 500 | NULL | - | 流程导航图描述 |
| Version | int | - | NOT NULL | 1 | 版本号 |
| GraphXml | text | - | NULL | - | 流程导航图XML内容 |
| CreateUserID | bigint | - | NULL | - | 创建用户ID |
| IsActive | bit | - | NOT NULL | 1 | 是否激活 |
| IsDefault | bit | - | NOT NULL | 0 | 是否为默认流程导航图 |
| Category | varchar | 100 | NULL | - | 流程导航图分类 |
| Tags | varchar | 300 | NULL | - | 流程导航图标签 |
| ParentNavigationID | bigint | - | NULL | NULL | 父流程导航图ID，支持层级关系 |
| NavigationLevel | int | - | NOT NULL | 1 | 层级深度，根流程为1 |
| SortOrder | int | - | NOT NULL | 0 | 在同级中的排序号 |
| CreateTime | datetime | - | NOT NULL | GETDATE() | 创建时间 |
| UpdateTime | datetime | - | NOT NULL | GETDATE() | 更新时间 |

### 2. tb_ProcessNavigationNode (流程导航图节点表)

**表名：** `tb_ProcessNavigationNode`

**用途：** 存储流程导航图中各个节点的详细信息

**字段说明：**

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| NodeID | bigint | - | NOT NULL | IDENTITY(1,1) | 主键，节点ID |
| ProcessNavID | bigint | - | NOT NULL | - | 流程导航图ID（外键） |
| NodeCode | varchar | 100 | NULL | - | 节点编码 |
| NodeName | varchar | 200 | NULL | - | 节点名称 |
| Description | varchar | 500 | NULL | - | 节点描述 |
| MenuID | bigint | - | NULL | - | 关联菜单ID |
| FormName | varchar | 200 | NULL | - | 关联窗体名称 |
| ClassPath | varchar | 300 | NULL | - | 关联类路径 |
| NodeColor | varchar | 50 | NULL | - | 节点颜色 |
| PositionX | float | - | NOT NULL | 0 | 节点位置X坐标 |
| PositionY | float | - | NOT NULL | 0 | 节点位置Y坐标 |
| Width | float | - | NOT NULL | 140 | 节点宽度 |
| Height | float | - | NOT NULL | 80 | 节点高度 |
| NodeType | varchar | 50 | NULL | - | 节点类型 |
| SortOrder | int | - | NOT NULL | 0 | 排序号 |
| CreateTime | datetime | - | NOT NULL | GETDATE() | 创建时间 |
| UpdateTime | datetime | - | NOT NULL | GETDATE() | 更新时间 |

**外键关系：**
- `ProcessNavID` 引用 `tb_ProcessNavigation(ProcessNavID)`

## 索引设计

### tb_ProcessNavigation表索引
- 主键索引：`PK_tb_ProcessNavigation` (ProcessNavID)
- 普通索引：`IX_tb_ProcessNavigation_IsActive` (IsActive)
- 普通索引：`IX_tb_ProcessNavigation_Category` (Category)
- 普通索引：`IX_tb_ProcessNavigation_ParentID` (ParentProcessNavID)
- 复合索引：`IX_tb_ProcessNavigation_Hierarchy` (HierarchyLevel, SortOrder)

### tb_ProcessNavigationNode表索引
- 主键索引：`PK_tb_ProcessNavigationNode` (NodeID)
- 普通索引：`IX_tb_ProcessNavigationNode_ProcessNavID` (ProcessNavID)
- 普通索引：`IX_tb_ProcessNavigationNode_NodeCode` (NodeCode)
- 普通索引：`IX_tb_ProcessNavigationNode_MenuID` (MenuID)

## 触发器

### 1. TR_tb_ProcessNavigation_UpdateTime
- **作用：** 自动更新`UpdateTime`字段
- **触发时机：** UPDATE操作
- **逻辑：** 将`UpdateTime`设置为当前时间

### 2. TR_tb_ProcessNavigation_AfterInsert
- **作用：** 流程导航图插入后处理
- **触发时机：** AFTER INSERT
- **逻辑：** 设置初始层级信息并执行必要的初始化

### 3. TR_tb_ProcessNavigation_HierarchyUpdate
- **作用：** 更新层级深度和相关流程的层级
- **触发时机：** INSERT/UPDATE操作，当ParentProcessNavID变更时
- **逻辑：** 更新当前流程的层级深度，并级联更新子流程的层级

### 4. TR_tb_ProcessNavigation_AfterUpdate
- **作用：** 层级更新触发器
- **触发时机：** AFTER UPDATE
- **逻辑：** 执行层级关系相关的更新操作

### 5. TR_tb_ProcessNavigationNode_UpdateTime
- **作用：** 自动更新`UpdateTime`字段
- **触发时机：** UPDATE操作
- **逻辑：** 将`UpdateTime`设置为当前时间

### 6. TR_tb_ProcessNavigationNode_UpdateChildNav
- **作用：** 节点更新触发器
- **触发时机：** AFTER UPDATE
- **逻辑：** 处理节点更新后相关子导航图的更新操作

## 视图

### V_tb_ProcessNavigationDetail
- **用途：** 提供流程导航图详细信息视图
- **包含字段：** 流程导航图基本信息 + 节点详细信息
- **过滤条件：** 只显示激活的流程导航图

### V_tb_ProcessNavigationHierarchy
- **用途：** 提供流程导航图层级关系视图
- **包含字段：** ProcessNavID, ProcessNavName, ParentProcessNavID, HierarchyLevel, SortOrder, ParentName
- **功能：** 方便查询流程的层级结构和父子关系

## 存储过程

### 1. SP_GetProcessNavigationByCategory
- **用途：** 根据分类获取流程导航图列表
- **参数：** @Category (NVARCHAR(100), 可为空)
- **返回：** 流程导航图列表，按默认标记和名称排序

### 2. SP_GetProcessNavigationNodes
- **用途：** 获取指定流程导航图的所有节点
- **参数：** @ProcessNavID (BIGINT)
- **返回：** 节点列表，按排序号和节点ID排序

### 3. SP_SetDefaultProcessNavigation
- **用途：** 设置默认流程导航图
- **参数：** @ProcessNavID (BIGINT)
- **逻辑：** 先取消所有默认标记，再设置新的默认

### 4. SP_SetProcessNavigationHierarchy
- **用途：** 设置流程导航图的层级关系
- **参数：** 
  - @ChildProcessNavID (BIGINT) - 子流程ID
  - @ParentProcessNavID (BIGINT, 可为空) - 父流程ID
- **逻辑：** 检查循环引用，设置父子关系，更新层级深度

### 5. SP_GetChildProcessNavigations
- **用途：** 获取指定流程导航图的所有子流程
- **参数：** 
  - @ParentProcessNavID (BIGINT)
  - @IncludeAllLevels (BIT = 0) - 是否包含所有层级
- **返回：** 子流程列表，按层级和排序号排序

### 6. SP_GetProcessNavigationPath
- **用途：** 获取流程导航图的完整路径
- **参数：** @ProcessNavID (BIGINT)
- **返回：** 包含路径节点的临时表，从根节点到目标节点

### 7. SP_GetProcessNavigationByModule
- **用途：** 根据模块ID获取流程导航图
- **参数：** @ModuleID (INT)
- **返回：** 流程导航图列表

### 8. SP_GetProcessNavigationHierarchy
- **用途：** 获取导航图的完整层级路径
- **参数：** @ProcessNavigationID (INT)
- **返回：** 包含层级路径信息的结果集

## 函数

### FN_GetProcessNavigationStats
- **用途：** 获取流程导航图统计信息
- **返回：** 包含节点数量的统计信息
- **字段：** ProcessNavID, ProcessNavName, Category, NodeCount, CreateTime, UpdateTime

### FN_GetProcessNavigationTreeLevel
- **用途：** 获取流程导航图的树级结构数据
- **参数：** @RootProcessNavID (BIGINT, 可为空)
- **返回：** 树级结构数据，包含层级路径信息

## 实体类映射

### C#实体类
- `tb_ProcessNavigation` - 对应数据库表
- `tb_ProcessNavigationNode` - 对应数据库表

### 服务接口
- `Itb_ProcessNavigationServices` - 流程导航图服务接口
- `Itb_ProcessNavigationNodeServices` - 节点服务接口

### 服务实现
- `tb_ProcessNavigationServices` - 流程导航图服务实现
- `tb_ProcessNavigationNodeServices` - 节点服务实现

## 数据完整性

### 外键约束
- `tb_ProcessNavigationNode.ProcessNavID` 引用 `tb_ProcessNavigation.ProcessNavID`
- 级联删除：删除流程导航图时自动删除相关节点
- `tb_ProcessNavigation.ParentProcessNavID` 引用 `tb_ProcessNavigation.ProcessNavID`
  - 级联更新：更新父流程ID时更新子流程的层级信息
  - 禁止级联删除：删除父流程时需要先处理子流程

### 数据验证
- 流程导航图名称不能为空
- 版本号必须大于0
- 节点位置和尺寸必须为有效数值
- 层级深度不能超过5级
- 不允许循环引用（流程不能成为自身或其后代的父流程）

## 示例数据

系统初始化时会插入示例数据：

### 示例流程导航图
- **名称：** ERP主业务流程
- **描述：** ERP系统主要业务流程导航图
- **分类：** 主流程
- **标签：** ERP,主流程,业务导航

### 示例节点
1. 开始节点 - 绿色 (#4CAF50)
2. 采购管理 - 蓝色 (#2196F3)
3. 销售管理 - 橙色 (#FF9800)
4. 库存管理 - 紫色 (#9C27B0)
5. 财务管理 - 红色 (#F44336)
6. 结束节点 - 灰色 (#607D8B)

## 使用注意事项

1. **命名规范：** 所有表名必须以`tb_`开头
2. **服务集成：** 使用项目标准的Service和Interface模式
3. **异步操作：** 所有数据库操作都应使用async/await
4. **事务处理：** 复杂操作需要使用事务确保数据一致性
5. **错误处理：** 统一的异常处理和日志记录
6. **性能优化：** 合理使用索引，避免全表扫描

## 扩展建议

1. **缓存机制：** 对常用的流程导航图数据进行缓存
2. **版本控制：** 增强版本管理功能，支持历史版本查看
3. **权限控制：** 基于用户角色的流程导航图访问控制
4. **审计日志：** 记录流程导航图的创建、修改、删除操作
5. **导入导出：** 支持流程导航图的批量导入导出功能
6. **层级模板：** 预定义常用的流程层级模板
7. **树形可视化：** 增强层级结构的可视化展示
8. **批量层级操作：** 支持多级流程的批量移动和调整