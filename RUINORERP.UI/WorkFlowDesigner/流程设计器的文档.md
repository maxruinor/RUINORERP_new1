# 工作流设计器功能设计计划

## 1. 项目概述

基于现有的工作流设计器目录，我们将扩展和完善两个核心功能：

1. **流程导航图功能**：创建美观的业务流程示意图，用于在ERP系统工作台中展示业务走向，创建后可以在流程设计器中修改，并且能通过事件打开对应的窗体。通过目前项目中的菜单打开机制MenuHelper.cs

2. **实际工作流功能**：设计可执行的工作流程 与 WorkflowCore 紧密集成结合，支持单据审批、人员指派等业务操作

## 2. 当前系统分析

### 2.1 现有功能
- 基于Netron图形控件的工作流设计器
- 支持会签/或签节点设计
- 支持流程图保存和加载
- 与WorkflowCore工作流引擎集成
- 支持流程定义的JSON/XML导出

### 2.2 技术架构
- Netron GraphLib图形控件
- C# WinForms界面
- WorkflowCore工作流引擎
- SqlSugar ORM数据库访问

## 3. 功能一：流程导航图设计

### 3.1 功能目标
创建美观的业务流程示意图，用于ERP系统工作台展示业务走向

### 3.2 设计要点
1. 支持创建业务流程示意图（非可执行工作流）
2. 图形化节点设计，支持拖拽布局
3. 节点点击事件，可打开对应业务单据窗体
4. 美观的视觉效果和布局算法

### 3.3 实现步骤

#### 3.3.1 创建流程导航图节点类型
- 在Nodes目录下创建新的节点类，如ProcessNavigationNode.cs
- 继承自BaseNode，实现流程导航节点的特殊属性
- 添加节点关联的业务单据类型属性

#### 3.3.2 设计流程导航图编辑器
- 扩展WFMainForm.cs界面，添加流程导航图模式
- 创建专门的工具栏和菜单项用于流程导航图设计
- 实现节点双击事件，设置关联的业务单据类型

#### 3.3.3 实现节点点击事件
- 在Mediator.cs中添加节点点击处理逻辑
- 根据节点关联的业务单据类型，调用相应的窗体打开方法
- 集成现有的业务单据打开帮助类

#### 3.3.4 流程导航图保存和加载
- 扩展WorkflowDefinitionService.cs支持流程导航图的保存
- 创建专门的数据表存储流程导航图定义
- 实现流程导航图的加载功能

#### 3.3.5 美化和布局优化
- 使用Netron的布局算法优化节点排列
- 添加自定义样式支持，提升视觉效果
- 实现流程导航图的导出功能（图片格式）

#### 3.3.6 流程导航图分级管理实现
- 创建ProcessNavigationHierarchyManager.cs组件，实现流程层级关系管理
- 扩展数据结构，添加流程间的父子关系字段
- 实现流程树形结构构建和导航功能
- 添加层级关系验证，防止循环引用和深度超限

## 4. 功能二：实际工作流设计

### 4.1 功能目标
设计可执行的工作流程，支持单据审批、人员指派等业务操作

### 4.2 设计要点
1. 扩展现有工作流设计器功能
2. 支持与业务单据的深度集成
3. 实现审批人员指派和通知机制
4. 支持条件分支和自动结案

### 4.3 实现步骤

#### 4.3.1 扩展节点类型
- 基于现有的CountersignNode.cs和OrSignNode.cs进行扩展
- 添加与业务单据关联的属性
- 实现审批人员自动指派功能

#### 4.3.2 业务单据集成
- 创建业务单据与工作流的关联机制
- 实现工作流启动时自动关联业务单据数据
- 添加业务单据状态更新机制

#### 4.3.3 审批流程优化
- 扩展CountersignStep.cs和OrSignStep.cs支持更多审批场景
- 实现审批通知机制（邮件、系统消息等）
- 添加审批超时处理功能

#### 4.3.4 条件分支和自动结案
- 扩展WFConditionStep.cs支持复杂的业务条件判断
- 实现自动结案逻辑，根据业务规则自动完成流程
- 添加流程监控和管理功能

#### 4.3.5 工作流执行和监控
- 扩展WorkflowDefinitionConverter.cs支持更多业务场景
- 实现工作流执行状态的实时监控
- 添加工作流执行日志和审计功能

## 5. 系统集成

### 5.1 与ERP主系统的集成
- 在MainForm.cs中添加流程导航图展示区域
- 实现工作台中流程导航图的自动加载
- 集成现有的用户权限管理系统
- 添加流程导航图分级展示功能，支持树形结构导航
- 实现流程间的层级跳转和关联显示

### 5.2 数据库集成
- 扩展现有的数据库表结构，支持流程导航图存储
- 实现工作流定义和执行数据的持久化
- 添加数据同步和备份机制

### 5.3 用户界面集成
- 在现有菜单系统中添加工作流相关菜单项
- 实现统一的用户操作界面
- 添加工作流设计器的快捷访问入口

## 6. 开发计划

### 6.1 第一阶段：基础框架搭建（2周）
1. 创建流程导航图节点类型
2. 扩展工作流设计器界面
3. 实现基本的保存和加载功能

### 6.2 第二阶段：流程导航图功能实现（3周）
1. 实现节点点击事件和业务单据关联
2. 完善流程导航图的美化和布局功能
3. 实现流程导航图在工作台的展示

### 6.3 第三阶段：实际工作流功能完善（4周）
1. 扩展节点类型和审批功能
2. 实现与业务单据的深度集成
3. 完善条件分支和自动结案功能

### 6.4 第四阶段：系统集成和测试（3周）
1. 完成与ERP主系统的集成
2. 进行全面的功能测试和性能优化
3. 编写用户文档和操作手册

## 7. 风险评估和应对措施

### 7.1 技术风险
- Netron控件的扩展性可能受限
- WorkflowCore与现有业务系统的集成复杂度高
- 流程分级管理可能导致数据结构复杂度增加
- 层级过深可能影响性能和用户体验

### 7.2 应对措施
- 提前进行技术验证和原型开发
- 分阶段实现功能，降低集成风险
- 建立完善的测试机制

## 8. 验收标准

### 8.1 功能验收
- 流程导航图能够正常显示和交互
- 实际工作流能够正确执行和监控
- 与现有ERP系统的集成无问题
- 流程导航图分级管理功能正常工作
- 流程间的层级关系正确维护
- 树形导航结构正确显示和操作
- 层级验证机制有效防止错误关系

### 8.2 性能验收
- 流程导航图加载时间小于2秒
- 工作流执行效率满足业务要求
- 系统资源占用在合理范围内