# æµç¨‹å¯¼èˆªå›¾åŠŸèƒ½é›†æˆæŒ‡å—

## ğŸ“‹ å®Œæˆæ¸…å•

### âœ… å·²å®Œæˆçš„å·¥ä½œ

1. **æ•°æ®åº“è®¾è®¡**
   - âœ… `tb_ProcessNavigation` è¡¨ï¼ˆæµç¨‹å¯¼èˆªå›¾å®šä¹‰ï¼‰
   - âœ… `tb_ProcessNavigationNode` è¡¨ï¼ˆæµç¨‹å¯¼èˆªå›¾èŠ‚ç‚¹ï¼‰
   - âœ… å®Œæ•´çš„æ•°æ®åº“è„šæœ¬ï¼ˆåŒ…å«ç´¢å¼•ã€è§¦å‘å™¨ã€è§†å›¾ã€å­˜å‚¨è¿‡ç¨‹ï¼‰

2. **å®ä½“æ¨¡å‹**
   - âœ… `tb_ProcessNavigation.cs` å®ä½“ç±»
   - âœ… `tb_ProcessNavigationNode.cs` å®ä½“ç±»

3. **æœåŠ¡å±‚**
   - âœ… `Itb_ProcessNavigationServices.cs` æœåŠ¡æ¥å£
   - âœ… `tb_ProcessNavigationServices.cs` æœåŠ¡å®ç°
   - âœ… `Itb_ProcessNavigationNodeServices.cs` èŠ‚ç‚¹æœåŠ¡æ¥å£
   - âœ… `ProcessNavigationService.cs` æµç¨‹å¯¼èˆªå›¾å¢å¼ºæœåŠ¡
   - âœ… `ProcessNavigationPersistence.cs` æµç¨‹å¯¼èˆªå›¾æŒä¹…åŒ–æœåŠ¡

4. **ä¸šåŠ¡ç»„ä»¶**
   - âœ… `BusinessNodeTemplateManager.cs` ä¸šåŠ¡èŠ‚ç‚¹æ¨¡æ¿ç®¡ç†å™¨
   - âœ… `ProcessNavigationDesigner.cs` æµç¨‹å¯¼èˆªå›¾è®¾è®¡å™¨
   - âœ… `ProcessNavigationManager.cs` æµç¨‹å¯¼èˆªå›¾ç®¡ç†å™¨
   - âœ… `ProcessNavigationHierarchyManager.cs` æµç¨‹å¯¼èˆªå›¾åˆ†çº§ç®¡ç†ç»„ä»¶

5. **UIç»„ä»¶**
   - âœ… `ProcessNavigationNode.cs` Netronå›¾å½¢èŠ‚ç‚¹
   - âœ… `ProcessNavigationNodePropertiesDialog.cs` èŠ‚ç‚¹å±æ€§å¯¹è¯æ¡†
   - âœ… `MenuHelperExtensions.cs` èœå•æ‰“å¼€æ‰©å±•æ–¹æ³•

6. **é›†æˆä»£ç **
   - âœ… `MainFormIntegration.cs` ä¸»çª—ä½“é›†æˆä»£ç 
   - âœ… `MainFormIntegrationExtensions.cs` ä¸»çª—ä½“é›†æˆæ‰©å±•

## ğŸ”§ éœ€è¦æ‰‹åŠ¨é›†æˆçš„éƒ¨åˆ†

### 1. ä¸»çª—ä½“é›†æˆ

åœ¨ `MainForm.cs` çš„ `Load` äº‹ä»¶ä¸­æ·»åŠ ï¼š

```csharp
private async void MainForm_Load(object sender, EventArgs e)
{
    // å…¶ä»–åˆå§‹åŒ–ä»£ç ...
    
    // åˆå§‹åŒ–æµç¨‹å¯¼èˆªå›¾åŠŸèƒ½
    await this.InitializeProcessNavigationAsync(logger);
    
    // æ·»åŠ æµç¨‹å¯¼èˆªå›¾èœå•é¡¹
    this.AddProcessNavigationMenuItems(logger);
}
```

### 2. èœå•é›†æˆ

åœ¨ä¸»çª—ä½“çš„èœå•ç³»ç»Ÿä¸­æ·»åŠ æµç¨‹å¯¼èˆªå›¾ç›¸å…³èœå•ï¼š

```csharp
// åœ¨èœå•åˆ›å»ºä»£ç ä¸­æ·»åŠ 
var processNavigationMenu = new ToolStripMenuItem("æµç¨‹å¯¼èˆªå›¾");
processNavigationMenu.DropDownItems.Add("è®¾è®¡å™¨", null, (s, e) => this.ShowProcessNavigationDesigner(logger));
processNavigationMenu.DropDownItems.Add("åˆ·æ–°", null, async (s, e) => await this.RefreshProcessNavigationAsync(logger));

// æ·»åŠ åˆ°ä¸»èœå•
mainMenuStrip.Items.Add(processNavigationMenu);
```

### 3. æ§åˆ¶ä¸­å¿ƒé›†æˆ

å¦‚æœä¸»çª—ä½“æœ‰æ§åˆ¶ä¸­å¿ƒå®¹å™¨ï¼Œæ·»åŠ æµç¨‹å¯¼èˆªå›¾ç®¡ç†å™¨ï¼š

```csharp
// åœ¨æ§åˆ¶ä¸­å¿ƒåˆå§‹åŒ–ä»£ç ä¸­æ·»åŠ 
var navigationPanel = new Panel();
navigationPanel.Dock = DockStyle.Fill;

var navigationManager = new ProcessNavigationManager();
navigationManager.Dock = DockStyle.Fill;

navigationPanel.Controls.Add(navigationManager);
controlCenterContainer.Controls.Add(navigationPanel);
```

## ğŸš€ å¯åŠ¨æ­¥éª¤

### 1. æ•°æ®åº“åˆå§‹åŒ–

æ‰§è¡Œæ•°æ®åº“è„šæœ¬ï¼š
```sql
-- æ‰§è¡Œå®Œæ•´çš„æ•°æ®åº“è„šæœ¬
-- è·¯å¾„ï¼šRUINORERP.UI\WorkFlowDesigner\Database\tb_ProcessNavigation_Complete.sql

-- æ‰§è¡Œå±‚çº§ç»“æ„æ›´æ–°è„šæœ¬
-- è·¯å¾„ï¼šRUINORERP.UI\WorkFlowDesigner\Database\tb_ProcessNavigation_HierarchyUpdate.sql
```

### 2. ç¼–è¯‘é¡¹ç›®

ç¡®ä¿æ‰€æœ‰æ–°æ–‡ä»¶éƒ½è¢«åŒ…å«åœ¨é¡¹ç›®ä¸­ï¼š
- æ£€æŸ¥ `.csproj` æ–‡ä»¶æ˜¯å¦åŒ…å«æ–°æ·»åŠ çš„æ–‡ä»¶
- ç¡®ä¿æ‰€æœ‰å¼•ç”¨éƒ½æ­£ç¡®

### 3. è¿è¡Œæµ‹è¯•

1. **å¯åŠ¨ä¸»çª—ä½“**
2. **æ£€æŸ¥æµç¨‹å¯¼èˆªå›¾æ˜¯å¦è‡ªåŠ¨åŠ è½½**
3. **æµ‹è¯•èœå•é¡¹æ˜¯å¦æ­£å¸¸å·¥ä½œ**
4. **éªŒè¯è®¾è®¡å™¨æ˜¯å¦èƒ½æ­£å¸¸æ‰“å¼€**

## ğŸ“ é…ç½®è¯´æ˜

### 1. æœåŠ¡æ³¨å†Œ

ç¡®ä¿åœ¨ä¾èµ–æ³¨å…¥å®¹å™¨ä¸­æ³¨å†Œäº†ç›¸å…³æœåŠ¡ï¼š

```csharp
// åœ¨ Startup.cs æˆ–ç›¸å…³é…ç½®æ–‡ä»¶ä¸­
services.AddScoped<Itb_ProcessNavigationServices, tb_ProcessNavigationServices>();
services.AddScoped<Itb_ProcessNavigationNodeServices, tb_ProcessNavigationNodeServices>();
services.AddScoped<ProcessNavigationService>();
services.AddScoped<ProcessNavigationPersistence>();
services.AddScoped<ProcessNavigationHierarchyManager>();
```

### 2. æƒé™é…ç½®

æ ¹æ®éœ€è¦é…ç½®ç”¨æˆ·æƒé™ï¼š

```sql
-- ä¸ºç”¨æˆ·åˆ†é…æµç¨‹å¯¼èˆªå›¾è®¿é—®æƒé™
INSERT INTO tb_UserModulePermission (UserID, ModuleID, HasPermission) 
VALUES (1, 1, 1); -- ç»™ç”¨æˆ·1åˆ†é…æ¨¡å—1çš„æƒé™
```

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### 1. åˆ›å»ºæµç¨‹å¯¼èˆªå›¾

```csharp
// æ˜¾ç¤ºè®¾è®¡å™¨
var designer = new ProcessNavigationDesigner();
designer.CurrentMode = ProcessNavigationMode.è®¾è®¡æ¨¡å¼;
designer.ShowDialog();
```

### 2. åŠ è½½æµç¨‹å¯¼èˆªå›¾

```csharp
// åœ¨ä¸»çª—ä½“ä¸­åŠ è½½
var navigationManager = new ProcessNavigationManager();
navigationManager.CurrentNavigation = await GetDefaultNavigationAsync();
```

### 3. ä½¿ç”¨åˆ†çº§ç®¡ç†åŠŸèƒ½

```csharp
// è·å–åˆ†çº§ç®¡ç†å™¨
var hierarchyManager = new ProcessNavigationHierarchyManager();

// è®¾ç½®æµç¨‹ä¹‹é—´çš„çˆ¶å­å…³ç³»
hierarchyManager.SetParentProcess(parentNavigationID, childNavigationID);

// è·å–æ‰€æœ‰å­æµç¨‹
var childProcesses = await hierarchyManager.GetChildProcessesAsync(parentNavigationID);

// è·å–æµç¨‹çš„å®Œæ•´è·¯å¾„
var processPath = await hierarchyManager.GetProcessPathAsync(navigationID);

// æ„å»ºå¯¼èˆªæ ‘
var navigationTree = await hierarchyManager.BuildNavigationTreeAsync();
```

### 3. å¤„ç†èŠ‚ç‚¹ç‚¹å‡»

```csharp
// èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶å¤„ç†
private void NavigationManager_NodeClick(object sender, ProcessNodeClickEventArgs e)
{
    var node = e.Node;
    
    switch (node.BusinessType)
    {
        case ProcessNavigationNodeBusinessType.èœå•èŠ‚ç‚¹:
            MenuHelperExtensions.OpenMenu(node.MenuID.Value);
            break;
        case ProcessNavigationNodeBusinessType.æ¨¡å—èŠ‚ç‚¹:
            LoadModuleNavigation(node.ModuleID.Value);
            break;
    }
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¾èµ–å…³ç³»

ç¡®ä¿ä»¥ä¸‹ä¾èµ–å·²æ­£ç¡®å¼•ç”¨ï¼š
- `Netron.GraphLib` - å›¾å½¢åº“
- `SqlSugar` - ORMæ¡†æ¶
- `Krypton.Toolkit` - UIç»„ä»¶åº“
- `Newtonsoft.Json` - JSONåºåˆ—åŒ–åº“ï¼ˆç”¨äºæŒä¹…åŒ–æœåŠ¡ï¼‰

### 2. å‘½åç©ºé—´

ç¡®ä¿åœ¨ç›¸å…³æ–‡ä»¶ä¸­æ·»åŠ äº†å¿…è¦çš„å‘½åç©ºé—´ï¼š
```csharp
using RUINORERP.UI.WorkFlowDesigner;
using RUINORERP.UI.WorkFlowDesigner.Nodes;
using RUINORERP.UI.WorkFlowDesigner.Dialogs;
```

### 3. èµ„æºæ–‡ä»¶

å¦‚æœä½¿ç”¨äº†å›¾æ ‡æˆ–å›¾ç‰‡èµ„æºï¼Œç¡®ä¿ï¼š
- èµ„æºæ–‡ä»¶å·²æ·»åŠ åˆ°é¡¹ç›®
- èµ„æºçš„ç”Ÿæˆæ“ä½œè®¾ç½®ä¸º"åµŒå…¥çš„èµ„æº"

## ğŸ” æ•…éšœæ’é™¤

### 1. ç¼–è¯‘é”™è¯¯

**é—®é¢˜**ï¼šæ‰¾ä¸åˆ°ç±»å‹æˆ–å‘½åç©ºé—´
**è§£å†³**ï¼šæ£€æŸ¥é¡¹ç›®å¼•ç”¨å’Œå‘½åç©ºé—´å¯¼å…¥

**é—®é¢˜**ï¼šç¼ºå°‘æ–¹æ³•æˆ–å±æ€§
**è§£å†³**ï¼šç¡®è®¤ä½¿ç”¨äº†æ­£ç¡®çš„æ–¹æ³•ç­¾å

### 2. è¿è¡Œæ—¶é”™è¯¯

**é—®é¢˜**ï¼šæœåŠ¡æ³¨å…¥å¤±è´¥
**è§£å†³**ï¼šæ£€æŸ¥æœåŠ¡æ³¨å†Œå’Œä¾èµ–æ³¨å…¥é…ç½®

**é—®é¢˜**ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥
**è§£å†³**ï¼šæ£€æŸ¥è¿æ¥å­—ç¬¦ä¸²å’Œæ•°æ®åº“æƒé™

### 3. UIæ˜¾ç¤ºé—®é¢˜

**é—®é¢˜**ï¼šæ§ä»¶ä¸æ˜¾ç¤º
**è§£å†³**ï¼šæ£€æŸ¥Dockå±æ€§å’Œçˆ¶å®¹å™¨è®¾ç½®

**é—®é¢˜**ï¼šäº‹ä»¶ä¸å“åº”
**è§£å†³**ï¼šæ£€æŸ¥äº‹ä»¶ç»‘å®šå’Œæ§ä»¶åˆå§‹åŒ–é¡ºåº

### 4. åˆ†çº§ç®¡ç†é—®é¢˜

**é—®é¢˜**ï¼šå¾ªç¯å¼•ç”¨é”™è¯¯
**è§£å†³**ï¼šä½¿ç”¨`ProcessNavigationHierarchyManager`çš„`CheckCircularReference`æ–¹æ³•æ£€æŸ¥æµç¨‹å±‚çº§å…³ç³»

**é—®é¢˜**ï¼šå±‚çº§æ·±åº¦é™åˆ¶
**è§£å†³**ï¼šé»˜è®¤æ”¯æŒæœ€å¤š5çº§åµŒå¥—ï¼Œè¶…è¿‡ä¼šæŠ›å‡ºå¼‚å¸¸

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®ç¼“å­˜

```csharp
// ä½¿ç”¨å†…å­˜ç¼“å­˜
private readonly IMemoryCache _cache;

public async Task<List<tb_ProcessNavigation>> GetCachedNavigationsAsync()
{
    return await _cache.GetOrCreateAsync("ProcessNavigations", 
        async () => await _service.QueryableAsync().ToListAsync(),
        TimeSpan.FromMinutes(30));
}
```

### 2. å¼‚æ­¥åŠ è½½

```csharp
// ä½¿ç”¨å¼‚æ­¥æ“ä½œé¿å…UIé˜»å¡
private async void LoadNavigationAsync()
{
    this.Cursor = Cursors.WaitCursor;
    try
    {
        var navigations = await _service.QueryableAsync().ToListAsync();
        // æ›´æ–°UI
    }
    finally
    {
        this.Cursor = Cursors.Default;
    }
}
```

### 3. å»¶è¿ŸåŠ è½½

```csharp
// æŒ‰éœ€åŠ è½½èŠ‚ç‚¹è¯¦æƒ…
private async void LoadNodeDetailsAsync(ProcessNavigationNode node)
{
    if (node.MenuID.HasValue && !node.IsLoaded)
    {
        node.MenuInfo = await _menuService.QueryableByIDAsync(node.MenuID.Value);
        node.IsLoaded = true;
    }
}
```

## ğŸ‰ å®ŒæˆéªŒè¯

å½“ä»¥ä¸‹åŠŸèƒ½éƒ½æ­£å¸¸å·¥ä½œæ—¶ï¼Œè¯´æ˜é›†æˆæˆåŠŸï¼š

1. âœ… ä¸»çª—ä½“å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½é»˜è®¤æµç¨‹å¯¼èˆªå›¾
2. âœ… æµç¨‹å¯¼èˆªå›¾èŠ‚ç‚¹èƒ½æ­£å¸¸æ˜¾ç¤º
3. âœ… ç‚¹å‡»èŠ‚ç‚¹èƒ½æ­£ç¡®æ‰“å¼€å¯¹åº”åŠŸèƒ½
4. âœ… è®¾è®¡å™¨èƒ½æ­£å¸¸æ‰“å¼€å’Œä½¿ç”¨
5. âœ… èŠ‚ç‚¹å±æ€§èƒ½æ­£å¸¸ç¼–è¾‘
6. âœ… æµç¨‹å¯¼èˆªå›¾èƒ½æ­£å¸¸ä¿å­˜å’ŒåŠ è½½
7. âœ… èœå•é¡¹èƒ½æ­£å¸¸å·¥ä½œ
8. âœ… æƒé™æ§åˆ¶èƒ½æ­£å¸¸ç”Ÿæ•ˆ

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨é›†æˆè¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. **æ—¥å¿—æ–‡ä»¶**ï¼šæŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
2. **æ•°æ®åº“çŠ¶æ€**ï¼šç¡®è®¤è¡¨ç»“æ„å’Œæ•°æ®å®Œæ•´æ€§
3. **é…ç½®æ–‡ä»¶**ï¼šæ£€æŸ¥æœåŠ¡é…ç½®å’Œè¿æ¥å­—ç¬¦ä¸²
4. **é¡¹ç›®å¼•ç”¨**ï¼šç¡®è®¤æ‰€æœ‰å¿…è¦çš„å¼•ç”¨éƒ½å·²æ·»åŠ 

---

**æ­å–œï¼** ğŸ‰ æµç¨‹å¯¼èˆªå›¾åŠŸèƒ½å·²ç»å®Œæ•´å®ç°å¹¶å¯ä»¥é›†æˆåˆ°æ‚¨çš„ERPç³»ç»Ÿä¸­äº†ï¼