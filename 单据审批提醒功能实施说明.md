# 单据审批提醒功能实施说明

## 一、概述

本文档说明如何使用新实现的**单据提交审批提醒功能**。该功能基于现有的安全库存提醒架构，使用已存在的 `DocApprovalConfig` 类实现单据状态变更时的智能提醒。

## 二、功能特性

### 2.1 支持的单据操作类型
- **提交操作** (ActionType = 1) - 单据提交时触发
- **审核操作** (ActionType = 2) - 单据审核通过时触发
- **结案操作** (ActionType = 4) - 单据完结时触发

### 2.2 配置项说明

| 配置项 | 说明 | 必填 |
|--------|------|------|
| 单据类型 | 需要监控的单据类型（支持多选） | 是 |
| 目标状态(ToBizType) | 触发提醒的目标状态 | 否 |
| 操作类型(ActionType) | 触发提醒的操作类型 | 是 |
| 目标角色(TargetRoles) | 接收提醒的角色ID列表 | 否 |
| 审批人(Approvers) | 具体审批人员ID列表 | 否 |
| 超时时间(TimeoutMinutes) | 超时多少分钟要提醒 | 是 |
| 实时提醒(EnableRealtimeReminders) | 是否启用实时提醒 | 否 |
| 审批阈值(ApprovalThreshold) | 审批金额阈值 | 否 |
| 检测频率 | 定期检查的间隔时间（分钟） | 是 |

## 三、使用步骤

### 3.1 创建新的审批提醒规则

1. 打开 **提醒规则管理** 窗体
2. 点击 **新增** 按钮
3. 填写基本信息：
   - 规则名称：如"销售订单审批提醒"
   - 业务类型：选择 **单据提交审批提醒**
   - 优先级：根据需要选择
   - 通知渠道：工作流消息、短信等
   - 有效日期和失效日期
4. 点击 **配置业务规则** 按钮
5. 在弹出的 **单据提交审批提醒配置** 窗体中进行详细配置

### 3.2 配置业务规则详细步骤

#### 步骤1：配置检测频率
- 在"检测频率(分钟)"字段输入检查间隔
- 建议值：1-5分钟
- 较小的值响应更快，但会增加系统负载

#### 步骤2：配置单据类型
1. 点击"选择..."按钮
2. 在弹出的选择器中勾选需要监控的单据类型
3. 例如：销售订单、采购订单、付款单等
4. 点击"确认"保存选择
5. 选中的单据类型会显示在下方的列表中

#### 步骤3：配置目标状态
- 从"目标状态"下拉框中选择触发提醒的目标状态
- 常用选择：新建（提交后）、确认（审核通过）
- 对应字段：`ToBizType`

#### 步骤4：配置触发时机
勾选需要触发提醒的操作类型（实际对应 `ActionType`）：
- ☐ 单据提交时（ActionType = 1，推荐勾选）
- ☑ 单据审核时（ActionType = 2，推荐勾选）
- ☐ 单据结案时（ActionType = 4）

**注意**：目前只能选择单一操作类型，配置时会覆盖之前的设置。

#### 步骤5：配置接收对象

**方式一：选择审批人员（Approvers）**
1. 点击"选择..."按钮
2. 在弹出的选择器中勾选需要接收提醒的用户
3. 点击"确认"保存选择

**方式二：选择接收角色（TargetRoles）**
1. 点击"选择..."按钮
2. 选择需要接收提醒的角色（如：财务主管、采购经理）
3. 该角色下的所有用户都会收到提醒

**注意**：可以同时选择人员和角色，但至少选择一种。部门选择暂未实现。

#### 步骤6：保存配置
1. 点击"确定"按钮保存配置
2. 系统会自动验证配置的完整性
3. 如果验证通过，配置信息会自动序列化为JSON并保存到提醒规则中
4. 如果验证失败，会提示错误信息，请根据提示修正配置

### 3.3 验证规则

配置完成后，可以查看JSON配置确认设置：

```json
{
  "CheckIntervalByMinutes": 1,
  "DocumentTypes": [0, 3],
  "ToBizType": 2,
  "ActionType": 2,
  "TargetRoles": [1, 2],
  "Approvers": [3],
  "TimeoutMinutes": 30,
  "EnableRealtimeReminders": true
}
```

## 四、配置示例

### 示例1：销售订单提交提醒

**配置项：**
- 单据类型：销售订单 (0)
- 目标状态：新建 (2)
- 操作类型：提交时 (1)
- 接收对象：销售经理角色 (TargetRoles)
- 超时时间：30分钟
- 检测频率：2分钟

**效果：**
当销售订单提交后，销售经理角色的所有用户会收到工作流消息。如果30分钟内未处理，会再次提醒。

### 示例2：采购订单审核提醒

**配置项：**
- 单据类型：采购订单 (3)
- 目标状态：确认 (4)
- 操作类型：审核时 (2)
- 接收对象：采购主管 (Approvers)
- 超时时间：60分钟
- 检测频率：5分钟

**效果：**
当采购订单审核通过后，采购主管会收到消息通知。如果60分钟内未进行下一步操作，会再次提醒。

### 示例3：大额付款审批提醒

**配置项：**
- 单据类型：付款申请单 (83)
- 目标状态：新建
- 操作类型：提交时 (1)
- 接收对象：财务总监 (Approvers)
- 审批阈值：100,000元
- 超时时间：15分钟
- 检测频率：1分钟
- 实时提醒：启用

**效果：**
当付款单提交且金额超过10万元时，财务总监会立即收到提醒（检测频率为1分钟，实时提醒启用）。如果15分钟内未审批，会再次提醒。

## 五、与现有功能的关系

### 5.1 使用现有配置类

本功能直接使用已存在的 `DocApprovalConfig` 类：

| 特性 | 说明 |
|------|------|
| 配置类 | DocApprovalConfig |
| 基类 | RuleConfigBase |
| 配置控件 | UCDocumentApprovalConfigEdit |
| JSON存储 | JsonConfig字段 |
| 验证机制 | Validate()方法 |

### 5.2 与安全库存提醒的对比

| 特性 | 安全库存提醒 | 单据审批提醒 |
|------|------------|------------|
| 配置类 | SafetyStockConfig | DocApprovalConfig |
| 监控对象 | 库存数量 | 单据状态变更 |
| 触发条件 | 库存低于阈值 | 单据操作（提交/审核/结案） |
| 检测频率 | 建议≥30分钟 | 建议≥1分钟 |
| 业务类型枚举 | 安全库存提醒 | 单据提交审批提醒 |

### 5.3 集成方式

在 `UCReminderRuleEdit` 中通过 `LoadBusinessConfig` 方法加载配置控件：

```csharp
switch (reminderBiz)
{
    case ReminderBizType.安全库存提醒:
        // 加载安全库存配置
        break;
    case ReminderBizType.单据提交审批提醒:
        // 加载单据审批配置 (DocApprovalConfig)
        break;
}
```

## 六、注意事项

### 6.1 性能考虑
1. **检测频率**：设置过小的检测频率会增加数据库查询压力
2. **接收对象数量**：尽量使用角色，避免直接选择大量用户
3. **实时提醒**：启用实时提醒会增加服务器负载

### 6.2 验证规则
- 必须选择至少一种单据类型
- 必须选择至少一种接收对象（角色或人员）
- 超时时间必须≥30分钟
- 检测频率建议≥1分钟

### 6.3 已知限制
1. 操作类型（ActionType）目前只能选择单一类型
2. 部门选择功能暂未实现
3. 消息模板功能暂未实现（DocApprovalConfig类中无此字段）
4. 来源状态（FromBizType）和来源-目标业务类型对（FromToBizType）配置未在UI中实现

### 6.4 扩展性
- 可以通过修改 `DocApprovalConfig` 类添加更多配置项
- 可以通过修改 `UCDocumentApprovalConfigEdit` 控件添加更多UI元素
- 可以通过扩展 `ReminderBizType` 枚举添加更多业务类型

## 七、故障排查

### 问题1：配置后没有收到提醒
**排查步骤：**
1. 检查规则是否启用
2. 检查有效日期范围是否正确
3. 检查检测频率设置是否过大
4. 检查接收对象配置是否正确
5. 查看系统日志

### 问题2：配置无法保存
**排查步骤：**
1. 检查是否满足所有必填项
2. 查看验证错误提示
3. 检查超时时间是否≥30分钟

### 问题3：操作类型配置不准确
**原因**：UI中操作类型通过复选框简化实现，只能选择单一类型。
**解决**：如需要更复杂的操作类型配置，可直接编辑JSON或在后续版本中改进UI。

## 八、后续优化建议

1. **多操作类型支持**：支持同时配置多个操作类型
2. **部门选择**：实现按部门选择接收对象
3. **消息模板**：添加消息模板配置功能，支持占位符
4. **来源状态配置**：添加来源状态配置，实现更精确的状态转换监控
5. **条件过滤**：支持按单据金额、客户、供应商等条件过滤
6. **优先级升级**：长时间未处理的提醒自动升级优先级
7. **统计报表**：提供提醒处理情况的统计报表

## 九、技术支持

如有问题，请联系技术支持或查看相关文档：
- 系统架构概述.md
- 提醒规则配置说明.md
- 数据库设计文档.md

## 十、相关文件

### 新增文件
- `RUINORERP.UI/SmartReminderClient/UCDocumentApprovalConfigEdit.cs` - 单据审批配置编辑控件
- `RUINORERP.UI/SmartReminderClient/UCDocumentApprovalConfigEdit.Designer.cs` - 设计器文件

### 修改文件
- `RUINORERP.UI/BI/UCReminderRuleEdit.cs` - 添加单据审批配置加载逻辑

### 使用现有类
- `RUINORERP.Model/ReminderModel/ReminderRules/DocApprovalConfig.cs` - 单据审批配置类（已存在）
- `RUINORERP.Model/ReminderModel/ReminderRules/RuleConfigBase.cs` - 规则配置基类（已存在）

