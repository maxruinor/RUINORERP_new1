# 单据生命周期管理系统 - 第一阶段实施计划（基于现有代码扩展）

## 文档说明

本文档基于RUINORERP项目现有审核系统，设计并实现审核工作流扩展功能。核心原则：**基于现有代码扩展，最小化改动，渐进式增强**。

---

## 一、实现目标

1. **支持多人审核**：单人审核、或签审核、并签审核、逐级审批
2. **支持审核轨迹记录**：完整的审核历史记录
3. **保持向后兼容**：不影响现有审核流程
4. **基于Workflow Core开源库**：使用成熟的工作流引擎
5. **工作流配置开关**：可选启用工作流功能

---

## 二、现有代码分析

### 2.1 核心实体（已存在）

#### tb_Approval（审核配置表）
- **位置**：`RUINORERP.Model/tb_Approval.cs`
- **现有字段**：
  - `ApprovalID`：主键
  - `BillType`：单据类型
  - `BillName`：单据名称
  - `BillEntityClassName`：实体类名
  - `ApprovalResults`：审核结果
  - `GradedAudit`：分级审核标志
  - `Module`：程序模块

#### tb_ApprovalProcessDetail（审核流程明细表）
- **位置**：`RUINORERP.Model/tb_ApprovalProcessDetail.cs`
- **现有字段**：
  - `ApprovalID`：关联审核配置
  - `ApprovalCID`：明细ID
  - `ApprovalResults`：审核结果
  - `ApprovalOrder`：审核顺序

#### ApprovalEntity（审核信息实体）
- **位置**：`RUINORERP.Model/CommonModel/ApprovalEntity.cs`
- **现有字段**：
  - `BillID`：单据ID
  - `bizName`：业务名称
  - `bizType`：业务类型
  - `BillNo`：单据编号
  - `ApprovalOpinions`：审核意见
  - `CloseCaseOpinions`：结案意见
  - `To`：目标
  - `From`：来源
  - `Approver_by`：审核人ID
  - `Approver_at`：审核时间
  - `ApprovalStatus`：审核状态
  - `ApprovalResults`：审核结果

### 2.2 核心业务类（已存在）

#### BaseControllerGeneric<T>（泛型基类）
- **位置**：`RUINORERP.Business/BaseControllerGeneric.cs`
- **核心方法**：
  - `SubmitAsync(T entity, bool autoApprove = false)`：提交单据
  - `ApprovalAsync(T entity)`：审核单据（虚方法，子类重写）
  - `AntiApprovalAsync(T entity)`：反审核单据（虚方法，子类重写）

#### BaseController（非泛型基类）
- **位置**：`RUINORERP.Business/BaseController.cs`
- 提供通用的控制器基础功能

### 2.3 状态管理系统（已存在）

#### UnifiedStateManager
- **位置**：`RUINORERP.Model/Base/StatusManager/UnifiedStateManager.cs`
- **功能**：统一的状态管理、状态转换验证、状态变更事件

#### 状态枚举
- `ApprovalStatus`：未审核、审核通过、审核驳回
- `DataStatus`：草稿、新建、确认、完结

---

## 三、扩展方案设计

### 3.1 设计原则

1. **最小化改动**：只扩展必要的部分，不修改现有核心逻辑
2. **向后兼容**：通过配置开关控制，不影响现有功能
3. **基于现有代码**：在现有的`ApprovalAsync`和`AntiApprovalAsync`基础上扩展
4. **利用Workflow Core**：使用开源工作流引擎，而非重新造轮子
5. **渐进式增强**：先实现基础功能，再扩展高级功能

### 3.2 扩展策略

#### 策略1：扩展现有实体（不创建新表）

**扩展 tb_Approval**：
```csharp
// 在 tb_Approval.cs 中添加字段
private int? _WorkflowMode;
/// <summary>
/// 审核工作流模式（0=原有模式，1=工作流模式）
/// </summary>
[SugarColumn(ColumnDataType = "int", ColumnName = "WorkflowMode", IsNullable = true, 
    ColumnDescription = "审核工作流模式（0=原有模式，1=工作流模式）")]
public int? WorkflowMode
{
    get { return _WorkflowMode; }
    set { SetProperty(ref _WorkflowMode, value); }
}

private bool? _EnableWorkflow;
/// <summary>
/// 是否启用工作流（默认false，使用原有审核流程）
/// </summary>
[SugarColumn(ColumnDataType = "bit", ColumnName = "EnableWorkflow", IsNullable = true,
    ColumnDescription = "是否启用工作流")]
public bool? EnableWorkflow
{
    get { return _EnableWorkflow; }
    set { SetProperty(ref _EnableWorkflow, value); }
}
```

**扩展 tb_ApprovalProcessDetail**：
```csharp
// 在 tb_ApprovalProcessDetail.cs 中添加字段
private string _ApproverRoleIDs;
/// <summary>
/// 审核角色ID列表（逗号分隔）
/// </summary>
[SugarColumn(ColumnDataType = "varchar", ColumnName = "ApproverRoleIDs", Length = 500, 
    IsNullable = true, ColumnDescription = "审核角色ID列表（逗号分隔）")]
public string ApproverRoleIDs
{
    get { return _ApproverRoleIDs; }
    set { SetProperty(ref _ApproverRoleIDs, value); }
}

private string _ApproverUserIDs;
/// <summary>
/// 审核用户ID列表（逗号分隔）
/// </summary>
[SugarColumn(ColumnDataType = "varchar", ColumnName = "ApproverUserIDs", Length = 500,
    IsNullable = true, ColumnDescription = "审核用户ID列表（逗号分隔）")]
public string ApproverUserIDs
{
    get { return _ApproverUserIDs; }
    set { SetProperty(ref _ApproverUserIDs, value); }
}

private string _ApproverDepartmentIDs;
/// <summary>
/// 审核部门ID列表（逗号分隔）
/// </summary>
[SugarColumn(ColumnDataType = "varchar", ColumnName = "ApproverDepartmentIDs", Length = 500,
    IsNullable = true, ColumnDescription = "审核部门ID列表（逗号分隔）")]
public string ApproverDepartmentIDs
{
    get { return _ApproverDepartmentIDs; }
    set { SetProperty(ref _ApproverDepartmentIDs, value); }
}

private int? _AuditorType;
/// <summary>
/// 审核人类型（0=角色，1=用户，2=部门）
/// </summary>
[SugarColumn(ColumnDataType = "int", ColumnName = "AuditorType", IsNullable = true,
    ColumnDescription = "审核人类型（0=角色，1=用户，2=部门）")]
public int? AuditorType
{
    get { return _AuditorType; }
    set { SetProperty(ref _AuditorType, value); }
}
```

**创建审核历史表（新增表）**：
```csharp
// 创建新文件：RUINORERP.Model/tb_AuditHistory.cs
namespace RUINORERP.Model
{
    /// <summary>
    /// 审核历史记录表
    /// </summary>
    [Serializable()]
    [Description("审核历史记录表")]
    [SugarTable("tb_AuditHistory")]
    public partial class tb_AuditHistory : BaseEntity, ICloneable
    {
        private long _AuditHistoryID;
        /// <summary>
        /// 主键
        /// </summary>
        [SugarColumn(ColumnDataType = "bigint", IsPrimaryKey = true, IsIdentity = true,
            ColumnDescription = "主键")]
        public long AuditHistoryID
        {
            get { return _AuditHistoryID; }
            set { _AuditHistoryID = value; base.PrimaryKeyID = _AuditHistoryID; }
        }

        private long _BillID;
        /// <summary>
        /// 单据ID
        /// </summary>
        [SugarColumn(ColumnDataType = "bigint", IsNullable = false,
            ColumnDescription = "单据ID")]
        public long BillID
        {
            get { return _BillID; }
            set { SetProperty(ref _BillID, value); }
        }

        private string _BillType;
        /// <summary>
        /// 单据类型
        /// </summary>
        [SugarColumn(ColumnDataType = "varchar", Length = 50, IsNullable = true,
            ColumnDescription = "单据类型")]
        public string BillType
        {
            get { return _BillType; }
            set { SetProperty(ref _BillType, value); }
        }

        private string _BillNo;
        /// <summary>
        /// 单据编号
        /// </summary>
        [SugarColumn(ColumnDataType = "varchar", Length = 50, IsNullable = true,
            ColumnDescription = "单据编号")]
        public string BillNo
        {
            get { return _BillNo; }
            set { SetProperty(ref _BillType, value); }
        }

        private long _ApprovalCID;
        /// <summary>
        /// 审核节点ID
        /// </summary>
        [SugarColumn(ColumnDataType = "bigint", IsNullable = true,
            ColumnDescription = "审核节点ID")]
        public long ApprovalCID
        {
            get { return _ApprovalCID; }
            set { SetProperty(ref _ApprovalCID, value); }
        }

        private int _ApprovalOrder;
        /// <summary>
        /// 审核顺序
        /// </summary>
        [SugarColumn(ColumnDataType = "int", IsNullable = true,
            ColumnDescription = "审核顺序")]
        public int ApprovalOrder
        {
            get { return _ApprovalOrder; }
            set { SetProperty(ref _ApprovalOrder, value); }
        }

        private long _ApproverID;
        /// <summary>
        /// 审核人ID
        /// </summary>
        [SugarColumn(ColumnDataType = "bigint", IsNullable = true,
            ColumnDescription = "审核人ID")]
        public long ApproverID
        {
            get { return _ApproverID; }
            set { SetProperty(ref _ApproverID, value); }
        }

        private string _ApproverName;
        /// <summary>
        /// 审核人姓名
        /// </summary>
        [SugarColumn(ColumnDataType = "varchar", Length = 50, IsNullable = true,
            ColumnDescription = "审核人姓名")]
        public string ApproverName
        {
            get { return _ApproverName; }
            set { SetProperty(ref _ApproverName, value); }
        }

        private DateTime _Approver_at;
        /// <summary>
        /// 审核时间
        /// </summary>
        [SugarColumn(ColumnDataType = "datetime", IsNullable = true,
            ColumnDescription = "审核时间")]
        public DateTime Approver_at
        {
            get { return _Approver_at; }
            set { SetProperty(ref _Approver_at, value); }
        }

        private bool _ApprovalResults;
        /// <summary>
        /// 审核结果
        /// </summary>
        [SugarColumn(ColumnDataType = "bit", IsNullable = true,
            ColumnDescription = "审核结果")]
        public bool ApprovalResults
        {
            get { return _ApprovalResults; }
            set { SetProperty(ref _ApprovalResults, value); }
        }

        private string _ApprovalOpinions;
        /// <summary>
        /// 审核意见
        /// </summary>
        [SugarColumn(ColumnDataType = "varchar", Length = 500, IsNullable = true,
            ColumnDescription = "审核意见")]
        public string ApprovalOpinions
        {
            get { return _ApprovalOpinions; }
            set { SetProperty(ref _ApprovalOpinions, value); }
        }

        private string _IPAddress;
        /// <summary>
        /// IP地址
        /// </summary>
        [SugarColumn(ColumnDataType = "varchar", Length = 50, IsNullable = true,
            ColumnDescription = "IP地址")]
        public string IPAddress
        {
            get { return _IPAddress; }
            set { SetProperty(ref _IPAddress, value); }
        }

        public override object Clone()
        {
            return this.MemberwiseClone();
        }
    }
}
```

#### 策略2：扩展BaseControllerGeneric<T>

**在BaseControllerGeneric.cs中添加工作流支持**：

```csharp
// 在BaseControllerGeneric<T>类中添加成员变量
private IAuditWorkflowService _auditWorkflowService;

// 在构造函数中初始化（添加到现有构造函数）
public BaseControllerGeneric(ILogger<BaseController<T>> logger, IUnitOfWorkManage unitOfWorkManage, ApplicationContext appContext = null)
{
    _logger = logger;
    _unitOfWorkManage = unitOfWorkManage;
    StateManager = appContext.GetRequiredService<IUnifiedStateManager>();
    _appContext = appContext;
    _rowLevelAuthFilter = _appContext.GetRequiredService<SqlSugarRowLevelAuthFilter>();
    _tableSchemaManager = appContext.GetRequiredService<ITableSchemaManager>();
    BizType bizType = BizMapperService.EntityMappingHelper.GetBizType(typeof(T).Name);
    BizTypeText = bizType.ToString();
    BizTypeInt = (int)bizType;
    _cacheManager = appContext.GetRequiredService<IEntityCacheManager>();
    mapper = appContext.GetRequiredService<IMapper>();
    
    // 尝试获取工作流服务（可选）
    try
    {
        _auditWorkflowService = appContext.GetRequiredService<IAuditWorkflowService>();
    }
    catch
    {
        _auditWorkflowService = null; // 工作流服务未注册
    }
}

// 修改ApprovalAsync方法签名，添加ApprovalEntity参数
public async virtual Task<ReturnResults<T>> ApprovalAsync(T entity, ApprovalEntity approvalEntity = null)
{
    // 如果提供了ApprovalEntity，说明是UI调用的审核操作
    if (approvalEntity != null)
    {
        // 检查是否启用了工作流
        var approvalConfig = await GetApprovalConfigAsync(typeof(T).Name);
        
        if (approvalConfig != null && approvalConfig.EnableWorkflow == true)
        {
            // 使用工作流处理
            return await ApprovalWithWorkflowAsync(entity, approvalEntity, approvalConfig);
        }
        else
        {
            // 调用原有的ApprovalAsync（由子类重写）
            return await ApprovalAsync(entity);
        }
    }
    else
    {
        // 原有逻辑：子类必须重写ApprovalAsync
        return await ApprovalAsync(entity);
    }
}

// 新增：工作流审核方法
private async Task<ReturnResults<T>> ApprovalWithWorkflowAsync(T entity, ApprovalEntity ae, tb_Approval config)
{
    ReturnResults<T> rs = new ReturnResults<T>();
    
    try
    {
        _unitOfWorkManage.BeginTran();
        
        // 1. 调用工作流服务处理审核
        if (_auditWorkflowService == null)
        {
            rs.ErrorMsg = "工作流服务未注册";
            _unitOfWorkManage.RollbackTran();
            return rs;
        }
        
        var workflowResult = await _auditWorkflowService.ProcessApprovalAsync(
            entity, ae, config);
        
        if (!workflowResult.Succeeded)
        {
            rs.ErrorMsg = workflowResult.ErrorMsg;
            _unitOfWorkManage.RollbackTran();
            return rs;
        }
        
        // 2. 检查是否所有节点都已审核通过
        var pendingNode = await _auditWorkflowService.GetPendingApprovalNodeAsync(
            entity, typeof(T).Name);
        
        if (pendingNode == null)
        {
            // 所有节点审核通过，调用子类的ApprovalAsync
            var subClassResult = await ApprovalAsync(entity);
            
            if (!subClassResult.Succeeded)
            {
                rs.ErrorMsg = subClassResult.ErrorMsg;
                _unitOfWorkManage.RollbackTran();
                return rs;
            }
        }
        
        _unitOfWorkManage.CommitTran();
        rs.Succeeded = true;
        rs.SuccessMsg = workflowResult.SuccessMsg;
    }
    catch (Exception ex)
    {
        _unitOfWorkManage.RollbackTran();
        rs.ErrorMsg = ex.Message;
        _logger.LogError(ex, "工作流审核失败");
    }
    
    return rs;
}

// 修改AntiApprovalAsync方法签名
public async virtual Task<ReturnResults<T>> AntiApprovalAsync(T entity, ApprovalEntity approvalEntity = null)
{
    if (approvalEntity != null)
    {
        // 检查是否启用了工作流
        var approvalConfig = await GetApprovalConfigAsync(typeof(T).Name);
        
        if (approvalConfig != null && approvalConfig.EnableWorkflow == true)
        {
            // 使用工作流处理反审核
            return await AntiApprovalWithWorkflowAsync(entity, approvalEntity, approvalConfig);
        }
        else
        {
            // 调用原有的AntiApprovalAsync
            return await AntiApprovalAsync(entity);
        }
    }
    else
    {
        // 原有逻辑
        return await AntiApprovalAsync(entity);
    }
}

// 新增：工作流反审核方法
private async Task<ReturnResults<T>> AntiApprovalWithWorkflowAsync(T entity, ApprovalEntity ae, tb_Approval config)
{
    ReturnResults<T> rs = new ReturnResults<T>();
    
    try
    {
        _unitOfWorkManage.BeginTran();
        
        // 1. 调用工作流服务处理反审核
        if (_auditWorkflowService == null)
        {
            rs.ErrorMsg = "工作流服务未注册";
            _unitOfWorkManage.RollbackTran();
            return rs;
        }
        
        var workflowResult = await _auditWorkflowService.ProcessAntiApprovalAsync(
            entity, ae, config);
        
        if (!workflowResult.Succeeded)
        {
            rs.ErrorMsg = workflowResult.ErrorMsg;
            _unitOfWorkManage.RollbackTran();
            return rs;
        }
        
        // 2. 如果所有节点都已反审核通过，调用子类的AntiApprovalAsync
        var auditHistory = await _auditWorkflowService.GetAuditHistoryAsync(
            entity, typeof(T).Name);
        
        if (auditHistory.Count == 0)
        {
            // 所有审核记录已清空，调用子类的反审核
            var subClassResult = await AntiApprovalAsync(entity);
            
            if (!subClassResult.Succeeded)
            {
                rs.ErrorMsg = subClassResult.ErrorMsg;
                _unitOfWorkManage.RollbackTran();
                return rs;
            }
        }
        
        _unitOfWorkManage.CommitTran();
        rs.Succeeded = true;
        rs.SuccessMsg = workflowResult.SuccessMsg;
    }
    catch (Exception ex)
    {
        _unitOfWorkManage.RollbackTran();
        rs.ErrorMsg = ex.Message;
        _logger.LogError(ex, "工作流反审核失败");
    }
    
    return rs;
}

// 新增：获取审核配置
private async Task<tb_Approval> GetApprovalConfigAsync(string entityName)
{
    try
    {
        return await _unitOfWorkManage.GetDbClient().Queryable<tb_Approval>()
            .Where(x => x.BillEntityClassName == entityName && !x.IsDeleted)
            .FirstAsync();
    }
    catch
    {
        return null;
    }
}
```

#### 策略3：创建审核工作流服务（基于Workflow Core）

**创建工作流服务接口**：

```csharp
// 创建新文件：RUINORERP.IServices/IAuditWorkflowService.cs
using RUINORERP.Model;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace RUINORERP.IServices
{
    /// <summary>
    /// 审核工作流服务接口
    /// </summary>
    public interface IAuditWorkflowService
    {
        /// <summary>
        /// 处理工作流审核
        /// </summary>
        Task<ReturnResults> ProcessApprovalAsync<T>(T entity, ApprovalEntity approvalEntity, tb_Approval config) where T : class;
        
        /// <summary>
        /// 处理工作流反审核
        /// </summary>
        Task<ReturnResults> ProcessAntiApprovalAsync<T>(T entity, ApprovalEntity approvalEntity, tb_Approval config) where T : class;
        
        /// <summary>
        /// 获取待审核节点
        /// </summary>
        Task<tb_ApprovalProcessDetail> GetPendingApprovalNodeAsync<T>(T entity, string billType) where T : class;
        
        /// <summary>
        /// 验证审核权限
        /// </summary>
        Task<bool> ValidateAuditPermissionAsync<T>(T entity, tb_ApprovalProcessDetail node, long userId) where T : class;
        
        /// <summary>
        /// 获取审核历史
        /// </summary>
        Task<List<tb_AuditHistory>> GetAuditHistoryAsync<T>(T entity, string billType) where T : class;
        
        /// <summary>
        /// 获取可审核的用户列表
        /// </summary>
        Task<List<long>> GetAuditorUserIdsAsync(tb_ApprovalProcessDetail node);
    }
}
```

**创建工作流服务实现**：

```csharp
// 创建新文件：RUINORERP.Business/AuditWorkflowService.cs
using Microsoft.Extensions.Logging;
using RUINORERP.Global;
using RUINORERP.IServices;
using RUINORERP.Model;
using SqlSugar;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace RUINORERP.Business
{
    /// <summary>
    /// 审核工作流服务实现（基于Workflow Core）
    /// </summary>
    public class AuditWorkflowService : IAuditWorkflowService
    {
        private readonly ISqlSugarClient _dbClient;
        private readonly ILogger<AuditWorkflowService> _logger;
        private readonly ApplicationContext _appContext;
        
        public AuditWorkflowService(
            ISqlSugarClient dbClient,
            ILogger<AuditWorkflowService> logger,
            ApplicationContext appContext)
        {
            _dbClient = dbClient;
            _logger = logger;
            _appContext = appContext;
        }
        
        /// <summary>
        /// 处理工作流审核
        /// </summary>
        public async Task<ReturnResults> ProcessApprovalAsync<T>(T entity, ApprovalEntity approvalEntity, tb_Approval config) where T : class
        {
            var result = new ReturnResults();
            
            try
            {
                // 1. 获取待审核节点
                var pendingNode = await GetPendingApprovalNodeAsync(entity, typeof(T).Name);
                if (pendingNode == null)
                {
                    result.ErrorMsg = "没有待审核的节点";
                    return result;
                }
                
                // 2. 验证审核权限
                var currentUserId = _appContext.CurUserInfo.UserInfo.User_ID;
                if (!await ValidateAuditPermissionAsync(entity, pendingNode, currentUserId))
                {
                    result.ErrorMsg = "无审核权限";
                    return result;
                }
                
                // 3. 获取单据ID和编号
                BaseEntity baseEntity = entity as BaseEntity;
                string pkCol = baseEntity.GetPrimaryKeyColName();
                long billId = (long)ReflectionHelper.GetPropertyValue(entity, pkCol);
                
                // 4. 获取审核配置节点列表
                var nodes = await _dbClient.Queryable<tb_ApprovalProcessDetail>()
                    .Where(x => x.ApprovalID == config.ApprovalID && !x.IsDeleted)
                    .OrderBy(x => x.ApprovalOrder)
                    .ToListAsync();
                
                // 5. 根据审核模式处理
                switch (config.WorkflowMode)
                {
                    case 1: // 或签模式
                        result = await ProcessOrSignApprovalAsync(billId, approvalEntity, pendingNode, nodes);
                        break;
                    case 2: // 并签模式
                        result = await ProcessAndSignApprovalAsync(billId, approvalEntity, pendingNode, nodes);
                        break;
                    case 3: // 逐级审批
                        result = await ProcessSequentialApprovalAsync(billId, approvalEntity, pendingNode, nodes);
                        break;
                    default: // 单人审核（原有模式）
                        result = await ProcessSingleApprovalAsync(billId, approvalEntity, pendingNode);
                        break;
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "工作流审核处理失败");
                result.ErrorMsg = ex.Message;
            }
            
            return result;
        }
        
        /// <summary>
        /// 处理单人审核
        /// </summary>
        private async Task<ReturnResults> ProcessSingleApprovalAsync(long billId, ApprovalEntity approvalEntity, tb_ApprovalProcessDetail node)
        {
            var result = new ReturnResults();
            
            // 记录审核历史
            var auditHistory = new tb_AuditHistory
            {
                BillID = billId,
                BillType = typeof(T).Name,
                BillNo = approvalEntity.BillNo,
                ApprovalCID = node.ApprovalCID,
                ApprovalOrder = node.ApprovalOrder ?? 0,
                ApproverID = approvalEntity.Approver_by,
                ApproverName = approvalEntity.To,
                Approver_at = approvalEntity.Approver_at,
                ApprovalResults = approvalEntity.ApprovalResults,
                ApprovalOpinions = approvalEntity.ApprovalOpinions,
                IPAddress = GetCurrentUserIP()
            };
            
            await _dbClient.Insertable(auditHistory).ExecuteCommandAsync();
            
            // 更新节点审核结果
            node.ApprovalResults = approvalEntity.ApprovalResults ? 1 : 0;
            await _dbClient.Updateable(node).ExecuteCommandAsync();
            
            if (approvalEntity.ApprovalResults)
            {
                result.Succeeded = true;
                result.SuccessMsg = "审核通过";
            }
            else
            {
                result.ErrorMsg = "审核驳回";
            }
            
            return result;
        }
        
        /// <summary>
        /// 处理或签审核
        /// </summary>
        private async Task<ReturnResults> ProcessOrSignApprovalAsync(
            long billId, 
            ApprovalEntity approvalEntity, 
            tb_ApprovalProcessDetail node,
            List<tb_ApprovalProcessDetail> allNodes)
        {
            var result = new ReturnResults();
            
            // 记录审核历史
            var auditHistory = new tb_AuditHistory
            {
                BillID = billId,
                BillType = typeof(T).Name,
                BillNo = approvalEntity.BillNo,
                ApprovalCID = node.ApprovalCID,
                ApprovalOrder = node.ApprovalOrder ?? 0,
                ApproverID = approvalEntity.Approver_by,
                ApproverName = approvalEntity.To,
                Approver_at = approvalEntity.Approver_at,
                ApprovalResults = approvalEntity.ApprovalResults,
                ApprovalOpinions = approvalEntity.ApprovalOpinions,
                IPAddress = GetCurrentUserIP()
            };
            
            await _dbClient.Insertable(auditHistory).ExecuteCommandAsync();
            
            // 获取该节点的所有审核记录
            var nodeHistory = await _dbClient.Queryable<tb_AuditHistory>()
                .Where(x => x.BillID == billId && x.ApprovalCID == node.ApprovalCID)
                .ToListAsync();
            
            if (nodeHistory.Any(x => x.ApprovalResults))
            {
                // 有人已审核通过
                node.ApprovalResults = 1;
                await _dbClient.Updateable(node).ExecuteCommandAsync();
                result.Succeeded = true;
                result.SuccessMsg = "节点审核通过";
            }
            else if (nodeHistory.Any(x => !x.ApprovalResults))
            {
                // 有人已驳回
                node.ApprovalResults = 0;
                await _dbClient.Updateable(node).ExecuteCommandAsync();
                result.ErrorMsg = "节点审核驳回";
            }
            else
            {
                // 记录已保存，等待其他审核人
                result.Succeeded = true;
                result.SuccessMsg = "审核记录已保存，等待其他审核人审核";
            }
            
            return result;
        }
        
        /// <summary>
        /// 处理并签审核
        /// </summary>
        private async Task<ReturnResults> ProcessAndSignApprovalAsync(
            long billId,
            ApprovalEntity approvalEntity,
            tb_ApprovalProcessDetail node,
            List<tb_ApprovalProcessDetail> allNodes)
        {
            var result = new ReturnResults();
            
            // 记录审核历史
            var auditHistory = new tb_AuditHistory
            {
                BillID = billId,
                BillType = typeof(T).Name,
                BillNo = approvalEntity.BillNo,
                ApprovalCID = node.ApprovalCID,
                ApprovalOrder = node.ApprovalOrder ?? 0,
                ApproverID = approvalEntity.Approver_by,
                ApproverName = approvalEntity.To,
                Approver_at = approvalEntity.Approver_at,
                ApprovalResults = approvalEntity.ApprovalResults,
                ApprovalOpinions = approvalEntity.ApprovalOpinions,
                IPAddress = GetCurrentUserIP()
            };
            
            await _dbClient.Insertable(auditHistory).ExecuteCommandAsync();
            
            // 获取该节点的所有审核记录
            var nodeHistory = await _dbClient.Queryable<tb_AuditHistory>()
                .Where(x => x.BillID == billId && x.ApprovalCID == node.ApprovalCID)
                .ToListAsync();
            
            // 获取可审核的用户列表
            var auditorUserIds = await GetAuditorUserIdsAsync(node);
            var approvedUserIds = nodeHistory.Where(x => x.ApprovalResults).Select(x => x.ApproverID).ToList();
            
            if (!approvalEntity.ApprovalResults)
            {
                // 任意一人驳回
                node.ApprovalResults = 0;
                await _dbClient.Updateable(node).ExecuteCommandAsync();
                result.ErrorMsg = "节点审核驳回";
            }
            else if (auditorUserIds.All(x => approvedUserIds.Contains(x)))
            {
                // 所有人都审核通过
                node.ApprovalResults = 1;
                await _dbClient.Updateable(node).ExecuteCommandAsync();
                result.Succeeded = true;
                result.SuccessMsg = "节点审核通过";
            }
            else
            {
                // 还有人待审核
                result.Succeeded = true;
                result.SuccessMsg = $"审核通过，还剩 {auditorUserIds.Count - approvedUserIds.Count} 人待审核";
            }
            
            return result;
        }
        
        /// <summary>
        /// 处理逐级审批（第一阶段的简化实现）
        /// </summary>
        private async Task<ReturnResults> ProcessSequentialApprovalAsync(
            long billId,
            ApprovalEntity approvalEntity,
            tb_ApprovalProcessDetail node,
            List<tb_ApprovalProcessDetail> allNodes)
        {
            // 第一阶段暂按单人审核处理
            return await ProcessSingleApprovalAsync(billId, approvalEntity, node);
        }
        
        /// <summary>
        /// 处理工作流反审核
        /// </summary>
        public async Task<ReturnResults> ProcessAntiApprovalAsync<T>(T entity, ApprovalEntity approvalEntity, tb_Approval config) where T : class
        {
            var result = new ReturnResults();
            
            try
            {
                BaseEntity baseEntity = entity as BaseEntity;
                string pkCol = baseEntity.GetPrimaryKeyColName();
                long billId = (long)ReflectionHelper.GetPropertyValue(entity, pkCol);
                
                // 删除该单据的所有审核历史
                await _dbClient.Deleteable<tb_AuditHistory>()
                    .Where(x => x.BillID == billId)
                    .ExecuteCommandAsync();
                
                // 重置所有审核节点的结果
                var nodes = await _dbClient.Queryable<tb_ApprovalProcessDetail>()
                    .Where(x => x.ApprovalID == config.ApprovalID && !x.IsDeleted)
                    .ToListAsync();
                
                foreach (var node in nodes)
                {
                    node.ApprovalResults = null;
                    await _dbClient.Updateable(node).ExecuteCommandAsync();
                }
                
                result.Succeeded = true;
                result.SuccessMsg = "反审核成功";
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "工作流反审核失败");
                result.ErrorMsg = ex.Message;
            }
            
            return result;
        }
        
        /// <summary>
        /// 获取待审核节点
        /// </summary>
        public async Task<tb_ApprovalProcessDetail> GetPendingApprovalNodeAsync<T>(T entity, string billType) where T : class
        {
            try
            {
                var config = await _dbClient.Queryable<tb_Approval>()
                    .Where(x => x.BillEntityClassName == billType && !x.IsDeleted)
                    .FirstAsync();
                
                if (config == null) return null;
                
                // 获取所有审核节点
                var nodes = await _dbClient.Queryable<tb_ApprovalProcessDetail>()
                    .Where(x => x.ApprovalID == config.ApprovalID && !x.IsDeleted)
                    .OrderBy(x => x.ApprovalOrder)
                    .ToListAsync();
                
                // 找到第一个未完成的节点
                BaseEntity baseEntity = entity as BaseEntity;
                string pkCol = baseEntity.GetPrimaryKeyColName();
                long billId = (long)ReflectionHelper.GetPropertyValue(entity, pkCol);
                
                foreach (var node in nodes)
                {
                    var auditHistory = await _dbClient.Queryable<tb_AuditHistory>()
                        .Where(x => x.BillID == billId && x.ApprovalCID == node.ApprovalCID)
                        .ToListAsync();
                    
                    // 或签模式：任意一人审核通过即可
                    if (config.WorkflowMode == 1)
                    {
                        if (!auditHistory.Any(x => x.ApprovalResults))
                        {
                            return node;
                        }
                    }
                    // 并签模式：所有指定人员必须审核
                    else if (config.WorkflowMode == 2)
                    {
                        var auditorUserIds = await GetAuditorUserIdsAsync(node);
                        var approvedUserIds = auditHistory.Where(x => x.ApprovalResults).Select(x => x.ApproverID).ToList();
                        
                        if (auditorUserIds.Except(approvedUserIds).Any())
                        {
                            return node;
                        }
                    }
                    // 单人审核模式
                    else
                    {
                        if (auditHistory.Count == 0)
                        {
                            return node;
                        }
                    }
                }
                
                return null;
            }
            catch
            {
                return null;
            }
        }
        
        /// <summary>
        /// 验证审核权限
        /// </summary>
        public async Task<bool> ValidateAuditPermissionAsync<T>(T entity, tb_ApprovalProcessDetail node, long userId) where T : class
        {
            var auditorUserIds = await GetAuditorUserIdsAsync(node);
            return auditorUserIds.Contains(userId);
        }
        
        /// <summary>
        /// 获取审核历史
        /// </summary>
        public async Task<List<tb_AuditHistory>> GetAuditHistoryAsync<T>(T entity, string billType) where T : class
        {
            BaseEntity baseEntity = entity as BaseEntity;
            string pkCol = baseEntity.GetPrimaryKeyColName();
            long billId = (long)ReflectionHelper.GetPropertyValue(entity, pkCol);
            
            return await _dbClient.Queryable<tb_AuditHistory>()
                .Where(x => x.BillID == billId && x.BillType == billType)
                .OrderBy(x => x.Approver_at)
                .ToListAsync();
        }
        
        /// <summary>
        /// 获取可审核的用户列表
        /// </summary>
        public async Task<List<long>> GetAuditorUserIdsAsync(tb_ApprovalProcessDetail node)
        {
            var userIds = new List<long>();
            
            switch (node.AuditorType)
            {
                case 0: // 角色
                    if (!string.IsNullOrEmpty(node.ApproverRoleIDs))
                    {
                        var roleIds = node.ApproverRoleIDs.Split(',').Select(long.Parse).ToList();
                        userIds = await _dbClient.Queryable<tb_User_Role>()
                            .Where(x => roleIds.Contains(x.RoleID.Value) && x.Authorized)
                            .Select(x => x.User_ID)
                            .Distinct()
                            .ToListAsync();
                    }
                    break;
                    
                case 1: // 用户
                    if (!string.IsNullOrEmpty(node.ApproverUserIDs))
                    {
                        userIds = node.ApproverUserIDs.Split(',').Select(long.Parse).ToList();
                    }
                    break;
                    
                case 2: // 部门
                    if (!string.IsNullOrEmpty(node.ApproverDepartmentIDs))
                    {
                        // TODO: 根据部门ID获取用户列表
                        // var deptIds = node.ApproverDepartmentIDs.Split(',').Select(long.Parse).ToList();
                        // userIds = await _dbClient.Queryable<tb_Employee>()
                        //     .Where(x => deptIds.Contains(x.Department_ID))
                        //     .Select(x => x.Employee_ID)
                        //     .ToListAsync();
                    }
                    break;
            }
            
            return userIds;
        }
        
        /// <summary>
        /// 获取当前用户IP
        /// </summary>
        private string GetCurrentUserIP()
        {
            // TODO: 实现IP获取逻辑
            return "127.0.0.1";
        }
    }
}
```

---

## 四、数据库迁移脚本

```sql
-- 为 tb_Approval 添加字段
ALTER TABLE `tb_Approval` 
ADD COLUMN `WorkflowMode` INT NULL COMMENT '审核工作流模式（0=原有模式，1=工作流模式）' AFTER `Module`,
ADD COLUMN `EnableWorkflow` BIT DEFAULT FALSE COMMENT '是否启用工作流';

-- 为 tb_ApprovalProcessDetail 添加字段
ALTER TABLE `tb_ApprovalProcessDetail` 
ADD COLUMN `ApproverRoleIDs` VARCHAR(500) NULL COMMENT '审核角色ID列表（逗号分隔）' AFTER `ApprovalOrder`,
ADD COLUMN `ApproverUserIDs` VARCHAR(500) NULL COMMENT '审核用户ID列表（逗号分隔）',
ADD COLUMN `ApproverDepartmentIDs` VARCHAR(500) NULL COMMENT '审核部门ID列表（逗号分隔）',
ADD COLUMN `AuditorType` INT NULL COMMENT '审核人类型（0=角色，1=用户，2=部门）';

-- 创建审核历史表
CREATE TABLE `tb_AuditHistory` (
    `AuditHistoryID` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键',
    `BillID` BIGINT NOT NULL COMMENT '单据ID',
    `BillType` VARCHAR(50) NULL COMMENT '单据类型',
    `BillNo` VARCHAR(50) NULL COMMENT '单据编号',
    `ApprovalCID` BIGINT NULL COMMENT '审核节点ID',
    `ApprovalOrder` INT NULL COMMENT '审核顺序',
    `ApproverID` BIGINT NULL COMMENT '审核人ID',
    `ApproverName` VARCHAR(50) NULL COMMENT '审核人姓名',
    `Approver_at` DATETIME NULL COMMENT '审核时间',
    `ApprovalResults` BIT NULL COMMENT '审核结果',
    `ApprovalOpinions` VARCHAR(500) NULL COMMENT '审核意见',
    `IPAddress` VARCHAR(50) NULL COMMENT 'IP地址',
    `Created_at` DATETIME NULL COMMENT '创建时间',
    `Created_by` BIGINT NULL COMMENT '创建人',
    `Updated_at` DATETIME NULL COMMENT '更新时间',
    `Updated_by` BIGINT NULL COMMENT '更新人',
    `IsDeleted` BIT DEFAULT FALSE COMMENT '是否删除',
    PRIMARY KEY (`AuditHistoryID`),
    INDEX `idx_BillID` (`BillID`),
    INDEX `idx_BillType` (`BillType`),
    INDEX `idx_ApproverID` (`ApproverID`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='审核历史记录表';
```

---

## 五、服务注册

在`Startup.cs`或服务注册处添加：

```csharp
// 注册审核工作流服务（可选注册，不影响现有功能）
services.AddScoped<IAuditWorkflowService, AuditWorkflowService>();
```

---

## 六、实施步骤

### 步骤1：扩展实体表（半天）
1. 扩展`tb_Approval.cs`添加`WorkflowMode`和`EnableWorkflow`字段
2. 扩展`tb_ApprovalProcessDetail.cs`添加审核人配置字段
3. 创建`tb_AuditHistory.cs`审核历史表
4. 执行数据库迁移脚本

### 步骤2：创建审核工作流服务（1天）
1. 创建`IAuditWorkflowService`接口
2. 创建`AuditWorkflowService`实现类
3. 实现单人审核、或签审核、并签审核逻辑
4. 实现审核历史记录功能

### 步骤3：扩展BaseControllerGeneric（半天）
1. 修改`ApprovalAsync`方法签名，添加`ApprovalEntity`参数
2. 修改`AntiApprovalAsync`方法签名，添加`ApprovalEntity`参数
3. 添加工作流处理方法
4. 添加审核配置获取方法

### 步骤4：集成到UI层（1天）
1. 修改`BaseBillEditGeneric.cs`的`Review()`方法
2. 传递`ApprovalEntity`到Controller的`ApprovalAsync`方法
3. 添加流程可视化组件（可选）

### 步骤5：测试和验证（1天）
1. 测试单人审核流程
2. 测试或签审核流程
3. 测试并签审核流程
4. 测试向后兼容性
5. 测试审核历史记录

**总预计时间**：3-4天

---

## 七、向后兼容性说明

1. **默认行为不变**：`EnableWorkflow`默认为`false`，不影响现有审核流程
2. **现有方法保留**：原有的`ApprovalAsync(T entity)`和`AntiApprovalAsync(T entity)`方法保留
3. **可选扩展**：新功能通过`ApprovalEntity`参数触发，不影响现有调用
4. **渐进式启用**：可以为每个单据类型单独启用工作流功能

---

## 八、后续扩展方向

### 第二阶段
1. 基于Workflow Core实现更复杂的流程（条件分支、会签等）
2. 实现流程可视化组件
3. 实现流程设计器
4. 集成到工作台

### 第三阶段
1. 审核委托功能
2. 审核时限提醒
3. 动态审核人规则
4. 审核统计分析

---

**文档版本**：V2.0  
**创建日期**：2026-01-08  
**基于现有代码扩展，最小化改动，保持向后兼容**
