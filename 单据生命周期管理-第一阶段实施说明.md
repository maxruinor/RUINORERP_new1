# 单据生命周期管理系统 - 基于现有架构的扩展方案

## 文档说明

本文档基于RUINORERP项目现有审核系统，设计并实现审核工作流扩展功能。核心原则：**复用现有代码，最小化改动，渐进式增强**。

---
我们要实现的功能：

1. 支持多人审核

2. 支持并签审核

3. 支持逐级审批

4. 支持审核轨迹记录


重点要利用目前代码中的现有机制，在这个基础上完善：
其中业务层的BaseControllerGeneric.cs，中的审核与反审核方法。我们新的设计要前置的方法要在原有方法的基础上进行扩展，而不是重写。 目前单一固定的流程和工作流的形式要进行扩展，支持多人审核，并签审核，逐级审批
如果要支持审核轨迹记录，则要在BaseControllerGeneric.cs中，审核与反审核方法中，添加审核轨迹记录的代码。
如果不影响目前的审核形式，通过工作流配置的形式则需要设置一个开关。
## 一、现有系统架构分析总结

### 1.1 核心实体（已存在，可扩展使用）

#### tb_Approval（审核配置表）
- **位置**：`RUINORERP.Model/tb_Approval.cs`
- **用途**：定义单据类型的审核流程配置
- **关键字段**：
  - `ApprovalID`：主键
  - `BillType`：单据类型
  - `BillName`：单据名称
  - `BillEntityClassName`：实体类名
  - `GradedAudit`：分级审核标志
  - `ApprovalResults`：审核结果

#### tb_ApprovalProcessDetail（审核流程明细表）
- **位置**：`RUINORERP.Model/tb_ApprovalProcessDetail.cs`
- **用途**：定义多级审核节点
- **关键字段**：
  - `ApprovalID`：关联审核配置
  - `ApprovalCID`：明细ID
  - `ApprovalOrder`：审核顺序
  - `ApprovalResults`：审核结果

#### ApprovalEntity（审核信息实体）
- **位置**：`RUINORERP.Model/CommonModel/ApprovalEntity.cs`
- **用途**：通用审核信息传递
- **关键字段**：
  - `BillID`：单据ID
  - `bizName`：业务名称
  - `bizType`：业务类型
  - `ApprovalOpinions`：审核意见
  - `ApprovalStatus`：审核状态
  - `ApprovalResults`：审核结果
  - `Approver_by`：审核人ID
  - `Approver_at`：审核时间

### 1.2 审核业务层（已存在，可扩展使用）

#### BaseController（基础控制器）
- **位置**：`RUINORERP.Business/BaseController.cs`
- **核心方法**：
  ```csharp
  public virtual async Task<ReturnResults<T>> SubmitAsync(T entity, bool autoApprove = false)
  public virtual async Task<ReturnResults<T>> ApprovalAsync(T ObjectEntity)
  public virtual async Task<ReturnResults<T>> AntiApprovalAsync(T ObjectEntity)
  ```

#### BaseController<T>（泛型基类）
- **位置**：`RUINORERP.Business/BaseControllerGeneric.cs`
- **特点**：提供通用的单据操作基础框架

#### 具体业务Controller（已实现）
- **tb_PurOrderControllerPartial**：采购订单审核
- **tb_BOM_SControllerPartial**：BOM审核
- **tb_FM_PaymentApplicationControllerPartial**：付款申请审核
- **其他多种业务单据审核**

### 1.3 UI层（已存在，可扩展使用）

#### BaseBillEditGeneric（单据编辑基类）
- **位置**：`RUINORERP.UI/BaseForm/BaseBillEditGeneric.cs`
- **核心方法**：
  ```csharp
  protected async override Task<ReviewResult> Review()           // 审核
  protected async override Task<bool> ReReview()                // 反审核
  private void UpdateUIAfterReview(T entity, ApprovalEntity ae) // 审核后更新UI
  ```

#### frmApproval（审核对话框）
- **位置**：`RUINORERP.UI/CommonUI/frmApproval.cs`
- **用途**：通用的审核对话框，支持同意/不同意和审核意见

### 1.4 状态管理系统（已存在，直接使用）

#### UnifiedStateManager（统一状态管理器）
- **位置**：`RUINORERP.Model/Base/StatusManager/UnifiedStateManager.cs`
- **功能**：
  - 统一的状态类型识别
  - 状态转换验证
  - 状态变更事件

#### 状态枚举（已定义）
- `ApprovalStatus`：审核状态（未审核、审核通过、审核驳回）
- `DataStatus`：单据状态（草稿、新建、确认、完结）
并且状态我们的完整的状态管理架构体系：基于实体模型的基类和：RUINORERP.Model\Base\StatusManager
### 1.5 权限系统（已存在，直接使用）

#### AuthorizeController（权限控制器）
- **位置**：`RUINORERP.Business/Security/AuthorizeController.cs` 这里只是实现了一些系统参数配置性的控件，
- **功能**：基于角色的权限控制
基于角色的控制是通过 几个关系表：用户表，角色表，用户角色表，菜单表，按钮表，字段表。以及相关的表： 用户有对应的窗体去编辑他们的关系。
RUINORERP.Model\tb_P4Button.cs
RUINORERP.Model\tb_P4ButtonFix.cs
RUINORERP.Model\tb_P4Field.cs
RUINORERP.Model\tb_P4FieldFix.cs
RUINORERP.Model\tb_P4Menu.cs
RUINORERP.Model\tb_P4Module.cs
RUINORERP.Model\tb_P4RowAuthPolicyByRole.cs
RUINORERP.Model\tb_P4RowAuthPolicyByUser.cs

通过：RUINORERP.UI\SysConfig\UCUserAuthorization.cs
RUINORERP.UI\SysConfig\UCRoleAuthorization.cs 完成授权。系统只在查询就能根据这些数据来控制了。


#### 用户实体
- `tb_UserInfo`：用户信息
- `tb_Employee`：员工信息
- `tb_User_Role`：用户角色关系

### 1.6 消息通知系统（已存在，直接使用）

#### TodoUpdate（消息模型）
- **位置**：`RUINORERP.PacketSpec/Models/Message/TodoUpdate.cs`
- **用途**：统一的消息通知机制

#### 同步机制
- `SyncTodoUpdatesToServer()`：同步消息到服务器
- 支持多端消息同步

---

## 二、扩展方案设计

### 2.1 设计原则

1. **最小化改动**：不修改现有核心代码，通过扩展实现新功能
2. **向后兼容**：保持现有审核流程不变，新功能可选启用
3. **渐进式增强**：先实现基础功能，再扩展高级功能
4. **复用优先**：优先使用现有组件和机制

### 2.2 扩展点识别

#### 扩展点1：审核配置表扩展
**现有**：`tb_Approval` 和 `tb_ApprovalProcessDetail`
**扩展**：添加工作流配置字段

```csharp
// 扩展 tb_Approval
public enum AuditWorkflowMode
{
    [Description("单人审核")]
    Single = 0,
    [Description("或签审核")]
    OrSign = 1,
    [Description("并签审核")]
    AndSign = 2,
    [Description("逐级审批")]
    Sequential = 3
}

// 在 tb_Approval 中添加字段
public AuditWorkflowMode? WorkflowMode { get; set; }  // 审核模式
public bool EnableWorkflow { get; set; }             // 是否启用工作流
```

**优点**：
- 不创建新表，直接扩展现有表
- 向后兼容，默认值为单人审核
- 无需迁移现有数据

#### 扩展点2：审核节点扩展
**现有**：`tb_ApprovalProcessDetail`
**扩展**：添加审核人配置字段

```csharp
// 在 tb_ApprovalProcessDetail 中添加字段
public string ApproverRoleIDs { get; set; }          // 审核角色ID列表（逗号分隔）
public string ApproverUserIDs { get; set; }          // 审核用户ID列表（逗号分隔）
public string ApproverDepartmentIDs { get; set; }    // 审核部门ID列表（逗号分隔）
public AuditorType? AuditorType { get; set; }        // 审核人类型（角色/用户/部门）
```

**优点**：
- 复用现有的审核顺序机制
- 支持灵活的审核人配置
- 可配置多人审核

#### 扩展点3：审核轨迹记录
**现有**：审计日志系统
**扩展**：添加审核历史记录表

```csharp
/// <summary>
/// 审核历史记录表
/// </summary>
[SugarTable("tb_AuditHistory")]
public class tb_AuditHistory : BaseEntity
{
    public long AuditHistoryID { get; set; }         // 主键
    public long BillID { get; set; }                  // 单据ID
    public string BillType { get; set; }              // 单据类型
    public string BillNo { get; set; }                // 单据编号
    public long ApprovalCID { get; set; }             // 审核节点ID
    public int ApprovalOrder { get; set; }           // 审核顺序
    public long ApproverID { get; set; }             // 审核人ID
    public string ApproverName { get; set; }         // 审核人姓名
    public DateTime Approver_at { get; set; }         // 审核时间
    public bool ApprovalResults { get; set; }         // 审核结果
    public string ApprovalOpinions { get; set; }     // 审核意见
    public string IPAddress { get; set; }             // IP地址
}
```

**优点**：
- 独立的审核历史记录
- 完整的审核轨迹
- 支持多人审核历史查询

#### 扩展点4：BaseController扩展
**现有**：`BaseController<T>` 的 `ApprovalAsync` 方法
**扩展**：添加工作流处理逻辑

```csharp
// 在 BaseController<T> 中添加
public virtual async Task<ReturnResults<T>> ApprovalAsync(T ObjectEntity, ApprovalEntity approvalEntity = null)
{
    // 1. 获取审核配置
    var approvalConfig = await GetApprovalConfigAsync(typeof(T).Name);
    
    // 2. 判断是否启用工作流
    if (approvalConfig?.EnableWorkflow == true)
    {
        // 使用工作流引擎处理
        return await ApprovalWithWorkflowAsync(ObjectEntity, approvalEntity, approvalConfig);
    }
    else
    {
        // 使用原有审核逻辑（保持兼容）
        return await ApprovalWithoutWorkflowAsync(ObjectEntity, approvalEntity);
    }
}

private async Task<ReturnResults<T>> ApprovalWithWorkflowAsync(T entity, ApprovalEntity ae, tb_Approval config)
{
    // 1. 验证审核权限
    if (!await ValidateAuditPermissionAsync(entity, ae, config))
    {
        return ReturnResults<T>.Error("无审核权限");
    }
    
    // 2. 根据审核模式处理
    switch (config.WorkflowMode)
    {
        case AuditWorkflowMode.Single:
            return await ProcessSingleApprovalAsync(entity, ae);
        case AuditWorkflowMode.OrSign:
            return await ProcessOrSignApprovalAsync(entity, ae, config);
        case AuditWorkflowMode.AndSign:
            return await ProcessAndSignApprovalAsync(entity, ae, config);
        case AuditWorkflowMode.Sequential:
            return await ProcessSequentialApprovalAsync(entity, ae, config);
        default:
            return await ProcessSingleApprovalAsync(entity, ae);
    }
}
```

**优点**：
- 通过参数控制是否使用工作流
- 不影响现有审核流程
- 支持多种审核模式

#### 扩展点5：BaseBillEditGeneric扩展
**现有**：`Review()` 和 `ReReview()` 方法
**扩展**：添加流程可视化

```csharp
// 在 BaseBillEditGeneric 中添加
private UCAuditWorkflowVisualizer _workflowVisualizer;

// 在构造函数中初始化
public BaseBillEditGeneric()
{
    // ... 原有代码
    
    // 初始化工作流可视化组件
    _workflowVisualizer = new UCAuditWorkflowVisualizer();
    _workflowVisualizer.Dock = DockStyle.Top;
    _workflowVisualizer.Visible = false;
    
    // 添加到面板（根据实际情况调整）
    this.pnlTop?.Controls.Add(_workflowVisualizer);
}

// 在加载单据时显示工作流
protected override async Task LoadDataAsync(long pkid)
{
    await base.LoadDataAsync(pkid);
    
    // 检查是否启用工作流
    var approvalConfig = await GetApprovalConfigAsync(typeof(T).Name);
    if (approvalConfig?.EnableWorkflow == true)
    {
        _workflowVisualizer.Visible = true;
        await _workflowVisualizer.LoadWorkflowAsync(pkid, typeof(T).Name);
    }
}
```

**优点**：
- 不修改原有Review/ReReview逻辑
- 可选的流程可视化
- 集成到现有界面

---

## 三、实施计划（第一阶段）

### 3.1 目标

实现基础的审核工作流扩展，包括：
1. 扩展现有实体表结构
2. 实现多人审核逻辑（或签、并签）
3. 添加审核历史记录
4. 基础的流程可视化

### 3.2 实施步骤

#### 步骤1：扩展实体表（1天）

**1.1 扩展 tb_Approval**

在 `RUINORERP.Model/tb_Approval.cs` 中添加字段：

```csharp
[SugarTable("tb_Approval")]
public class tb_Approval : BaseEntity, ICloneable
{
    // ... 现有字段保持不变
    
    /// <summary>
    /// 审核模式（0=单人审核，1=或签审核，2=并签审核，3=逐级审批）
    /// </summary>
    public int? WorkflowMode { get; set; }
    
    /// <summary>
    /// 是否启用工作流（默认false，使用原有审核流程）
    /// </summary>
    public bool EnableWorkflow { get; set; } = false;
}
```

**1.2 扩展 tb_ApprovalProcessDetail**

在 `RUINORERP.Model/tb_ApprovalProcessDetail.cs` 中添加字段：

```csharp
[SugarTable("tb_ApprovalProcessDetail")]
public class tb_ApprovalProcessDetail : BaseEntity, ICloneable
{
    // ... 现有字段保持不变
    
    /// <summary>
    /// 审核角色ID列表（逗号分隔）
    /// </summary>
    public string ApproverRoleIDs { get; set; }
    
    /// <summary>
    /// 审核用户ID列表（逗号分隔）
    /// </summary>
    public string ApproverUserIDs { get; set; }
    
    /// <summary>
    /// 审核部门ID列表（逗号分隔）
    /// </summary>
    public string ApproverDepartmentIDs { get; set; }
    
    /// <summary>
    /// 审核人类型（0=角色，1=用户，2=部门）
    /// </summary>
    public int? AuditorType { get; set; }
}
```

**1.3 创建审核历史表**

在 `RUINORERP.Model/tb_AuditHistory.cs` 中创建新表：

```csharp
/// <summary>
/// 审核历史记录表
/// </summary>
[SugarTable("tb_AuditHistory")]
public class tb_AuditHistory : BaseEntity
{
    /// <summary>
    /// 主键
    /// </summary>
    public long AuditHistoryID { get; set; }
    
    /// <summary>
    /// 单据ID
    /// </summary>
    public long BillID { get; set; }
    
    /// <summary>
    /// 单据类型
    /// </summary>
    public string BillType { get; set; }
    
    /// <summary>
    /// 单据编号
    /// </summary>
    public string BillNo { get; set; }
    
    /// <summary>
    /// 审核节点ID
    /// </summary>
    public long ApprovalCID { get; set; }
    
    /// <summary>
    /// 审核顺序
    /// </summary>
    public int ApprovalOrder { get; set; }
    
    /// <summary>
    /// 审核人ID
    /// </summary>
    public long ApproverID { get; set; }
    
    /// <summary>
    /// 审核人姓名
    /// </summary>
    public string ApproverName { get; set; }
    
    /// <summary>
    /// 审核时间
    /// </summary>
    public DateTime Approver_at { get; set; }
    
    /// <summary>
    /// 审核结果
    /// </summary>
    public bool ApprovalResults { get; set; }
    
    /// <summary>
    /// 审核意见
    /// </summary>
    public string ApprovalOpinions { get; set; }
    
    /// <summary>
    /// IP地址
    /// </summary>
    public string IPAddress { get; set; }
}
```

**1.4 创建数据库迁移脚本**

```sql
-- 为 tb_Approval 添加字段
ALTER TABLE `tb_Approval` 
ADD COLUMN `WorkflowMode` INT NULL COMMENT '审核模式（0=单人审核，1=或签审核，2=并签审核，3=逐级审批）' AFTER `ApprovalResults`,
ADD COLUMN `EnableWorkflow` BIT DEFAULT FALSE COMMENT '是否启用工作流';

-- 为 tb_ApprovalProcessDetail 添加字段
ALTER TABLE `tb_ApprovalProcessDetail` 
ADD COLUMN `ApproverRoleIDs` VARCHAR(500) NULL COMMENT '审核角色ID列表（逗号分隔）' AFTER `ApprovalOrder`,
ADD COLUMN `ApproverUserIDs` VARCHAR(500) NULL COMMENT '审核用户ID列表（逗号分隔）',
ADD COLUMN `ApproverDepartmentIDs` VARCHAR(500) NULL COMMENT '审核部门ID列表（逗号分隔）',
ADD COLUMN `AuditorType` INT NULL COMMENT '审核人类型（0=角色，1=用户，2=部门）';

-- 创建审核历史表
CREATE TABLE `tb_AuditHistory` (
    `AuditHistoryID` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键',
    `BillID` BIGINT NOT NULL COMMENT '单据ID',
    `BillType` VARCHAR(50) NULL COMMENT '单据类型',
    `BillNo` VARCHAR(50) NULL COMMENT '单据编号',
    `ApprovalCID` BIGINT NULL COMMENT '审核节点ID',
    `ApprovalOrder` INT NULL COMMENT '审核顺序',
    `ApproverID` BIGINT NULL COMMENT '审核人ID',
    `ApproverName` VARCHAR(50) NULL COMMENT '审核人姓名',
    `Approver_at` DATETIME NULL COMMENT '审核时间',
    `ApprovalResults` BIT NULL COMMENT '审核结果',
    `ApprovalOpinions` VARCHAR(500) NULL COMMENT '审核意见',
    `IPAddress` VARCHAR(50) NULL COMMENT 'IP地址',
    `Created_at` DATETIME NULL COMMENT '创建时间',
    `Created_by` BIGINT NULL COMMENT '创建人',
    `Updated_at` DATETIME NULL COMMENT '更新时间',
    `Updated_by` BIGINT NULL COMMENT '更新人',
    `IsDeleted` BIT DEFAULT FALSE COMMENT '是否删除',
    PRIMARY KEY (`AuditHistoryID`),
    INDEX `idx_BillID` (`BillID`),
    INDEX `idx_BillType` (`BillType`),
    INDEX `idx_ApproverID` (`ApproverID`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='审核历史记录表';
```

#### 步骤2：创建审核工作流服务（2天）

是基于开源的：开源工作流引擎 Workflow Core的基础来编写代码。

**2.1 创建审核工作流接口**

创建 `RUINORERP.IServices/IAuditWorkflowService.cs`：

```csharp
/// <summary>
/// 审核工作流服务接口
/// </summary>
public interface IAuditWorkflowService
{
    /// <summary>
    /// 获取审核配置
    /// </summary>
    Task<tb_Approval> GetApprovalConfigAsync(string entityName);
    
    /// <summary>
    /// 获取待审核节点
    /// </summary>
    Task<tb_ApprovalProcessDetail> GetPendingApprovalNodeAsync(long billId, string billType);
    
    /// <summary>
    /// 验证审核权限
    /// </summary>
    Task<bool> ValidateAuditPermissionAsync(long billId, string billType, long userId);
    
    /// <summary>
    /// 处理单人审核
    /// </summary>
    Task<ReturnResults> ProcessSingleApprovalAsync(long billId, string billType, ApprovalEntity approvalEntity);
    
    /// <summary>
    /// 处理或签审核
    /// </summary>
    Task<ReturnResults> ProcessOrSignApprovalAsync(long billId, string billType, ApprovalEntity approvalEntity);
    
    /// <summary>
    /// 处理并签审核
    /// </summary>
    Task<ReturnResults> ProcessAndSignApprovalAsync(long billId, string billType, ApprovalEntity approvalEntity);
    
    /// <summary>
    /// 记录审核历史
    /// </summary>
    Task RecordAuditHistoryAsync(tb_AuditHistory auditHistory);
    
    /// <summary>
    /// 获取审核历史
    /// </summary>
    Task<List<tb_AuditHistory>> GetAuditHistoryAsync(long billId, string billType);
    
    /// <summary>
    /// 获取可审核的用户列表
    /// </summary>
    Task<List<long>> GetAuditorUserIdsAsync(tb_ApprovalProcessDetail node);
}
```

**2.2 创建审核工作流服务实现**

创建 `RUINORERP.Business/AuditWorkflow/AuditWorkflowService.cs`：

```csharp
/// <summary>
/// 审核工作流服务实现
/// </summary>
public class AuditWorkflowService : IAuditWorkflowService
{
    private readonly ISqlSugarClient _dbClient;
    private readonly ILogger<AuditWorkflowService> _logger;
    private readonly IAuthorizeController _authorizeController;
    private readonly ApplicationContext _appContext;
    
    public AuditWorkflowService(
        ISqlSugarClient dbClient,
        ILogger<AuditWorkflowService> logger,
        IAuthorizeController authorizeController,
        ApplicationContext appContext)
    {
        _dbClient = dbClient;
        _logger = logger;
        _authorizeController = authorizeController;
        _appContext = appContext;
    }
    
    /// <summary>
    /// 获取审核配置
    /// </summary>
    public async Task<tb_Approval> GetApprovalConfigAsync(string entityName)
    {
        return await _dbClient.Queryable<tb_Approval>()
            .Where(x => x.BillEntityClassName == entityName && !x.IsDeleted)
            .FirstAsync();
    }
    
    /// <summary>
    /// 获取待审核节点
    /// </summary>
    public async Task<tb_ApprovalProcessDetail> GetPendingApprovalNodeAsync(long billId, string billType)
    {
        var config = await GetApprovalConfigAsync(billType);
        if (config == null) return null;
        
        // 获取所有审核节点
        var nodes = await _dbClient.Queryable<tb_ApprovalProcessDetail>()
            .Where(x => x.ApprovalID == config.ApprovalID && !x.IsDeleted)
            .OrderBy(x => x.ApprovalOrder)
            .ToListAsync();
        
        // 找到第一个未完成的节点
        foreach (var node in nodes)
        {
            var auditHistory = await _dbClient.Queryable<tb_AuditHistory>()
                .Where(x => x.BillID == billId && x.ApprovalCID == node.ApprovalCID)
                .ToListAsync();
            
            // 或签模式：任意一人审核通过即可
            if (config.WorkflowMode == 1) // 或签
            {
                if (!auditHistory.Any(x => x.ApprovalResults))
                {
                    return node;
                }
            }
            // 并签模式：所有指定人员必须审核
            else if (config.WorkflowMode == 2) // 并签
            {
                var auditorUserIds = await GetAuditorUserIdsAsync(node);
                var approvedUserIds = auditHistory.Where(x => x.ApprovalResults).Select(x => x.ApproverID).ToList();
                
                if (auditorUserIds.Except(approvedUserIds).Any())
                {
                    return node;
                }
            }
            // 单人审核模式
            else if (config.WorkflowMode == 0) // 单人
            {
                if (auditHistory.Count == 0)
                {
                    return node;
                }
            }
        }
        
        return null;
    }
    
    /// <summary>
    /// 验证审核权限
    /// </summary>
    public async Task<bool> ValidateAuditPermissionAsync(long billId, string billType, long userId)
    {
        var config = await GetApprovalConfigAsync(billType);
        if (config == null) return false;
        
        var pendingNode = await GetPendingApprovalNodeAsync(billId, billType);
        if (pendingNode == null) return false;
        
        // 获取可审核的用户列表
        var auditorUserIds = await GetAuditorUserIdsAsync(pendingNode);
        
        return auditorUserIds.Contains(userId);
    }
    
    /// <summary>
    /// 处理单人审核
    /// </summary>
    public async Task<ReturnResults> ProcessSingleApprovalAsync(long billId, string billType, ApprovalEntity approvalEntity)
    {
        var config = await GetApprovalConfigAsync(billType);
        var pendingNode = await GetPendingApprovalNodeAsync(billId, billType);
        
        if (pendingNode == null)
        {
            return ReturnResults.Error("没有待审核的节点");
        }
        
        // 记录审核历史
        var auditHistory = new tb_AuditHistory
        {
            BillID = billId,
            BillType = billType,
            BillNo = approvalEntity.BillNo,
            ApprovalCID = pendingNode.ApprovalCID,
            ApprovalOrder = pendingNode.ApprovalOrder.Value,
            ApproverID = approvalEntity.Approver_by,
            ApproverName = approvalEntity.To,
            Approver_at = approvalEntity.Approver_at,
            ApprovalResults = approvalEntity.ApprovalResults,
            ApprovalOpinions = approvalEntity.ApprovalOpinions,
            IPAddress = GetCurrentUserIP()
        };
        
        await RecordAuditHistoryAsync(auditHistory);
        
        // 更新审核结果
        pendingNode.ApprovalResults = approvalEntity.ApprovalResults ? 1 : 0;
        await _dbClient.Updateable(pendingNode).ExecuteCommandAsync();
        
        if (approvalEntity.ApprovalResults)
        {
            return ReturnResults.Success("审核通过");
        }
        else
        {
            return ReturnResults.Error("审核驳回");
        }
    }
    
    /// <summary>
    /// 处理或签审核
    /// </summary>
    public async Task<ReturnResults> ProcessOrSignApprovalAsync(long billId, string billType, ApprovalEntity approvalEntity)
    {
        var config = await GetApprovalConfigAsync(billType);
        var pendingNode = await GetPendingApprovalNodeAsync(billId, billType);
        
        if (pendingNode == null)
        {
            return ReturnResults.Error("没有待审核的节点");
        }
        
        // 记录审核历史
        var auditHistory = new tb_AuditHistory
        {
            BillID = billId,
            BillType = billType,
            BillNo = approvalEntity.BillNo,
            ApprovalCID = pendingNode.ApprovalCID,
            ApprovalOrder = pendingNode.ApprovalOrder.Value,
            ApproverID = approvalEntity.Approver_by,
            ApproverName = approvalEntity.To,
            Approver_at = approvalEntity.Approver_at,
            ApprovalResults = approvalEntity.ApprovalResults,
            ApprovalOpinions = approvalEntity.ApprovalOpinions,
            IPAddress = GetCurrentUserIP()
        };
        
        await RecordAuditHistoryAsync(auditHistory);
        
        // 检查是否有人已审核通过
        var history = await _dbClient.Queryable<tb_AuditHistory>()
            .Where(x => x.BillID == billId && x.ApprovalCID == pendingNode.ApprovalCID)
            .ToListAsync();
        
        if (history.Any(x => x.ApprovalResults))
        {
            // 节点审核通过
            pendingNode.ApprovalResults = 1;
            await _dbClient.Updateable(pendingNode).ExecuteCommandAsync();
            return ReturnResults.Success("节点审核通过");
        }
        else if (history.Any(x => !x.ApprovalResults))
        {
            // 节点审核驳回
            pendingNode.ApprovalResults = 0;
            await _dbClient.Updateable(pendingNode).ExecuteCommandAsync();
            return ReturnResults.Error("节点审核驳回");
        }
        else
        {
            return ReturnResults.Success("审核记录已保存");
        }
    }
    
    /// <summary>
    /// 处理并签审核
    /// </summary>
    public async Task<ReturnResults> ProcessAndSignApprovalAsync(long billId, string billType, ApprovalEntity approvalEntity)
    {
        var config = await GetApprovalConfigAsync(billType);
        var pendingNode = await GetPendingApprovalNodeAsync(billId, billType);
        
        if (pendingNode == null)
        {
            return ReturnResults.Error("没有待审核的节点");
        }
        
        // 记录审核历史
        var auditHistory = new tb_AuditHistory
        {
            BillID = billId,
            BillType = billType,
            BillNo = approvalEntity.BillNo,
            ApprovalCID = pendingNode.ApprovalCID,
            ApprovalOrder = pendingNode.ApprovalOrder.Value,
            ApproverID = approvalEntity.Approver_by,
            ApproverName = approvalEntity.To,
            Approver_at = approvalEntity.Approver_at,
            ApprovalResults = approvalEntity.ApprovalResults,
            ApprovalOpinions = approvalEntity.ApprovalOpinions,
            IPAddress = GetCurrentUserIP()
        };
        
        await RecordAuditHistoryAsync(auditHistory);
        
        // 检查所有指定人员是否都已审核
        var auditorUserIds = await GetAuditorUserIdsAsync(pendingNode);
        var history = await _dbClient.Queryable<tb_AuditHistory>()
            .Where(x => x.BillID == billId && x.ApprovalCID == pendingNode.ApprovalCID)
            .ToListAsync();
        
        var approvedUserIds = history.Where(x => x.ApprovalResults).Select(x => x.ApproverID).ToList();
        
        if (!approvalEntity.ApprovalResults)
        {
            // 任意一人驳回，节点驳回
            pendingNode.ApprovalResults = 0;
            await _dbClient.Updateable(pendingNode).ExecuteCommandAsync();
            return ReturnResults.Error("节点审核驳回");
        }
        else if (auditorUserIds.All(x => approvedUserIds.Contains(x)))
        {
            // 所有人都审核通过
            pendingNode.ApprovalResults = 1;
            await _dbClient.Updateable(pendingNode).ExecuteCommandAsync();
            return ReturnResults.Success("节点审核通过");
        }
        else
        {
            return ReturnResults.Success($"审核通过，还剩 {auditorUserIds.Count - approvedUserIds.Count} 人待审核");
        }
    }
    
    /// <summary>
    /// 记录审核历史
    /// </summary>
    public async Task RecordAuditHistoryAsync(tb_AuditHistory auditHistory)
    {
        auditHistory.Created_at = DateTime.Now;
        auditHistory.Created_by = _appContext.CurUserInfo.UserInfo.User_ID;
        
        await _dbClient.Insertable(auditHistory).ExecuteCommandAsync();
        
        _logger.LogInformation("记录审核历史：单据ID={BillID}，审核人={ApproverName}，结果={Results}",
            auditHistory.BillID, auditHistory.ApproverName,
            auditHistory.ApprovalResults ? "通过" : "驳回");
    }
    
    /// <summary>
    /// 获取审核历史
    /// </summary>
    public async Task<List<tb_AuditHistory>> GetAuditHistoryAsync(long billId, string billType)
    {
        return await _dbClient.Queryable<tb_AuditHistory>()
            .Where(x => x.BillID == billId && x.BillType == billType)
            .OrderBy(x => x.Approver_at)
            .ToListAsync();
    }
    
    /// <summary>
    /// 获取可审核的用户列表
    /// </summary>
    public async Task<List<long>> GetAuditorUserIdsAsync(tb_ApprovalProcessDetail node)
    {
        var userIds = new List<long>();
        
        switch (node.AuditorType)
        {
            case 0: // 角色
                if (!string.IsNullOrEmpty(node.ApproverRoleIDs))
                {
                    var roleIds = node.ApproverRoleIDs.Split(',').Select(long.Parse).ToList();
                    userIds = await _dbClient.Queryable<tb_User_Role>()
                        .Where(x => roleIds.Contains(x.RoleID.Value) && x.Authorized)
                        .Select(x => x.User_ID)
                        .Distinct()
                        .ToListAsync();
                }
                break;
                
            case 1: // 用户
                if (!string.IsNullOrEmpty(node.ApproverUserIDs))
                {
                    userIds = node.ApproverUserIDs.Split(',').Select(long.Parse).ToList();
                }
                break;
                
            case 2: // 部门
                // TODO: 根据部门ID获取用户列表
                break;
        }
        
        return userIds;
    }
    
    /// <summary>
    /// 获取当前用户IP
    /// </summary>
    private string GetCurrentUserIP()
    {
        // TODO: 实现IP获取逻辑
        return "127.0.0.1";
    }
}
```

#### 步骤3：扩展现有Controller（1天）

**3.1 扩展 BaseController<T>**

在 `RUINORERP.Business/BaseControllerGeneric.cs` 中添加工作流处理方法：

```csharp
protected IAuditWorkflowService _auditWorkflowService;

public BaseControllerGeneric(ISqlSugarClient dbClient, ...) 
    : base(dbClient, ...)
{
    // ... 原有代码
    _auditWorkflowService = Startup.GetFromFac<IAuditWorkflowService>();
}

/// <summary>
/// 审核方法（支持工作流）
/// </summary>
public virtual async Task<ReturnResults<T>> ApprovalAsync(T ObjectEntity, ApprovalEntity approvalEntity = null)
{
    if (approvalEntity == null)
    {
        return await ApprovalAsync(ObjectEntity);
    }
    
    // 获取审核配置
    var approvalConfig = await _auditWorkflowService.GetApprovalConfigAsync(typeof(T).Name);
    
    // 判断是否启用工作流
    if (approvalConfig?.EnableWorkflow == true)
    {
        // 使用工作流引擎处理
        return await ApprovalWithWorkflowAsync(ObjectEntity, approvalEntity, approvalConfig);
    }
    else
    {
        // 使用原有审核逻辑
        return await ApprovalWithoutWorkflowAsync(ObjectEntity, approvalEntity);
    }
}

/// <summary>
/// 使用工作流审核
/// </summary>
private async Task<ReturnResults<T>> ApprovalWithWorkflowAsync(T entity, ApprovalEntity ae, tb_Approval config)
{
    ReturnResults<T> rs = new ReturnResults<T>();
    
    try
    {
        _unitOfWorkManage.BeginTran();
        
        // 1. 验证审核权限
        long currentUserId = MainForm.Instance.AppContext.CurUserInfo.UserInfo.User_ID;
        var pkid = (long)ReflectionHelper.GetPropertyValue(entity, BaseUIHelper.GetEntityPrimaryKey<T>());
        
        if (!await _auditWorkflowService.ValidateAuditPermissionAsync(pkid, typeof(T).Name, currentUserId))
        {
            rs.ErrorMsg = "无审核权限";
            _unitOfWorkManage.RollbackTran();
            return rs;
        }
        
        // 2. 根据审核模式处理
        ReturnResults workflowResult;
        switch (config.WorkflowMode)
        {
            case 0: // 单人审核
                workflowResult = await _auditWorkflowService.ProcessSingleApprovalAsync(pkid, typeof(T).Name, ae);
                break;
            case 1: // 或签审核
                workflowResult = await _auditWorkflowService.ProcessOrSignApprovalAsync(pkid, typeof(T).Name, ae);
                break;
            case 2: // 并签审核
                workflowResult = await _auditWorkflowService.ProcessAndSignApprovalAsync(pkid, typeof(T).Name, ae);
                break;
            case 3: // 逐级审批
                // TODO: 实现逐级审批
                workflowResult = ReturnResults.Error("逐级审批功能待实现");
                break;
            default:
                workflowResult = await _auditWorkflowService.ProcessSingleApprovalAsync(pkid, typeof(T).Name, ae);
                break;
        }
        
        if (!workflowResult.Succeeded)
        {
            rs.ErrorMsg = workflowResult.ErrorMsg;
            _unitOfWorkManage.RollbackTran();
            return rs;
        }
        
        // 3. 检查是否所有节点都已审核通过
        var pendingNode = await _auditWorkflowService.GetPendingApprovalNodeAsync(pkid, typeof(T).Name);
        if (pendingNode == null)
        {
            // 所有节点审核通过，更新单据状态
            var baseEntity = entity as BaseEntity;
            baseEntity.DataStatus = (int)DataStatus.确认;
            baseEntity.ApprovalStatus = (int)ApprovalStatus.审核通过;
            BusinessHelper.Instance.ApproverEntity(baseEntity);
            
            await _unitOfWorkManage.GetDbClient().Updateable(entity)
                .UpdateColumns(it => new { it.DataStatus, it.ApprovalStatus, it.Approver_by, it.Approver_at })
                .ExecuteCommandAsync();
            
            rs.Data = entity;
            rs.SuccessMsg = "审核通过，单据已确认";
        }
        else
        {
            rs.SuccessMsg = workflowResult.SuccessMsg;
        }
        
        _unitOfWorkManage.CommitTran();
        rs.Succeeded = true;
    }
    catch (Exception ex)
    {
        _unitOfWorkManage.RollbackTran();
        rs.ErrorMsg = ex.Message;
        _logger.LogError(ex, "工作流审核失败");
    }
    
    return rs;
}

/// <summary>
/// 不使用工作流审核（原有逻辑）
/// </summary>
private async Task<ReturnResults<T>> ApprovalWithoutWorkflowAsync(T entity, ApprovalEntity ae)
{
    // 调用原有的审核方法（由子类重写）
    return await ApprovalAsync(entity);
}
```

#### 步骤4：创建流程可视化组件（2天）

创建 `RUINORERP.UI/Controls/UCAuditWorkflowVisualizer.cs`：

```csharp
/// <summary>
/// 审核工作流可视化组件
/// </summary>
public partial class UCAuditWorkflowVisualizer : UserControl
{
    private long _billId;
    private string _billType;
    private IAuditWorkflowService _auditWorkflowService;
    
    public UCAuditWorkflowVisualizer()
    {
        InitializeComponent();
        _auditWorkflowService = Startup.GetFromFac<IAuditWorkflowService>();
    }
    
    /// <summary>
    /// 加载工作流
    /// </summary>
    public async Task LoadWorkflowAsync(long billId, string billType)
    {
        _billId = billId;
        _billType = billType;
        
        // 清空现有内容
        panelWorkflow.Controls.Clear();
        
        // 获取审核配置
        var config = await _auditWorkflowService.GetApprovalConfigAsync(billType);
        if (config == null) return;
        
        // 获取审核节点
        var nodes = await _unitOfWorkManage.GetDbClient().Queryable<tb_ApprovalProcessDetail>()
            .Where(x => x.ApprovalID == config.ApprovalID && !x.IsDeleted)
            .OrderBy(x => x.ApprovalOrder)
            .ToListAsync();
        
        // 获取审核历史
        var auditHistory = await _auditWorkflowService.GetAuditHistoryAsync(billId, billType);
        
        // 获取当前待审核节点
        var pendingNode = await _auditWorkflowService.GetPendingApprovalNodeAsync(billId, billType);
        
        // 绘制流程图
        int x = 10;
        int y = 10;
        
        foreach (var node in nodes)
        {
            // 创建节点控件
            var nodeControl = CreateNodeControl(node, auditHistory, pendingNode);
            nodeControl.Location = new Point(x, y);
            
            panelWorkflow.Controls.Add(nodeControl);
            
            // 绘制连线
            if (x > 10)
            {
                var arrow = CreateArrowControl();
                arrow.Location = new Point(x - 30, y + 25);
                panelWorkflow.Controls.Add(arrow);
            }
            
            x += 150;
        }
        
        // 调整面板大小
        panelWorkflow.Width = x + 20;
        panelWorkflow.Height = 80;
    }
    
    /// <summary>
    /// 创建节点控件
    /// </summary>
    private Panel CreateNodeControl(tb_ApprovalProcessDetail node, List<tb_AuditHistory> auditHistory, tb_ApprovalProcessDetail pendingNode)
    {
        var panel = new Panel
        {
            Size = new Size(120, 50),
            BorderStyle = BorderStyle.FixedSingle
        };
        
        // 确定节点状态
        bool isCompleted = auditHistory.Any(x => x.ApprovalCID == node.ApprovalCID && x.ApprovalResults);
        bool isPending = pendingNode != null && pendingNode.ApprovalCID == node.ApprovalCID;
        bool isRejected = auditHistory.Any(x => x.ApprovalCID == node.ApprovalCID && !x.ApprovalResults);
        
        // 设置节点颜色
        if (isRejected)
        {
            panel.BackColor = Color.LightPink;
        }
        else if (isCompleted)
        {
            panel.BackColor = Color.LightGreen;
        }
        else if (isPending)
        {
            panel.BackColor = Color.LightYellow;
        }
        else
        {
            panel.BackColor = Color.LightGray;
        }
        
        // 添加节点标签
        var label = new Label
        {
            Text = $"节点{node.ApprovalOrder}",
            Dock = DockStyle.Fill,
            TextAlign = ContentAlignment.MiddleCenter,
            Font = new Font("微软雅黑", 9F, FontStyle.Bold)
        };
        
        panel.Controls.Add(label);
        
        // 如果是待审核节点，添加点击事件
        if (isPending)
        {
            panel.Click += (s, e) => 
            {
                // 触发审核操作
                OnPendingNodeClicked?.Invoke(node);
            };
            
            panel.Cursor = Cursors.Hand;
        }
        
        return panel;
    }
    
    /// <summary>
    /// 创建箭头控件
    /// </summary>
    private Label CreateArrowControl()
    {
        return new Label
        {
            Text = "→",
            Size = new Size(20, 20),
            Font = new Font("Arial", 14F, FontStyle.Bold),
            TextAlign = ContentAlignment.MiddleCenter
        };
    }
    
    /// <summary>
    /// 待审核节点点击事件
    /// </summary>
    public event Action<tb_ApprovalProcessDetail> OnPendingNodeClicked;
}
```

#### 步骤5：集成到BaseBillEditGeneric（1天）

在 `RUINORERP.UI/BaseForm/BaseBillEditGeneric.cs` 中集成：

```csharp
// 在类中添加成员变量
private UCAuditWorkflowVisualizer _workflowVisualizer;

// 在构造函数中初始化
public BaseBillEditGeneric()
{
    InitializeComponent();
    
    // 初始化工作流可视化组件
    _workflowVisualizer = new UCAuditWorkflowVisualizer();
    _workflowVisualizer.Dock = DockStyle.Top;
    _workflowVisualizer.Height = 80;
    _workflowVisualizer.Visible = false;
    _workflowVisualizer.OnPendingNodeClicked += WorkflowVisualizer_OnPendingNodeClicked;
    
    // 添加到面板（根据实际布局调整）
    if (pnlTop != null)
    {
        pnlTop.Controls.Add(_workflowVisualizer);
        pnlTop.Height += 80;
    }
}

// 在加载单据时显示工作流
protected override async Task LoadDataAsync(long pkid)
{
    await base.LoadDataAsync(pkid);
    
    // 检查是否启用工作流
    var auditWorkflowService = Startup.GetFromFac<IAuditWorkflowService>();
    if (auditWorkflowService != null)
    {
        var approvalConfig = await auditWorkflowService.GetApprovalConfigAsync(typeof(T).Name);
        if (approvalConfig?.EnableWorkflow == true)
        {
            _workflowVisualizer.Visible = true;
            await _workflowVisualizer.LoadWorkflowAsync(pkid, typeof(T).Name);
        }
    }
}

// 处理工作流节点点击
private async void WorkflowVisualizer_OnPendingNodeClicked(tb_ApprovalProcessDetail node)
{
    // 调用审核方法
    await Review();
}
```

---

## 四、配置示例

### 4.1 配置示例1：单人审核

```sql
-- 配置审核流程（单人审核）
INSERT INTO `tb_Approval` (BillType, BillName, BillEntityClassName, GradedAudit, WorkflowMode, EnableWorkflow)
VALUES ('tb_PurOrder', '采购订单', 'tb_PurOrder', 0, 0, 1);

-- 添加审核节点
INSERT INTO `tb_ApprovalProcessDetail` (ApprovalID, ApprovalOrder, ApproverUserIDs, AuditorType)
VALUES (LAST_INSERT_ID(), 1, '1,2,3', 1);  -- 用户1、2、3中的任意一人审核
```

### 4.2 配置示例2：或签审核

```sql
-- 配置审核流程（或签审核）
INSERT INTO `tb_Approval` (BillType, BillName, BillEntityClassName, GradedAudit, WorkflowMode, EnableWorkflow)
VALUES ('tb_PurOrder', '采购订单', 'tb_PurOrder', 0, 1, 1);

-- 添加审核节点
INSERT INTO `tb_ApprovalProcessDetail` (ApprovalID, ApprovalOrder, ApproverUserIDs, AuditorType)
VALUES (LAST_INSERT_ID(), 1, '1,2,3', 1);  -- 用户1、2、3中的任意一人审核即可
```

### 4.3 配置示例3：并签审核

```sql
-- 配置审核流程（并签审核）
INSERT INTO `tb_Approval` (BillType, BillName, BillEntityClassName, GradedAudit, WorkflowMode, EnableWorkflow)
VALUES ('tb_PurOrder', '采购订单', 'tb_PurOrder', 0, 2, 1);

-- 添加审核节点
INSERT INTO `tb_ApprovalProcessDetail` (ApprovalID, ApprovalOrder, ApproverUserIDs, AuditorType)
VALUES (LAST_INSERT_ID(), 1, '1,2,3', 1);  -- 用户1、2、3都必须审核
```

---

## 五、测试计划

### 5.1 功能测试

1. **单人审核测试**
   - 配置单人审核流程
   - 提交单据进入审核
   - 指定用户审核通过
   - 验证单据状态更新

2. **或签审核测试**
   - 配置或签审核流程
   - 多个用户中任意一人审核通过
   - 验证单据状态更新

3. **并签审核测试**
   - 配置并签审核流程
   - 多个用户依次审核
   - 验证所有人员审核通过后单据状态更新

4. **权限验证测试**
   - 非审核人尝试审核
   - 验证权限检查生效

5. **审核历史测试**
   - 查看审核历史记录
   - 验证审核轨迹完整

### 5.2 兼容性测试

1. **现有流程兼容性**
   - EnableWorkflow=false 的单据使用原有审核流程
   - 验证原有功能不受影响

2. **向后兼容性**
   - 现有数据无需迁移
   - 新功能可选启用

---

## 六、实施注意事项

### 6.1 数据库迁移

- 新增字段设置默认值
- 索引创建优化查询性能
- 测试环境先验证脚本

### 6.2 服务注册

在 `Startup.cs` 或服务注册处添加：

```csharp
services.AddScoped<IAuditWorkflowService, AuditWorkflowService>();
```

### 6.3 向后兼容

- 默认值设置为不启用工作流
- 保持原有审核方法签名不变
- 新旧审核流程可以共存

### 6.4 日志和监控

- 记录审核操作日志
- 监控工作流性能
- 记录异常情况

---

## 七、后续扩展方向

### 7.1 第二阶段扩展

1. **逐级审批实现**
2. **条件分支审核**
3. **流程设计器**
4. **工作台集成**

### 7.2 高级功能

1. **会签模式**
2. **动态审核人**
3. **审核委托**
4. **审核时限**

---

## 八、总结

本方案基于RUINORERP项目现有审核系统，通过最小化改动实现了审核工作流扩展功能：

### 8.1 核心优势

1. **充分复用现有代码**：不重复造轮子
2. **向后兼容**：不影响现有功能
3. **渐进式增强**：可选启用新功能
4. **易于维护**：基于成熟架构扩展

### 8.2 技术要点

1. 扩展现有实体表而非创建新表
2. 通过Service层封装工作流逻辑
3. 扩展BaseController支持工作流
4. 可选的流程可视化组件

### 8.3 实施建议

1. 先在测试环境验证
2. 逐步启用工作流功能
3. 监控系统运行情况
4. 收集用户反馈优化

---

**文档版本**：V1.0  
**创建日期**：2026-01-08  
**更新日期**：2026-01-08
