# 单据生命周期管理优化方案 V2.0

## 文档信息

| 项目 | 内容 |
|------|------|
| **版本** | V2.0 - 优化增强版 |
| **创建日期** | 2026-01-08 |
| **作者** | RUINOR ERP开发团队 |
| **适用系统** | RUINORERP 中小企业ERP系统 |
| **文档状态** | 实施方案 |

---

## 1. 方案概述

### 1.1 设计目标

本方案基于现有的单据生命周期管理方案进行优化升级，打造一套**以实用主义为核心**，兼顾当前需求与未来扩展性的完整单据生命周期管理解决方案。重点实现：

1. **灵活的审核流程配置**：支持单人审核、或签、并签等多种模式
2. **可视化流程设计器**：拖拽式流程设计，直观易用
3. **工作台流程展示**：在ERP工作台或首页可视化显示流程状态
4. **便捷的操作入口**：直接在流程图上点击即可打开单据进行操作
5. **美观的界面设计**：现代化UI设计，提升用户体验

### 1.2 核心特性

| 特性 | 描述 | 优先级 |
|------|------|--------|
| **单人审核** | 当前阶段实现，任何具备审核权限的用户或角色均可审核 | P0（高） |
| **或签模式** | 多位审核人中任意一人完成审核即可通过 | P1（中） |
| **并签模式** | 所有指定审核人必须全部完成审核 | P1（中） |
| **流程可视化** | 流程图展示，状态一目了然 | P0（高） |
| **拖拽设计器** | 可视化配置审核流程 | P2（低） |
| **工作台集成** | 流程显示到工作台/首页 | P0（高） |
| **点击操作** | 流程图节点点击直接打开单据 | P0（高） |
| **审核轨迹** | 完整记录审核操作历史 | P1（中） |

### 1.3 设计原则

1. **实用优先**：优先满足当前中小企业简单高效的操作需求
2. **渐进增强**：当前阶段实现基础功能，未来逐步扩展高级特性
3. **无缝集成**：与现有系统架构完美集成，最小化改动
4. **可扩展设计**：预留接口支持未来复杂业务场景
5. **平滑过渡**：确保新旧审核模式兼容
6. **美观易用**：现代化UI设计，提升用户体验
7. **完整可追溯**：记录全流程操作日志

---

## 2. 系统架构设计

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          表现层 (Presentation Layer)                     │
│                                                                         │
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────┐  │
│  │  单据编辑窗体         │  │  审核流程配置窗体     │  │ 工作台界面    │  │
│  │  (BaseBillEdit)      │  │  (WorkflowConfig)    │  │ (Workspace)   │  │
│  └──────────┬───────────┘  └──────────┬───────────┘  └──────┬───────┘  │
│             │                          │                     │          │
│  ┌──────────┴──────────────────────────┴─────────────────────┐        │
│  │              流程可视化组件 (WorkflowVisualizer)            │        │
│  │  - 流程图展示 - 节点状态显示 - 点击打开单据 - 进度跟踪      │        │
│  └────────────────────────────────┬─────────────────────────────┘        │
└──────────────────────────────────┼──────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        业务逻辑层 (Business Layer)                        │
│                                                                         │
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────┐  │
│  │ 单据生命周期管理服务  │  │  审核流程引擎         │  │ 权限控制服务  │  │
│  │ (BillLifecycleService)│  │ (AuditWorkflowEngine) │  │(PermissionSvc)│  │
│  └──────────┬───────────┘  └──────────┬───────────┘  └──────┬───────┘  │
│             │                          │                     │          │
│  ┌──────────┴──────────────────────────┴─────────────────────┐        │
│  │              审核规则引擎 (AuditRuleEngine)              │        │
│  │  - 单人审核规则 - 或签规则 - 并签规则 - 自定义规则        │        │
│  └────────────────────────────────┬─────────────────────────────┘        │
└──────────────────────────────────┼──────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          数据访问层 (Data Layer)                         │
│                                                                         │
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────┐  │
│  │  审核流程配置数据    │  │    审核轨迹数据       │  │ 单据数据      │  │
│  │ (WorkflowConfig)     │  │  (AuditTrail)        │  │ (BillEntity)  │  │
│  └──────────┬───────────┘  └──────────┬───────────┘  └──────┬───────┘  │
│             │                          │                     │          │
│  ┌──────────┴──────────────────────────┴─────────────────────┐        │
│  │                   统一状态管理器 (UnifiedStateManager)       │        │
│  │  - 状态转换 - 状态验证 - 事件触发 - 历史记录                │        │
│  └────────────────────────────────┬─────────────────────────────┘        │
└──────────────────────────────────┼──────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          基础设施层 (Infrastructure)                     │
│                                                                         │
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────┐  │
│  │     消息通知服务      │  │      缓存服务         │  │  日志服务    │  │
│  │ (NotificationService) │  │   (CacheService)      │  │ (LogService)  │  │
│  └──────────────────────┘  └──────────────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件说明

| 组件名称 | 职责 | 所属项目 |
|---------|------|---------|
| `BillLifecycleService` | 单据生命周期管理服务 | RUINORERP.Business |
| `AuditWorkflowEngine` | 审核流程引擎 | RUINORERP.Business |
| `AuditRuleEngine` | 审核规则引擎 | RUINORERP.Business |
| `PermissionService` | 权限控制服务 | RUINORERP.Business |
| `WorkflowConfigService` | 工作流配置服务 | RUINORERP.Business |
| `WorkflowVisualizer` | 流程可视化组件 | RUINORERP.UI |
| `WorkflowDesigner` | 流程设计器 | RUINORERP.UI |
| `UnifiedStateManager` | 统一状态管理器 | RUINORERP.Model |

---

## 3. 数据模型设计

### 3.1 核心枚举定义

#### 3.1.1 审核流程模式枚举

```csharp
/// <summary>
/// 审核流程模式枚举
/// </summary>
public enum AuditWorkflowMode
{
    /// <summary>单人审核：任意具备审核权限的用户均可审核</summary>
    [Display(Name = "单人审核", Description = "任意具备审核权限的用户均可审核")]
    Single = 0,

    /// <summary>或签模式：多位审核人中任意一人完成审核即可通过</summary>
    [Display(Name = "或签模式", Description = "多位审核人中任意一人完成审核即可通过")]
    OrApproval = 1,

    /// <summary>并签模式：所有指定审核人必须全部完成审核</summary>
    [Display(Name = "并签模式", Description = "所有指定审核人必须全部完成审核")]
    AndApproval = 2,

    /// <summary>逐级审批：按层级顺序依次审核</summary>
    [Display(Name = "逐级审批", Description = "按层级顺序依次审核")]
    SequentialApproval = 3,

    /// <summary>会签模式：指定审核顺序，按顺序依次审核</summary>
    [Display(Name = "会签模式", Description = "指定审核顺序，按顺序依次审核")]
    Countersign = 4
}
```

#### 3.1.2 审核操作类型枚举

```csharp
/// <summary>
/// 审核操作类型枚举
/// </summary>
public enum AuditActionType
{
    /// <summary>提交</summary>
    [Display(Name = "提交", Description = "提交单据进入审核流程")]
    Submit = 1,

    /// <summary>审核通过</summary>
    [Display(Name = "审核通过", Description = "审核人同意该单据")]
    Approve = 2,

    /// <summary>审核拒绝</summary>
    [Display(Name = "审核拒绝", Description = "审核人拒绝该单据")]
    Reject = 3,

    /// <summary>驳回修改</summary>
    [Display(Name = "驳回修改", Description = "驳回给提交人修改后重新提交")]
    Return = 4,

    /// <summary>撤回</summary>
    [Display(Name = "撤回", Description = "提交人撤回单据")]
    Withdraw = 5,

    /// <summary>结案</summary>
    [Display(Name = "结案", Description = "单据生命周期结束")]
    Close = 6
}
```

#### 3.1.3 审核人类型枚举

```csharp
/// <summary>
/// 审核人类型枚举
/// </summary>
public enum AuditorType
{
    /// <summary>指定用户</summary>
    [Display(Name = "用户", Description = "指定具体用户")]
    User = 1,

    /// <summary>指定角色</summary>
    [Display(Name = "角色", Description = "指定角色，角色内所有用户可审核")]
    Role = 2,

    /// <summary>指定部门</summary>
    [Display(Name = "部门", Description = "指定部门，部门内所有用户可审核")]
    Department = 3,

    /// <summary>指定岗位</summary>
    [Display(Name = "岗位", Description = "指定岗位，岗位内所有用户可审核")]
    Position = 4,

    /// <summary>动态计算</summary>
    [Display(Name = "动态计算", Description = "通过规则动态计算审核人")]
    Dynamic = 5
}
```

### 3.2 核心数据模型

#### 3.2.1 审核流程配置表 (`tb_WorkflowConfig`)

| 字段名 | 数据类型 | 长度 | 可空 | 描述 | 示例 |
|-------|---------|------|------|------|------|
| `WorkflowID` | `bigint` | - | 否 | 流程ID（主键） | 1001 |
| `WorkflowName` | `varchar` | 100 | 否 | 流程名称 | "销售订单审核流程" |
| `WorkflowCode` | `varchar` | 50 | 否 | 流程编码 | "SALES_ORDER_AUDIT" |
| `BillType` | `varchar` | 50 | 否 | 适用单据类型 | "tb_SaleOrder" |
| `BillTypeName` | `varchar` | 100 | 是 | 单据类型名称 | "销售订单" |
| `WorkflowMode` | `int` | - | 否 | 审核流程模式 | 0-单人/1-或签/2-并签 |
| `IsEnabled` | `bit` | - | 否 | 是否启用 | true |
| `Description` | `nvarchar` | 500 | 是 | 流程描述 | "销售订单标准审核流程" |
| `Version` | `varchar` | 20 | 是 | 版本号 | "V1.0" |
| `Creator` | `bigint` | - | 是 | 创建人ID | 1001 |
| `CreateTime` | `datetime` | - | 否 | 创建时间 | 2026-01-08 10:00:00 |
| `Updater` | `bigint` | - | 是 | 更新人ID | 1002 |
| `UpdateTime` | `datetime` | - | 是 | 更新时间 | 2026-01-08 14:30:00 |
| `IsDeleted` | `bit` | - | 否 | 是否删除 | false |

**索引设计**：
- 主键索引：`PK_tb_WorkflowConfig (WorkflowID)`
- 唯一索引：`UK_tb_WorkflowConfig (BillType)`
- 普通索引：`IX_tb_WorkflowConfig (IsEnabled, BillType)`

#### 3.2.2 审核流程节点表 (`tb_WorkflowNode`)

| 字段名 | 数据类型 | 长度 | 可空 | 描述 | 示例 |
|-------|---------|------|------|------|------|
| `NodeID` | `bigint` | - | 否 | 节点ID（主键） | 2001 |
| `WorkflowID` | `bigint` | - | 否 | 所属流程ID | 1001 |
| `NodeName` | `varchar` | 100 | 否 | 节点名称 | "业务审核" |
| `NodeCode` | `varchar` | 50 | 否 | 节点编码 | "SALES_AUDIT" |
| `NodeType` | `int` | - | 否 | 节点类型 | 1-提交/2-审核/3-结案 |
| `NodeMode` | `int` | - | 否 | 节点审核模式 | 0-单人/1-或签/2-并签 |
| `OrderIndex` | `int` | - | 否 | 节点顺序 | 1 |
| `AllowReject` | `bit` | - | 否 | 是否允许拒绝 | true |
| `AllowReturn` | `bit` | - | 否 | 是否允许驳回 | true |
| `RequireComments` | `bit` | - | 否 | 是否必填审核意见 | true |
| `TimeoutMinutes` | `int` | - | 是 | 超时提醒时间（分钟） | 1440 |
| `IsActive` | `bit` | - | 否 | 是否激活 | true |
| `Description` | `nvarchar` | 500 | 是 | 节点描述 | "销售部门负责人审核" |
| `Creator` | `bigint` | - | 是 | 创建人ID | 1001 |
| `CreateTime` | `datetime` | - | 否 | 创建时间 | 2026-01-08 10:00:00 |
| `Updater` | `bigint` | - | 是 | 更新人ID | 1002 |
| `UpdateTime` | `datetime` | - | 是 | 更新时间 | 2026-01-08 14:30:00 |

**索引设计**：
- 主键索引：`PK_tb_WorkflowNode (NodeID)`
- 外键索引：`FK_tb_WorkflowNode_tb_WorkflowConfig (WorkflowID)`
- 普通索引：`IX_tb_WorkflowNode (WorkflowID, OrderIndex)`

#### 3.2.3 审核节点人员表 (`tb_WorkflowAuditor`)

| 字段名 | 数据类型 | 长度 | 可空 | 描述 | 示例 |
|-------|---------|------|------|------|------|
| `AuditorID` | `bigint` | - | 否 | 审核人ID（主键） | 3001 |
| `NodeID` | `bigint` | - | 否 | 所属节点ID | 2001 |
| `AuditorType` | `int` | - | 否 | 审核人类型 | 1-用户/2-角色/3-部门 |
| `AuditorValue` | `bigint` | - | 否 | 审核人值 | 1001（用户ID/角色ID/部门ID） |
| `AuditorName` | `varchar` | 100 | 是 | 审核人名称 | "张三" |
| `OrderIndex` | `int` | - | 是 | 审核顺序（逐级审批使用） | 1 |
| `IsOptional` | `bit` | - | 否 | 是否可选审核人 | false |
| `IsActive` | `bit` | - | 否 | 是否激活 | true |
| `Creator` | `bigint` | - | 是 | 创建人ID | 1001 |
| `CreateTime` | `datetime` | - | 否 | 创建时间 | 2026-01-08 10:00:00 |
| `Updater` | `bigint` | - | 是 | 更新人ID | 1002 |
| `UpdateTime` | `datetime` | - | 是 | 更新时间 | 2026-01-08 14:30:00 |

**索引设计**：
- 主键索引：`PK_tb_WorkflowAuditor (AuditorID)`
- 外键索引：`FK_tb_WorkflowAuditor_tb_WorkflowNode (NodeID)`
- 普通索引：`IX_tb_WorkflowAuditor (NodeID, AuditorType, AuditorValue)`

#### 3.2.4 审核轨迹表 (`tb_AuditTrail`)

| 字段名 | 数据类型 | 长度 | 可空 | 描述 | 示例 |
|-------|---------|------|------|------|------|
| `TrailID` | `bigint` | - | 否 | 轨迹ID（主键） | 4001 |
| `BillID` | `bigint` | - | 否 | 单据ID | 50001 |
| `BillType` | `varchar` | 50 | 否 | 单据类型 | "tb_SaleOrder" |
| `BillNo` | `varchar` | 50 | 否 | 单据编号 | "SO20260108001" |
| `WorkflowID` | `bigint` | - | 是 | 流程ID | 1001 |
| `NodeID` | `bigint` | - | 是 | 节点ID | 2001 |
| `Operator` | `bigint` | - | 否 | 操作人ID | 1001 |
| `OperatorName` | `varchar` | 100 | 是 | 操作人姓名 | "张三" |
| `ActionType` | `int` | - | 否 | 操作类型 | 2-审核通过 |
| `StatusBefore` | `int` | - | 是 | 操作前状态 | 0-待审核 |
| `StatusAfter` | `int` | - | 是 | 操作后状态 | 1-已审核 |
| `Comments` | `nvarchar` | 1000 | 是 | 审核意见 | "同意，请继续办理" |
| `Attachments` | `nvarchar` | 1000 | 是 | 附件信息 | JSON格式 |
| `ActionTime` | `datetime` | - | 否 | 操作时间 | 2026-01-08 10:30:00 |
| `IPAddress` | `varchar` | 50 | 是 | 操作IP地址 | "192.168.1.100" |
| `ClientInfo` | `varchar` | 200 | 是 | 客户端信息 | "PC/Windows" |

**索引设计**：
- 主键索引：`PK_tb_AuditTrail (TrailID)`
- 普通索引：`IX_tb_AuditTrail (BillID, BillType)`
- 普通索引：`IX_tb_AuditTrail (BillType, ActionTime)`
- 普通索引：`IX_tb_AuditTrail (Operator, ActionTime)`

#### 3.2.5 审核实例表 (`tb_AuditInstance`)

| 字段名 | 数据类型 | 长度 | 可空 | 描述 | 示例 |
|-------|---------|------|------|------|------|
| `InstanceID` | `bigint` | - | 否 | 实例ID（主键） | 6001 |
| `BillID` | `bigint` | - | 否 | 单据ID | 50001 |
| `BillType` | `varchar` | 50 | 否 | 单据类型 | "tb_SaleOrder" |
| `BillNo` | `varchar` | 50 | 否 | 单据编号 | "SO20260108001" |
| `WorkflowID` | `bigint` | - | 否 | 流程ID | 1001 |
| `CurrentNodeID` | `bigint` | - | 是 | 当前节点ID | 2001 |
| `WorkflowStatus` | `int` | - | 否 | 流程状态 | 0-进行中/1-已完成/2-已拒绝 |
| `Submitter` | `bigint` | - | 否 | 提交人ID | 1001 |
| `SubmitterName` | `varchar` | 100 | 是 | 提交人姓名 | "李四" |
| `SubmitTime` | `datetime` | - | 否 | 提交时间 | 2026-01-08 10:00:00 |
| `CompleteTime` | `datetime` | - | 是 | 完成时间 | 2026-01-08 11:00:00 |
| `IsUrgent` | `bit` | - | 否 | 是否紧急 | false |
| `Creator` | `bigint` | - | 是 | 创建人ID | 1001 |
| `CreateTime` | `datetime` | - | 否 | 创建时间 | 2026-01-08 10:00:00 |
| `Updater` | `bigint` | - | 是 | 更新人ID | 1002 |
| `UpdateTime` | `datetime` | - | 是 | 更新时间 | 2026-01-08 11:00:00 |

**索引设计**：
- 主键索引：`PK_tb_AuditInstance (InstanceID)`
- 外键索引：`FK_tb_AuditInstance_tb_WorkflowConfig (WorkflowID)`
- 唯一索引：`UK_tb_AuditInstance (BillID, BillType)`
- 普通索引：`IX_tb_AuditInstance (WorkflowStatus, CurrentNodeID)`
- 普通索引：`IX_tb_AuditInstance (Submitter, SubmitTime)`

#### 3.2.6 审核节点执行表 (`tb_AuditNodeExecution`)

| 字段名 | 数据类型 | 长度 | 可空 | 描述 | 示例 |
|-------|---------|------|------|------|------|
| `ExecutionID` | `bigint` | - | 否 | 执行ID（主键） | 7001 |
| `InstanceID` | `bigint` | - | 否 | 实例ID | 6001 |
| `NodeID` | `bigint` | - | 否 | 节点ID | 2001 |
| `Auditor` | `bigint` | - | 否 | 审核人ID | 1001 |
| `AuditorName` | `varchar` | 100 | 是 | 审核人姓名 | "张三" |
| `ActionType` | `int` | - | 否 | 操作类型 | 2-审核通过 |
| `Comments` | `nvarchar` | 1000 | 是 | 审核意见 | "同意" |
| `ActionTime` | `datetime` | - | 否 | 操作时间 | 2026-01-08 10:30:00 |
| `IPAddress` | `varchar` | 50 | 是 | 操作IP地址 | "192.168.1.100" |

**索引设计**：
- 主键索引：`PK_tb_AuditNodeExecution (ExecutionID)`
- 外键索引：`FK_tb_AuditNodeExecution_tb_AuditInstance (InstanceID)`
- 外键索引：`FK_tb_AuditNodeExecution_tb_WorkflowNode (NodeID)`
- 普通索引：`IX_tb_AuditNodeExecution (InstanceID, NodeID, Auditor)`

---

## 4. 审核流程引擎设计

### 4.1 审核流程引擎接口

```csharp
/// <summary>
/// 审核流程引擎接口
/// </summary>
public interface IAuditWorkflowEngine
{
    /// <summary>
    /// 提交单据进入审核流程
    /// </summary>
    /// <param name="billId">单据ID</param>
    /// <param name="billType">单据类型</param>
    /// <param name="submitterId">提交人ID</param>
    /// <param name="comments">提交说明</param>
    /// <returns>审核结果</returns>
    Task<AuditResult> SubmitBillAsync(long billId, string billType, long submitterId, string comments = null);

    /// <summary>
    /// 执行审核操作
    /// </summary>
    /// <param name="billId">单据ID</param>
    /// <param name="billType">单据类型</param>
    /// <param name="operatorId">操作人ID</param>
    /// <param name="actionType">操作类型</param>
    /// <param name="comments">审核意见</param>
    /// <returns>审核结果</returns>
    Task<AuditResult> ExecuteAuditAsync(long billId, string billType, long operatorId, 
        AuditActionType actionType, string comments = null);

    /// <summary>
    /// 撤回单据
    /// </summary>
    /// <param name="billId">单据ID</param>
    /// <param name="billType">单据类型</param>
    /// <param name="operatorId">操作人ID</param>
    /// <param name="comments">撤回说明</param>
    /// <returns>审核结果</returns>
    Task<AuditResult> WithdrawBillAsync(long billId, string billType, long operatorId, string comments = null);

    /// <summary>
    /// 结案单据
    /// </summary>
    /// <param name="billId">单据ID</param>
    /// <param name="billType">单据类型</param>
    /// <param name="operatorId">操作人ID</param>
    /// <param name="comments">结案说明</param>
    /// <returns>审核结果</returns>
    Task<AuditResult> CloseBillAsync(long billId, string billType, long operatorId, string comments = null);

    /// <summary>
    /// 获取审核实例信息
    /// </summary>
    /// <param name="billId">单据ID</param>
    /// <param name="billType">单据类型</param>
    /// <returns>审核实例信息</returns>
    Task<AuditInstance> GetAuditInstanceAsync(long billId, string billType);

    /// <summary>
    /// 获取审核轨迹
    /// </summary>
    /// <param name="billId">单据ID</param>
    /// <param name="billType">单据类型</param>
    /// <returns>审核轨迹列表</returns>
    Task<List<AuditTrail>> GetAuditTrailAsync(long billId, string billType);

    /// <summary>
    /// 获取待审核列表
    /// </summary>
    /// <param name="userId">用户ID</param>
    /// <param name="billTypes">单据类型过滤</param>
    /// <param name="pageIndex">页码</param>
    /// <param name="pageSize">每页大小</param>
    /// <returns>待审核单据列表</returns>
    Task<PagedResult<AuditInstance>> GetPendingAuditsAsync(long userId, List<string> billTypes = null, 
        int pageIndex = 1, int pageSize = 20);

    /// <summary>
    /// 检查用户是否可以审核该单据
    /// </summary>
    /// <param name="billId">单据ID</param>
    /// <param name="billType">单据类型</param>
    /// <param name="userId">用户ID</param>
    /// <returns>是否可以审核</returns>
    Task<bool> CanAuditAsync(long billId, string billType, long userId);

    /// <summary>
    /// 获取流程可视化数据
    /// </summary>
    /// <param name="billId">单据ID</param>
    /// <param name="billType">单据类型</param>
    /// <returns>流程可视化数据</returns>
    Task<WorkflowVisualizationData> GetWorkflowVisualizationAsync(long billId, string billType);
}
```

### 4.2 审核结果模型

```csharp
/// <summary>
/// 审核结果模型
/// </summary>
public class AuditResult
{
    /// <summary>是否成功</summary>
    public bool IsSuccess { get; set; }

    /// <summary>结果代码</summary>
    public string Code { get; set; }

    /// <summary>结果消息</summary>
    public string Message { get; set; }

    /// <summary>审核实例ID</summary>
    public long InstanceId { get; set; }

    /// <summary>当前节点ID</summary>
    public long? CurrentNodeId { get; set; }

    /// <summary>流程状态</summary>
    public WorkflowStatus WorkflowStatus { get; set; }

    /// <summary>单据状态</summary>
    public DataStatus BillStatus { get; set; }

    /// <summary>是否需要通知</summary>
    public bool NeedNotify { get; set; }

    /// <summary>通知接收者列表</summary>
    public List<long> NotifyUserIds { get; set; }

    /// <summary>附加数据</summary>
    public Dictionary<string, object> AdditionalData { get; set; }
}

/// <summary>
/// 流程状态枚举
/// </summary>
public enum WorkflowStatus
{
    /// <summary>进行中</summary>
    [Display(Name = "进行中")]
    InProgress = 0,

    /// <summary>已完成</summary>
    [Display(Name = "已完成")]
    Completed = 1,

    /// <summary>已拒绝</summary>
    [Display(Name = "已拒绝")]
    Rejected = 2,

    /// <summary>已撤回</summary>
    [Display(Name = "已撤回")]
    Withdrawn = 3
}
```

### 4.3 审核规则引擎

```csharp
/// <summary>
/// 审核规则引擎接口
/// </summary>
public interface IAuditRuleEngine
{
    /// <summary>
    /// 验证审核条件
    /// </summary>
    /// <param name="billId">单据ID</param>
    /// <param name="billType">单据类型</param>
    /// <param name="userId">用户ID</param>
    /// <param name="actionType">操作类型</param>
    /// <returns>验证结果</returns>
    Task<ValidationResult> ValidateAsync(long billId, string billType, long userId, AuditActionType actionType);

    /// <summary>
    /// 获取审核人列表
    /// </summary>
    /// <param name="billId">单据ID</param>
    /// <param name="billType">单据类型</param>
    /// <param name="nodeId">节点ID</param>
    /// <returns>审核人列表</returns>
    Task<List<AuditorInfo>> GetAuditorsAsync(long billId, string billType, long nodeId);

    /// <summary>
    /// 检查审核是否完成
    /// </summary>
    /// <param name="billId">单据ID</param>
    /// <param name="billType">单据类型</param>
    /// <param name="nodeId">节点ID</param>
    /// <returns>是否完成</returns>
    Task<bool> IsNodeCompletedAsync(long billId, string billType, long nodeId);

    /// <summary>
    /// 获取下一个节点
    /// </summary>
    /// <param name="billId">单据ID</param>
    /// <param name="billType">单据类型</param>
    /// <param name="currentNodeId">当前节点ID</param>
    /// <returns>下一个节点</returns>
    Task<WorkflowNode> GetNextNodeAsync(long billId, string billType, long currentNodeId);
}

/// <summary>
/// 审核人信息模型
/// </summary>
public class AuditorInfo
{
    /// <summary>审核人ID</summary>
    public long UserId { get; set; }

    /// <summary>审核人姓名</summary>
    public string UserName { get; set; }

    /// <summary>审核人类型</summary>
    public AuditorType AuditorType { get; set; }

    /// <summary>是否已审核</summary>
    public bool IsAudited { get; set; }

    /// <summary>审核时间</summary>
    public DateTime? AuditTime { get; set; }

    /// <summary>审核结果</summary>
    public AuditActionType? AuditAction { get; set; }

    /// <summary>审核意见</summary>
    public string Comments { get; set; }
}
```

### 4.4 审核流程引擎实现核心逻辑

#### 4.4.1 提交单据进入审核流程

```csharp
public async Task<AuditResult> SubmitBillAsync(long billId, string billType, long submitterId, string comments = null)
{
    var result = new AuditResult();
    
    try
    {
        // 1. 验证单据状态
        var billStatus = await _unifiedStateManager.GetDataStatusAsync(billId, billType);
        if (billStatus != DataStatus.草稿 && billStatus != DataStatus.新建)
        {
            result.IsSuccess = false;
            result.Code = "INVALID_STATUS";
            result.Message = "单据状态不允许提交";
            return result;
        }

        // 2. 获取流程配置
        var workflowConfig = await GetWorkflowConfigAsync(billType);
        if (workflowConfig == null || !workflowConfig.IsEnabled)
        {
            // 无需审核流程，直接更新状态为已确认
            await _unifiedStateManager.SetDataStatusAsync(billId, billType, DataStatus.确认);
            result.IsSuccess = true;
            result.Code = "NO_WORKFLOW";
            result.Message = "单据已提交，无需审核";
            result.BillStatus = DataStatus.确认;
            result.WorkflowStatus = WorkflowStatus.Completed;
            return result;
        }

        // 3. 创建审核实例
        var auditInstance = new tb_AuditInstance
        {
            BillID = billId,
            BillType = billType,
            BillNo = await GetBillNoAsync(billId, billType),
            WorkflowID = workflowConfig.WorkflowID,
            WorkflowStatus = (int)WorkflowStatus.InProgress,
            Submitter = submitterId,
            SubmitterName = await GetUserNameAsync(submitterId),
            SubmitTime = DateTime.Now,
            Creator = submitterId,
            CreateTime = DateTime.Now
        };

        var instanceId = await _repository.InsertAsync(auditInstance);
        result.InstanceId = instanceId;

        // 4. 获取第一个审核节点
        var firstNode = await GetFirstNodeAsync(workflowConfig.WorkflowID);
        if (firstNode == null)
        {
            result.IsSuccess = false;
            result.Code = "NO_FIRST_NODE";
            result.Message = "审核流程未配置节点";
            return result;
        }

        auditInstance.CurrentNodeID = firstNode.NodeID;
        await _repository.UpdateAsync(auditInstance);
        result.CurrentNodeId = firstNode.NodeID;

        // 5. 更新单据状态
        await _unifiedStateManager.SetDataStatusAsync(billId, billType, DataStatus.新建);
        result.BillStatus = DataStatus.新建;

        // 6. 记录审核轨迹
        await RecordAuditTrailAsync(new AuditTrail
        {
            BillID = billId,
            BillType = billType,
            BillNo = auditInstance.BillNo,
            WorkflowID = workflowConfig.WorkflowID,
            NodeID = firstNode.NodeID,
            Operator = submitterId,
            OperatorName = auditInstance.SubmitterName,
            ActionType = AuditActionType.Submit,
            Comments = comments,
            ActionTime = DateTime.Now
        });

        // 7. 获取审核人列表并发送通知
        var auditors = await _auditRuleEngine.GetAuditorsAsync(billId, billType, firstNode.NodeID);
        var notifyUserIds = auditors.Select(a => a.UserId).Distinct().ToList();
        result.NotifyUserIds = notifyUserIds;
        result.NeedNotify = notifyUserIds.Count > 0;

        result.IsSuccess = true;
        result.Code = "SUCCESS";
        result.Message = "单据提交成功，进入审核流程";
        result.WorkflowStatus = WorkflowStatus.InProgress;

        return result;
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "提交单据审核失败：{BillID}, {BillType}", billId, billType);
        result.IsSuccess = false;
        result.Code = "ERROR";
        result.Message = "提交审核失败：" + ex.Message;
        return result;
    }
}
```

#### 4.4.2 执行审核操作（支持单人/或签/并签）

```csharp
public async Task<AuditResult> ExecuteAuditAsync(long billId, string billType, long operatorId, 
    AuditActionType actionType, string comments = null)
{
    var result = new AuditResult();
    
    try
    {
        // 1. 验证操作权限
        var canAudit = await _auditRuleEngine.ValidateAsync(billId, billType, operatorId, actionType);
        if (!canAudit.IsValid)
        {
            result.IsSuccess = false;
            result.Code = "NO_PERMISSION";
            result.Message = canAudit.ErrorMessage;
            return result;
        }

        // 2. 获取审核实例
        var instance = await _repository.GetAuditInstanceAsync(billId, billType);
        if (instance == null)
        {
            result.IsSuccess = false;
            result.Code = "INSTANCE_NOT_FOUND";
            result.Message = "审核实例不存在";
            return result;
        }

        // 3. 获取当前节点
        var currentNode = await _repository.GetNodeAsync(instance.CurrentNodeID ?? 0);
        if (currentNode == null)
        {
            result.IsSuccess = false;
            result.Code = "NODE_NOT_FOUND";
            result.Message = "审核节点不存在";
            return result;
        }

        // 4. 记录审核操作
        var auditExecution = new tb_AuditNodeExecution
        {
            InstanceID = instance.InstanceID,
            NodeID = currentNode.NodeID,
            Auditor = operatorId,
            AuditorName = await GetUserNameAsync(operatorId),
            ActionType = (int)actionType,
            Comments = comments,
            ActionTime = DateTime.Now,
            IPAddress = GetCurrentUserIP()
        };
        await _repository.InsertAsync(auditExecution);

        // 5. 记录审核轨迹
        var billNo = await GetBillNoAsync(billId, billType);
        await RecordAuditTrailAsync(new AuditTrail
        {
            BillID = billId,
            BillType = billType,
            BillNo = billNo,
            WorkflowID = instance.WorkflowID,
            NodeID = currentNode.NodeID,
            Operator = operatorId,
            OperatorName = auditExecution.AuditorName,
            ActionType = actionType,
            Comments = comments,
            ActionTime = DateTime.Now
        });

        // 6. 根据操作类型处理
        switch (actionType)
        {
            case AuditActionType.Approve:
                return await HandleApproveAsync(instance, currentNode, operatorId, result);
                
            case AuditActionType.Reject:
                return await HandleRejectAsync(instance, currentNode, operatorId, result);
                
            case AuditActionType.Return:
                return await HandleReturnAsync(instance, currentNode, operatorId, result);
                
            default:
                result.IsSuccess = false;
                result.Code = "INVALID_ACTION";
                result.Message = "无效的操作类型";
                return result;
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "执行审核失败：{BillID}, {BillType}, {UserID}", billId, billType, operatorId);
        result.IsSuccess = false;
        result.Code = "ERROR";
        result.Message = "审核失败：" + ex.Message;
        return result;
    }
}

/// <summary>
/// 处理审核通过
/// </summary>
private async Task<AuditResult> HandleApproveAsync(tb_AuditInstance instance, WorkflowNode currentNode, 
    long operatorId, AuditResult result)
{
    // 1. 根据审核模式判断节点是否完成
    var nodeMode = (AuditWorkflowMode)currentNode.NodeMode;
    var isNodeCompleted = await _auditRuleEngine.IsNodeCompletedAsync(
        instance.BillID, instance.BillType, currentNode.NodeID);

    if (isNodeCompleted)
    {
        // 节点审核完成，进入下一节点
        var nextNode = await _auditRuleEngine.GetNextNodeAsync(
            instance.BillID, instance.BillType, currentNode.NodeID);

        if (nextNode == null)
        {
            // 所有节点审核完成，流程结束
            instance.WorkflowStatus = (int)WorkflowStatus.Completed;
            instance.CurrentNodeID = null;
            instance.CompleteTime = DateTime.Now;
            await _repository.UpdateAsync(instance);

            // 更新单据状态
            await _unifiedStateManager.SetDataStatusAsync(
                instance.BillID, instance.BillType, DataStatus.确认);

            result.IsSuccess = true;
            result.Code = "COMPLETED";
            result.Message = "审核流程已完成";
            result.WorkflowStatus = WorkflowStatus.Completed;
            result.BillStatus = DataStatus.确认;
        }
        else
        {
            // 进入下一节点
            instance.CurrentNodeID = nextNode.NodeID;
            await _repository.UpdateAsync(instance);

            result.IsSuccess = true;
            result.Code = "NEXT_NODE";
            result.Message = "审核通过，进入下一节点";
            result.WorkflowStatus = WorkflowStatus.InProgress;
            result.CurrentNodeId = nextNode.NodeID;

            // 通知下一节点审核人
            var auditors = await _auditRuleEngine.GetAuditorsAsync(
                instance.BillID, instance.BillType, nextNode.NodeID);
            result.NotifyUserIds = auditors.Select(a => a.UserId).Distinct().ToList();
            result.NeedNotify = true;
        }
    }
    else
    {
        // 节点尚未完成
        result.IsSuccess = true;
        result.Code = "NODE_IN_PROGRESS";
        result.Message = nodeMode == AuditWorkflowMode.AndApproval 
            ? "审核通过，等待其他审核人审核" 
            : "审核通过";
        result.WorkflowStatus = WorkflowStatus.InProgress;
    }

    return result;
}

/// <summary>
/// 处理审核拒绝
/// </summary>
private async Task<AuditResult> HandleRejectAsync(tb_AuditInstance instance, WorkflowNode currentNode, 
    long operatorId, AuditResult result)
{
    // 更新流程状态为已拒绝
    instance.WorkflowStatus = (int)WorkflowStatus.Rejected;
    instance.CompleteTime = DateTime.Now;
    await _repository.UpdateAsync(instance);

    // 更新单据状态
    await _unifiedStateManager.SetDataStatusAsync(
        instance.BillID, instance.BillType, DataStatus.驳回);

    // 通知提交人
    result.NotifyUserIds = new List<long> { instance.Submitter ?? 0 };
    result.NeedNotify = true;

    result.IsSuccess = true;
    result.Code = "REJECTED";
    result.Message = "审核已拒绝";
    result.WorkflowStatus = WorkflowStatus.Rejected;
    result.BillStatus = DataStatus.驳回;

    return result;
}

/// <summary>
/// 处理驳回修改
/// </summary>
private async Task<AuditResult> HandleReturnAsync(tb_AuditInstance instance, WorkflowNode currentNode, 
    long operatorId, AuditResult result)
{
    // 更新流程状态为已撤回
    instance.WorkflowStatus = (int)WorkflowStatus.Withdrawn;
    instance.CompleteTime = DateTime.Now;
    await _repository.UpdateAsync(instance);

    // 更新单据状态为草稿
    await _unifiedStateManager.SetDataStatusAsync(
        instance.BillID, instance.BillType, DataStatus.草稿);

    // 通知提交人
    result.NotifyUserIds = new List<long> { instance.Submitter ?? 0 };
    result.NeedNotify = true;

    result.IsSuccess = true;
    result.Code = "RETURNED";
    result.Message = "已驳回，请修改后重新提交";
    result.WorkflowStatus = WorkflowStatus.Withdrawn;
    result.BillStatus = DataStatus.草稿;

    return result;
}
```

---

## 5. 流程可视化组件设计

### 5.1 流程可视化数据模型

```csharp
/// <summary>
/// 流程可视化数据模型
/// </summary>
public class WorkflowVisualizationData
{
    /// <summary>流程ID</summary>
    public long WorkflowID { get; set; }

    /// <summary>流程名称</summary>
    public string WorkflowName { get; set; }

    /// <summary>流程模式</summary>
    public AuditWorkflowMode WorkflowMode { get; set; }

    /// <summary>节点列表</summary>
    public List<NodeVisualizationData> Nodes { get; set; }

    /// <summary>连接线列表</summary>
    public List<ConnectionData> Connections { get; set; }

    /// <summary>当前单据信息</summary>
    public BillInfoData BillInfo { get; set; }

    /// <summary>流程进度</summary>
    public int Progress { get; set; }
}

/// <summary>
/// 节点可视化数据模型
/// </summary>
public class NodeVisualizationData
{
    /// <summary>节点ID</summary>
    public long NodeID { get; set; }

    /// <summary>节点名称</summary>
    public string NodeName { get; set; }

    /// <summary>节点类型</summary>
    public NodeType NodeType { get; set; }

    /// <summary>节点状态</summary>
    public NodeStatus NodeStatus { get; set; }

    /// <summary>节点审核模式</summary>
    public AuditWorkflowMode NodeMode { get; set; }

    /// <summary>节点顺序</summary>
    public int OrderIndex { get; set; }

    /// <summary>显示位置X</summary>
    public int PositionX { get; set; }

    /// <summary>显示位置Y</summary>
    public int PositionY { get; set; }

    /// <summary>审核人列表</summary>
    public List<AuditorDisplayData> Auditors { get; set; }

    /// <summary>进入时间</summary>
    public DateTime? EnterTime { get; set; }

    /// <summary>完成时间</summary>
    public DateTime? CompleteTime { get; set; }

    /// <summary>是否可点击</summary>
    public bool CanClick { get; set; }

    /// <summary>点击操作类型</summary>
    public NodeClickAction ClickAction { get; set; }

    /// <summary>附加信息</summary>
    public Dictionary<string, object> AdditionalInfo { get; set; }
}

/// <summary>
/// 节点类型枚举
/// </summary>
public enum NodeType
{
    /// <summary>开始节点（提交）</summary>
    [Display(Name = "提交")]
    Start = 1,

    /// <summary>审核节点</summary>
    [Display(Name = "审核")]
    Audit = 2,

    /// <summary>结束节点（结案）</summary>
    [Display(Name = "结案")]
    End = 3
}

/// <summary>
/// 节点状态枚举
/// </summary>
public enum NodeStatus
{
    /// <summary>未开始</summary>
    [Display(Name = "未开始")]
    NotStarted = 0,

    /// <summary>进行中</summary>
    [Display(Name = "进行中")]
    InProgress = 1,

    /// <summary>已完成</summary>
    [Display(Name = "已完成")]
    Completed = 2,

    /// <summary>已跳过</summary>
    [Display(Name = "已跳过")]
    Skipped = 3
}

/// <summary>
/// 节点点击操作类型
/// </summary>
public enum NodeClickAction
{
    /// <summary>打开单据</summary>
    OpenBill = 1,

    /// <summary>执行审核</summary>
    ExecuteAudit = 2,

    /// <summary>查看审核详情</summary>
    ViewAuditDetail = 3,

    /// <summary>无操作</summary>
    None = 0
}

/// <summary>
/// 审核人显示数据模型
/// </summary>
public class AuditorDisplayData
{
    /// <summary>审核人ID</summary>
    public long UserId { get; set; }

    /// <summary>审核人姓名</summary>
    public string UserName { get; set; }

    /// <summary>审核人头像</summary>
    public string Avatar { get; set; }

    /// <summary>是否已审核</summary>
    public bool IsAudited { get; set; }

    /// <summary>审核时间</summary>
    public DateTime? AuditTime { get; set; }

    /// <summary>审核结果</summary>
    public AuditActionType? AuditAction { get; set; }

    /// <summary>审核意见</summary>
    public string Comments { get; set; }
}

/// <summary>
/// 连接线数据模型
/// </summary>
public class ConnectionData
{
    /// <summary>连接线ID</summary>
    public string ConnectionID { get; set; }

    /// <summary>源节点ID</summary>
    public long SourceNodeID { get; set; }

    /// <summary>目标节点ID</summary>
    public long TargetNodeID { get; set; }

    /// <summary>连接线类型</summary>
    public ConnectionType ConnectionType { get; set; }

    /// <summary>条件表达式（用于条件分支）</summary>
    public string ConditionExpression { get; set; }
}

/// <summary>
/// 连接线类型枚举
/// </summary>
public enum ConnectionType
{
    /// <summary>默认连接</summary>
    [Display(Name = "默认")]
    Default = 0,

    /// <summary>通过</summary>
    [Display(Name = "通过")]
    Approve = 1,

    /// <summary>拒绝</summary>
    [Display(Name = "拒绝")]
    Reject = 2,

    /// <summary>条件分支</summary>
    [Display(Name = "条件分支")]
    Conditional = 3
}

/// <summary>
/// 单据信息数据模型
/// </summary>
public class BillInfoData
{
    /// <summary>单据ID</summary>
    public long BillID { get; set; }

    /// <summary>单据类型</summary>
    public string BillType { get; set; }

    /// <summary>单据类型名称</summary>
    public string BillTypeName { get; set; }

    /// <summary>单据编号</summary>
    public string BillNo { get; set; }

    /// <summary>单据状态</summary>
    public DataStatus BillStatus { get; set; }

    /// <summary>流程状态</summary>
    public WorkflowStatus WorkflowStatus { get; set; }

    /// <summary>提交人ID</summary>
    public long SubmitterID { get; set; }

    /// <summary>提交人姓名</summary>
    public string SubmitterName { get; set; }

    /// <summary>提交时间</summary>
    public DateTime SubmitTime { get; set; }

    /// <summary>完成时间</summary>
    public DateTime? CompleteTime { get; set; }
}
```

### 5.2 流程可视化组件接口

```csharp
/// <summary>
/// 流程可视化组件
/// </summary>
public partial class WorkflowVisualizer : UserControl
{
    /// <summary>
    /// 单据ID
    /// </summary>
    public long BillID { get; set; }

    /// <summary>
    /// 单据类型
    /// </summary>
    public string BillType { get; set; }

    /// <summary>
    /// 是否显示详细信息
    /// </summary>
    public bool ShowDetail { get; set; } = true;

    /// <summary>
    /// 是否可交互
    /// </summary>
    public bool IsInteractive { get; set; } = true;

    /// <summary>
    /// 节点点击事件
    /// </summary>
    public event EventHandler<NodeClickEventArgs> NodeClicked;

    /// <summary>
    /// 流程完成事件
    /// </summary>
    public event EventHandler<WorkflowCompleteEventArgs> WorkflowCompleted;

    /// <summary>
    /// 初始化组件
    /// </summary>
    public WorkflowVisualizer()
    {
        InitializeComponent();
        InitializeVisualizer();
    }

    /// <summary>
    /// 加载流程数据
    /// </summary>
    /// <param name="billId">单据ID</param>
    /// <param name="billType">单据类型</param>
    public async Task LoadWorkflowAsync(long billId, string billType)
    {
        try
        {
            BillID = billId;
            BillType = billType;

            // 获取流程可视化数据
            var workflowData = await _auditWorkflowEngine.GetWorkflowVisualizationAsync(billId, billType);

            // 渲染流程图
            RenderWorkflow(workflowData);

            // 显示单据信息
            DisplayBillInfo(workflowData.BillInfo);

            // 显示流程进度
            DisplayProgress(workflowData.Progress);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "加载流程可视化失败：{BillID}, {BillType}", billId, billType);
            MessageBox.Show("加载流程失败：" + ex.Message, "错误", MessageBoxButtons.OK, MessageBoxIcon.Error);
        }
    }

    /// <summary>
    /// 刷新流程状态
    /// </summary>
    public async Task RefreshAsync()
    {
        if (BillID > 0 && !string.IsNullOrEmpty(BillType))
        {
            await LoadWorkflowAsync(BillID, BillType);
        }
    }

    /// <summary>
    /// 清空流程显示
    /// </summary>
    public void Clear()
    {
        BillID = 0;
        BillType = null;
        ClearWorkflowDisplay();
    }
}
```

### 5.3 流程设计器接口

```csharp
/// <summary>
/// 流程设计器组件
/// </summary>
public partial class WorkflowDesigner : UserControl
{
    /// <summary>
    /// 流程ID
    /// </summary>
    public long WorkflowID { get; set; }

    /// <summary>
    /// 单据类型
    /// </summary>
    public string BillType { get; set; }

    /// <summary>
    /// 流程模式
    /// </summary>
    public AuditWorkflowMode WorkflowMode { get; set; }

    /// <summary>
    /// 是否编辑模式
    /// </summary>
    public bool IsEditMode { get; set; } = true;

    /// <summary>
    /// 流程保存事件
    /// </summary>
    public event EventHandler<WorkflowSaveEventArgs> WorkflowSaved;

    /// <summary>
    /// 初始化设计器
    /// </summary>
    public WorkflowDesigner()
    {
        InitializeComponent();
        InitializeDesigner();
    }

    /// <summary>
    /// 创建新流程
    /// </summary>
    /// <param name="billType">单据类型</param>
    public void CreateNewWorkflow(string billType)
    {
        BillType = billType;
        WorkflowMode = AuditWorkflowMode.Single;
        WorkflowID = 0;

        // 创建默认节点
        CreateDefaultNodes();

        // 渲染设计画布
        RenderDesignerCanvas();
    }

    /// <summary>
    /// 加载现有流程
    /// </summary>
    /// <param name="workflowId">流程ID</param>
    public async Task LoadWorkflowAsync(long workflowId)
    {
        try
        {
            // 获取流程配置
            var workflowConfig = await _workflowConfigService.GetWorkflowConfigAsync(workflowId);
            if (workflowConfig == null)
            {
                MessageBox.Show("流程不存在", "错误", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            WorkflowID = workflowConfig.WorkflowID;
            BillType = workflowConfig.BillType;
            WorkflowMode = (AuditWorkflowMode)workflowConfig.WorkflowMode;

            // 获取节点列表
            var nodes = await _workflowConfigService.GetNodesAsync(workflowId);

            // 获取连接线列表
            var connections = await _workflowConfigService.GetConnectionsAsync(workflowId);

            // 渲染设计画布
            RenderDesignerCanvas(nodes, connections);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "加载流程失败：{WorkflowID}", workflowId);
            MessageBox.Show("加载流程失败：" + ex.Message, "错误", MessageBoxButtons.OK, MessageBoxIcon.Error);
        }
    }

    /// <summary>
    /// 保存流程
    /// </summary>
    public async Task<bool> SaveWorkflowAsync()
    {
        try
        {
            // 验证流程配置
            var validationResult = ValidateWorkflow();
            if (!validationResult.IsValid)
            {
                MessageBox.Show(validationResult.ErrorMessage, "验证失败", 
                    MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return false;
            }

            // 收集流程数据
            var workflowData = CollectWorkflowData();

            // 保存流程配置
            bool success;
            if (WorkflowID > 0)
            {
                success = await _workflowConfigService.UpdateWorkflowAsync(workflowData);
            }
            else
            {
                success = await _workflowConfigService.CreateWorkflowAsync(workflowData);
            }

            if (success)
            {
                // 触发保存事件
                WorkflowSaved?.Invoke(this, new WorkflowSaveEventArgs(workflowData));
                return true;
            }

            return false;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "保存流程失败");
            MessageBox.Show("保存流程失败：" + ex.Message, "错误", MessageBoxButtons.OK, MessageBoxIcon.Error);
            return false;
        }
    }
}
```

---

## 6. 界面设计

### 6.1 审核流程配置窗体

**窗体名称**：`FrmAuditWorkflowConfig`

**设计原则**：
- 简洁直观的表单化界面
- 支持拖拽式流程设计
- 实时预览流程效果
- 权限控制可视化配置

**窗体布局**：

```
┌─────────────────────────────────────────────────────────────────────────┐
│  审核流程配置                                    [─][□][×]          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  流程基本信息                                                     │ │
│  │  ──────────────────────────────────────────────────────────────  │ │
│  │  流程名称: [销售订单审核流程                     ]               │ │
│  │  适用单据: [销售订单 (tb_SaleOrder)        ▼]                     │ │
│  │  审核模式: (•) 单人审核  ( ) 或签模式  ( ) 并签模式  ( ) 逐级审批│ │
│  │  流程描述: [销售订单标准审核流程，支持业务审核和财务审核       ]   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  流程设计器                                                       │ │
│  │  ──────────────────────────────────────────────────────────────  │ │
│  │                                                                   │ │
│  │  [提交] ───▶ [业务审核] ───▶ [财务审核] ───▶ [结案]               │ │
│  │    ●           ▲                 ▲              ●                  │ │
│  │   完成         │               进行中          完成                 │ │
│  │               │               ●/●                                │ │
│  │           [张三,李四]        [王五,赵六]                          │ │
│  │                                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │
│  │  │ 节点属性                                                      │ │
│  │  │ 节点名称: [业务审核                      ]                   │ │
│  │  │ 审核模式: (•) 或签模式  ( ) 并签模式                        │ │
│  │  │ 允许拒绝: [√]  允许驳回: [√]  必填意见: [ ]                 │ │
│  │  │ 超时提醒: [1440] 分钟                                        │ │
│  │  │                                                               │ │
│  │  │ 审核人配置:                                                   │ │
│  │  │ ┌─────────────────────────────────────────────────────────┐   │ │
│  │  │ │ 审核人类型: [角色 ▼]  审核人: [销售经理   ▼]         │   │ │
│  │  │ │ [+ 添加审核人]                                          │   │ │
│  │  │ │ ┌───────────────────────────────────────────────────────┐│   │ │
│  │  │ │ │ #  审核人      类型      审核时间    审核意见    操作 ││   │ │
│  │  │ │ │ 1  张三        角色        10:30      同意       ×   ││   │ │
│  │  │ │ │ 2  李四        角色          -         -          ×   ││   │ │
│  │  │ │ └───────────────────────────────────────────────────────┘│   │ │
│  │  │ └─────────────────────────────────────────────────────────┘   │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                                                                   │ │
│  │  工具栏: [添加节点] [添加连接线] [删除] [对齐] [预览] [验证]     │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  [保存] [另存为] [取消] [应用]                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**主要功能**：
1. 流程基本信息配置
2. 拖拽式流程设计
3. 节点属性编辑
4. 审核人配置
5. 流程验证和预览
6. 保存和应用流程

### 6.2 流程可视化组件（嵌入单据编辑窗体）

**设计原则**：
- 清晰的状态指示
- 美观的节点显示
- 便捷的操作入口
- 实时的状态更新

**布局示例**：

```
┌─────────────────────────────────────────────────────────────────────────┐
│  单据信息                                                               │
├─────────────────────────────────────────────────────────────────────────┤
│  单据编号: SO20260108001          状态: 待审核                          │
│  提交人: 李四                    提交时间: 2026-01-08 10:00:00        │
├─────────────────────────────────────────────────────────────────────────┤
│  审核流程                                                               │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                                                                   │ │
│  │   [● 提交] ───────────▶ [● 业务审核] ───────────▶ [○ 财务审核]  │ │
│  │    已完成                   进行中                 未开始          │ │
│  │   10:00                    10:30                                  │ │
│  │                                                                   │ │
│  │   审核人: 张三, 李四                                              │ │
│  │   当前审核人: 张三 (点击可审核)                                    │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────┤
│  审核轨迹                                                               │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ ┌─────────────────────────────────────────────────────────────┐ │ │
│  │ │ 2026-01-08 10:30  张三  [审核进行中] 业务审核               │ │ │
│  │ │ 意见: 正在审核中...                                          │ │ │
│  │ ├─────────────────────────────────────────────────────────────┤ │ │
│  │ │ 2026-01-08 10:00  李四  [提交] 提交                       │ │ │
│  │ │ 意见: 销售订单已提交审核                                    │ │ │
│  │ └─────────────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.3 工作台流程显示

**设计原则**：
- 美观的流程卡片展示
- 直观的待办任务提示
- 便捷的操作入口
- 实时的状态更新

**布局示例**：

```
┌─────────────────────────────────────────────────────────────────────────┐
│  ERP工作台                                                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  我的待办 (5)                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ ┌─────────────────────────────────────────────────────────────┐ │ │
│  │ │ 销售订单审核                                                 │ │ │
│  │ │ ┌─────────────────────────────────────────────────────────┐ │ │ │
│  │ │ │ 单据编号: SO20260108001                                │ │ │ │
│  │ │ │ 客户名称: XX科技有限公司                                │ │ │ │
│  │ │ │ 金额: ¥12,500.00                                      │ │ │ │
│  │ │ │ 提交时间: 2026-01-08 10:00                            │ │ │ │
│  │ │ │ ┌─────────────────────────────────────────────────────┐ │ │ │ │
│  │ │ │ │ 流程进度: ████████░░ 80%                           │ │ │ │ │
│  │ │ │ │ [●提交] → [●业务审核] → [○财务审核] → [○结案]    │ │ │ │ │
│  │ │ │ └─────────────────────────────────────────────────────┘ │ │ │ │
│  │ │ │ 操作: [审核通过] [审核拒绝] [驳回] [查看详情]          │ │ │ │
│  │ │ └─────────────────────────────────────────────────────────┘ │ │ │
│  │ └─────────────────────────────────────────────────────────────┘ │ │
│  │ ┌─────────────────────────────────────────────────────────────┐ │ │
│  │ │ 采购订单审核                                                 │ │ │
│  │ │ ...                                                         │ │ │
│  │ └─────────────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  我的已提交 (3)                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ ...                                                                 │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  我的已完成 (10)                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ ...                                                                 │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 实施计划

### 7.1 第一阶段：基础架构搭建（预计5天）

| 任务 | 描述 | 时间 | 负责人 | 状态 |
|------|------|------|--------|------|
| 1.1 | 创建数据库表结构 | 1天 | 后端开发 | 待开始 |
| 1.2 | 实现核心枚举和数据模型 | 1天 | 后端开发 | 待开始 |
| 1.3 | 实现审核流程引擎基础接口 | 1.5天 | 后端开发 | 待开始 |
| 1.4 | 实现审核规则引擎基础接口 | 1.5天 | 后端开发 | 待开始 |

### 7.2 第二阶段：核心功能实现（预计8天）

| 任务 | 描述 | 时间 | 负责人 | 状态 |
|------|------|------|--------|------|
| 2.1 | 实现单人审核机制 | 2天 | 后端开发 | 待开始 |
| 2.2 | 实现或签和并签审核机制 | 3天 | 后端开发 | 待开始 |
| 2.3 | 实现审核轨迹记录 | 1天 | 后端开发 | 待开始 |
| 2.4 | 实现权限控制机制 | 2天 | 后端开发 | 待开始 |

### 7.3 第三阶段：界面开发（预计10天）

| 任务 | 描述 | 时间 | 负责人 | 状态 |
|------|------|------|--------|------|
| 3.1 | 开发审核流程配置窗体 | 3天 | 前端开发 | 待开始 |
| 3.2 | 开发流程可视化组件 | 3天 | 前端开发 | 待开始 |
| 3.3 | 开发流程设计器（简化版） | 2天 | 前端开发 | 待开始 |
| 3.4 | 集成到单据编辑窗体 | 2天 | 前端开发 | 待开始 |

### 7.4 第四阶段：工作台集成（预计5天）

| 任务 | 描述 | 时间 | 负责人 | 状态 |
|------|------|------|--------|------|
| 4.1 | 设计工作台流程展示界面 | 1天 | UI设计 | 待开始 |
| 4.2 | 开发待办任务列表 | 2天 | 前端开发 | 待开始 |
| 4.3 | 实现流程图嵌入工作台 | 1.5天 | 前端开发 | 待开始 |
| 4.4 | 实现节点点击打开单据 | 0.5天 | 前端开发 | 待开始 |

### 7.5 第五阶段：测试与优化（预计6天）

| 任务 | 描述 | 时间 | 负责人 | 状态 |
|------|------|------|--------|------|
| 5.1 | 功能测试 | 2天 | 测试工程师 | 待开始 |
| 5.2 | 性能测试 | 1天 | 测试工程师 | 待开始 |
| 5.3 | 界面美化优化 | 2天 | UI设计 | 待开始 |
| 5.4 | 文档编写 | 1天 | 技术写作 | 待开始 |

**总计预计时间：34天（约7周）**

---

## 8. 技术要点与注意事项

### 8.1 与现有系统集成

#### 8.1.1 状态管理系统集成

```csharp
// 在BaseBillEditGeneric中集成审核流程引擎
public partial class BaseBillEditGeneric<T, TItem> : BaseForm 
    where T : BaseEntity, new()
    where TItem : BaseEntity, new()
{
    private readonly IAuditWorkflowEngine _auditWorkflowEngine;

    protected override async Task SubmitBillAsync()
    {
        // 1. 保存单据
        await SaveBillAsync();

        // 2. 调用审核流程引擎提交
        var auditResult = await _auditWorkflowEngine.SubmitBillAsync(
            PrimaryKeyValue, 
            typeof(T).Name, 
            MainForm.Instance.AppContext.CurUserInfo.UserInfo.User_ID,
            "提交审核"
        );

        // 3. 处理审核结果
        if (auditResult.IsSuccess)
        {
            // 发送消息通知
            if (auditResult.NeedNotify && auditResult.NotifyUserIds != null)
            {
                await SendNotificationAsync(auditResult.NotifyUserIds, auditResult.Message);
            }

            // 刷新界面
            await RefreshFormAsync();
            
            // 显示流程可视化
            if (ShowWorkflowVisualization)
            {
                await _workflowVisualizer.LoadWorkflowAsync(PrimaryKeyValue, typeof(T).Name);
            }
        }
        else
        {
            MessageBox.Show(auditResult.Message, "提示", MessageBoxButtons.OK, MessageBoxIcon.Warning);
        }
    }

    protected override async Task ApproveBillAsync(string comments = null)
    {
        var auditResult = await _auditWorkflowEngine.ExecuteAuditAsync(
            PrimaryKeyValue,
            typeof(T).Name,
            MainForm.Instance.AppContext.CurUserInfo.UserInfo.User_ID,
            AuditActionType.Approve,
            comments
        );

        if (auditResult.IsSuccess)
        {
            // 处理审核结果
            await HandleAuditResultAsync(auditResult);
        }
        else
        {
            MessageBox.Show(auditResult.Message, "提示", MessageBoxButtons.OK, MessageBoxIcon.Warning);
        }
    }
}
```

#### 8.1.2 消息系统集成

```csharp
// 在审核流程引擎中集成消息通知
private async Task SendNotificationAsync(List<long> userIds, string message)
{
    try
    {
        var messageService = Startup.GetFromFac<MessageService>();
        if (messageService != null)
        {
            var messageData = new MessageData
            {
                MessageType = MessageType.Business,
                Title = "单据审核通知",
                Content = message,
                ReceiverIds = userIds,
                BizType = BizType.单据审核,
                SendTime = DateTime.Now,
                IsPopupMessage = true,
                AutoAddToMessageCenter = true
            };

            await messageService.SendBusinessMessageAsync(messageData);
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "发送审核通知失败");
    }
}
```

### 8.2 性能优化

1. **缓存策略**
   - 流程配置缓存（减少数据库查询）
   - 审核人列表缓存
   - 权限检查结果缓存
   - 流程可视化数据缓存

2. **异步处理**
   - 所有审核操作使用异步方法
   - 消息通知异步发送
   - 状态更新异步执行

3. **批量操作**
   - 批量查询审核实例
   - 批量更新状态
   - 批量发送通知

### 8.3 安全性考虑

1. **权限控制**
   - 严格的审核权限检查
   - 防止越权操作
   - 操作日志记录

2. **数据安全**
   - 敏感数据加密
   - SQL注入防护
   - XSS防护

3. **审计追踪**
   - 完整的操作日志
   - 不可篡改的审核轨迹
   - IP地址记录

### 8.4 扩展性设计

1. **插件化审核规则**
   ```csharp
   /// <summary>
   /// 审核规则插件接口
   /// </summary>
   public interface IAuditRulePlugin
   {
       /// <summary>
       /// 规则名称
       /// </summary>
       string RuleName { get; }

       /// <summary>
       /// 规则描述
       /// </summary>
       string Description { get; }

       /// <summary>
       /// 验证规则
       /// </summary>
       Task<ValidationResult> ValidateAsync(AuditContext context);

       /// <summary>
       /// 获取审核人
       /// </summary>
       Task<List<AuditorInfo>> GetAuditorsAsync(AuditContext context);
   }
   ```

2. **事件驱动架构**
   ```csharp
   // 审核前事件
   public event EventHandler<BeforeAuditEventArgs> BeforeAudit;

   // 审核后事件
   public event EventHandler<AfterAuditEventArgs> AfterAudit;

   // 流程完成事件
   public event EventHandler<WorkflowCompletedEventArgs> WorkflowCompleted;
   ```

3. **API扩展**
   ```csharp
   // REST API端点
   [HttpPost("api/audit/submit")]
   public async Task<IActionResult> SubmitAudit([FromBody] SubmitAuditRequest request);

   [HttpPost("api/audit/approve")]
   public async Task<IActionResult> ApproveAudit([FromBody] ApproveAuditRequest request);

   [HttpGet("api/workflow/visualization/{billId}/{billType}")]
   public async Task<IActionResult> GetWorkflowVisualization(long billId, string billType);
   ```

---

## 9. 未来扩展规划

### 9.1 高级审核模式

1. **条件分支审核**
   - 根据单据金额自动选择审核路径
   - 根据单据类型选择不同审核人
   - 根据客户等级选择审核流程

2. **逐级审批**
   - 支持多级审批（部门经理→总监→总经理）
   - 支持越级审批
   - 支持审批委托

3. **会签模式**
   - 指定审核顺序
   - 依次审核
   - 支持会签中止

### 9.2 流程设计器增强

1. **可视化拖拽设计**
   - 从工具箱拖拽节点到画布
   - 节点连线
   - 属性面板配置

2. **流程模板**
   - 预置常用流程模板
   - 模板导入导出
   - 模板库管理

3. **流程仿真**
   - 模拟流程执行
   - 检测流程错误
   - 性能分析

### 9.3 移动端支持

1. **移动端审核**
   - 微信小程序审核
   - 移动APP审核
   - 推送通知

2. **移动端流程查看**
   - 流程进度查看
   - 审核轨迹查看
   - 单据详情查看

### 9.4 智能化功能

1. **智能审核**
   - AI辅助审核
   - 异常检测
   - 风险预警

2. **智能提醒**
   - 基于用户习惯的提醒
   - 超时自动提醒
   - 紧急单据优先提醒

3. **智能路由**
   - 自动选择审核人
   - 负载均衡分配
   - 忙碌检测

### 9.5 数据分析

1. **审核效率分析**
   - 审核时长统计
   - 审核人效率分析
   - 流程瓶颈识别

2. **审核质量分析**
   - 审核通过率
   - 拒绝原因分析
   - 审核意见质量

3. **流程优化建议**
   - AI流程优化
   - 最佳实践推荐
   - 流程改进建议

---

## 10. 总结

### 10.1 方案优势

1. **实用主义**
   - 优先满足中小企业简单高效的审核需求
   - 当前阶段实现单人审核，快速见效
   - 后续逐步扩展高级功能

2. **无缝集成**
   - 与现有状态管理系统完美集成
   - 复用现有消息系统和权限系统
   - 最小化对现有代码的改动

3. **可扩展性**
   - 插件化审核规则引擎
   - 事件驱动架构
   - 预留接口支持未来扩展

4. **用户体验**
   - 美观的流程可视化
   - 直观的操作入口
   - 实时状态更新
   - 工作台集成

5. **完整可追溯**
   - 完整的审核轨迹记录
   - 详细的操作日志
   - 不可篡改的审核历史

### 10.2 实施建议

1. **分阶段实施**
   - 第一阶段：基础架构和单人审核
   - 第二阶段：多人审核（或签、并签）
   - 第三阶段：流程可视化和工作台集成
   - 第四阶段：高级功能和优化

2. **逐步迭代**
   - 每个阶段独立可交付
   - 及时收集用户反馈
   - 持续优化改进

3. **测试先行**
   - 完善的单元测试
   - 全面的集成测试
   - 充分的用户测试

4. **文档完善**
   - 技术文档
   - 用户手册
   - 操作指南

### 10.3 预期效果

1. **提升效率**
   - 简化审核流程，减少审批等待时间
   - 可视化流程，操作更直观
   - 工作台集中管理，提高工作效率

2. **降低风险**
   - 完整的审核轨迹，确保业务合规
   - 严格的权限控制，防止越权操作
   - 完善的审计日志，满足监管要求

3. **灵活适应**
   - 支持从简单到复杂的审核需求
   - 可配置的审核流程
   - 插件化的审核规则

4. **提升体验**
   - 美观的界面设计
   - 便捷的操作方式
   - 实时的状态反馈

---

## 附录A：术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 审核流程 | Audit Workflow | 单据从提交到结案的完整流程 |
| 审核节点 | Audit Node | 审核流程中的一个步骤 |
| 审核人 | Auditor | 有权限审核单据的用户 |
| 或签模式 | Or Approval | 多位审核人中任意一人完成审核即可通过 |
| 并签模式 | And Approval | 所有指定审核人必须全部完成审核 |
| 逐级审批 | Sequential Approval | 按层级顺序依次审核 |
| 审核轨迹 | Audit Trail | 审核操作的完整记录 |
| 流程可视化 | Workflow Visualization | 将流程以图形方式展示 |
| 流程设计器 | Workflow Designer | 用于设计和配置流程的工具 |

---

## 附录B：参考文档

1. 《单据生命周期管理方案.md》 - V1.0
2. 《状态管理系统统一文档.md》
3. 《RUINORERP系统架构概述.md》
4. 《工作流配置与消息分发规则整合方案.md》

---

**文档结束**

*本文档为RUINORERP单据生命周期管理系统的优化方案，基于现有系统架构，提供完整的实施方案和技术指导。*
