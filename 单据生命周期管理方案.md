# 单据生命周期管理方案

## 1. 方案概述

### 1.1 设计目标

本方案旨在为面向中小企业的ERP系统设计一套**实用主义为核心**的单据生命周期管理流程，兼顾当前需求与未来扩展性。通过灵活的审核流程配置，支持从简单到复杂的业务场景，确保系统能够随企业发展而平滑演进。

### 1.2 核心原则

- **实用优先**：满足当前中小企业简单高效的操作需求
- **可扩展设计**：预留接口支持未来复杂业务场景
- **平滑过渡**：确保新旧审核模式兼容
- **可视化管理**：流程可视化，提升用户体验
- **完整轨迹**：记录全流程操作日志，确保可追溯性

## 2. 单据生命周期管理流程

### 2.1 核心操作步骤

| 操作阶段 | 操作名称 | 操作描述 | 状态变化 |
|---------|---------|---------|---------|
| 初始阶段 | 新增 | 创建新单据，填写基本信息 | 草稿 |
| 编辑阶段 | 保存 | 保存单据内容，可继续编辑 | 草稿 |
| 生效阶段 | 提交 | 单据正式生效，进入审核流程 | 待审核 |
| 控制阶段 | 审核 | 核心控制环节，审核通过或拒绝 | 已审核/已拒绝 |
| 结束阶段 | 结案 | 单据生命周期结束 | 已结案 |

### 2.2 单据状态流转图

```
┌─────────┐     ┌─────────┐     ┌─────────────┐     ┌─────────┐     ┌─────────┐
│  新增   │────▶│  保存   │────▶│   提交      │────▶│  审核   │────▶│  结案   │
└─────────┘     └─────────┘     └─────────────┘     └─────────┘     └─────────┘
        ▲                           │                     │                     ▲
        │                           │                     │                     │
        └───────────────────────────┘                     └─────────────────────┘
                 可多次保存                               审核通过/拒绝后结案
```

## 3. 审核机制设计

### 3.1 单人审核机制（当前阶段）

**功能描述**：任何具备审核权限的用户或角色均可执行审核操作

**实现要点**：
- 基于角色/用户的权限控制
- 审核人列表显示所有具备权限的用户
- 支持审核意见录入
- 审核后自动更新单据状态

### 3.2 多人审核机制（前瞻性设计）

**支持审核模式**：

#### 3.2.1 或签模式

- **定义**：多位审核人中任意一人完成审核即可通过
- **适用场景**：并行审批，提高效率
- **流程**：
  1. 单据提交后，所有指定审核人收到待办通知
  2. 任意审核人完成审核后，流程继续
  3. 其他审核人无需再审核

#### 3.2.2 并签模式

- **定义**：所有指定审核人必须全部完成审核
- **适用场景**：重要单据，需要多方确认
- **流程**：
  1. 单据提交后，所有指定审核人收到待办通知
  2. 所有审核人完成审核后，流程继续
  3. 任意审核人拒绝，流程终止

### 3.3 高级审核预留接口

系统预留接口支持未来更复杂的审核规则：
- **条件分支审核**：根据单据金额、类型等条件自动选择审核路径
- **逐级审批**：按层级顺序审核，如部门经理→总经理
- **会签模式**：指定审核顺序，按顺序依次审核
- **委托审核**：支持审核权限临时委托

## 4. 技术实现方案

### 4.1 系统架构设计

```
┌──────────────────────────────────────────────────────────────────┐
│                        表现层                                    │
│  ┌───────────────────────┐  ┌───────────────────────┐            │
│  │   单据录入界面         │  │  审核流程配置界面     │            │
│  └─────────────┬─────────┘  └─────────────┬─────────┘            │
│                │                          │                        │
│  ┌─────────────────────────────────────────────────────────┐      │
│  │                   流程可视化组件                       │      │
│  └──────────────────────────────┬─────────────────────────┘      │
└──────────────────────────────────┼────────────────────────────────┘
                                   │
                                   ▼
┌──────────────────────────────────────────────────────────────────┐
│                        业务逻辑层                                │
│  ┌───────────────────────┐  ┌───────────────────────┐            │
│  │   单据生命周期管理     │  │  审核流程引擎         │            │
│  └─────────────┬─────────┘  └─────────────┬─────────┘            │
│                │                          │                        │
│  ┌─────────────────────────────────────────────────────────┐      │
│  │                   权限控制服务                       │      │
│  └──────────────────────────────┬─────────────────────────┘      │
└──────────────────────────────────┼────────────────────────────────┘
                                   │
                                   ▼
┌──────────────────────────────────────────────────────────────────┐
│                        数据层                                    │
│  ┌───────────────────────┐  ┌───────────────────────┐            │
│  │   单据主表            │  │  审核轨迹表           │            │
│  └─────────────┬─────────┘  └─────────────┬─────────┘            │
│                │                          │                        │
│  ┌─────────────────────────────────────────────────────────┐      │
│  │                   审核流程配置表                     │      │
│  └─────────────────────────────────────────────────────────┘      │
└──────────────────────────────────────────────────────────────────┘
```

### 4.2 数据库设计

#### 4.2.1 审核流程配置表 (`tb_WorkflowConfig`)

| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| `WorkflowID` | `long` | 流程ID |
| `WorkflowName` | `string` | 流程名称 |
| `BillType` | `string` | 适用单据类型 |
| `IsEnabled` | `bool` | 是否启用 |
| `AuditMode` | `int` | 审核模式（0：单人，1：或签，2：并签） |
| `Creator` | `long` | 创建人 |
| `CreateTime` | `datetime` | 创建时间 |
| `Updater` | `long` | 更新人 |
| `UpdateTime` | `datetime` | 更新时间 |

#### 4.2.2 审核节点配置表 (`tb_WorkflowNode`)

| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| `NodeID` | `long` | 节点ID |
| `WorkflowID` | `long` | 所属流程ID |
| `NodeName` | `string` | 节点名称 |
| `NodeType` | `int` | 节点类型（1：提交，2：审核，3：结案） |
| `OrderIndex` | `int` | 节点顺序 |
| `AuditMode` | `int` | 审核模式（0：单人，1：或签，2：并签） |
| `IsActive` | `bool` | 是否激活 |

#### 4.2.3 审核人员配置表 (`tb_WorkflowAuditor`)

| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| `AuditorID` | `long` | 审核人ID |
| `NodeID` | `long` | 所属节点ID |
| `AuditorType` | `int` | 审核人类型（1：用户，2：角色，3：部门） |
| `AuditorValue` | `long` | 审核人值（用户ID/角色ID/部门ID） |
| `OrderIndex` | `int` | 顺序（仅用于逐级审批） |

#### 4.2.4 审核轨迹表 (`tb_AuditTrail`)

| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| `TrailID` | `long` | 轨迹ID |
| `BillID` | `long` | 单据ID |
| `BillType` | `string` | 单据类型 |
| `NodeID` | `long` | 节点ID |
| `Operator` | `long` | 操作人 |
| `ActionType` | `int` | 操作类型（1：提交，2：审核通过，3：审核拒绝，4：结案） |
| `ActionTime` | `datetime` | 操作时间 |
| `Comments` | `string` | 操作意见 |
| `StatusBefore` | `int` | 操作前状态 |
| `StatusAfter` | `int` | 操作后状态 |

### 4.3 核心技术实现

#### 4.3.1 审核流程引擎

```csharp
/// <summary>
/// 审核流程引擎
/// </summary>
public class AuditWorkflowEngine
{
    /// <summary>
    /// 执行审核操作
    /// </summary>
    /// <param name="billId">单据ID</param>
    /// <param name="billType">单据类型</param>
    /// <param name="operatorId">操作人ID</param>
    /// <param name="comments">审核意见</param>
    /// <returns>审核结果</returns>
    public async Task<AuditResult> ExecuteAuditAsync(long billId, string billType, long operatorId, string comments)
    {
        // 1. 获取单据当前状态
        // 2. 检查操作人权限
        // 3. 执行审核逻辑
        // 4. 更新单据状态
        // 5. 记录审核轨迹
        // 6. 发送通知
        // 7. 返回审核结果
    }
}
```

#### 4.3.2 流程可视化组件

```csharp
/// <summary>
/// 流程可视化组件
/// </summary>
public class WorkflowVisualizationComponent : UserControl
{
    /// <summary>
    /// 加载流程配置
    /// </summary>
    /// <param name="workflowId">流程ID</param>
    public async Task LoadWorkflowAsync(long workflowId)
    {
        // 1. 获取流程配置
        // 2. 构建可视化流程图
        // 3. 绑定事件处理
    }
    
    /// <summary>
    /// 处理节点点击事件
    /// </summary>
    private void Node_Click(object sender, EventArgs e)
    {
        // 1. 获取节点信息
        // 2. 打开对应单据界面
        // 3. 执行相关操作
    }
}
```

## 5. 界面设计

### 5.1 审核流程配置界面

**设计原则**：
- 简洁直观的表单化界面
- 支持拖拽式流程设计（未来扩展）
- 实时预览流程效果
- 权限控制可视化配置

**主要功能**：
1. 流程基本信息配置
2. 审核节点添加/编辑
3. 审核人/角色/部门配置
4. 审核模式选择
5. 流程启用/禁用

### 5.2 单据操作界面

**设计原则**：
- 清晰的状态指示
- 直观的操作按钮
- 完整的审核轨迹显示
- 便捷的意见录入

**主要功能**：
1. 单据信息编辑
2. 保存/提交/审核/结案操作按钮
3. 审核轨迹查看
4. 审核意见录入
5. 流程状态可视化显示

### 5.3 工作台流程可视化

**设计原则**：
- 美观的流程图展示
- 直观的待办任务提示
- 便捷的操作入口
- 实时的状态更新

**主要功能**：
1. 我的待办流程显示
2. 流程状态可视化
3. 直接点击节点打开单据
4. 流程进度跟踪
5. 流程历史记录查看

## 6. 扩展性设计

### 6.1 审核规则扩展机制

```csharp
/// <summary>
/// 审核规则接口
/// </summary>
public interface IAuditRule
{
    /// <summary>
    /// 规则名称
    /// </summary>
    string RuleName { get; }
    
    /// <summary>
    /// 验证审核条件
    /// </summary>
    /// <param name="billInfo">单据信息</param>
    /// <returns>验证结果</returns>
    Task<bool> ValidateAsync(BillInfo billInfo);
    
    /// <summary>
    /// 获取审核人列表
    /// </summary>
    /// <param name="billInfo">单据信息</param>
    /// <returns>审核人列表</returns>
    Task<List<AuditorInfo>> GetAuditorsAsync(BillInfo billInfo);
}
```

### 6.2 事件驱动架构

系统采用事件驱动架构，支持流程节点事件扩展：

| 事件类型 | 触发时机 | 用途 |
|---------|---------|------|
| `BeforeAuditEvent` | 审核前 | 审核条件验证 |
| `AfterAuditEvent` | 审核后 | 状态更新、通知发送 |
| `NodeEnterEvent` | 进入节点 | 节点初始化、权限检查 |
| `NodeLeaveEvent` | 离开节点 | 节点清理、后续节点准备 |

### 6.3 API设计

```
// 获取流程配置
GET /api/workflow/config/{workflowId}

// 保存流程配置
POST /api/workflow/config

// 执行审核操作
POST /api/workflow/audit

// 获取审核轨迹
GET /api/workflow/trail/{billId}

// 获取我的待办
GET /api/workflow/todos/{userId}

// 获取流程可视化数据
GET /api/workflow/visual/{workflowId}
```

## 7. 实施计划

### 7.1 第一阶段：基础框架搭建

| 任务 | 描述 | 时间 |
|------|------|------|
| 1.1 数据库设计 | 设计审核流程相关表结构 | 3天 |
| 1.2 核心服务开发 | 实现审核流程引擎、权限控制 | 5天 |
| 1.3 基础UI开发 | 单据操作界面、审核流程配置界面 | 5天 |
| 1.4 单人审核机制 | 实现当前阶段的单人审核功能 | 3天 |

### 7.2 第二阶段：多人审核扩展

| 任务 | 描述 | 时间 |
|------|------|------|
| 2.1 多人审核逻辑 | 实现或签、并签审核模式 | 4天 |
| 2.2 审核轨迹记录 | 完整记录审核操作轨迹 | 2天 |
| 2.3 兼容性处理 | 确保新旧审核模式兼容 | 3天 |

### 7.3 第三阶段：流程可视化

| 任务 | 描述 | 时间 |
|------|------|------|
| 3.1 流程可视化组件 | 开发流程可视化显示组件 | 5天 |
| 3.2 工作台集成 | 将流程显示到ERP工作台 | 3天 |
| 3.3 交互优化 | 实现节点点击打开单据等功能 | 3天 |

### 7.4 第四阶段：测试与优化

| 任务 | 描述 | 时间 |
|------|------|------|
| 4.1 功能测试 | 验证各功能模块正确性 | 5天 |
| 4.2 性能测试 | 确保系统性能满足需求 | 3天 |
| 4.3 用户体验优化 | 提升界面美观性和操作便捷性 | 3天 |
| 4.4 文档编写 | 编写用户手册和技术文档 | 3天 |

## 8. 预期效果

### 8.1 业务价值

- **提高效率**：简化审核流程，减少审批等待时间
- **降低风险**：完整的审核轨迹，确保业务合规
- **灵活适应**：支持从简单到复杂的审核需求
- **提升体验**：可视化流程，操作直观便捷

### 8.2 技术价值

- **可扩展架构**：支持未来复杂业务场景
- **模块化设计**：便于维护和扩展
- **事件驱动**：提高系统响应性和灵活性
- **API设计**：支持前后端分离和第三方集成

## 9. 未来规划

1. **拖动式流程设计器**：实现可视化拖拽配置流程
2. **条件分支审核**：根据单据条件自动选择审核路径
3. **逐级审批**：支持按层级顺序审核
4. **移动端支持**：实现移动端审核功能
5. **智能提醒**：基于AI的审核任务智能分配
6. **数据分析**：审核流程效率分析和优化建议
7. **电子签名**：支持审核电子签名
8. **区块链存证**：实现审核轨迹区块链存证

## 10. 结论

本方案设计了一套以实用主义为核心，兼顾当前需求与未来扩展性的单据生命周期管理流程。通过灵活的审核流程配置、完整的审核轨迹记录和直观的可视化界面，能够满足中小企业当前的简单实用需求，同时为未来业务复杂度提升和更精细化权限管理预留了扩展空间。

方案采用了模块化、事件驱动的架构设计，确保系统具有良好的可扩展性和可维护性。通过分阶段实施，能够平滑过渡到更复杂的审核模式，为企业数字化转型提供有力支持。