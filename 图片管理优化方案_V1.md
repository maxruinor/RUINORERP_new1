# å›¾ç‰‡ç®¡ç†ä¼˜åŒ–æ–¹æ¡ˆ - å®Œæ•´å®ç°æŒ‡å—

## 1. æ–¹æ¡ˆæ¦‚è¿°

é’ˆå¯¹é”€å”®è®¢å•ç­‰ä¸šåŠ¡å•æ®ä¸­çš„å›¾ç‰‡ç®¡ç†,å®ç°å®Œæ•´çš„å›¾ç‰‡ç”Ÿå‘½å‘¨æœŸç®¡ç†,åŒ…æ‹¬:

- âœ… å›¾ç‰‡ä¸Šä¼ /ä¸‹è½½ä¼˜åŒ–
- âœ… å›¾ç‰‡æ›´æ–°ä¸ç‰ˆæœ¬ç®¡ç†
- âœ… è¿‡æœŸæ–‡ä»¶è‡ªåŠ¨è¯†åˆ«ä¸æ¸…ç†
- âœ… å­¤ç«‹æ–‡ä»¶æ£€æµ‹ä¸å¤„ç†
- âœ… ä¸šåŠ¡å…³è”å…³ç³»ç»´æŠ¤

## 2. æ ¸å¿ƒæ¶æ„è®¾è®¡

### 2.1 æ–‡ä»¶çŠ¶æ€ç®¡ç†

```
æ–‡ä»¶çŠ¶æ€ (tb_FS_FileStorageInfo.Status):
â”œâ”€â”€ 0 = Active (æ­£å¸¸) - æ–‡ä»¶æœ‰æ•ˆä¸”æœ‰ä¸šåŠ¡å…³è”
â”œâ”€â”€ 1 = Expired (è¿‡æœŸ) - è¶…è¿‡ExpireTime
â”œâ”€â”€ 2 = Orphaned (å­¤ç«‹) - æ— ä¸šåŠ¡å…³è”
â””â”€â”€ 3 = Deleted (å·²åˆ é™¤) - é€»è¾‘åˆ é™¤
```

### 2.2 å›¾ç‰‡æ›´æ–°ç­–ç•¥

```csharp
/// <summary>
/// ä¸‰ç§å›¾ç‰‡æ›´æ–°ç­–ç•¥
/// </summary>
public enum UpdateStrategy
{
    /// <summary>
    /// ä»…æ–°å¢ - ä¿ç•™æ—§æ–‡ä»¶,åˆ›å»ºæ–°å…³è”(é»˜è®¤)
    /// é€‚ç”¨åœºæ™¯: éœ€è¦ä¿ç•™å†å²è®°å½•
    /// </summary>
    AppendOnly = 0,

    /// <summary>
    /// æ›¿æ¢æ¨¡å¼ - ä¿ç•™å†å²ç‰ˆæœ¬,æ›´æ–°å…³è”åˆ°æ–°æ–‡ä»¶
    /// é€‚ç”¨åœºæ™¯: éœ€è¦å†å²è¿½æº¯ä½†åªæ˜¾ç¤ºæœ€æ–°ç‰ˆæœ¬
    /// </summary>
    Replace = 1,

    /// <summary>
    /// è¦†ç›–æ¨¡å¼ - åˆ é™¤æ—§æ–‡ä»¶,åˆ›å»ºæ–°æ–‡ä»¶
    /// é€‚ç”¨åœºæ™¯: ä¸éœ€è¦å†å²è®°å½•
    /// </summary>
    Overwrite = 2
}
```

## 3. æœåŠ¡ç«¯å®ç°

### 3.1 ä¾èµ–æ³¨å…¥é…ç½®

**å·²æ·»åŠ çš„DIæ³¨å†Œ:**

```csharp
// æœåŠ¡ç«¯ DIé…ç½®: RUINORERP.Server/Network/DI/NetworkServicesDependencyInjection.cs

// åœ¨ AddNetworkServices æ–¹æ³•ä¸­æ·»åŠ :
services.AddTransient<FileUpdateService>();
services.AddTransient<FileCleanupService>();

// åœ¨ ConfigureNetworkServicesContainer æ–¹æ³•ä¸­æ·»åŠ :
builder.RegisterType<FileUpdateService>().AsSelf().InstancePerDependency();
builder.RegisterType<FileCleanupService>().AsSelf().InstancePerDependency();

// FileCommandHandler é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥:
public FileCommandHandler(
    FileUpdateService fileUpdateService,
    FileCleanupService fileCleanupService,
    // ...å…¶ä»–å‚æ•°
)
{
    _fileUpdateService = fileUpdateService ?? throw new ArgumentNullException(nameof(fileUpdateService));
    _fileCleanupService = fileCleanupService ?? throw new ArgumentNullException(nameof(fileCleanupService));
}
```

**FileStorageHelper æ‰©å±•:**

å·²æ·»åŠ `GetStoragePath()`æ–¹æ³•,ç”¨äºè·å–è§£æåçš„å­˜å‚¨æ ¹è·¯å¾„:

```csharp
// RUINORERP.Server/Helpers/FileStorageHelper.cs
public static string GetStoragePath()
{
    if (_serverConfig == null || string.IsNullOrEmpty(_serverConfig.FileStoragePath))
        return string.Empty;

    return ResolveEnvironmentVariables(_serverConfig.FileStoragePath);
}
```

### 3.2 FileCleanupService - æ–‡ä»¶æ¸…ç†æœåŠ¡

**åŠŸèƒ½èŒè´£:**
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ–‡ä»¶(æ¯å¤©å‡Œæ™¨2ç‚¹)
- è¯†åˆ«å¹¶æ¸…ç†å­¤ç«‹æ–‡ä»¶
- æ¸…ç†ç‰©ç†ç›®å½•ä¸­çš„å­¤ç«‹æ–‡ä»¶
- æä¾›æ‰‹åŠ¨æ¸…ç†æ¥å£
- ç»Ÿè®¡æ–‡ä»¶å­˜å‚¨ä½¿ç”¨æƒ…å†µ

**å…³é”®æ–¹æ³•:**

```csharp
// æ¸…ç†è¿‡æœŸæ–‡ä»¶
await cleanupService.CleanupExpiredFilesAsync(
    daysThreshold: 30,      // è¿‡æœŸå¤©æ•°é˜ˆå€¼
    physicalDelete: false   // æ˜¯å¦ç‰©ç†åˆ é™¤
);

// æ¸…ç†å­¤ç«‹æ–‡ä»¶
await cleanupService.CleanupOrphanedFilesAsync(
    daysThreshold: 7,      // å­¤ç«‹å¤©æ•°é˜ˆå€¼
    physicalDelete: false   // æ˜¯å¦ç‰©ç†åˆ é™¤
);

// æ¸…ç†ç‰©ç†ç›®å½•ä¸­çš„å­¤ç«‹æ–‡ä»¶
await cleanupService.CleanupPhysicalOrphanedFilesAsync();

// è·å–æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯
var stats = await cleanupService.GetCleanupStatisticsAsync();
Console.WriteLine($"æ€»æ–‡ä»¶æ•°: {stats.TotalFiles}");
Console.WriteLine($"è¿‡æœŸæ–‡ä»¶: {stats.ExpiredFiles}");
Console.WriteLine($"å­¤ç«‹æ–‡ä»¶: {stats.OrphanedFiles}");
Console.WriteLine($"æ€»å­˜å‚¨: {stats.TotalStorageSizeFormatted}");
```

**æ¸…ç†ç­–ç•¥:**
1. **è¿‡æœŸæ–‡ä»¶** - è¶…è¿‡ExpireTimeçš„æ–‡ä»¶
   - é€»è¾‘åˆ é™¤(é»˜è®¤): æ ‡è®°Status=1,ä¿ç•™ç‰©ç†æ–‡ä»¶
   - ç‰©ç†åˆ é™¤: æ£€æŸ¥æ— ä¸šåŠ¡å…³è”ååˆ é™¤ç‰©ç†æ–‡ä»¶å’Œè®°å½•

2. **å­¤ç«‹æ–‡ä»¶** - æ— ä¸šåŠ¡å…³è”ä¸”è¶…è¿‡é˜ˆå€¼çš„æ–‡ä»¶
   - é€»è¾‘åˆ é™¤(é»˜è®¤): æ ‡è®°Status=2
   - ç‰©ç†åˆ é™¤: ç›´æ¥åˆ é™¤

3. **ç‰©ç†å­¤ç«‹æ–‡ä»¶** - æ•°æ®åº“ä¸­ä¸å­˜åœ¨ä½†ç‰©ç†ç›®å½•å­˜åœ¨çš„æ–‡ä»¶
   - è¶…è¿‡30å¤©æœªè®¿é—®è‡ªåŠ¨åˆ é™¤
   - è·³è¿‡ç³»ç»Ÿæ–‡ä»¶(.gitkeep, .DS_Storeç­‰)

### 3.2 FileUpdateService - æ–‡ä»¶æ›´æ–°æœåŠ¡

**åŠŸèƒ½èŒè´£:**
- å¤„ç†å›¾ç‰‡çš„æ›¿æ¢å’Œæ›´æ–°
- ç»´æŠ¤ä¸šåŠ¡å…³è”å…³ç³»
- æ”¯æŒç‰ˆæœ¬å†å²è®°å½•
- æä¾›æ‰¹é‡æ›´æ–°åŠŸèƒ½

**æ›´æ–°æµç¨‹:**

```csharp
// å•ä¸ªæ–‡ä»¶æ›´æ–°
var (newFileInfo, newRelation, oldFiles) = await updateService.UpdateBusinessFileAsync(
    businessType: (int)BizType.é”€å”®è®¢å•,
    businessNo: "SO20250119001",
    businessId: 1001,
    relatedField: "VoucherImage",
    newFileData: imageData,
    newFileName: "å‡­è¯å›¾ç‰‡.jpg",
    strategy: FileUpdateService.UpdateStrategy.Replace,  // æ›´æ–°ç­–ç•¥
    userId: currentUser.UserId,
    isDetailTable: false,
    detailId: null
);

// æ‰¹é‡æ–‡ä»¶æ›´æ–°
var result = await updateService.BatchUpdateBusinessFilesAsync(
    businessType: (int)BizType.é”€å”®è®¢å•,
    businessNo: "SO20250119001",
    businessId: 1001,
    relatedField: "VoucherImage",
    newFiles: new List<(byte[], string)> {
        (imageData1, "å‡­è¯1.jpg"),
        (imageData2, "å‡­è¯2.jpg")
    },
    strategy: FileUpdateService.UpdateStrategy.Replace
);

Console.WriteLine($"æˆåŠŸ: {result.SuccessFiles.Count}, å¤±è´¥: {result.FailedFiles.Count}");
```

**ç­–ç•¥è¯¦è§£:**

#### ç­–ç•¥1: AppendOnly (ä»…æ–°å¢)
```sql
-- ä¿ç•™æ‰€æœ‰æ–‡ä»¶å’Œå…³è”å…³ç³»
-- ä¸åˆ é™¤ä»»ä½•æ—§æ•°æ®
-- ä»…æ·»åŠ æ–°çš„å…³è”è®°å½•
INSERT INTO tb_FS_BusinessRelation (...)

ä¼˜ç‚¹: å®Œæ•´çš„å†å²è®°å½•
ç¼ºç‚¹: å­˜å‚¨ç©ºé—´å ç”¨å¤§
é€‚ç”¨: éœ€è¦å®¡è®¡è¿½è¸ªçš„åœºæ™¯
```

#### ç­–ç•¥2: Replace (æ›¿æ¢)
```sql
-- æ ‡è®°æ—§å…³è”ä¸ºä¸æ´»è·ƒ
UPDATE tb_FS_BusinessRelation 
SET IsActive = 0 
WHERE BusinessId = ? AND RelatedField = ?

-- åˆ›å»ºæ–°çš„æ´»è·ƒå…³è”
INSERT INTO tb_FS_BusinessRelation (..., IsActive = 1)

ä¼˜ç‚¹: ä¿ç•™å†å²ä½†æŸ¥è¯¢æœ€æ–°ç‰ˆæœ¬é«˜æ•ˆ
ç¼ºç‚¹: ä»å ç”¨å­˜å‚¨ç©ºé—´
é€‚ç”¨: éœ€è¦å†å²è¿½æº¯ä½†ä¸»è¦ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
```

#### ç­–ç•¥3: Overwrite (è¦†ç›–)
```sql
-- åˆ é™¤æ—§å…³è”
DELETE FROM tb_FS_BusinessRelation WHERE ...

-- é€»è¾‘åˆ é™¤æ—§æ–‡ä»¶
UPDATE tb_FS_FileStorageInfo SET isdeleted = 1 WHERE ...

-- åˆ é™¤ç‰©ç†æ–‡ä»¶
DELETE FROM disk WHERE FileId = ...

-- åˆ›å»ºæ–°æ–‡ä»¶å’Œå…³è”
INSERT INTO tb_FS_FileStorageInfo (...)
INSERT INTO tb_FS_BusinessRelation (...)

ä¼˜ç‚¹: èŠ‚çœå­˜å‚¨ç©ºé—´
ç¼ºç‚¹: ä¸¢å¤±å†å²è®°å½•
é€‚ç”¨: ä¸éœ€è¦å†å²è®°å½•çš„åœºæ™¯
```

### 3.3 FileCommandHandler é›†æˆ

å·²åœ¨FileCommandHandlerä¸­é›†æˆäº†FileUpdateServiceå’ŒFileCleanupService:

```csharp
public class FileCommandHandler : BaseCommandHandler
{
    private readonly FileUpdateService _fileUpdateService;
    private readonly FileCleanupService _fileCleanupService;

    // æ”¯æŒçš„å‘½ä»¤æ‰©å±•
    SetSupportedCommands(
        FileCommands.FileUpload,
        FileCommands.FileDownload,
        FileCommands.FileDelete,
        // ...
        // æœªæ¥å¯æ‰©å±•:
        // FileCommands.FileUpdate,
        // FileCommands.FileCleanup,
        // FileCommands.FileVersionHistory
    );
}
```

## 4. å®¢æˆ·ç«¯å®ç°

### 4.1 å®¢æˆ·ç«¯DIé…ç½®

**å·²æ·»åŠ çš„DIæ³¨å†Œ:**

```csharp
// å®¢æˆ·ç«¯ DIé…ç½®: RUINORERP.UI/Network/DI/NetworkServicesDependencyInjection.cs

// åœ¨ ConfigureNetworkServicesContainer æ–¹æ³•ä¸­æ·»åŠ :
builder.RegisterType<FileUpdateClientService>()
    .AsSelf()
    .InstancePerLifetimeScope()
    .PropertiesAutowired();

// FileManagementService å·²åœ¨å‰é¢æ³¨å†Œ:
builder.RegisterType<FileManagementService>()
    .AsSelf()
    .InstancePerLifetimeScope()
    .PropertiesAutowired();
```

**DIæ³¨å…¥è¯´æ˜:**

`FileUpdateClientService`é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–:

```csharp
public sealed class FileUpdateClientService : IDisposable
{
    private readonly ClientCommunicationService _communicationService;
    private readonly FileManagementService _fileManagementService;
    private readonly ILogger<FileUpdateClientService> _logger;

    public FileUpdateClientService(
        ClientCommunicationService communicationService,
        FileManagementService fileManagementService,
        ILogger<FileUpdateClientService> logger = null)
    {
        _communicationService = communicationService;
        _fileManagementService = fileManagementService;
        _logger = logger;
    }
}
```

**ä½¿ç”¨æ–¹å¼:**

```csharp
// åœ¨çª—ä½“æˆ–æœåŠ¡ä¸­é€šè¿‡DIæ³¨å…¥
public class UCSaleOrder : BaseBillEditGeneric
{
    private readonly FileUpdateClientService _fileUpdateService;

    public UCSaleOrder(FileUpdateClientService fileUpdateService)
    {
        _fileUpdateService = fileUpdateService;
    }
}

// æˆ–è€…é€šè¿‡Startupè·å–æœåŠ¡
var fileUpdateService = Startup.GetFromFac<FileUpdateClientService>();
```

### 4.2 FileUpdateClientService - æ–‡ä»¶æ›´æ–°å®¢æˆ·ç«¯æœåŠ¡

**åŠŸèƒ½èŒè´£:**
- æä¾›ç®€å•çš„APIè°ƒç”¨æœåŠ¡ç«¯æ›´æ–°åŠŸèƒ½
- æ”¯æŒå•ä¸ªå’Œæ‰¹é‡æ–‡ä»¶æ›´æ–°
- æä¾›æ›´æ–°ç­–ç•¥é€‰æ‹©
- å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•

**ä½¿ç”¨ç¤ºä¾‹:**

```csharp
// è·å–æœåŠ¡
var updateService = Startup.GetFromFac<FileUpdateClientService>();

// æ›´æ–°å•ä¸ªå›¾ç‰‡
var result = await updateService.UpdateBusinessFileAsync(
    businessType: (int)BizType.é”€å”®è®¢å•,
    businessNo: saleOrder.SOrderNo,
    businessId: saleOrder.PrimaryKeyID,
    relatedField: "VoucherImage",
    newFileData: File.ReadAllBytes(@"C:\æ–°å‡­è¯.jpg"),
    newFileName: "æ–°å‡­è¯.jpg",
    strategy: FileUpdateStrategy.Replace
);

if (result.IsSuccess)
{
    Console.WriteLine($"æ–‡ä»¶æ›´æ–°æˆåŠŸ,æ–°æ–‡ä»¶ID: {result.NewFileId}");
}
else
{
    Console.WriteLine($"æ–‡ä»¶æ›´æ–°å¤±è´¥: {result.Message}");
}

// æ‰¹é‡æ›´æ–°å›¾ç‰‡
var batchResult = await updateService.BatchUpdateBusinessFilesAsync(
    businessType: (int)BizType.é”€å”®è®¢å•,
    businessNo: saleOrder.SOrderNo,
    businessId: saleOrder.PrimaryKeyID,
    relatedField: "PaymentImagePath",
    newFiles: new List<(byte[], string)> {
        (File.ReadAllBytes(@"C:\å‡­è¯1.jpg"), "å‡­è¯1.jpg"),
        (File.ReadAllBytes(@"C:\å‡­è¯2.jpg"), "å‡­è¯2.jpg")
    },
    strategy: FileUpdateStrategy.AppendOnly
);
```

### 4.2 FileManagementController æ‰©å±•

åœ¨FileManagementControllerä¸­æ·»åŠ æ›´æ–°æ–¹æ³•:

```csharp
/// <summary>
/// æ›´æ–°ä¸šåŠ¡å•æ®çš„å›¾ç‰‡
/// </summary>
public async Task<FileUploadResponse> UpdateBusinessImageAsync(
    BaseEntity entity,
    string relatedField,
    byte[] newImageData,
    string newImageName,
    FileUpdateStrategy strategy = FileUpdateStrategy.Replace,
    long? oldFileId = null)
{
    // å‚æ•°éªŒè¯
    if (entity == null)
        throw new ArgumentNullException(nameof(entity));

    if (newImageData == null || newImageData.Length == 0)
        throw new ArgumentException("å›¾ç‰‡æ•°æ®ä¸èƒ½ä¸ºç©º");

    try
    {
        // è·å–å®ä½“ä¿¡æ¯
        var entityInfo = _mapper.GetEntityInfo(entity.GetType());
        if (entityInfo == null)
            throw new ArgumentException("æ— æ•ˆçš„ä¸šåŠ¡å®ä½“ç±»å‹");

        string businessNo = entity.GetPropertyValue<string>(entityInfo.NoField).ToString();
        int businessType = (int)entityInfo.BizType;

        // è·å–æ–‡ä»¶æ›´æ–°æœåŠ¡
        var updateService = _appContext.GetRequiredService<FileUpdateClientService>();

        // æ‰§è¡Œæ›´æ–°
        var updateResult = await updateService.UpdateBusinessFileAsync(
            businessType: businessType,
            businessNo: businessNo,
            businessId: entity.PrimaryKeyID,
            relatedField: relatedField,
            newFileData: newImageData,
            newFileName: newImageName,
            strategy: strategy
        );

        if (updateResult.IsSuccess)
        {
            // è¿”å›æ ‡å‡†å“åº”æ ¼å¼
            var response = new FileUploadResponse();
            response.IsSuccess = true;
            response.Message = updateResult.Message;

            // æŸ¥è¯¢æ–°æ–‡ä»¶ä¿¡æ¯å¹¶æ·»åŠ åˆ°å“åº”
            var fileStorageInfo = new tb_FS_FileStorageInfo
            {
                FileId = updateResult.NewFileId,
                OriginalFileName = updateResult.NewFileName,
                FileSize = updateResult.NewFileSize
            };
            response.FileStorageInfos.Add(fileStorageInfo);

            return response;
        }
        else
        {
            return ResponseFactory.CreateSpecificErrorResponse<FileUploadResponse>(updateResult.Message);
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "æ›´æ–°ä¸šåŠ¡å›¾ç‰‡å¤±è´¥");
        return ResponseFactory.CreateSpecificErrorResponse<FileUploadResponse>($"æ›´æ–°ä¸šåŠ¡å›¾ç‰‡å¤±è´¥: {ex.Message}");
    }
}
```

## 5. ä¸šåŠ¡å•æ®é›†æˆç¤ºä¾‹

### 5.1 åœ¨é”€å”®è®¢å•ä¸­ä½¿ç”¨

```csharp
// UCSaleOrder.cs ä¸­ä½¿ç”¨
public partial class UCSaleOrder : BaseBillEditGeneric<tb_SaleOrder, tb_SaleOrderDetail>
{
    // è·å–æœåŠ¡
    private readonly FileManagementController _fileController;
    private readonly FileUpdateClientService _fileUpdateService;

    /// <summary>
    /// æ›´æ–°é”€å”®è®¢å•å‡­è¯å›¾ç‰‡
    /// </summary>
    private async Task UpdateVoucherImageAsync(string imagePath)
    {
        if (!File.Exists(imagePath))
        {
            MessageBox.Show("æ–‡ä»¶ä¸å­˜åœ¨", "æç¤º");
            return;
        }

        // é€‰æ‹©æ›´æ–°ç­–ç•¥
        var strategy = FileUpdateStrategy.Replace; // æ›¿æ¢æ¨¡å¼,ä¿ç•™å†å²

        // è¯»å–å›¾ç‰‡æ•°æ®
        var imageData = File.ReadAllBytes(imagePath);
        var fileName = Path.GetFileName(imagePath);

        // æ›´æ–°å›¾ç‰‡
        var result = await _fileUpdateService.UpdateBusinessFileAsync(
            businessType: (int)BizType.é”€å”®è®¢å•,
            businessNo: CurrentEntity.SOrderNo,
            businessId: CurrentEntity.PrimaryKeyID,
            relatedField: "VoucherImage",
            newFileData: imageData,
            newFileName: fileName,
            strategy: strategy
        );

        if (result.IsSuccess)
        {
            MessageBox.Show("å‡­è¯å›¾ç‰‡æ›´æ–°æˆåŠŸ", "æç¤º");
            // åˆ·æ–°æ˜¾ç¤º
            await LoadVoucherImagesAsync();
        }
        else
        {
            MessageBox.Show($"å‡­è¯å›¾ç‰‡æ›´æ–°å¤±è´¥: {result.Message}", "é”™è¯¯");
        }
    }

    /// <summary>
    /// æ‰¹é‡æ›´æ–°ä»˜æ¬¾å‡­è¯å›¾ç‰‡
    /// </summary>
    private async Task BatchUpdatePaymentImagesAsync(List<string> imagePaths)
    {
        var files = new List<(byte[], string)>();
        foreach (var path in imagePaths)
        {
            if (File.Exists(path))
            {
                files.Add((File.ReadAllBytes(path), Path.GetFileName(path)));
            }
        }

        if (files.Count == 0)
        {
            MessageBox.Show("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶", "æç¤º");
            return;
        }

        var result = await _fileUpdateService.BatchUpdateBusinessFilesAsync(
            businessType: (int)BizType.é”€å”®è®¢å•,
            businessNo: CurrentEntity.SOrderNo,
            businessId: CurrentEntity.PrimaryKeyID,
            relatedField: "PaymentImagePath",
            newFiles: files,
            strategy: FileUpdateStrategy.AppendOnly // ä¿ç•™æ‰€æœ‰å†å²å›¾ç‰‡
        );

        if (result.IsSuccess)
        {
            MessageBox.Show($"æˆåŠŸæ›´æ–° {result.SuccessFiles.Count} å¼ å›¾ç‰‡", "æç¤º");
            await LoadPaymentImagesAsync();
        }
        else
        {
            MessageBox.Show($"éƒ¨åˆ†å›¾ç‰‡æ›´æ–°å¤±è´¥,æˆåŠŸ:{result.SuccessFiles.Count}, å¤±è´¥:{result.FailedFiles.Count}", "è­¦å‘Š");
        }
    }
}
```

### 5.2 åœ¨BaseBillEditGenericä¸­é€šç”¨é›†æˆ

```csharp
// BaseBillEditGeneric.cs ä¸­æ·»åŠ é€šç”¨æ–¹æ³•

/// <summary>
/// æ›´æ–°ä¸šåŠ¡å•æ®å›¾ç‰‡çš„é€šç”¨æ–¹æ³•
/// </summary>
/// <param name="relatedField">å…³è”å­—æ®µå</param>
/// <param name="imagePath">å›¾ç‰‡è·¯å¾„</param>
/// <param name="strategy">æ›´æ–°ç­–ç•¥</param>
/// <returns>æ˜¯å¦æ›´æ–°æˆåŠŸ</returns>
protected async Task<bool> UpdateBillImageAsync(
    string relatedField,
    string imagePath,
    FileUpdateStrategy strategy = FileUpdateStrategy.Replace)
{
    if (CurrentEntity == null)
    {
        MainForm.Instance?.ShowStatusText("å½“å‰æ²¡æœ‰åŠ è½½çš„ä¸šåŠ¡å•æ®");
        return false;
    }

    if (!File.Exists(imagePath))
    {
        MainForm.Instance?.ShowStatusText("å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨");
        return false;
    }

    try
    {
        var fileService = Startup.GetFromFac<FileUpdateClientService>();
        
        var entityInfo = _mapper.GetEntityInfo(CurrentEntity.GetType());
        var businessNo = CurrentEntity.GetPropertyValue<string>(entityInfo.NoField).ToString();
        var businessType = (int)entityInfo.BizType;

        var imageData = File.ReadAllBytes(imagePath);
        var fileName = Path.GetFileName(imagePath);

        var result = await fileService.UpdateBusinessFileAsync(
            businessType: businessType,
            businessNo: businessNo,
            businessId: CurrentEntity.PrimaryKeyID,
            relatedField: relatedField,
            newFileData: imageData,
            newFileName: fileName,
            strategy: strategy
        );

        if (result.IsSuccess)
        {
            MainForm.Instance?.ShowStatusText("å›¾ç‰‡æ›´æ–°æˆåŠŸ");
            return true;
        }
        else
        {
            MainForm.Instance?.ShowStatusText($"å›¾ç‰‡æ›´æ–°å¤±è´¥: {result.Message}");
            return false;
        }
    }
    catch (Exception ex)
    {
        MainForm.Instance?.logger?.LogError(ex, "æ›´æ–°ä¸šåŠ¡å›¾ç‰‡å¤±è´¥");
        MainForm.Instance?.ShowStatusText($"å›¾ç‰‡æ›´æ–°å¤±è´¥: {ex.Message}");
        return false;
    }
}
```

## 6. å®šæ—¶ä»»åŠ¡é…ç½®

### 6.1 å¯ç”¨è‡ªåŠ¨æ¸…ç†

FileCleanupServiceåœ¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ³¨å†Œå®šæ—¶ä»»åŠ¡,æ— éœ€é¢å¤–é…ç½®:

```csharp
// Startup.cs æˆ– Program.cs ä¸­æ³¨å†ŒæœåŠ¡
services.AddSingleton<FileCleanupService>();
services.AddSingleton<FileUpdateService>();
```

æ¸…ç†æ—¶é—´: æ¯å¤©å‡Œæ™¨2:00æ‰§è¡Œ

### 6.2 æ‰‹åŠ¨è§¦å‘æ¸…ç†

```csharp
// åœ¨ç®¡ç†ç•Œé¢æˆ–å®šæ—¶ä»»åŠ¡ä¸­æ‰‹åŠ¨è§¦å‘
var cleanupService = Startup.GetFromFac<FileCleanupService>();

// æ¸…ç†è¿‡æœŸæ–‡ä»¶
var expiredCount = await cleanupService.CleanupExpiredFilesAsync(
    daysThreshold: 30,
    physicalDelete: false
);

// æ¸…ç†å­¤ç«‹æ–‡ä»¶
var orphanedCount = await cleanupService.CleanupOrphanedFilesAsync(
    daysThreshold: 7,
    physicalDelete: false
);

// æ¸…ç†ç‰©ç†å­¤ç«‹æ–‡ä»¶
var physicalCount = await cleanupService.CleanupPhysicalOrphanedFilesAsync();

Console.WriteLine($"æ¸…ç†å®Œæˆ - è¿‡æœŸ:{expiredCount}, å­¤ç«‹:{orphanedCount}, ç‰©ç†:{physicalCount}");
```

## 7. é…ç½®é€‰é¡¹

### 7.1 æœåŠ¡å™¨é…ç½®

```json
{
  "ServerGlobalConfig": {
    "FileStoragePath": "D:\\FileStorage",
    "EnableAutoCleanup": true,
    "ExpiredFileDaysThreshold": 30,
    "OrphanedFileDaysThreshold": 7,
    "PhysicalOrphanedFileDaysThreshold": 30,
    "MaxStorageSizeGB": 100
  }
}
```

### 7.2 æ›´æ–°ç­–ç•¥é…ç½®

å¯ä»¥æ ¹æ®ä¸šåŠ¡ç±»å‹é…ç½®é»˜è®¤çš„æ›´æ–°ç­–ç•¥:

```csharp
public class FileUpdateConfig
{
    /// <summary>
    /// å„ä¸šåŠ¡ç±»å‹çš„é»˜è®¤æ›´æ–°ç­–ç•¥
    /// </summary>
    public Dictionary<BizType, FileUpdateStrategy> DefaultStrategies { get; set; } =
        new Dictionary<BizType, FileUpdateStrategy>
        {
            // é”€å”®è®¢å• - é»˜è®¤ä½¿ç”¨æ›¿æ¢æ¨¡å¼,ä¿ç•™å†å²
            [BizType.é”€å”®è®¢å•] = FileUpdateStrategy.Replace,
            
            // ä»˜æ¬¾å• - é»˜è®¤ä½¿ç”¨ä»…æ–°å¢æ¨¡å¼,ä¿ç•™æ‰€æœ‰å‡­è¯
            [BizType.ä»˜æ¬¾å•] = FileUpdateStrategy.AppendOnly,
            
            // äº§å“å›¾ç‰‡ - é»˜è®¤ä½¿ç”¨è¦†ç›–æ¨¡å¼,èŠ‚çœç©ºé—´
            [BizType.äº§å“ä¿¡æ¯] = FileUpdateStrategy.Overwrite
        };
}
```

## 8. ç›‘æ§ä¸ç»Ÿè®¡

### 8.1 è·å–å­˜å‚¨ç»Ÿè®¡ä¿¡æ¯

```csharp
var cleanupService = Startup.GetFromFac<FileCleanupService>();
var stats = await cleanupService.GetCleanupStatisticsAsync();

// æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
Console.WriteLine($"=== æ–‡ä»¶å­˜å‚¨ç»Ÿè®¡ ===");
Console.WriteLine($"æ€»æ–‡ä»¶æ•°: {stats.TotalFiles}");
Console.WriteLine($"æ­£å¸¸æ–‡ä»¶: {stats.ActiveFiles}");
Console.WriteLine($"è¿‡æœŸæ–‡ä»¶: {stats.ExpiredFiles}");
Console.WriteLine($"å­¤ç«‹æ–‡ä»¶: {stats.OrphanedFiles}");
Console.WriteLine($"æ€»å­˜å‚¨: {stats.TotalStorageSizeFormatted}");
```

### 8.2 å­˜å‚¨ç©ºé—´é¢„è­¦

```csharp
// æ£€æŸ¥å­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡
var stats = await cleanupService.GetCleanupStatisticsAsync();
var maxStorageBytes = _serverConfig.MaxStorageSizeGB * 1024L * 1024 * 1024;
var usagePercentage = (double)stats.TotalStorageSize / maxStorageBytes * 100;

if (usagePercentage > 90)
{
    _logger.LogWarning("å­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡è¶…è¿‡90%,å»ºè®®æ¸…ç†è¿‡æœŸæ–‡ä»¶");
    // å‘é€å‘Šè­¦é€šçŸ¥
}

if (usagePercentage > 95)
{
    _logger.LogError("å­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡è¶…è¿‡95%,ç´§æ€¥æ¸…ç†");
    // è‡ªåŠ¨è§¦å‘æ¸…ç†
    await cleanupService.CleanupExpiredFilesAsync(daysThreshold: 7, physicalDelete: true);
}
```

## 9. å¸¸è§é—®é¢˜è§£ç­”

### Q1: å›¾ç‰‡æ›´æ–°åæ—§æ–‡ä»¶ä¼šç«‹å³åˆ é™¤å—?

A: å–å†³äºä½¿ç”¨çš„æ›´æ–°ç­–ç•¥:
- **AppendOnly**: æ—§æ–‡ä»¶ä¿ç•™,ä¸åˆ é™¤
- **Replace**: æ—§æ–‡ä»¶ä¿ç•™,ä»…æ ‡è®°å…³è”ä¸ºä¸æ´»è·ƒ
- **Overwrite**: æ—§æ–‡ä»¶ç‰©ç†åˆ é™¤

### Q2: è¿‡æœŸæ–‡ä»¶ä»€ä¹ˆæ—¶å€™ä¼šè¢«æ¸…ç†?

A: FileCleanupServiceæ¯å¤©å‡Œæ™¨2:00è‡ªåŠ¨æ¸…ç†,ä¹Ÿå¯æ‰‹åŠ¨è§¦å‘æ¸…ç†:
- é»˜è®¤è¿‡æœŸé˜ˆå€¼: 30å¤©
- å¯é…ç½®: `ExpiredFileDaysThreshold`

### Q3: å¦‚ä½•æ¢å¤è¢«åˆ é™¤çš„æ–‡ä»¶?

A: å¦‚æœæ˜¯é€»è¾‘åˆ é™¤(Status=1/2/3),å¯ä»¥é€šè¿‡FileCleanupService.RestoreFilesAsyncæ¢å¤:
```csharp
await cleanupService.RestoreFilesAsync(new List<long> { fileId1, fileId2 });
```

å¦‚æœæ˜¯ç‰©ç†åˆ é™¤,åˆ™æ— æ³•æ¢å¤,å»ºè®®å®šæœŸå¤‡ä»½ã€‚

### Q4: å­¤ç«‹æ–‡ä»¶æ˜¯å¦‚ä½•è¯†åˆ«çš„?

A: å­¤ç«‹æ–‡ä»¶è¯†åˆ«æ¡ä»¶:
1. æ•°æ®åº“ä¸­å­˜åœ¨è®°å½•(tb_FS_FileStorageInfo)
2. ä½†æ²¡æœ‰ä¸šåŠ¡å…³è”è®°å½•(tb_FS_BusinessRelation)
3. ä¸”åˆ›å»ºæ—¶é—´è¶…è¿‡é˜ˆå€¼(é»˜è®¤7å¤©)

### Q5: å¦‚ä½•æŸ¥çœ‹æ–‡ä»¶çš„ç‰ˆæœ¬å†å²?

A: ä½¿ç”¨FileUpdateService.GetFileVersionHistoryAsync:
```csharp
var history = await updateService.GetFileVersionHistoryAsync(
    businessType: (int)BizType.é”€å”®è®¢å•,
    businessId: saleOrder.PrimaryKeyID,
    relatedField: "VoucherImage"
);

foreach (var version in history)
{
    Console.WriteLine($"ç‰ˆæœ¬: {version.VersionNo}, æ–‡ä»¶: {version.FileName}, æ´»è·ƒ: {version.IsActive}");
}
```

## 10. æœ€ä½³å®è·µå»ºè®®

### 10.1 æ›´æ–°ç­–ç•¥é€‰æ‹©

| ä¸šåŠ¡ç±»å‹ | æ¨èç­–ç•¥ | åŸå›  |
|---------|---------|------|
| é”€å”®è®¢å•å‡­è¯ | Replace | éœ€è¦å†å²è¿½æº¯,ä¸»è¦ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ |
| ä»˜æ¬¾å•å‡­è¯ | AppendOnly | æ³•å¾‹è¦æ±‚ä¿ç•™æ‰€æœ‰åŸå§‹å‡­è¯ |
| äº§å“å›¾ç‰‡ | Overwrite | ä¸éœ€è¦å†å²,èŠ‚çœå­˜å‚¨ç©ºé—´ |
| åˆåŒé™„ä»¶ | Replace | åˆåŒå¯èƒ½æœ‰ä¿®æ”¹ç‰ˆæœ¬ |
| å…¶ä»–å•æ® | AppendOnly | ä¿å®ˆé€‰æ‹©,ä¿ç•™æ‰€æœ‰è®°å½• |

### 10.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ‰¹é‡æ“ä½œ**: å°½é‡ä½¿ç”¨æ‰¹é‡ä¸Šä¼ /æ›´æ–°æ¥å£
2. **æ–‡ä»¶å‹ç¼©**: ä¸Šä¼ å‰å‹ç¼©å¤§å›¾ç‰‡
3. **å¼‚æ­¥å¤„ç†**: æ‰€æœ‰æ–‡ä»¶æ“ä½œä½¿ç”¨å¼‚æ­¥æ–¹æ³•
4. **ç¼“å­˜æœºåˆ¶**: é¢‘ç¹è®¿é—®çš„æ–‡ä»¶å¯è€ƒè™‘ç¼“å­˜

### 10.3 å®‰å…¨å»ºè®®

1. **æƒé™éªŒè¯**: æ‰€æœ‰æ–‡ä»¶æ“ä½œéœ€è¦æƒé™æ£€æŸ¥
2. **æ–‡ä»¶å¤§å°é™åˆ¶**: é™åˆ¶å•ä¸ªæ–‡ä»¶æœ€å¤§10MB
3. **æ–‡ä»¶ç±»å‹éªŒè¯**: åªå…è®¸ç‰¹å®šæ ¼å¼(jpg,png,pdfç­‰)
4. **å®šæœŸå¤‡ä»½**: é‡è¦æ–‡ä»¶å®šæœŸå¤‡ä»½

## 11. å®æ–½æ­¥éª¤

### é˜¶æ®µ1: åŸºç¡€åŠŸèƒ½å®ç°(å·²å®Œæˆ)
- âœ… FileCleanupServiceå®ç°
- âœ… FileUpdateServiceå®ç°
- âœ… FileUpdateClientServiceå®ç°

### é˜¶æ®µ2: é›†æˆä¸æµ‹è¯•(è¿›è¡Œä¸­)
- â³ åœ¨FileCommandHandlerä¸­é›†æˆæ–°æœåŠ¡
- â³ åœ¨é”€å”®è®¢å•æ¨¡å—ä¸­é›†æˆ
- â³ ç¼–å†™å•å…ƒæµ‹è¯•

### é˜¶æ®µ3: éƒ¨ç½²ä¸ä¼˜åŒ–(å¾…å®æ–½)
- â³ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
- â³ æ€§èƒ½æµ‹è¯•ä¸ä¼˜åŒ–
- â³ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- â³ ç›‘æ§ä¸ç»´æŠ¤

## 12. æ€»ç»“

æœ¬ä¼˜åŒ–æ–¹æ¡ˆæä¾›äº†å®Œæ•´çš„å›¾ç‰‡ç”Ÿå‘½å‘¨æœŸç®¡ç†:

1. **çµæ´»çš„æ›´æ–°ç­–ç•¥**: æ”¯æŒä¸‰ç§ç­–ç•¥,æ»¡è¶³ä¸åŒä¸šåŠ¡éœ€æ±‚
2. **è‡ªåŠ¨æ¸…ç†æœºåˆ¶**: å®šæ—¶æ¸…ç†è¿‡æœŸå’Œå­¤ç«‹æ–‡ä»¶,èŠ‚çœå­˜å‚¨ç©ºé—´
3. **å®Œæ•´çš„ç‰ˆæœ¬ç®¡ç†**: ä¿ç•™æ–‡ä»¶ç‰ˆæœ¬å†å²,æ”¯æŒè¿½æº¯
4. **ç®€å•çš„APIè®¾è®¡**: å®¢æˆ·ç«¯è°ƒç”¨ç®€å•,æ˜“äºé›†æˆ
5. **å¯é…ç½®æ€§**: æ”¯æŒçµæ´»é…ç½®,é€‚åº”ä¸åŒåœºæ™¯

**å…³é”®ä¼˜åŠ¿:**
- ğŸš€ æå‡å­˜å‚¨ç©ºé—´åˆ©ç”¨ç‡
- ğŸ“Š æä¾›å®Œæ•´çš„æ–‡ä»¶ç»Ÿè®¡å’Œç›‘æ§
- ğŸ”’ ä¿è¯æ•°æ®ä¸€è‡´æ€§å’Œå¯è¿½æº¯æ€§
- ğŸ’¾ æ”¯æŒå¤šç§æ›´æ–°ç­–ç•¥,çµæ´»é€‚åº”ä¸šåŠ¡éœ€æ±‚
- â™»ï¸ è‡ªåŠ¨æ¸…ç†è¿‡æœŸå’Œå­¤ç«‹æ–‡ä»¶,å‡å°‘äººå·¥å¹²é¢„
