# 定时任务配置管理系统使用指南

## 概述

本系统提供了一个统一的定时任务配置管理方案，用于集中管理所有工作流的执行时间点。通过 JSON 配置文件，可以方便地修改定时任务的执行时间，无需修改代码。

## 系统架构

### 核心组件

1. **ScheduledTaskConfiguration.cs** - 配置管理类
   - 负责加载、保存、管理定时任务配置
   - 单例模式，确保全局只有一个配置实例
   - 自动创建默认配置文件（如果不存在）

2. **ScheduledTaskHelper.cs** - 配置辅助类
   - 提供任务ID常量和配置访问方法
   - 计算下次执行时间
   - 检查任务启用状态

3. **ScheduledTasks.json** - 配置文件
   - JSON 格式的定时任务配置文件
   - 位于服务器应用程序根目录

## 配置文件格式

```json
{
  "tasks": [
    {
      "id": "InventorySnapshot",
      "name": "库存快照",
      "description": "每日生成库存快照并清理过期快照",
      "executionTime": "03:00:00",
      "intervalType": 0,
      "enabled": true,
      "workflowId": "InventorySnapshotWorkflow"
    }
  ]
}
```

### 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| id | string | 任务ID（唯一标识） |
| name | string | 任务名称 |
| description | string | 任务描述 |
| executionTime | string | 执行时间（HH:mm:ss 格式）|
| intervalType | int | 间隔类型（0=每日，1=循环）|
| enabled | bool | 是否启用 |
| workflowId | string | 关联的工作流ID（可选）|

## 预配置的定时任务

### 1. 库存快照
- **任务ID**: InventorySnapshot
- **默认时间**: 03:00:00（凌晨3点）
- **类型**: 每日执行
- **描述**: 每日生成库存快照并清理过期快照

### 2. 文件清理
- **任务ID**: FileCleanup
- **默认时间**: 03:00:00（凌晨3点）
- **类型**: 每日执行
- **描述**: 清理过期文件、孤立文件和物理孤立文件

### 3. 临时图片清理
- **任务ID**: TempImageCleanup
- **默认时间**: 03:00:00（凌晨3点）
- **类型**: 每日执行
- **描述**: 清理上传目录中的临时图片

### 4. 安全库存计算
- **任务ID**: SafetyStockCalculation
- **默认时间**: 02:00:00（凌晨2点）
- **类型**: 每日执行
- **描述**: 计算所有产品的安全库存和预警库存

### 5. 提醒检查
- **任务ID**: ReminderCheck
- **默认时间**: 00:01:00
- **类型**: 循环执行
- **描述**: 检查需要提醒的业务数据并触发提醒工作流

## 使用方法

### 修改任务执行时间

1. 打开 `ScheduledTasks.json` 文件
2. 找到需要修改的任务
3. 修改 `executionTime` 字段（格式：HH:mm:ss）
4. 保存文件
5. 重启服务器应用程序

示例：将文件清理时间改为凌晨4点

```json
{
  "id": "FileCleanup",
  "name": "文件清理",
  "description": "清理过期文件、孤立文件和物理孤立文件",
  "executionTime": "04:00:00",  // 修改为4点
  "intervalType": 0,
  "enabled": true,
  "workflowId": "FileCleanupWorkflow"
}
```

### 禁用/启用任务

修改 `enabled` 字段：

```json
{
  "enabled": false  // 禁用任务
}
```

或

```json
{
  "enabled": true   // 启用任务
}
```

### 编程方式访问配置

```csharp
// 获取任务执行时间
var executionTime = ScheduledTaskHelper.GetTaskExecutionTime("FileCleanup");

// 计算下次执行时间
var nextTime = ScheduledTaskHelper.CalculateNextExecutionTime("InventorySnapshot");

// 检查任务是否启用
var isEnabled = ScheduledTaskHelper.IsTaskEnabled("SafetyStockCalculation");

// 获取任务完整信息
var taskInfo = ScheduledTaskHelper.GetTaskInfo("TempImageCleanup");
```

### 修改任务配置

```csharp
// 获取配置实例
var config = ScheduledTaskConfiguration.GetInstance();

// 设置任务执行时间
config.SetExecutionTime("FileCleanup", "05:00:00");

// 启用/禁用任务
config.SetTaskEnabled("InventorySnapshot", false);

// 重新加载配置
config.Reload();
```

## 工作流集成

### 在工作流中使用配置

将工作流配置类中的硬编码时间改为从配置文件读取：

**修改前**：
```csharp
public static TimeSpan DailyExecutionTime = new TimeSpan(2, 0, 0); // 硬编码
```

**修改后**：
```csharp
public static TimeSpan DailyExecutionTime =>
    ScheduledTaskHelper.GetTaskExecutionTime("InventorySnapshot"); // 从配置读取
```

### 计算下次执行时间

使用辅助方法计算下次执行时间：

```csharp
// 从配置文件获取执行时间
var nextRunTime = ScheduledTaskHelper.CalculateNextExecutionTime("FileCleanup");

// 计算首次延迟
var interval = nextRunTime - DateTime.Now;
```

### Timer 回调中重新计算

每次执行后重新计算下次执行时间，支持动态调整：

```csharp
_timer.Elapsed += async (sender, e) =>
{
    // 执行工作流
    await host.StartWorkflow("FileCleanupWorkflow", data);

    // 重新计算下次执行时间
    var nextTime = ScheduledTaskHelper.CalculateNextExecutionTime("FileCleanup");
    _timer.Interval = (nextTime - DateTime.Now).TotalMilliseconds;
};
```

## 配置文件位置

- **默认路径**: 服务器应用程序根目录下的 `ScheduledTasks.json`
- **自动创建**: 首次运行时自动创建默认配置文件
- **热更新**: 修改配置文件后需要重启服务器应用程序

## 注意事项

1. **时间格式**: `executionTime` 必须使用 `HH:mm:ss` 格式（24小时制）
2. **范围限制**: 小时范围 0-23，分钟范围 0-59，秒数范围 0-59
3. **重启生效**: 修改配置文件后需要重启服务器应用程序
4. **任务唯一性**: 每个 `id` 必须唯一，不要重复使用
5. **启用检查**: 系统启动时会检查任务的 `enabled` 状态

## 故障排除

### 问题1：配置文件未生效

**解决方案**：
- 检查 JSON 格式是否正确
- 确认已保存文件
- 重启服务器应用程序

### 问题2：任务未按预期执行

**解决方案**：
- 检查任务的 `enabled` 字段是否为 `true`
- 确认 `executionTime` 格式正确
- 查看服务器日志获取详细错误信息

### 问题3：配置文件丢失

**解决方案**：
- 删除应用程序会自动创建默认配置文件
- 或从备份恢复 `ScheduledTasks.json`

## 扩展指南

### 添加新的定时任务

1. 在工作流配置类中添加任务逻辑
2. 在 `ScheduledTaskConfiguration.CreateDefault()` 中添加任务定义
3. 在 `ScheduledTaskHelper` 中添加任务ID常量
4. 在 `appsettings.json` 或使用文档中更新任务列表

### 自定义间隔类型

当前支持两种间隔类型：
- `Daily` (0): 每日固定时间执行
- `Recurring` (1): 按固定间隔循环执行

可根据需要扩展 `IntervalType` 枚举。

## 示例配置

### 场景1：将所有凌晨任务改为4点

```json
{
  "tasks": [
    {
      "id": "InventorySnapshot",
      "name": "库存快照",
      "description": "每日生成库存快照并清理过期快照",
      "executionTime": "04:00:00",
      "intervalType": 0,
      "enabled": true,
      "workflowId": "InventorySnapshotWorkflow"
    },
    {
      "id": "FileCleanup",
      "name": "文件清理",
      "description": "清理过期文件、孤立文件和物理孤立文件",
      "executionTime": "04:00:00",
      "intervalType": 0,
      "enabled": true,
      "workflowId": "FileCleanupWorkflow"
    },
    {
      "id": "TempImageCleanup",
      "name": "临时图片清理",
      "description": "清理上传目录中的临时图片",
      "executionTime": "04:00:00",
      "intervalType": 0,
      "enabled": true,
      "workflowId": "TempImageCleanupWorkflow"
    }
  ]
}
```

### 场景2：调试模式 - 每5分钟执行

```json
{
  "id": "InventorySnapshot",
  "name": "库存快照",
  "description": "每日生成库存快照并清理过期快照",
  "executionTime": "00:05:00",
  "intervalType": 1,
  "enabled": true,
  "workflowId": "InventorySnapshotWorkflow"
}
```

## 总结

本定时任务配置管理系统提供了：
- ✅ 集中配置管理
- ✅ JSON 格式易于编辑
- ✅ 支持动态启用/禁用任务
- ✅ 支持时间调整
- ✅ 单例模式确保配置一致性
- ✅ 编程接口便于扩展

通过统一管理所有定时任务的执行时间，系统维护变得更加简单和高效。
