# RUINORERP总服务器系统设计文档

## 项目概述

基于现有RUINORERP.Server架构，设计一个总服务器系统（RUINORERP.MasterServer），用于统一管理多个ERP服务器的注册、配置分发和生命周期控制。

## 项目命名

**项目名称**: RUINORERP.MasterServer  
**命名空间**: RUINORERP.MasterServer  
**程序集名称**: RUINORERP.MasterServer

## 技术栈

与现有RUINORERP.Server保持一致：
- **框架**: .NET Framework 4.8
- **ORM**: SqlSugar
- **依赖注入**: Autofac
- **缓存**: CacheManager.Core + StackExchange.Redis
- **工作流**: WorkflowCore
- **通信**: SuperSocket (与现有ERP服务器保持一致)
- **日志**: log4net
- **配置**: Microsoft.Extensions.Configuration

## 系统架构

### 总体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    RUINORERP.MasterServer                  │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              总服务器核心服务层                        │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌──────────────┐  │    │
│  │  │ 注册服务     │ │ 配置服务     │ │ 授权服务      │  │    │
│  │  │ Registration │ │ Configuration│ │ Authorization│  │    │
│  │  │   Service    │ │   Service    │ │   Service    │  │    │
│  │  └─────────────┘ └─────────────┘ └──────────────┘  │    │
│  └─────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              通信管理层                               │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌──────────────┐  │    │
│  │  │ 连接管理     │ │ 心跳检测     │ │ 消息路由      │  │    │
│  │  │ Connection  │ │ Heartbeat    │ │ Message      │  │    │
│  │  │  Manager    │ │  Monitor     │ │  Router      │  │    │
│  │  └─────────────┘ └─────────────┘ └──────────────┘  │    │
│  └─────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              数据存储层                               │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌──────────────┐  │    │
│  │  │ 服务器信息   │ │ 配置数据     │ │ 授权记录      │  │    │
│  │  │ Server Info │ │ Config Data │ │ Auth Records │  │    │
│  │  │   MySQL     │ │   MySQL     │ │   MySQL      │  │    │
│  │  └─────────────┘ └─────────────┘ └──────────────┘  │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 网络通信 (SuperSocket)
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
┌───────▼───────┐   ┌────────▼────────┐   ┌──────▼──────┐
│ RUINORERP.Server  │   │ RUINORERP.Server  │   │ RUINORERP.Server  │
│   (生产环境)     │   │   (测试环境)     │   │   (开发环境)     │
└───────────────┘   └─────────────────┘   └─────────────┘
```

### 核心功能模块

#### 1. 服务器注册管理 (Registration Service)
- **服务器注册**: ERP服务器启动时向总服务器注册
- **服务器信息维护**: 维护服务器基本信息、状态、版本等
- **服务器集群管理**: 支持多服务器实例的集群管理
- **服务器状态监控**: 实时监控服务器在线状态

#### 2. 配置分发服务 (Configuration Service)
- **配置模板管理**: 管理不同类型服务器的配置模板
- **配置版本控制**: 支持配置版本管理和回滚
- **动态配置更新**: 支持运行时配置动态推送
- **配置差异对比**: 支持配置差异检测和同步

#### 3. 授权控制服务 (Authorization Service)
- **授权策略管理**: 基于时间、功能、并发数等维度的授权
- **授权状态监控**: 实时监控授权使用情况和剩余时间
- **授权到期提醒**: 提前通知授权即将到期
- **授权续期管理**: 支持授权续期和升级

#### 4. 通信管理层 (Communication Layer)
- **连接池管理**: 维护与各个ERP服务器的连接池
- **心跳检测**: 定期检测ERP服务器存活状态
- **消息队列**: 支持异步消息通信
- **断线重连**: 自动处理网络断线重连

## 数据库设计

### 核心数据表

```sql
-- 服务器信息表
CREATE TABLE tb_master_server_info (
    server_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    server_code VARCHAR(50) NOT NULL UNIQUE COMMENT '服务器编码',
    server_name VARCHAR(100) NOT NULL COMMENT '服务器名称',
    server_type ENUM('PRODUCTION', 'TEST', 'DEVELOPMENT') NOT NULL,
    ip_address VARCHAR(45) NOT NULL COMMENT 'IP地址',
    port INT NOT NULL COMMENT '端口',
    version VARCHAR(20) NOT NULL COMMENT '版本号',
    status ENUM('ONLINE', 'OFFLINE', 'MAINTENANCE', 'EXPIRED') NOT NULL DEFAULT 'OFFLINE',
    last_heartbeat DATETIME COMMENT '最后心跳时间',
    registration_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    max_connections INT DEFAULT 100 COMMENT '最大连接数',
    current_connections INT DEFAULT 0 COMMENT '当前连接数',
    description TEXT,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_server_code (server_code),
    INDEX idx_status (status),
    INDEX idx_last_heartbeat (last_heartbeat)
);

-- 授权信息表
CREATE TABLE tb_master_authorization (
    auth_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    server_id BIGINT NOT NULL,
    license_key VARCHAR(100) NOT NULL UNIQUE,
    auth_type ENUM('TRIAL', 'OFFICIAL', 'INTERNAL') NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    max_users INT NOT NULL DEFAULT 10,
    max_companies INT NOT NULL DEFAULT 1,
    features JSON COMMENT '授权功能列表',
    status ENUM('ACTIVE', 'EXPIRED', 'SUSPENDED', 'REVOKED') NOT NULL DEFAULT 'ACTIVE',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (server_id) REFERENCES tb_master_server_info(server_id),
    INDEX idx_server_id (server_id),
    INDEX idx_license_key (license_key),
    INDEX idx_status (status),
    INDEX idx_end_date (end_date)
);

-- 配置模板表
CREATE TABLE tb_master_config_template (
    template_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    template_name VARCHAR(100) NOT NULL,
    template_type ENUM('SERVER', 'DATABASE', 'CACHE', 'NETWORK') NOT NULL,
    config_data JSON NOT NULL COMMENT '配置数据',
    version VARCHAR(20) NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    description TEXT,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_template_type (template_type),
    INDEX idx_version (version),
    INDEX idx_active (is_active)
);

-- 服务器配置关联表
CREATE TABLE tb_master_server_config (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    server_id BIGINT NOT NULL,
    template_id BIGINT NOT NULL,
    config_data JSON COMMENT '实际配置数据',
    applied_at DATETIME COMMENT '应用时间',
    applied_by VARCHAR(50) COMMENT '应用人',
    status ENUM('PENDING', 'APPLIED', 'FAILED', 'ROLLED_BACK') NOT NULL DEFAULT 'PENDING',
    error_message TEXT,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (server_id) REFERENCES tb_master_server_info(server_id),
    FOREIGN KEY (template_id) REFERENCES tb_master_config_template(template_id),
    INDEX idx_server_id (server_id),
    INDEX idx_template_id (template_id),
    INDEX idx_status (status)
);

-- 心跳日志表
CREATE TABLE tb_master_heartbeat_log (
    log_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    server_id BIGINT NOT NULL,
    status ENUM('ONLINE', 'OFFLINE') NOT NULL,
    response_time INT COMMENT '响应时间(ms)',
    error_message TEXT,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (server_id) REFERENCES tb_master_server_info(server_id),
    INDEX idx_server_id (server_id),
    INDEX idx_created_at (created_at)
);
```

## 通信协议设计

### 消息格式

采用与现有系统一致的SuperSocket通信协议：

```csharp
/// <summary>
/// 总服务器消息包结构
/// </summary>
public class MasterServerPackage
{
    /// <summary>
    /// 消息ID
    /// </summary>
    public string MessageId { get; set; }
    
    /// <summary>
    /// 消息类型
    /// </summary>
    public string MessageType { get; set; }
    
    /// <summary>
    /// 服务器编码
    /// </summary>
    public string ServerCode { get; set; }
    
    /// <summary>
    /// 时间戳
    /// </summary>
    public DateTime Timestamp { get; set; }
    
    /// <summary>
    /// 消息体
    /// </summary>
    public JObject Payload { get; set; }
    
    /// <summary>
    /// 签名信息
    /// </summary>
    public string Signature { get; set; }
}
```

### 核心命令定义

```csharp
/// <summary>
/// 服务器注册命令
/// </summary>
public class ServerRegisterCommand : ICommand
{
    public string ServerCode { get; set; }
    public string ServerName { get; set; }
    public string ServerType { get; set; }
    public string IpAddress { get; set; }
    public int Port { get; set; }
    public string Version { get; set; }
    public int MaxConnections { get; set; }
}

/// <summary>
/// 心跳命令
/// </summary>
public class HeartbeatCommand : ICommand
{
    public string ServerCode { get; set; }
    public int CurrentConnections { get; set; }
    public Dictionary<string, object> Status { get; set; }
}

/// <summary>
/// 配置更新命令
/// </summary>
public class ConfigUpdateCommand : ICommand
{
    public string ServerCode { get; set; }
    public string ConfigType { get; set; }
    public JObject ConfigData { get; set; }
    public string Version { get; set; }
}

/// <summary>
/// 授权验证命令
/// </summary>
public class AuthorizationCheckCommand : ICommand
{
    public string ServerCode { get; set; }
    public string LicenseKey { get; set; }
}
```

## 实现思路

### 阶段一：基础框架搭建

1. **创建项目结构**
   ```
   RUINORERP.MasterServer/
   ├── Program.cs                    // 程序入口
   ├── Startup.cs                    // 依赖注入配置
   ├── appsettings.json              // 配置文件
   ├── Models/                       // 数据模型
   │   ├── ServerInfo.cs
   │   ├── Authorization.cs
   │   └── ConfigTemplate.cs
   ├── Services/                     // 核心业务服务
   │   ├── IRegistrationService.cs
   │   ├── IConfigurationService.cs
   │   ├── IAuthorizationService.cs
   │   └── impl/
   ├── Network/                      // 网络通信层
   │   ├── Core/
   │   ├── Commands/
   │   └── Services/
   ├── Repository/                   // 数据访问层
   │   ├── IServerRepository.cs
   │   └── impl/
   └── Utils/                        // 工具类
   ```

2. **数据库初始化**
   - 创建数据库表结构
   - 初始化默认配置模板
   - 创建管理员账户

### 阶段二：核心服务实现

1. **注册服务实现**
   ```csharp
   public class RegistrationService : IRegistrationService
   {
       private readonly IServerRepository _serverRepository;
       private readonly ILogger<RegistrationService> _logger;
       private readonly IConnectionManager _connectionManager;
       
       public async Task<RegistrationResult> RegisterServerAsync(ServerRegisterCommand command)
       {
           // 1. 验证服务器信息
           // 2. 生成服务器编码（如果不存在）
           // 3. 检查授权状态
           // 4. 保存服务器信息
           // 5. 建立连接
           // 6. 返回注册结果
       }
   }
   ```

2. **心跳监控实现**
   ```csharp
   public class HeartbeatMonitor : BackgroundService
   {
       private readonly IConnectionManager _connectionManager;
       private readonly IServerRepository _serverRepository;
       private readonly ILogger<HeartbeatMonitor> _logger;
       
       protected override async Task ExecuteAsync(CancellationToken stoppingToken)
       {
           while (!stoppingToken.IsCancellationRequested)
           {
               await CheckHeartbeatAsync();
               await Task.Delay(TimeSpan.FromMinutes(1), stoppingToken);
           }
       }
   }
   ```

### 阶段三：配置管理实现

1. **配置模板管理**
   ```csharp
   public class ConfigurationService : IConfigurationService
   {
       public async Task<ConfigTemplate> GetTemplateAsync(string templateType)
       {
           // 获取配置模板
       }
       
       public async Task<bool> UpdateServerConfigAsync(string serverCode, JObject configData)
       {
           // 1. 验证配置数据
           // 2. 保存配置版本
           // 3. 推送配置到服务器
           // 4. 等待确认
           // 5. 更新应用状态
       }
   }
   ```

### 阶段四：授权控制实现

1. **授权验证服务**
   ```csharp
   public class AuthorizationService : IAuthorizationService
   {
       public async Task<AuthorizationResult> ValidateAuthorizationAsync(string serverCode, string licenseKey)
       {
           // 1. 验证授权密钥
           // 2. 检查授权期限
           // 3. 检查功能权限
           // 4. 返回验证结果
       }
       
       public async Task<bool> IsExpiredAsync(string serverCode)
       {
           // 检查授权是否过期
       }
   }
   ```

### 阶段五：集成与测试

1. **ERP服务器端改造**
   - 添加总服务器连接模块
   - 实现注册逻辑
   - 添加配置接收和应用
   - 实现心跳上报

2. **断线容错机制**
   ```csharp
   public class ConnectionManager : IConnectionManager
   {
       private readonly Dictionary<string, ServerConnection> _connections;
       private readonly ILogger<ConnectionManager> _logger;
       
       public async Task<bool> TryConnectAsync(string serverCode)
       {
           // 1. 尝试建立连接
           // 2. 如果失败，进入重试队列
           // 3. 定期重试连接
           // 4. 连接成功后同步状态
       }
       
       public async Task<bool> IsServerAvailableAsync(string serverCode)
       {
           // 检查服务器是否可用（即使与总服务器断线）
           // 基于本地缓存的授权信息
       }
   }
   ```

## 断线容错设计

### 本地缓存机制

ERP服务器端实现本地授权缓存：

```csharp
public class LocalAuthorizationCache
{
    private readonly ICacheManager<object> _cache;
    private readonly ILogger<LocalAuthorizationCache> _logger;
    
    public AuthorizationInfo GetCachedAuthorization()
    {
        // 从本地缓存获取授权信息
        return _cache.Get<AuthorizationInfo>("local_authorization");
    }
    
    public void UpdateAuthorizationCache(AuthorizationInfo authInfo)
    {
        // 更新本地缓存（当与总服务器通信正常时）
        _cache.AddOrUpdate("local_authorization", authInfo, 
            item => TimeSpan.FromHours(24));
    }
}
```

### 优雅降级策略

1. **网络断线时**: 使用本地缓存的授权信息继续运行
2. **授权到期时**: 提前30天提醒，到期后进入受限模式
3. **服务器重启时**: 自动尝试重新注册和同步配置
4. **配置更新失败**: 使用上一次成功的配置继续运行

## 部署方案

### 总服务器部署

1. **环境要求**
   - Windows Server 2016+
   - .NET Framework 4.8
   - MySQL 8.0+
   - Redis 6.0+

2. **部署步骤**
   ```bash
   # 1. 创建数据库
   mysql -u root -p < master_server_schema.sql
   
   # 2. 安装服务
   RUINORERP.MasterServer.exe --install
   
   # 3. 启动服务
   net start RUINORERP.MasterServer
   ```

### ERP服务器配置更新

在现有`appsettings.json`中添加总服务器配置：

```json
{
  "MasterServer": {
    "Enabled": true,
    "ServerAddress": "master.ruinor.com",
    "ServerPort": 8888,
    "RegistrationInterval": 300,
    "HeartbeatInterval": 60,
    "ConnectionTimeout": 30,
    "RetryCount": 3,
    "CacheAuthorization": true,
    "GracePeriodDays": 30
  }
}
```

## 监控与运维

### 监控指标

1. **服务器健康度**
   - 在线服务器数量
   - 心跳响应时间
   - 配置同步成功率

2. **授权使用情况**
   - 授权到期预警
   - 功能使用统计
   - 并发用户数

3. **系统性能**
   - 消息处理延迟
   - 数据库连接池状态
   - 内存和CPU使用率

### 运维工具

提供管理界面支持：
- 服务器状态监控
- 授权信息管理
- 配置模板编辑
- 实时日志查看

## 安全考虑

1. **通信安全**
   - 使用TLS加密通信
   - 消息签名验证
   - 防重放攻击

2. **数据安全**
   - 敏感数据加密存储
   - 数据库访问权限控制
   - 定期备份策略

3. **访问控制**
   - 基于角色的权限管理
   - 操作审计日志
   - IP白名单机制

## 后续扩展

1. **集群支持**: 总服务器集群部署，支持高可用
2. **API网关**: 提供RESTful API供第三方系统集成
3. **数据分析**: 服务器使用数据分析和报表
4. **自动化运维**: 基于规则的自动化配置和故障处理

## 实施计划

### 第一阶段（2周）
- [ ] 创建项目框架和基础结构
- [ ] 实现数据库设计和初始化
- [ ] 完成基本的注册和心跳功能

### 第二阶段（2周）
- [ ] 实现配置管理服务
- [ ] 完成授权控制服务
- [ ] 实现通信管理层

### 第三阶段（1周）
- [ ] ERP服务器端集成改造
- [ ] 断线容错机制实现
- [ ] 基础监控功能

### 第四阶段（1周）
- [ ] 完整测试和bug修复
- [ ] 文档完善
- [ ] 生产环境部署

总计预计开发周期：6周