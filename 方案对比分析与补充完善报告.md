# æ–¹æ¡ˆå¯¹æ¯”åˆ†æä¸è¡¥å……å®Œå–„æŠ¥å‘Š

## ä¸€ã€å½“å‰ä»£ç å®é™…æƒ…å†µåˆ†æ

### 1.1 ç°æœ‰çŠ¶æ€å˜é‡è¯¦ç»†ç»Ÿè®¡

ç»è¿‡å…¨é¢é˜…è¯»ä»£ç ï¼Œå½“å‰ç³»ç»Ÿçš„çŠ¶æ€å˜é‡åˆ†å¸ƒå¦‚ä¸‹ï¼š

#### ClientCommunicationService (14ä¸ªçŠ¶æ€å˜é‡)
```csharp
// å¿ƒè·³ç›¸å…³ (10ä¸ª)
private int _heartbeatIntervalMs = 30000;
private int _baseHeartbeatIntervalMs = 30000;
private int _minHeartbeatIntervalMs = 10000;
private int _maxHeartbeatIntervalMs = 120000;
private int _networkQualityThresholdGood = 100;
private int _networkQualityThresholdPoor = 500;
private int _heartbeatTimeoutMs = 60000;
private int _heartbeatFailedAttempts = 0;
private bool _isHeartbeatRunning;
private DateTime _lastHeartbeatTime;

// ç½‘ç»œè´¨é‡ç›¸å…³ (2ä¸ª)
private readonly Queue<double> _latencyHistory = new Queue<double>();
private readonly int _maxLatencyHistory = 10;

// ç»Ÿè®¡ç›¸å…³ (3ä¸ª)
private int _totalHeartbeatAttempts = 0;
private int _totalHeartbeatSuccess = 0;
private int _totalHeartbeatFailures = 0;

// è¿½è¸ªå™¨ (1ä¸ª)
private HeartbeatFailureTracker _heartbeatFailureTracker;

// é˜Ÿåˆ—å¤„ç† (2ä¸ª)
private bool _isProcessingQueue = false;
private bool _isReconnecting = false; // ä¸ ConnectionManager é‡å¤

// èµ„æºç®¡ç† (2ä¸ª)
private bool _isDisposed = false;
private bool _disposed = false; // é‡å¤å®šä¹‰ï¼
```

#### ConnectionManager (4ä¸ªçŠ¶æ€å˜é‡)
```csharp
private bool _isReconnecting = false;
private bool _disposed = false;
private bool _reconnectStopped = false;
private bool _isNetworkAvailable = true;
```

#### UserLoginService (2ä¸ªçŠ¶æ€å˜é‡)
```csharp
private bool _isLoggedIn = false;
private bool _isDisposed = false;
```

#### ClientEventManager (1ä¸ªçŠ¶æ€å˜é‡)
```csharp
private readonly Dictionary<CommandId, Action<PacketModel, object>> _specificCommandHandlers;
```

### 1.2 ç°æœ‰äº‹ä»¶è¯¦ç»†ç»Ÿè®¡

#### ClientCommunicationService (7ä¸ªäº‹ä»¶)
```csharp
public event Action<int> HeartbeatFailed;
public event Action HeartbeatRecovered;
public event Action HeartbeatFailureThresholdReached;
public event Action SessionExpired;
public event Action<PacketModel, object> CommandReceived;
public event Action ReconnectFailed;
public event Action<bool> ConnectionStateChanged;
```

#### ConnectionManager (4ä¸ªäº‹ä»¶)
```csharp
public event Action<bool> ConnectionStateChanged;
public event Action ReconnectFailed;
public event Action<int, int> ReconnectAttempt;
public event Action ReconnectSucceeded;
```

#### ClientEventManager (8ä¸ªäº‹ä»¶)
```csharp
public event Action<PacketModel, object> CommandReceived;
public event Action<bool> ConnectionStatusChanged;
public event Action<Exception> ErrorOccurred;
public event Action ConnectionClosed;
public event Action ReconnectFailed;
public event Action<string, TimeSpan> RequestCompleted;
public event Action<bool, string> WelcomeCompleted;
public event Action<PacketModel, object> ServerPushCommandReceived;
```

### 1.3 ç°æœ‰æ ¸å¿ƒé€»è¾‘åˆ†æ

#### å¿ƒè·³é€»è¾‘ (å½“å‰å®ç°)
```csharp
// è¡Œ278: å¿ƒè·³å¤±è´¥é˜ˆå€¼ = 3æ¬¡
public const int HEARTBEAT_FAILURE_THRESHOLD = 3;

// åŠ¨æ€è°ƒæ•´é—´éš” (è¡Œ364-391)
private void AdjustHeartbeatInterval()
{
    var avgLatency = GetAverageLatency();
    // æ ¹æ®å¹³å‡å»¶è¿Ÿè°ƒæ•´é—´éš”
    // ç½‘ç»œè‰¯å¥½: 15ç§’
    // ç½‘ç»œä¸€èˆ¬: 30ç§’
    // ç½‘ç»œè¾ƒå·®: 60ç§’
}

// æ™ºèƒ½å¤±è´¥è¿½è¸ªå™¨ (è¡Œ68-145)
internal class HeartbeatFailureTracker
{
    // 2åˆ†é’Ÿå†…3æ¬¡åŒç±»å‹å¤±è´¥ â†’ è§¦å‘é”å®š
    // æˆ–æ€»å¤±è´¥5æ¬¡ â†’ è§¦å‘é”å®š
}
```

#### é‡è¿é€»è¾‘ (å½“å‰å®ç°)
```csharp
// ConnectionManager è¡Œ446-449
private bool ShouldStopReconnecting(int attempts)
{
    // æœ‰æœ€å¤§é‡è¿æ¬¡æ•°é™åˆ¶
    return _config.MaxReconnectAttempts > 0 && attempts >= _config.MaxReconnectAttempts;
}

// è¡Œ454-464: åœæ­¢é‡è¿
private void StopReconnecting()
{
    _isReconnecting = false;
    _reconnectStopped = true; // è®¾ç½®åœæ­¢æ ‡å¿—
    OnReconnectFailed();
}
```

### 1.4 å·²å­˜åœ¨ä½†éœ€è¦ä¿ç•™çš„åŠŸèƒ½

#### âœ… æ¬¢è¿æ¶ˆæ¯åŠŸèƒ½
åœ¨ `ClientEventManager` ä¸­å®šä¹‰ï¼š
```csharp
public event Action<bool, string> WelcomeCompleted;
```

#### âœ… é”å®šåçš„UIå¤„ç†
åœ¨ `ClientCommunicationService.cs` è¡Œ689-711ï¼š
```csharp
// å¦‚æœä¹‹å‰æ˜¯é”å®šçŠ¶æ€ï¼Œç°åœ¨åº”è¯¥è§£é™¤é”å®š
if (MainForm.Instance.IsLocked)
{
    MainForm.Instance.UpdateLockStatus(false);
    MainForm.Instance.PrintInfoLog("é‡è¿æˆåŠŸï¼Œå·²è§£é™¤å®¢æˆ·ç«¯é”å®š");
}
```

#### âœ… é‡è¿æˆåŠŸåçš„å¤„ç†
åœ¨ `ClientCommunicationService.cs` è¡Œ654-730ï¼š
```csharp
private void OnReconnectSucceeded()
{
    // é‡ç½®å¿ƒè·³å¤±è´¥æ¬¡æ•°å’Œå¤±è´¥è¿½è¸ªå™¨
    Interlocked.Exchange(ref _heartbeatFailedAttempts, 0);
    _heartbeatFailureTracker?.Reset();

    // é‡ç½®å¿ƒè·³é—´éš”ä¸ºåŸºç¡€å€¼
    _heartbeatIntervalMs = _baseHeartbeatIntervalMs;

    // é‡æ–°å¯åŠ¨å¿ƒè·³
    StartHeartbeat();
}
```

## äºŒã€é‡æ„æ–¹æ¡ˆä¸å½“å‰ä»£ç å¯¹æ¯”

### 2.1 æ–¹æ¡ˆå‡è®¾ä¸å®é™…æƒ…å†µçš„å·®å¼‚

| é¡¹ç›® | æ–¹æ¡ˆå‡è®¾ | å®é™…æƒ…å†µ | å·®å¼‚è¯´æ˜ |
|------|---------|---------|---------|
| å¿ƒè·³å¤±è´¥é˜ˆå€¼ | 5æ¬¡ | 3æ¬¡ | å½“å‰æ˜¯3æ¬¡ï¼Œæ–¹æ¡ˆå»ºè®®5æ¬¡ |
| æœ€å¤§é‡è¿æ¬¡æ•° | æ— é™åˆ¶ | æœ‰é™åˆ¶ | å½“å‰æœ‰ `MaxReconnectAttempts` é…ç½® |
| æ™ºèƒ½å¤±è´¥è¿½è¸ªå™¨ | ç§»é™¤ | å­˜åœ¨ | å½“å‰æœ‰ `HeartbeatFailureTracker` |
| åŠ¨æ€å¿ƒè·³é—´éš” | ç§»é™¤ | å­˜åœ¨ | å½“å‰æœ‰ `AdjustHeartbeatInterval()` |
| ç½‘ç»œè´¨é‡è¯„ä¼° | ç§»é™¤ | å­˜åœ¨ | å½“å‰æœ‰ `RecordLatency()` å’Œå»¶è¿Ÿå†å² |

### 2.2 éœ€è¦è¡¥å……çš„å†…å®¹

#### 2.2.1 ç¼ºå¤±ï¼šç™»å½•çª—ä½“æ¨¡æ€æ˜¾ç¤ºçš„å®ç°

**é—®é¢˜**: æ–¹æ¡ˆæåˆ°"æ˜¾ç¤ºç™»å½•çª—ä½“ï¼ˆæ¨¡æ€å¯¹è¯æ¡†ï¼‰"ï¼Œ ä½¿ç”¨loginForm.ShowDialog(this)

**å»ºè®®è¡¥å……**:
```csharp
// åœ¨ UserLoginService ä¸­æ·»åŠ 
/// <summary>
/// æ˜¾ç¤ºç™»å½•çª—ä½“ï¼ˆæ¨¡æ€å¯¹è¯æ¡†ï¼‰
/// </summary>
private void ShowLoginFormModal()
{
    try
    {
        // ç¡®ä¿åœ¨UIçº¿ç¨‹ä¸­æ‰§è¡Œ
        if (MainForm.Instance.InvokeRequired)
        {
            MainForm.Instance.Invoke(new Action(() =>
            {
                ShowLoginFormModal();
            }));
            return;
        }

        // åˆ›å»ºå¹¶æ˜¾ç¤ºç™»å½•çª—ä½“ï¼ˆæ¨¡æ€ï¼‰
        var loginForm = new FrmLogin();
        var dialogResult = loginForm.ShowDialog();

        // ç”¨æˆ·å…³é—­ç™»å½•çª—ä½“åï¼Œæ£€æŸ¥æ˜¯å¦ç™»å½•æˆåŠŸ
        if (dialogResult == DialogResult.OK && _isLoggedIn)
        {
            // ç™»å½•æˆåŠŸï¼Œé‡ç½®å¿ƒè·³å¤±è´¥è®¡æ•°
            if (_communicationService is ClientCommunicationService commService)
            {
                commService.ResetHeartbeatFailureCount();
            }
            _logger?.LogInformation("ç”¨æˆ·é‡æ–°ç™»å½•æˆåŠŸï¼Œè§£é™¤é”å®š");
        }
    }
    catch (Exception ex)
    {
        _logger?.LogError(ex, "æ˜¾ç¤ºç™»å½•çª—ä½“æ—¶å‘ç”Ÿå¼‚å¸¸");
    }
}
```

#### 2.2.2 ç¼ºå¤±ï¼šæœåŠ¡å™¨åˆ‡æ¢æ—¶è¿æ¥é‡ç½®

**é—®é¢˜**: æ–¹æ¡ˆæåˆ°"æœåŠ¡å™¨åˆ‡æ¢"åŠŸèƒ½ï¼Œéœ€è¦ç¡®ä¿æœåŠ¡å™¨åˆ‡æ¢æ—¶æ­£ç¡®é‡ç½®è¿æ¥çŠ¶æ€ã€‚

**å»ºè®®è¡¥å……**:
```csharp
// åœ¨ UserLoginService ä¸­æ·»åŠ 
/// <summary>
/// åˆ‡æ¢æœåŠ¡å™¨ï¼ˆç”¨æˆ·ä¿®æ”¹IPæˆ–ç«¯å£åè°ƒç”¨ï¼‰
/// </summary>
/// <param name="newServerAddress">æ–°çš„æœåŠ¡å™¨åœ°å€</param>
/// <param name="newServerPort">æ–°çš„æœåŠ¡å™¨ç«¯å£</param>
/// <returns>æ“ä½œæ˜¯å¦æˆåŠŸ</returns>
public async Task<bool> SwitchServerAsync(string newServerAddress, int newServerPort)
{
    try
    {
        _logger?.LogInformation("ç”¨æˆ·è¯·æ±‚åˆ‡æ¢æœåŠ¡å™¨: {Address}:{Port}", newServerAddress, newServerPort);

        // å…ˆæ–­å¼€å½“å‰è¿æ¥ï¼ˆå¦‚æœå·²è¿æ¥ï¼‰
        if (_communicationService.ConnectionManager.IsConnected)
        {
            await _communicationService.Disconnect();
        }

        // åœæ­¢å¿ƒè·³
        if (_communicationService is ClientCommunicationService commService)
        {
            commService.StopHeartbeat();
            commService.ResetHeartbeatFailureCount();
        }

        // è¿æ¥åˆ°æ–°æœåŠ¡å™¨
        bool connected = await _communicationService.ConnectAsync(newServerAddress, newServerPort);

        if (connected)
        {
            _logger?.LogInformation("å·²æˆåŠŸè¿æ¥åˆ°æ–°æœåŠ¡å™¨: {Address}:{Port}", newServerAddress, newServerPort);
            // è¿æ¥æˆåŠŸåå¯ä»¥åŠ è½½æ¬¢è¿æ¶ˆæ¯
        }
        else
        {
            _logger?.LogError("è¿æ¥åˆ°æ–°æœåŠ¡å™¨å¤±è´¥: {Address}:{Port}", newServerAddress, newServerPort);
        }

        return connected;
    }
    catch (Exception ex)
    {
        _logger?.LogError(ex, "åˆ‡æ¢æœåŠ¡å™¨æ—¶å‘ç”Ÿå¼‚å¸¸");
        return false;
    }
}
```

#### 2.2.3 ç¼ºå¤±ï¼šé‡ç½®å¿ƒè·³å¤±è´¥è®¡æ•°çš„å…¬å…±æ–¹æ³•

**é—®é¢˜**: æ–¹æ¡ˆæåˆ°"ç”¨æˆ·ç‚¹å‡»ç™»å½•åé‡ç½®å¿ƒè·³å¤±è´¥è®¡æ•°"ï¼Œä½†æ²¡æœ‰æä¾›å…¬å…±æ–¹æ³•ã€‚

**å»ºè®®è¡¥å……**:
```csharp
// åœ¨ ClientCommunicationService ä¸­æ·»åŠ 
/// <summary>
/// é‡ç½®å¿ƒè·³å¤±è´¥è®¡æ•°ï¼ˆç”¨äºç”¨æˆ·é‡æ–°ç™»å½•åï¼‰
/// </summary>
public void ResetHeartbeatFailureCount()
{
    Interlocked.Exchange(ref _heartbeatFailedAttempts, 0);
    _heartbeatFailureTracker?.Reset();
    _logger?.LogDebug("å¿ƒè·³å¤±è´¥è®¡æ•°å·²é‡ç½®");
}
```

#### 2.2.4 ç¼ºå¤±ï¼šé…ç½®æ— æœ€å¤§é‡è¿æ¬¡æ•°é™åˆ¶

**é—®é¢˜**: æ–¹æ¡ˆå»ºè®®"æ— æ¬¡æ•°é™åˆ¶"ï¼Œä½†å½“å‰ä»£ç æœ‰ `MaxReconnectAttempts` é…ç½®ã€‚

**å»ºè®®ä¿®æ”¹**:
```csharp
// åœ¨ ConnectionManagerConfig ä¸­
public class ConnectionManagerConfig
{
    // æ”¹ä¸º -1 è¡¨ç¤ºæ— é™åˆ¶
    public int MaxReconnectAttempts { get; set; } = -1;

    // é»˜è®¤å€¼
    public static ConnectionManagerConfig Default => new ConnectionManagerConfig
    {
        AutoReconnect = true,
        MaxReconnectAttempts = -1, // æ— é™åˆ¶
        ReconnectInterval = 3000, // 3ç§’
        ReconnectCheckInterval = 5000 // 5ç§’
    };
}

// ä¿®æ”¹ ShouldStopReconnecting é€»è¾‘
private bool ShouldStopReconnecting(int attempts)
{
    // -1 è¡¨ç¤ºæ— é™åˆ¶ï¼Œæˆ–è€…è¾¾åˆ°æœ€å¤§æ¬¡æ•°
    return _config.MaxReconnectAttempts > 0 && attempts >= _config.MaxReconnectAttempts;
}
```

#### 2.2.5 ç¼ºå¤±ï¼šå¿ƒè·³é˜ˆå€¼ä»3æ”¹ä¸º5

**é—®é¢˜**: æ–¹æ¡ˆå»ºè®®å¿ƒè·³å¤±è´¥é˜ˆå€¼ä¸º5æ¬¡ï¼Œä½†å½“å‰ä»£ç æ˜¯3æ¬¡ã€‚

**å»ºè®®ä¿®æ”¹**:
```csharp
// åœ¨ ClientCommunicationService ä¸­
public const int HEARTBEAT_FAILURE_THRESHOLD = 5; // ä»3æ”¹ä¸º5
```

### 2.3 éœ€è¦ä¼˜åŒ–çš„å†…å®¹

#### 2.3.1 ç§»é™¤é‡å¤çš„ _disposed å®šä¹‰

**é—®é¢˜**: `ClientCommunicationService` ä¸­æœ‰ä¸¤ä¸ª `_disposed` å®šä¹‰ï¼ˆè¡Œ230å’Œè¡Œ249ï¼‰ã€‚

**å»ºè®®ä¿®å¤**:
```csharp
// åˆ é™¤è¡Œ249çš„é‡å¤å®šä¹‰
// private bool _disposed = false; // åˆ é™¤
```

#### 2.3.2 ç§»é™¤ ClientCommunicationService ä¸­çš„ _isReconnecting

**é—®é¢˜**: `ClientCommunicationService` ä¸­çš„ `_isReconnecting` ä¸ `ConnectionManager._isReconnecting` é‡å¤ã€‚

**å»ºè®®ä¿®å¤**:
```csharp
// åˆ é™¤è¡Œ229
// private bool _isReconnecting = false; // åˆ é™¤ï¼Œä½¿ç”¨ ConnectionManager.IsReconnecting

// æ‰€æœ‰ä½¿ç”¨ _isReconnecting çš„åœ°æ–¹æ”¹ä¸º
_connectionManager.IsReconnecting
```

#### 2.3.3 ç§»é™¤ _reconnectStopped æ ‡å¿—

**é—®é¢˜**: æ–¹æ¡ˆå»ºè®®ç§»é™¤ `_reconnectStopped` æ ‡å¿—ï¼Œè®©é‡è¿æŒç»­è¿è¡Œã€‚

**å»ºè®®ä¿®å¤**:
```csharp
// åœ¨ ConnectionManager ä¸­
private bool _reconnectStopped = false; // å¯ä»¥ä¿ç•™ä½†ä¸å†ä½¿ç”¨

// ä¿®æ”¹ ShouldContinueReconnecting
private bool ShouldContinueReconnecting()
{
    // ç§»é™¤ _reconnectStopped çš„æ£€æŸ¥ï¼Œåªæ£€æŸ¥å¿…è¦æ¡ä»¶
    return !_disposed && _isReconnecting && !_cancellationTokenSource.Token.IsCancellationRequested;
}

// ä¿®æ”¹ StopReconnecting
private void StopReconnecting()
{
    lock (_reconnectStateLock)
    {
        _isReconnecting = false;
        // ä¸å†è®¾ç½® _reconnectStopped
        // _reconnectStopped = true;
    }

    _logger?.LogInformation("åœæ­¢é‡è¿æ“ä½œ");
    OnReconnectFailed();
}
```

## ä¸‰ã€æ–¹æ¡ˆå®Œå–„å»ºè®®

### 3.1 ä¿ç•™å½“å‰ä»£ç çš„ä¼˜åŠ¿

#### 3.1.1 æ™ºèƒ½å¤±è´¥è¿½è¸ªå™¨å¯ä»¥ç®€åŒ–ä½†ä¿ç•™æ ¸å¿ƒé€»è¾‘

**å½“å‰å®ç°**:
- 2åˆ†é’Ÿå†…3æ¬¡åŒç±»å‹å¤±è´¥ â†’ è§¦å‘é”å®š
- æ€»å¤±è´¥5æ¬¡ â†’ è§¦å‘é”å®š

**å»ºè®®ä¼˜åŒ–**:
```csharp
/// <summary>
/// ç®€åŒ–çš„å¿ƒè·³å¤±è´¥è¿½è¸ªå™¨
/// </summary>
internal class HeartbeatFailureTracker
{
    private int _totalFailures = 0;
    private readonly ILogger _logger;

    public HeartbeatFailureTracker(ILogger logger = null)
    {
        _logger = logger;
    }

    /// <summary>
    /// è®°å½•å¤±è´¥
    /// </summary>
    public void RecordFailure(HeartbeatFailureType type)
    {
        _totalFailures++;
        _logger?.LogDebug("è®°å½•å¿ƒè·³å¤±è´¥: {Type}, æ€»å¤±è´¥: {Total}", type, _totalFailures);
    }

    /// <summary>
    /// åˆ¤æ–­æ˜¯å¦åº”è¯¥è§¦å‘é”å®š
    /// </summary>
    public bool ShouldTriggerLockout()
    {
        return _totalFailures >= 5;
    }

    /// <summary>
    /// é‡ç½®å¤±è´¥è®°å½•
    /// </summary>
    public void Reset()
    {
        _totalFailures = 0;
    }
}
```

**ä¼˜åŠ¿**:
- ç®€åŒ–é€»è¾‘ï¼Œç§»é™¤æ—¶é—´çª—å£æ£€æŸ¥
- ä¿ç•™æ ¸å¿ƒåŠŸèƒ½ï¼ˆå¤±è´¥è®¡æ•°ï¼‰
- å‡å°‘å†…å­˜å ç”¨ï¼ˆä¸éœ€è¦ä¿å­˜å¤±è´¥å†å²ï¼‰

#### 3.1.2 ä¿ç•™æ¬¢è¿æ¶ˆæ¯åŠŸèƒ½

**å½“å‰å®ç°**: `WelcomeCompleted` äº‹ä»¶å·²å­˜åœ¨

**å»ºè®®**:
- ç¡®ä¿ç™»å½•çª—ä½“åŠ è½½æ—¶å…ˆè¿æ¥æœåŠ¡å™¨å¹¶è·å–æ¬¢è¿æ¶ˆæ¯
- ä¿ç•™ `WelcomeCompleted` äº‹ä»¶ï¼Œä¸åˆ é™¤

#### 3.1.3 ä¿ç•™é‡è¿æˆåŠŸåçš„å¿ƒè·³æ¢å¤

**å½“å‰å®ç°**: `OnReconnectSucceeded()` ä¸­é‡ç½®å¿ƒè·³å¹¶é‡å¯

**å»ºè®®**:
- ä¿ç•™è¿™ä¸ªé€»è¾‘ï¼Œè¿™å¯¹ç”¨æˆ·ä½“éªŒå¾ˆé‡è¦
- åªéœ€ç®€åŒ–å¿ƒè·³å¤±è´¥è®¡æ•°çš„é‡ç½®

### 3.2 éœ€è¦è¡¥å……çš„å®ç°ç»†èŠ‚

#### 3.2.1 å®Œæ•´çš„é”å®šæµç¨‹å®ç°

```csharp
// åœ¨ UserLoginService ä¸­æ·»åŠ 
/// <summary>
/// å¤„ç†å¿ƒè·³å¤±è´¥è¾¾åˆ°é˜ˆå€¼äº‹ä»¶
/// </summary>
private void OnHeartbeatFailureThresholdReached()
{
    _logger?.LogWarning("å¿ƒè·³å¤±è´¥è¾¾åˆ°é˜ˆå€¼ï¼Œæ˜¾ç¤ºç™»å½•çª—ä½“");

    try
    {
        // åœ¨UIçº¿ç¨‹ä¸­æ˜¾ç¤ºç™»å½•çª—ä½“ï¼ˆæ¨¡æ€ï¼‰
        ShowLoginFormModal();
    }
    catch (Exception ex)
    {
        _logger?.LogError(ex, "æ˜¾ç¤ºç™»å½•çª—ä½“æ—¶å‘ç”Ÿå¼‚å¸¸");
    }
}

// åœ¨æ„é€ å‡½æ•°ä¸­è®¢é˜…äº‹ä»¶
public UserLoginService(/* ... */)
{
    // ...
    // è®¢é˜…å¿ƒè·³å¤±è´¥é˜ˆå€¼äº‹ä»¶ï¼ˆå¦‚æœé€šä¿¡æœåŠ¡æ”¯æŒï¼‰
    if (_communicationService is ClientCommunicationService commService)
    {
        commService.HeartbeatFailureThresholdReached += OnHeartbeatFailureThresholdReached;
    }
}
```

#### 3.2.2 ç½‘ç»œçŠ¶æ€å˜åŒ–çš„å¤„ç†

**å½“å‰å®ç°**: `ConnectionManager` ä¸­æœ‰ `_isNetworkAvailable` æ ‡å¿—

**å»ºè®®**: ä¿ç•™ç½‘ç»œçŠ¶æ€æ£€æµ‹ï¼Œä½†ç®€åŒ–é€»è¾‘
```csharp
// åœ¨ ConnectionManager ä¸­
private void OnNetworkAvailabilityChanged(object sender, EventArgs e)
{
    bool isAvailable = System.Net.NetworkInformation.NetworkInterface.GetIsNetworkAvailable();

    if (isAvailable != _isNetworkAvailable)
    {
        _isNetworkAvailable = isAvailable;
        _logger?.LogDebug("ç½‘ç»œçŠ¶æ€å˜åŒ–: {IsAvailable}", isAvailable);

        if (isAvailable && _isReconnecting)
        {
            // ç½‘ç»œæ¢å¤ï¼Œå¯ä»¥å°è¯•ç«‹å³é‡è¿
            _logger?.LogDebug("ç½‘ç»œå·²æ¢å¤ï¼Œå°è¯•ç«‹å³é‡è¿");
            StartAutoReconnect();
        }
    }
}
```

## å››ã€æœ€ç»ˆä¼˜åŒ–æ–¹æ¡ˆå»ºè®®

### 4.1 çŠ¶æ€å˜é‡æœ€ç»ˆæ¸…å•

#### ClientCommunicationService (ä¿ç•™6ä¸ªï¼Œç§»é™¤10ä¸ª)
```csharp
// ä¿ç•™ (6ä¸ª)
private int _heartbeatIntervalMs = 30000;
private int _heartbeatTimeoutMs = 60000;
private int _heartbeatFailedAttempts = 0;
private bool _isHeartbeatRunning;
private DateTime _lastHeartbeatTime;
private HeartbeatFailureTracker _heartbeatFailureTracker; // ç®€åŒ–ç‰ˆ

// ç§»é™¤ (10ä¸ª)
private int _baseHeartbeatIntervalMs;
private int _minHeartbeatIntervalMs;
private int _maxHeartbeatIntervalMs;
private int _networkQualityThresholdGood;
private int _networkQualityThresholdPoor;
private readonly Queue<double> _latencyHistory;
private readonly int _maxLatencyHistory;
private int _totalHeartbeatAttempts;
private int _totalHeartbeatSuccess;
private int _totalHeartbeatFailures;
private bool _isReconnecting; // é‡å¤
private bool _isProcessingQueue;
private bool _disposed; // é‡å¤
```

#### ConnectionManager (ä¿ç•™3ä¸ªï¼Œç§»é™¤1ä¸ª)
```csharp
// ä¿ç•™ (3ä¸ª)
private bool _isReconnecting = false;
private bool _disposed = false;
private bool _isNetworkAvailable = true;

// ç§»é™¤ (1ä¸ª) - æˆ–ä¿ç•™ä½†ä¸ä½¿ç”¨
private bool _reconnectStopped = false; // å»ºè®®ä¿ç•™ä½†ä¸ä½¿ç”¨
```

### 4.2 äº‹ä»¶æœ€ç»ˆæ¸…å•

#### ClientCommunicationService (ä¿ç•™4ä¸ªï¼Œç§»é™¤3ä¸ª)
```csharp
// ä¿ç•™ (4ä¸ª)
public event Action HeartbeatFailureThresholdReached;
public event Action SessionExpired;
public event Action<PacketModel, object> CommandReceived;
public event Action<bool> ConnectionStateChanged;

// ç§»é™¤ (3ä¸ª)
public event Action<int> HeartbeatFailed; // æ—¥å¿—å³å¯
public event Action HeartbeatRecovered; // æ—¥å¿—å³å¯
public event Action ReconnectFailed; // ç”± ConnectionManager æä¾›
```

#### ConnectionManager (ä¿ç•™4ä¸ª)
```csharp
// å…¨éƒ¨ä¿ç•™
public event Action<bool> ConnectionStateChanged;
public event Action ReconnectFailed;
public event Action<int, int> ReconnectAttempt;
public event Action ReconnectSucceeded;
```

#### ClientEventManager (ä¿ç•™6ä¸ªï¼Œåˆå¹¶2ä¸ª)
```csharp
// ä¿ç•™ (6ä¸ª)
public event Action<PacketModel, object> CommandReceived;
public event Action<bool> ConnectionStatusChanged;
public event Action<Exception> ErrorOccurred;
public event Action ConnectionClosed;
public event Action<string, TimeSpan> RequestCompleted;
public event Action<bool, string> WelcomeCompleted;

// åˆå¹¶ (2ä¸ª)
public event Action<PacketModel, object> ServerPushCommandReceived; // åˆå¹¶åˆ° CommandReceived
public event Action ReconnectFailed; // ç”± ConnectionManager æä¾›
```

### 4.3 å¿ƒè·³é˜ˆå€¼è°ƒæ•´

**å»ºè®®**: ä¿æŒå½“å‰3æ¬¡ï¼Œä¸æ”¹ä¸º5æ¬¡

**ç†ç”±**:
- 3æ¬¡å¤±è´¥é”å®šæ›´å¿«ï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½
- 2.5åˆ†é’Ÿï¼ˆ30ç§’Ã—5ï¼‰é”å®šæ—¶é—´è¿‡é•¿
- å¦‚æœç½‘ç»œä¸ç¨³å®šï¼Œ5æ¬¡å¤±è´¥éœ€è¦ç­‰å¾…å¤ªä¹…

**æœ€ç»ˆå†³å®š**: `public const int HEARTBEAT_FAILURE_THRESHOLD = 3;`

### 4.4 é‡è¿æ¬¡æ•°é™åˆ¶

**å»ºè®®**: è®¾ç½®ä¸ºæ— é™åˆ¶ï¼ˆ-1ï¼‰

**ç†ç”±**:
- æœåŠ¡å™¨å¯èƒ½å…³é—­å¾ˆé•¿æ—¶é—´
- ç”¨æˆ·å¸Œæœ›æœåŠ¡å™¨æ¢å¤åè‡ªåŠ¨é‡è¿
- é¿å…ç”¨æˆ·æ‰‹åŠ¨è§¦å‘é‡è¿

**æœ€ç»ˆå†³å®š**: `MaxReconnectAttempts = -1;`

## äº”ã€å®æ–½è®¡åˆ’æ›´æ–°

### é˜¶æ®µ0: è¡¥å……ç¼ºå¤±åŠŸèƒ½ï¼ˆ2å¤©ï¼‰

1. **å®ç°ç™»å½•çª—ä½“æ¨¡æ€æ˜¾ç¤º**
   - æ·»åŠ  `ShowLoginFormModal()` æ–¹æ³•
   - å¤„ç†UIçº¿ç¨‹è°ƒç”¨
   - æµ‹è¯•é”å®šçŠ¶æ€ä¸‹çš„ç™»å½•æµç¨‹

2. **å®ç°æœåŠ¡å™¨åˆ‡æ¢åŠŸèƒ½**
   - æ·»åŠ  `SwitchServerAsync()` æ–¹æ³•
   - æ­£ç¡®é‡ç½®è¿æ¥å’Œå¿ƒè·³
   - æµ‹è¯•æœåŠ¡å™¨åˆ‡æ¢æµç¨‹

3. **æ·»åŠ é‡ç½®å¿ƒè·³å¤±è´¥è®¡æ•°æ–¹æ³•**
   - æ·»åŠ  `ResetHeartbeatFailureCount()` å…¬å…±æ–¹æ³•
   - åœ¨ç™»å½•æˆåŠŸæ—¶è°ƒç”¨
   - æµ‹è¯•è®¡æ•°é‡ç½®

### é˜¶æ®µ1-7: æŒ‰åŸè®¡åˆ’æ‰§è¡Œï¼ˆå‚è€ƒåŸæ–¹æ¡ˆï¼‰

**æ€»è®¡**: çº¦13ä¸ªå·¥ä½œæ—¥ï¼ˆæ¯”åŸè®¡åˆ’å¢åŠ 2å¤©ï¼‰

## å…­ã€é£é™©è¯„ä¼°æ›´æ–°

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| ç¼ºå¤±åŠŸèƒ½å®ç°ä¸å®Œå–„ | é«˜ | ä¸­ | å……åˆ†æµ‹è¯•ç™»å½•çª—ä½“å’ŒæœåŠ¡å™¨åˆ‡æ¢ |
| å¿ƒè·³é˜ˆå€¼3æ¬¡å¤ªæ•æ„Ÿ | ä¸­ | ä½ | å¯é…ç½®ï¼Œåç»­æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ |
| é‡è¿æ— é™åˆ¶å¯¼è‡´èµ„æºæµªè´¹ | ä½ | ä½ | æ·»åŠ é‡è¿é—´éš”é€€é¿æœºåˆ¶ |
| çŠ¶æ€å˜é‡åˆ é™¤å¯¼è‡´å›å½’ | é«˜ | ä¸­ | å•å…ƒæµ‹è¯•ï¼Œé€æ­¥åˆ é™¤ |

## ä¸ƒã€æ€»ç»“

### 7.1 æ–¹æ¡ˆéœ€è¦è¡¥å……çš„å†…å®¹

1. âœ… ç™»å½•çª—ä½“æ¨¡æ€æ˜¾ç¤ºçš„å®ç°
2. âœ… æœåŠ¡å™¨åˆ‡æ¢åŠŸèƒ½çš„å®ç°
3. âœ… é‡ç½®å¿ƒè·³å¤±è´¥è®¡æ•°çš„å…¬å…±æ–¹æ³•
4. âœ… é…ç½®æ— æœ€å¤§é‡è¿æ¬¡æ•°é™åˆ¶
5. âœ… ä¿®å¤é‡å¤çš„çŠ¶æ€å˜é‡å®šä¹‰
6. âœ… ç§»é™¤é‡å¤çš„ `_isReconnecting`

### 7.2 æ–¹æ¡ˆéœ€è¦ä¼˜åŒ–çš„å†…å®¹

1. âœ… ç®€åŒ–æ™ºèƒ½å¤±è´¥è¿½è¸ªå™¨ï¼ˆç§»é™¤æ—¶é—´çª—å£ï¼‰
2. âœ… ä¿ç•™æ¬¢è¿æ¶ˆæ¯åŠŸèƒ½
3. âœ… ä¿ç•™é‡è¿æˆåŠŸåçš„å¿ƒè·³æ¢å¤
4. âœ… ä¿æŒå¿ƒè·³é˜ˆå€¼ä¸º3æ¬¡ï¼ˆä¸æ”¹ä¸º5æ¬¡ï¼‰
5. âœ… è®¾ç½®é‡è¿æ¬¡æ•°ä¸ºæ— é™åˆ¶

### 7.3 æœ€ç»ˆå»ºè®®

**å»ºè®®æ‰§è¡Œä¼˜åŒ–æ–¹æ¡ˆï¼Œä½†éœ€è¦å…ˆè¡¥å……ä¸Šè¿°ç¼ºå¤±åŠŸèƒ½ã€‚**

**ç†ç”±**:
1. æ–¹æ¡ˆçš„æ ¸å¿ƒæ€è·¯æ­£ç¡®ï¼ˆç®€åŒ–çŠ¶æ€ã€ç»Ÿä¸€äº‹ä»¶ï¼‰
2. å½“å‰ä»£ç å­˜åœ¨ä¸€äº›é—®é¢˜éœ€è¦ä¿®å¤ï¼ˆé‡å¤å®šä¹‰ã€å¤æ‚é€»è¾‘ï¼‰
3. ç¼ºå¤±åŠŸèƒ½éœ€è¦è¡¥å……ï¼ˆç™»å½•çª—ä½“ã€æœåŠ¡å™¨åˆ‡æ¢ï¼‰
4. ä¼˜åŒ–åä¼šæ˜¾è‘—é™ä½å¤æ‚åº¦ï¼Œæé«˜å¯ç»´æŠ¤æ€§

**å»ºè®®ä¼˜å…ˆçº§**:
1. ğŸ”´ **é«˜ä¼˜å…ˆçº§**: è¡¥å……ç™»å½•çª—ä½“æ¨¡æ€æ˜¾ç¤ºã€æœåŠ¡å™¨åˆ‡æ¢åŠŸèƒ½
2. ğŸŸ¡ **ä¸­ä¼˜å…ˆçº§**: ä¿®å¤é‡å¤å®šä¹‰ã€ç®€åŒ–çŠ¶æ€å˜é‡
3. ğŸŸ¢ **ä½ä¼˜å…ˆçº§**: ç§»é™¤ä¸å¿…è¦çš„äº‹ä»¶ã€ä¼˜åŒ–ä»£ç ç»“æ„

**æ˜¯å¦æ‰§è¡Œï¼Ÿ**
- å¦‚æœè¡¥å……ç¼ºå¤±åŠŸèƒ½ï¼Œå»ºè®® âœ… æ‰§è¡Œ
- å¦‚æœä¸è¡¥å……ï¼Œå»ºè®® âŒ æš‚ç¼“
