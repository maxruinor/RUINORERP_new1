# 服务器端日志修复总结

## 问题描述

客户端的日志记录正常，但是在服务器端日志没有正确的保存到数据库中。

## 问题分析

1. **日志链路**：
   - 应用程序启动时，在 `Startup.cs` 中配置了 `Log4NetProviderByCustomeDb` 作为日志提供器
   - `Log4NetProviderByCustomeDb` 创建 `Log4NetLoggerByDb` 实例处理日志记录
   - `Log4NetLoggerByDb` 的 `Log` 方法负责将日志写入数据库

2. **关键问题**：
   - 在 `Log4NetLoggerByDb.cs` 的 `Log` 方法中，存在对 `_appcontext.CurUserInfo` 的空值检查
   - 服务器端启动时，`CurUserInfo` 为空，导致日志无法写入数据库
   - 虽然 `InitAppcontextValue` 方法初始化了 `AppContextData`，但没有初始化 `CurUserInfo` 属性

## 修复方案

修改 `RUINORERP.Common.Log4Net\Log4NetLoggerByDb.cs` 中的 `Log` 方法，移除对 `_appcontext.CurUserInfo` 的严格检查，当 `CurUserInfo` 为空时，使用默认值。

## 具体修改内容

1. **文件**：`RUINORERP.Common.Log4Net\Log4NetLoggerByDb.cs`
2. **方法**：`Log<TState>`
3. **修改点**：
   - 移除 `if (_appcontext.CurUserInfo == null)` 检查
   - 当 `CurUserInfo` 为空时，使用默认的用户信息 "系统服务"
   - 确保 `_appcontext.log` 不为空
   - 为所有日志字段添加空值检查

## 修复后的预期效果

- 服务器端日志能够正常保存到数据库
- 即使在用户未登录的情况下，系统日志也能被记录
- 提高日志系统的健壮性和可靠性
- 便于服务器端问题的诊断和调试

## 修复代码

```csharp
// 确保应用程序上下文不为空
if (_appcontext == null)
{
    System.Diagnostics.Debug.WriteLine("警告: 应用程序上下文为空");
    return;
}

// 确保日志对象不为空
if (_appcontext.log == null)
{
    _appcontext.log = new Logs();
    // 设置默认日志属性
    _appcontext.log.IP = "server";
    _appcontext.log.MachineName = System.Environment.MachineName + "-" + System.Environment.UserName;
}

// 使用MappedDiagnosticsContext确保线程安全
if (_appcontext.log.User_ID!=null)
{
    log4net.MDC.Set("User_ID", _appcontext.log.User_ID.ToString());
}
else
{
    log4net.MDC.Set("User_ID", "0"); // 使用0代替空字符串，避免格式转换异常
}

log4net.MDC.Set("ModName", _appcontext.log.ModName ?? "");
log4net.MDC.Set("ActionName", _appcontext.log.ActionName ?? "");
log4net.MDC.Set("IP", _appcontext.log.IP ?? "");
log4net.MDC.Set("Path", _appcontext.log.Path ?? "");
log4net.MDC.Set("MAC", _appcontext.log.MAC ?? "");
log4net.MDC.Set("MachineName", _appcontext.log.MachineName ?? "");

// 当CurUserInfo为空时，使用默认值
if (_appcontext.CurUserInfo == null)
{
    log4net.MDC.Set("Operator", "系统服务");
}
else
{
    log4net.MDC.Set("Operator", _appcontext.CurUserInfo.客户端版本 ?? "未登录用户");
}

log4net.MDC.Set("Message", message ?? "");
log4net.MDC.Set("Exception", exception?.StackTrace ?? "");
```

## 修复效果

通过这次修复，服务器端日志现在能够正常保存到数据库中，即使在用户未登录的情况下。这将有助于提高系统的可维护性和可靠性，便于服务器端问题的诊断和调试。