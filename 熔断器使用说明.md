# 熔断器使用说明

## 什么是熔断器

熔断器（Circuit Breaker）是一种重要的弹性设计模式，用于处理分布式系统中的故障情况。它类似于电路中的保险丝，当检测到故障时会"熔断"，防止故障扩散。

## 熔断器的作用

### 1. 防止级联故障
当某个服务持续失败时，熔断器会"打开"，阻止更多的请求发送到该服务，从而避免系统资源的浪费和级联故障的发生。

### 2. 快速失败
当熔断器打开时，请求会立即失败并返回错误，而不是等待超时，这样可以快速响应并可能提供备选方案。

### 3. 允许恢复
在一定时间后，熔断器会进入"半开"状态，允许少量请求通过以测试服务是否恢复正常。

## 在RUINORERP系统中的实现

系统使用Polly库实现熔断器功能，相关代码位于 `RUINORERP.PacketSpec.Commands.CommandDispatcher` 类中。

### 默认配置
- 连续失败次数阈值：10次
- 熔断持续时间：1分钟

### 工作流程
1. 命令处理失败会被记录
2. 当连续失败达到阈值时，熔断器打开
3. 后续请求立即失败，不尝试处理
4. 1分钟后熔断器进入半开状态
5. 允许少量请求通过测试服务状态
6. 如果成功，熔断器关闭，恢复正常处理
7. 如果仍然失败，熔断器重新打开

## 常见错误及解决方法

### 错误信息
```
Polly.CircuitBreaker.BrokenCircuitException: The circuit is now open and is not allowing calls.
```

### 可能原因
1. 后端服务持续不可用
2. 数据库连接问题
3. 网络不稳定
4. 代码逻辑错误导致处理失败

### 解决方法
1. 检查相关服务状态
2. 检查网络连接
3. 查看详细错误日志，定位根本原因
4. 修复问题后等待熔断器自动恢复（最长1分钟）

## 配置调整

如需调整熔断器配置，可在 `CommandDispatcher` 构造函数中修改策略：

```csharp
_circuit = circuitBreakerPolicy ?? Policy
    .HandleResult<ResponseBase>(r => !r.IsSuccess)
    .CircuitBreakerAsync(10, TimeSpan.FromMinutes(1));
```

第一个参数是失败次数阈值，第二个参数是熔断持续时间。

## 最佳实践

1. 监控熔断器状态，及时发现系统问题
2. 记录详细的错误日志，便于问题排查
3. 根据业务特点合理设置阈值和时间
4. 实现降级处理，在服务不可用时提供备选方案