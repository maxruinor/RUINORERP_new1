# 状态管理系统优化建议

## 1. UnifiedStateManager 核心方法增强

### 1.1 添加 IsFinalStatus 方法

```csharp
/// <summary>
/// 判断指定实体的指定状态类型是否为终态
/// </summary>
/// <typeparam name="TStatus">状态类型</typeparam>
/// <param name="entity">目标实体</param>
/// <returns>是否为终态</returns>
public bool IsFinalStatus<TStatus>(object entity) where TStatus : struct
{
    if (entity == null)
        throw new ArgumentNullException(nameof(entity));

    try
    {
        // 获取实体当前状态
        TStatus currentStatus = GetBusinessStatus<TStatus>(entity);
        
        // 判断是否为终态
        return GlobalStateRulesManager.Instance.IsFinalStatus(currentStatus);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, $"判断状态类型 {typeof(TStatus).Name} 是否为终态时发生错误");
        return false;
    }
}

/// <summary>
/// 判断指定实体的数据状态是否为终态
/// </summary>
/// <param name="entity">目标实体</param>
/// <returns>是否为终态</returns>
public bool IsFinalDataStatus(object entity)
{
    if (entity == null)
        throw new ArgumentNullException(nameof(entity));

    try
    {
        // 获取实体当前数据状态
        DataStatus currentStatus = GetDataStatus(entity);
        
        // 判断是否为终态
        return GlobalStateRulesManager.Instance.IsFinalStatus(currentStatus);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "判断数据状态是否为终态时发生错误");
        return false;
    }
}
```

### 1.2 添加 CanModify 方法

```csharp
/// <summary>
/// 判断实体是否可修改
/// </summary>
/// <param name="entity">目标实体</param>
/// <returns>是否可修改</returns>
public bool CanModify(object entity)
{
    if (entity == null)
        throw new ArgumentNullException(nameof(entity));

    try
    {
        // 获取实体当前数据状态
        DataStatus currentStatus = GetDataStatus(entity);
        
        // 判断数据状态是否为终态
        if (IsFinalDataStatus(entity))
            return false;
            
        // 检查提交修改规则模式
        bool isSubmittedStatus = currentStatus == DataStatus.提交 || currentStatus == DataStatus.确认;
        return GlobalStateRulesManager.Instance.AllowModifyAfterSubmit(isSubmittedStatus);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "判断实体是否可修改时发生错误");
        return false;
    }
}
```

### 1.3 添加 GetStatusTypeDescription 方法

```csharp
/// <summary>
/// 获取状态类型的描述信息
/// </summary>
/// <param name="statusType">状态类型</param>
/// <returns>状态类型描述</returns>
public string GetStatusTypeDescription(Type statusType)
{
    if (statusType == null)
        throw new ArgumentNullException(nameof(statusType));
        
    // 这里可以基于状态类型返回描述信息
    // 例如：DataStatus -> "数据状态"，ActionStatus -> "操作状态"
    return GlobalStateRulesManager.Instance.GetStatusTypeDescription(statusType);
}
```

## 2. GlobalStateRulesManager 增强

### 2.1 添加 IsFinalStatus 方法

```csharp
/// <summary>
/// 判断指定状态是否为终态
/// </summary>
/// <typeparam name="TStatus">状态类型</typeparam>
/// <param name="status">状态值</param>
/// <returns>是否为终态</returns>
public bool IsFinalStatus<TStatus>(TStatus status) where TStatus : struct
{
    var statusType = typeof(TStatus);
    
    // 针对不同状态类型的终态判断
    if (statusType == typeof(DataStatus))
    {
        DataStatus dataStatus = (DataStatus)(object)status;
        return dataStatus == DataStatus.完结 || dataStatus == DataStatus.作废;
    }
    else if (statusType == typeof(ActionStatus))
    {
        ActionStatus actionStatus = (ActionStatus)(object)status;
        return actionStatus == ActionStatus.无操作;
    }
    else if (statusType == typeof(PaymentStatus))
    {
        PaymentStatus paymentStatus = (PaymentStatus)(object)status;
        return paymentStatus == PaymentStatus.已支付;
    }
    else if (statusType == typeof(RefundStatus))
    {
        RefundStatus refundStatus = (RefundStatus)(object)status;
        return refundStatus == RefundStatus.已退款已退货 || refundStatus == RefundStatus.已退款未退货 || refundStatus == RefundStatus.部分退款退货;
    }
    else if (statusType == typeof(PrePaymentStatus))
    {
        PrePaymentStatus prepayStatus = (PrePaymentStatus)(object)status;
        return prepayStatus == PrePaymentStatus.已结案;
    }
    else if (statusType == typeof(ARAPStatus))
    {
        ARAPStatus arapStatus = (ARAPStatus)(object)status;
        return arapStatus == ARAPStatus.全部支付 || arapStatus == ARAPStatus.已冲销;
    }
    else if (statusType == typeof(StatementStatus))
    {
        StatementStatus statementStatus = (StatementStatus)(object)status;
        return statementStatus == StatementStatus.已结清 || statementStatus == StatementStatus.已作废;
    }
    
    // 默认情况下，不是终态
    return false;
}
```

### 2.2 添加 RefundStatus 规则定义

```csharp
/// <summary>
/// 初始化退款状态转换规则
/// </summary>
private void InitializeRefundStatusTransitionRules()
{
    var statusType = typeof(RefundStatus);
    _stateTransitionRules[statusType] = new Dictionary<object, List<object>>
    {
        [RefundStatus.未退款等待退货] = new List<object> { RefundStatus.未退款已退货, RefundStatus.已退款等待退货, RefundStatus.已退款未退货 },
        [RefundStatus.未退款已退货] = new List<object> { RefundStatus.已退款已退货, RefundStatus.部分退款退货 },
        [RefundStatus.已退款等待退货] = new List<object> { RefundStatus.已退款已退货, RefundStatus.部分退款退货 },
        [RefundStatus.已退款未退货] = new List<object> { RefundStatus.部分退款退货 },
        [RefundStatus.已退款已退货] = new List<object>(),
        [RefundStatus.部分退款退货] = new List<object>()
    };
}
```

然后在 InitializeBusinessStatusTransitionRules 方法中添加对 InitializeRefundStatusTransitionRules 的调用：

```csharp
private void InitializeBusinessStatusTransitionRules()
{
    InitializePaymentStatusTransitionRules();
    InitializePrePaymentStatusTransitionRules();
    InitializeARAPStatusTransitionRules();
    InitializeStatementStatusTransitionRules();
    InitializeRefundStatusTransitionRules(); // 新增
}
```

### 2.3 添加状态类型描述方法

```csharp
/// <summary>
/// 获取状态类型的描述信息
/// </summary>
/// <param name="statusType">状态类型</param>
/// <returns>状态类型描述</returns>
public string GetStatusTypeDescription(Type statusType)
{
    if (statusType == typeof(DataStatus))
        return "数据状态";
    else if (statusType == typeof(ActionStatus))
        return "操作状态";
    else if (statusType == typeof(PaymentStatus))
        return "付款状态";
    else if (statusType == typeof(RefundStatus))
        return "退款状态";
    else if (statusType == typeof(PrePaymentStatus))
        return "预付款状态";
    else if (statusType == typeof(ARAPStatus))
        return "应收应付状态";
    else if (statusType == typeof(StatementStatus))
        return "对账状态";
    
    return statusType.Name;
}
```

## 3. BaseBillEditGeneric.cs 状态判断逻辑重构

### 3.1 重构 UpdateSaveButtonState 方法

```csharp
/// <summary>
/// 更新保存按钮状态
/// </summary>
protected void UpdateSaveButtonState()
{
    try
    {
        // 获取当前实体
        var entity = this.Entity;
        if (entity == null)
        {
            toolStripButtonSave.Enabled = false;
            return;
        }
        
        // 实体变更检查
        bool hasChanged = entity.HasChanged;
        if (!hasChanged)
        {
            toolStripButtonSave.Enabled = false;
            return;
        }
        
        // 使用统一状态管理器判断是否可修改
        var stateManager = entity.StateManager;
        bool canModify = stateManager.CanModify(entity);
        
        // 锁定状态检查
        bool isLocked = false;
        var lockInfoProperty = entity.GetType().GetProperty("LockInfo", BindingFlags.Instance | BindingFlags.Public);
        if (lockInfoProperty != null)
        {
            var lockInfo = lockInfoProperty.GetValue(entity);
            isLocked = lockInfo != null && !string.IsNullOrEmpty(lockInfo.ToString());
        }
        
        // 综合判断保存按钮状态
        toolStripButtonSave.Enabled = canModify && !isLocked;
    }
    catch (Exception ex)
    {
        // 异常处理
        toolStripButtonSave.Enabled = false;
        LogHelper.WriteLog(ex.Message);
    }
}
```

### 3.2 添加业务状态判断辅助方法

```csharp
/// <summary>
/// 判断当前实体的指定业务状态类型是否为终态
/// </summary>
/// <typeparam name="TStatus">业务状态类型</typeparam>
/// <returns>是否为终态</returns>
protected bool IsBusinessStatusFinal<TStatus>() where TStatus : struct
{
    if (Entity == null)
        return false;
    
    return Entity.StateManager.IsFinalStatus<TStatus>(Entity);
}
```

## 4. 迁移步骤

### 4.1 为 BaseEntity 添加 StateManager 属性

确保 BaseEntity 类中已正确实现了 StateManager 属性：

```csharp
/// <summary>
/// 状态管理器实例
/// </summary>
public IUnifiedStateManager StateManager => UnifiedStateManager.Instance;
```

### 4.2 重构现有辅助类中的状态判断方法

对于 FMPaymentStatusHelper.cs、RefundStatusHelper.cs 和 StatusManagerService.cs 中的方法，应按照以下方式重构：

#### 4.2.1 FMPaymentStatusHelper.cs 重构示例

```csharp
/// <summary>
/// 判断实体的付款状态是否为终态
/// </summary>
/// <param name="entity">实体</param>
/// <returns>是否为终态</returns>
public static bool IsFinalStatus(object entity)
{
    if (entity == null)
        return false;
    
    // 委托给统一状态管理器
    return entity.StateManager.IsFinalStatus<PaymentStatus>(entity);
}

/// <summary>
/// 判断实体是否可修改
/// </summary>
/// <param name="entity">实体</param>
/// <returns>是否可修改</returns>
public static bool CanModify(object entity)
{
    if (entity == null)
        return false;
    
    // 委托给统一状态管理器
    return entity.StateManager.CanModify(entity);
}
```

#### 4.2.2 RefundStatusHelper.cs 重构示例

```csharp
/// <summary>
/// 判断退款状态是否为终态
/// </summary>
/// <param name="status">退款状态</param>
/// <returns>是否为终态</returns>
public static bool IsFinalStatus(RefundStatus status)
{
    // 委托给全局规则管理器
    return GlobalStateRulesManager.Instance.IsFinalStatus(status);
}

/// <summary>
/// 验证状态转换是否有效
/// </summary>
/// <param name="fromStatus">源状态</param>
/// <param name="toStatus">目标状态</param>
/// <returns>转换结果</returns>
public static StateTransitionResult TryValidateTransition(RefundStatus fromStatus, RefundStatus toStatus)
{
    // 委托给全局规则管理器
    bool isValid = GlobalStateRulesManager.Instance.IsValidTransition(fromStatus, toStatus);
    return new StateTransitionResult(isValid, isValid ? string.Empty : $"无法从 {fromStatus} 转换到 {toStatus}");
}
```

#### 4.2.3 StatusManagerService.cs 重构示例

```csharp
/// <summary>
/// 判断实体是否可编辑
/// </summary>
/// <param name="entity">实体</param>
/// <returns>是否可编辑</returns>
public bool IsEditable(object entity)
{
    if (entity == null)
        return false;
    
    // 委托给统一状态管理器
    return entity.StateManager.CanModify(entity);
}

/// <summary>
/// 判断数据状态是否为终态
/// </summary>
/// <param name="status">数据状态</param>
/// <returns>是否为终态</returns>
public bool IsFinalStatus(DataStatus status)
{
    // 委托给全局规则管理器
    return GlobalStateRulesManager.Instance.IsFinalStatus(status);
}
```

## 5. 完全迁移计划

### 5.1 第一阶段：扩展核心组件

1. 在 UnifiedStateManager 中添加 IsFinalStatus 和 CanModify 方法
2. 在 GlobalStateRulesManager 中添加 IsFinalStatus 和 GetStatusTypeDescription 方法
3. 添加 RefundStatus 的状态转换规则

### 5.2 第二阶段：重构辅助类

1. 修改 FMPaymentStatusHelper.cs、RefundStatusHelper.cs 和 StatusManagerService.cs，将逻辑委托给统一状态管理系统
2. 保持原方法签名，确保向后兼容性

### 5.3 第三阶段：重构 UI 层状态判断逻辑

1. 修改 BaseBillEditGeneric.cs 中的状态判断逻辑，使用实体的 StateManager 属性
2. 替换所有直接访问实体状态属性的代码

### 5.4 第四阶段：代码清理

1. 经过一段时间的验证后，标记旧辅助类为过时 (Obsolete)
2. 在适当的时候完全移除旧辅助类