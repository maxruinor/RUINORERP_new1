# 状态管理系统使用指南

## 概述

本系统提供了两种类型的状态规则管理：

1. **状态转换规则**：控制各种状态（如DataStatus、ActionStatus和业务状态）之间的转换关系
2. **UI控件规则**：控制UI中操作按钮的显示、只读和可用属性

## 核心组件

### 1. StateTransitionRules 类

负责管理所有状态之间的转换规则，包括：
- 数据状态转换规则（DataStatus）
- 操作状态转换规则（ActionStatus）
- 业务状态转换规则（PaymentStatus、PrePaymentStatus、ARAPStatus等）

### 2. UIControlRules 类

负责管理UI操作按钮的状态规则，控制按钮的：
- Enabled（是否启用）
- Visible（是否可见）

注意：此类控制的是操作按钮（如新增、保存、提交等），而不是具体业务控件。

### 3. UnifiedStateManager 类

提供统一的状态管理功能，包括：
- 状态转换验证
- 状态转换执行
- 状态事件处理

## 使用示例

### 初始化状态转换规则

```csharp
// 初始化状态转换规则
var transitionRules = new Dictionary<Type, Dictionary<object, List<object>>>();
StateTransitionRules.InitializeDefaultRules(transitionRules);
```

### 检查状态转换是否允许

```csharp
// 检查数据状态转换是否允许
bool canTransition = StateTransitionRules.IsTransitionAllowed(transitionRules, DataStatus.草稿, DataStatus.新建);

// 检查业务状态转换是否允许
bool canTransition = StateTransitionRules.IsTransitionAllowed(transitionRules, PaymentStatus.草稿, PaymentStatus.待审核);
```

### 执行状态转换

```csharp
// 使用统一状态管理器执行状态转换
var stateManager = serviceProvider.GetService<IUnifiedStateManager>();
var result = await stateManager.SetEntityDataStatusAsync(entity, DataStatus.新建, "用户操作");

if (result.IsSuccess)
{
    // 状态转换成功
}
else
{
    // 状态转换失败，处理错误
    Console.WriteLine($"状态转换失败: {result.ErrorMessage}");
}
```

### 获取UI按钮状态规则

```csharp
// 获取数据状态对应的按钮规则
var buttonRules = UIControlRules.GetButtonRules(DataStatus.草稿);

// 遍历按钮规则
foreach (var rule in buttonRules)
{
    Console.WriteLine($"按钮 {rule.Key}: 启用={rule.Value.Enabled}, 可见={rule.Value.Visible}");
}
```

### 添加自定义状态转换规则

```csharp
// 添加自定义状态转换规则
StateTransitionRules.AddTransitionRule(transitionRules, DataStatus.草稿, DataStatus.自定义状态);
```

### 添加自定义UI按钮规则

```csharp
// 添加自定义按钮规则
UIControlRules.AddButtonRule(DataStatus.草稿, "btnCustomAction", true, true);
```

## 状态转换流程

### DataStatus 状态转换流程

```
草稿 → 新建 → 确认 → 完结
  ↓       ↓       ↓
作废 ← 作废 ← 作废 ← 作废
```

- 草稿状态可以转换到：新建、作废
- 新建状态可以转换到：确认、作废
- 确认状态可以转换到：完结、作废
- 完结状态不能再转换
- 作废状态可以重新激活为草稿

### 业务状态转换流程

#### PaymentStatus（付款状态）
```
草稿 → 待审核 → 已支付
  ↑       ↓
 草稿 ← 草稿
```

#### PrePaymentStatus（预付款状态）
```
草稿 → 待审核 → 已生效 → 待核销 → 部分核销 → 全额核销 → 已结案
  ↑       ↓         ↓         ↓          ↓          ↓
 草稿 ← 草稿         已生效    已生效      已生效       已生效
```

#### ARAPStatus（应收应付状态）
```
草稿 → 待审核 → 待支付 → 部分支付 → 全部支付 → 已冲销
  ↑       ↓         ↓          ↓          ↓
 草稿 ← 草稿         坏账 ← 部分支付
```

## UI按钮状态规则

### DataStatus 按钮状态

| 状态 | 新增 | 修改 | 保存 | 删除 | 提交 | 审核 | 反审 | 结案 | 反结案 | 打印 | 导出 |
|------|------|------|------|------|------|------|------|------|--------|------|------|
| 草稿 | ✓ | ✓ | ✓ | ✓ | ✓ | ✗ | ✗ | ✗ | ✗ | ✓ | ✓ |
| 新建 | ✓ | ✓ | ✓ | ✓ | ✗ | ✓ | ✗ | ✗ | ✗ | ✓ | ✓ |
| 确认 | ✗ | ✗ | ✗ | ✗ | ✗ | ✗ | ✓ | ✓ | ✗ | ✓ | ✓ |
| 完结 | ✗ | ✗ | ✗ | ✗ | ✗ | ✗ | ✗ | ✗ | ✓ | ✓ | ✓ |
| 作废 | ✗ | ✗ | ✗ | ✗ | ✗ | ✗ | ✗ | ✗ | ✗ | ✗ | ✗ |

*✓ 表示启用/可见，✗ 表示禁用/不可见*

### 业务状态按钮规则

业务状态的按钮规则遵循以下原则：
- 草稿、待审核状态：允许大部分操作
- 已生效、待支付状态：允许修改，但限制删除
- 部分核销/部分支付状态：允许修改，限制删除
- 全额核销/全部支付/已结案/已冲销/坏账状态：只允许查看和打印

## 扩展指南

### 添加新的业务状态枚举

1. 在 `Global\EnumExt` 目录下创建新的枚举类型
2. 在 `StateTransitionRules.cs` 中添加初始化规则的方法
3. 在 `UIControlRules.cs` 中添加按钮规则的方法

### 自定义状态转换验证

```csharp
// 添加带验证的状态转换规则
StateTransitionRules.AddTransitionRule(transitionRules, CustomStatus.草稿, CustomStatus.审核, 
    context => {
        // 自定义验证逻辑
        var entity = context as BaseEntity;
        return entity != null && entity.HasChanged;
    });
```

### 自定义UI按钮规则

```csharp
// 为特定状态添加自定义按钮规则
UIControlRules.AddButtonRule(DataStatus.自定义状态, "btnCustomAction", true, true);
```

## 最佳实践

1. **统一使用统一状态管理器**：避免直接操作状态，使用 `UnifiedStateManager` 进行所有状态操作
2. **遵循状态转换规则**：不要绕过状态转换规则直接设置状态
3. **UI状态与业务状态同步**：确保UI按钮状态与业务状态保持一致
4. **使用事件驱动**：订阅状态变更事件，而不是轮询状态
5. **异常处理**：始终处理状态转换可能出现的异常

## 注意事项

1. 状态转换规则是全局的，修改会影响所有使用该状态的实体
2. UI按钮规则是全局的，修改会影响所有使用该状态的窗体
3. 状态转换是异步的，请使用 `await` 等待完成
4. 状态转换会触发事件，注意避免事件循环调用