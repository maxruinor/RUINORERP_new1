# ç™»å½•ã€é‡è¿ã€é”å®šæµç¨‹åˆ†æä¸ç®€åŒ–æ–¹æ¡ˆï¼ˆä¼˜åŒ–ç‰ˆï¼‰

## ä¸€ã€ä¿ç•™çš„æ ¸å¿ƒåŠŸèƒ½

### 1.1 å¿…é¡»ä¿ç•™çš„åŠŸèƒ½

1. **ç™»å½•ç•Œé¢æ¬¢è¿æ¶ˆæ¯åŠ è½½**: æ‰“å¼€ç™»å½•ç•Œé¢æ—¶å…ˆè¿æ¥æœåŠ¡å™¨æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
2. **è‡ªåŠ¨é‡è¿**: æœåŠ¡å™¨æ–­å¼€åé‡æ–°æ‰“å¼€ï¼Œå®¢æˆ·ç«¯è‡ªåŠ¨é‡è¿
3. **å¿ƒè·³æ£€æµ‹å’Œé”å®š**:
   - å¿ƒè·³é—´éš”å›ºå®š
   - ç®€åŒ–å¤±è´¥ç±»å‹æ£€æµ‹ï¼ˆè¶…æ—¶/ç½‘ç»œé”™è¯¯/æœåŠ¡å™¨ç¹å¿™/ä¼šè¯è¿‡æœŸï¼‰
   - ç®€å•é˜ˆå€¼åˆ¤æ–­ï¼ˆå¿ƒè·³å¤±è´¥è¾¾åˆ°5æ¬¡è§¦å‘é”å®šï¼‰
   - é”å®šåé‡è¿ç»§ç»­è¿è¡Œ â†’ é‡è¿æˆåŠŸ â†’ è§£é™¤é”å®šï¼ˆå³é‡æ–°ç™»å½•æµç¨‹ï¼‰
4. **å¿ƒè·³å¼€å§‹å’Œç»“æŸç»´æŠ¤**: ä¿æŒå¿ƒè·³çš„æ­£ç¡®å¯åŠ¨å’Œåœæ­¢æ—¶æœº
5. **æœåŠ¡å™¨åˆ‡æ¢**: ç”¨æˆ·å¯ä»¥ä¿®æ”¹IPæˆ–ç«¯å£ï¼Œé‡æ–°è¿æ¥åˆ°æ–°æœåŠ¡å™¨

### 1.2 ä¿ç•™çš„ç”¨æˆ·äº¤äº’æµç¨‹

```
æœåŠ¡å™¨æ–­å¼€ â†’ è‡ªåŠ¨é‡è¿ï¼ˆæŒç»­è¿è¡Œï¼‰
    â†“
å¿ƒè·³å¤±è´¥æˆ–ç½‘ç»œæ–­å¼€ â†’ è§¦å‘é”å®šï¼ˆ5æ¬¡å¤±è´¥ï¼‰
    â†“
é”å®šçŠ¶æ€ï¼šæ˜¾ç¤ºç™»å½•çª—ä½“ï¼ˆæ¨¡æ€å¯¹è¯æ¡†ï¼‰
    â†“
ç”¨æˆ·ç‚¹å‡»ç™»å½• â†’ è¿›å…¥æ­£å¸¸ç™»å½•æµç¨‹
    â†“
é‡è¿æˆåŠŸ â†’ è§£é™¤é”å®š
```

## äºŒã€å½“å‰ç³»ç»Ÿå¤æ‚åº¦åˆ†æ

### 1.1 çŠ¶æ€å˜é‡ç»Ÿè®¡

| ç±»å | çŠ¶æ€å˜é‡æ•°é‡ | ä¸»è¦çŠ¶æ€å˜é‡ |
|------|------------|------------|
| **SuperSocketClient** | 3ä¸ª | `_isConnected`, `_port`, `_networkHealthWarningShown` |
| **ConnectionManager** | 4ä¸ª | `_isReconnecting`, `_disposed`, `_reconnectStopped`, `_isNetworkAvailable` |
| **ClientCommunicationService** | 14ä¸ª | `_heartbeatIntervalMs`, `_heartbeatFailedAttempts`, `_isHeartbeatRunning`, `_isReconnecting`, `_isDisposed`, `_isProcessingQueue`, `_totalHeartbeatAttempts`, `_totalHeartbeatSuccess`, `_totalHeartbeatFailures`, ç½‘ç»œè´¨é‡ç›¸å…³å˜é‡ |
| **UserLoginService** | 2ä¸ª | `_isLoggedIn`, `_isDisposed` |
| **NetworkHealthCheckService** | 3ä¸ª | `_isNetworkHealthy`, `_isRunning`, `_consecutiveFailures` |

**æ€»è®¡**: çº¦26ä¸ªå¸ƒå°”/æ•´æ•°çŠ¶æ€å˜é‡

### 1.2 äº‹ä»¶ç»Ÿè®¡

| ç±»å | äº‹ä»¶æ•°é‡ | äº‹ä»¶åˆ—è¡¨ |
|------|---------|---------|
| **SuperSocketClient** | 3ä¸ª | `ConnectionStateChanged`, `Received`, `Closed` |
| **ConnectionManager** | 4ä¸ª | `ConnectionStateChanged`, `ReconnectFailed`, `ReconnectAttempt`, `ReconnectSucceeded` |
| **ClientEventManager** | 8ä¸ª | `CommandReceived`, `ConnectionStatusChanged`, `ErrorOccurred`, `ConnectionClosed`, `ReconnectFailed`, `RequestCompleted`, `WelcomeCompleted`, `ServerPushCommandReceived` |
| **ClientCommunicationService** | 7ä¸ª | `HeartbeatFailed`, `HeartbeatRecovered`, `HeartbeatFailureThresholdReached`, `SessionExpired`, `CommandReceived`, `ReconnectFailed`, `ConnectionStateChanged` |
| **MessageService** | 3ä¸ª | `PopupMessageReceived`, `BusinessMessageReceived`, `SystemNotificationReceived` |
| **SilentTokenRefresher** | 2ä¸ª | `OnRefreshSucceeded`, `OnRefreshFailed` |
| **NetworkHealthCheckService** | 1ä¸ª | `NetworkHealthChanged` |

**æ€»è®¡**: 28ä¸ªäº‹ä»¶

### 1.3 ä¸»è¦é—®é¢˜è¯†åˆ«

#### é—®é¢˜1: çŠ¶æ€å†—ä½™å’Œåˆ†æ•£
- `_isReconnecting` åœ¨ `ConnectionManager` å’Œ `ClientCommunicationService` ä¸­åŒæ—¶å­˜åœ¨ï¼Œå®¹æ˜“ä¸åŒæ­¥
- `_isConnected` åœ¨ `SuperSocketClient` ä¸­ç»´æŠ¤ï¼Œ`ConnectionManager` é€šè¿‡æŸ¥è¯¢è·å–ï¼ŒçŠ¶æ€å¯èƒ½ä¸ä¸€è‡´
- `_disposed` åœ¨å¤šä¸ªç±»ä¸­é‡å¤å®šä¹‰

#### é—®é¢˜2: å¿ƒè·³é€»è¾‘è¿‡åº¦å¤æ‚
- **å¿ƒè·³é—´éš”åŠ¨æ€è°ƒæ•´**: åŸºç¡€é—´éš”ã€æœ€å°é—´éš”ã€æœ€å¤§é—´éš”ã€ç½‘ç»œè´¨é‡é˜ˆå€¼
- **å¿ƒè·³å¤±è´¥ç»Ÿè®¡**: å¤±è´¥æ¬¡æ•°ã€å¤±è´¥è¿½è¸ªå™¨ã€å¤±è´¥ç±»å‹æ£€æµ‹ã€å¤±è´¥å†å²è®°å½•
- **å¿ƒè·³é˜ˆå€¼åˆ¤æ–­**: æ™®é€šé˜ˆå€¼ï¼ˆ3æ¬¡ï¼‰ã€æ™ºèƒ½è¿½è¸ªå™¨é˜ˆå€¼ï¼ˆ2åˆ†é’Ÿå†…3æ¬¡åŒç±»å‹å¤±è´¥ï¼‰
- **å¿ƒè·³æ¢å¤é€»è¾‘**: æ¢å¤äº‹ä»¶ã€å‡åŠé—´éš”ã€å¯åŠ¨é‡è¿

#### é—®é¢˜3: é‡å¤çš„çŠ¶æ€æ£€æŸ¥å’Œäº‹ä»¶è§¦å‘
- å¿ƒè·³å¤±è´¥æ—¶æ£€æŸ¥ `_socketClient.IsConnected` å’Œ `_connectionManager.IsConnected`
- è¿æ¥çŠ¶æ€å˜æ›´äº‹ä»¶åœ¨å¤šä¸ªå±‚çº§é‡å¤è§¦å‘
- é‡è¿å¤±è´¥äº‹ä»¶åœ¨å¤šä¸ªç±»ä¸­å®šä¹‰

#### é—®é¢˜4: é”å®šé€»è¾‘ä¸å¿ƒè·³è€¦åˆè¿‡åº¦
- å¿ƒè·³å¤±è´¥ â†’ è¾¾åˆ°é˜ˆå€¼ â†’ è§¦å‘é”å®šäº‹ä»¶ âœ… ä¿ç•™
- é”å®šåé‡è¿ç»§ç»­è¿è¡Œ â†’ é‡è¿æˆåŠŸ â†’ è§£é™¤é”å®š âœ… ä¿ç•™å¹¶ä¼˜åŒ–
- é‡è¿å¤±è´¥æ¬¡æ•°è¾¾åˆ°æœ€å¤§ â†’ åœæ­¢é‡è¿ â†’ åº”è¯¥ä¿æŒé‡è¿æœºåˆ¶æ´»è·ƒ âœ… ä¿®å¤

## äºŒã€ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡ï¼ˆä¿ç•™æ ¸å¿ƒåŠŸèƒ½ï¼‰

### 2.1 æ ¸å¿ƒåŸåˆ™

1. **å•ä¸€çœŸå®æ¥æº (Single Source of Truth)**
   - è¿æ¥çŠ¶æ€: `ConnectionManager.IsConnected` (æŸ¥è¯¢ SuperSocketClient)
   - é‡è¿çŠ¶æ€: `ConnectionManager.IsReconnecting`
   - ç™»å½•çŠ¶æ€: `UserLoginService.IsLoggedIn`

2. **å‡å°‘çŠ¶æ€å˜é‡**
   - åˆå¹¶é‡å¤çš„çŠ¶æ€æ ‡å¿—ï¼ˆ`_isReconnecting`ï¼‰
   - ç§»é™¤ä¸å¿…è¦çš„ç»Ÿè®¡å˜é‡ï¼ˆæ€»å¿ƒè·³æˆåŠŸ/å¤±è´¥æ¬¡æ•°ã€å»¶è¿Ÿå†å²ï¼‰
   - ç§»é™¤ä¸å¿…è¦çš„åŠ¨æ€è°ƒæ•´é€»è¾‘

3. **ç»Ÿä¸€äº‹ä»¶æµ**
   - å‡å°‘é‡å¤çš„äº‹ä»¶å®šä¹‰
   - å»ºç«‹æ¸…æ™°çš„äº‹ä»¶ä¼ é€’é“¾
   - é¿å…äº‹ä»¶å¾ªç¯è§¦å‘

4. **ä¿ç•™æ ¸å¿ƒé”å®šæœºåˆ¶**
   - å¿ƒè·³é—´éš”å›ºå®š
   - ç®€åŒ–å¤±è´¥ç±»å‹æ£€æµ‹ï¼ˆä¿ç•™æ ¸å¿ƒç±»å‹ï¼‰
   - ç®€å•é˜ˆå€¼åˆ¤æ–­ï¼ˆ5æ¬¡å¤±è´¥è§¦å‘é”å®šï¼‰
   - é”å®šåé‡è¿ç»§ç»­è¿è¡Œï¼Œé‡è¿æˆåŠŸåè§£é™¤é”å®š

### 2.2 ä¼˜åŒ–åçš„æ¶æ„ï¼ˆä¿ç•™æ ¸å¿ƒåŠŸèƒ½ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      UI Layer                            â”‚
â”‚  (MainForm, Login Dialog, Status Display)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Connect/Login/ManualReconnect
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                UserLoginService                         â”‚
â”‚  - ç®¡ç†ç™»å½•çŠ¶æ€ (_isLoggedIn)                            â”‚
â”‚  - å¤„ç†ç™»å½•è¯·æ±‚å’Œå“åº”                                    â”‚
â”‚  - æä¾›æ‰‹åŠ¨é‡è¿æ¥å£                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Send Commands/Manage Session
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ClientCommunicationService                     â”‚
â”‚  - å‘½ä»¤å‘é€å’Œæ¥æ”¶ (æ ¸å¿ƒåŠŸèƒ½)                             â”‚
â”‚  - ç®€åŒ–çš„å¿ƒè·³æœºåˆ¶ (å›ºå®šé—´éš”)                             â”‚
â”‚  - è¯·æ±‚-å“åº”åŒ¹é… (PendingRequest)                        â”‚
â”‚  - å‡å°‘çŠ¶æ€å˜é‡ (åªä¿ç•™å¿…è¦çš„çŠ¶æ€)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Connection Management
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ConnectionManager                           â”‚
â”‚  - è¿æ¥/æ–­å¼€/é‡è¿ (çŠ¶æ€å”¯ä¸€çœŸå®æ¥æº)                      â”‚
â”‚  - è‡ªåŠ¨é‡è¿ (æŒç»­å°è¯•,ä¸é™åˆ¶æ¬¡æ•°)                        â”‚
â”‚  - è¿æ¥çŠ¶æ€äº‹ä»¶ (ConnectionStateChanged)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Socket Communication
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               SuperSocketClient                          â”‚
â”‚  - åº•å±‚Socketæ“ä½œ                                        â”‚
â”‚  - æ•°æ®å‘é€å’Œæ¥æ”¶                                        â”‚
â”‚  - è¿æ¥çŠ¶æ€å˜åŒ–é€šçŸ¥                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      UI Layer                            â”‚
â”‚  - LoginForm (ç™»å½•çª—ä½“, æ”¯æŒæ¨¡æ€æ˜¾ç¤º)                     â”‚
â”‚  - MainForm (ä¸»çª—ä½“)                                      â”‚
â”‚  - Status Display (è¿æ¥çŠ¶æ€ã€å¿ƒè·³çŠ¶æ€æ˜¾ç¤º)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Connect/Login/ShowLoginModal/ManualReconnect
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                UserLoginService                         â”‚
â”‚  - ç®¡ç†ç™»å½•çŠ¶æ€ (_isLoggedIn)                            â”‚
â”‚  - å¤„ç†ç™»å½•è¯·æ±‚å’Œå“åº”                                    â”‚
â”‚  - å¤„ç†æ¬¢è¿æ¶ˆæ¯åŠ è½½                                      â”‚
â”‚  - æä¾›æ‰‹åŠ¨é‡è¿æ¥å£                                      â”‚
â”‚  - é”å®šçŠ¶æ€ç®¡ç†ï¼ˆæ˜¾ç¤ºç™»å½•çª—ä½“ï¼‰                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Send Commands/Manage Session
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ClientCommunicationService                     â”‚
â”‚  - å‘½ä»¤å‘é€å’Œæ¥æ”¶ (æ ¸å¿ƒåŠŸèƒ½)                             â”‚
â”‚  - å›ºå®šé—´éš”å¿ƒè·³ (30ç§’)                                   â”‚
â”‚  - å¿ƒè·³å¤±è´¥è®¡æ•°å’Œé”å®šè§¦å‘ (5æ¬¡å¤±è´¥è§¦å‘é”å®š)              â”‚
â”‚  - ç®€åŒ–å¤±è´¥ç±»å‹æ£€æµ‹ (è¶…æ—¶/ç½‘ç»œé”™è¯¯/æœåŠ¡å™¨ç¹å¿™/ä¼šè¯è¿‡æœŸ)  â”‚
â”‚  - è¯·æ±‚-å“åº”åŒ¹é… (PendingRequest)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Connection Management
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ConnectionManager                           â”‚
â”‚  - è¿æ¥/æ–­å¼€/é‡è¿ (çŠ¶æ€å”¯ä¸€çœŸå®æ¥æº)                      â”‚
â”‚  - è‡ªåŠ¨é‡è¿ (æŒç»­å°è¯•,æ— æ¬¡æ•°é™åˆ¶)                        â”‚
â”‚  - è¿æ¥çŠ¶æ€äº‹ä»¶ (ConnectionStateChanged)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Socket Communication
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               SuperSocketClient                          â”‚
â”‚  - åº•å±‚Socketæ“ä½œ                                        â”‚
â”‚  - æ•°æ®å‘é€å’Œæ¥æ”¶                                        â”‚
â”‚  - è¿æ¥çŠ¶æ€å˜åŒ–é€šçŸ¥                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸‰ã€å…·ä½“ä¼˜åŒ–æ–¹æ¡ˆ

#### 3.1 çŠ¶æ€å˜é‡ä¼˜åŒ–

**ç§»é™¤çš„å˜é‡**:
```csharp
// ClientCommunicationService ä¸­ç§»é™¤
private int _baseHeartbeatIntervalMs = 30000;  // åªä¿ç•™ä¸€ä¸ªå›ºå®šé—´éš”
private int _minHeartbeatIntervalMs = 10000;   // ä¸éœ€è¦åŠ¨æ€è°ƒæ•´
private int _maxHeartbeatIntervalMs = 120000;  // ä¸éœ€è¦åŠ¨æ€è°ƒæ•´
private int _networkQualityThresholdGood = 100; // ä¸éœ€è¦ç½‘ç»œè´¨é‡åˆ¤æ–­
private int _networkQualityThresholdPoor = 500; // ä¸éœ€è¦ç½‘ç»œè´¨é‡åˆ¤æ–­
private int _totalHeartbeatAttempts = 0;      // ä¸éœ€è¦ç»Ÿè®¡
private int _totalHeartbeatSuccess = 0;       // ä¸éœ€è¦ç»Ÿè®¡
private int _totalHeartbeatFailures = 0;      // ä¸éœ€è¦ç»Ÿè®¡
private readonly Queue<double> _latencyHistory = new Queue<double>(); // ä¸éœ€è¦å»¶è¿Ÿå†å²
private bool _isProcessingQueue = false;      // ç®€åŒ–é˜Ÿåˆ—å¤„ç†é€»è¾‘
```

**ä¿ç•™çš„å¿…è¦å˜é‡**:
```csharp
// ClientCommunicationService
private int _heartbeatIntervalMs = 30000; // å›ºå®šå¿ƒè·³é—´éš”
private int _heartbeatTimeoutMs = 60000;  // å¿ƒè·³è¶…æ—¶æ—¶é—´
private int _heartbeatFailedAttempts = 0; // å¿ƒè·³å¤±è´¥è®¡æ•°ï¼ˆä¿ç•™ï¼Œç”¨äºé”å®šåˆ¤æ–­ï¼‰
private bool _isHeartbeatRunning;         // å¿ƒè·³è¿è¡ŒçŠ¶æ€
private DateTime _lastHeartbeatTime;       // æœ€åå¿ƒè·³æ—¶é—´
private readonly ConcurrentDictionary<string, PendingRequest> _pendingRequests;
private readonly ConcurrentQueue<ClientQueuedCommand> _queuedCommands;
```

**ConnectionManager ä¸­çš„å˜é‡**:
```csharp
private bool _isReconnecting = false;      // å”¯ä¸€çš„é‡è¿çŠ¶æ€æ ‡å¿—
private bool _disposed = false;
private string _serverAddress;
private int _serverPort;
private DateTime _lastReconnectAttempt;
// ç§»é™¤ _reconnectStopped æ ‡å¿—ï¼ˆç®€åŒ–é‡è¿é€»è¾‘ï¼ŒæŒç»­è¿è¡Œï¼‰
```

**ç§»é™¤çš„å˜é‡**:
```csharp
// ClientCommunicationService ä¸­ç§»é™¤
private int _baseHeartbeatIntervalMs = 30000;
private int _minHeartbeatIntervalMs = 10000;
private int _maxHeartbeatIntervalMs = 120000;
private int _networkQualityThresholdGood = 100;
private int _networkQualityThresholdPoor = 500;
private int _totalHeartbeatAttempts = 0;
private int _totalHeartbeatSuccess = 0;
private int _totalHeartbeatFailures = 0;
private bool _isReconnecting = false; // ä½¿ç”¨ ConnectionManager.IsReconnecting
private bool _isProcessingQueue = false; // ç®€åŒ–é˜Ÿåˆ—å¤„ç†é€»è¾‘
```

**ä¿ç•™çš„å¿…è¦å˜é‡**:
```csharp
// ClientCommunicationService
private int _heartbeatIntervalMs = 30000; // å›ºå®šå¿ƒè·³é—´éš”
private bool _isHeartbeatRunning;
private DateTime _lastHeartbeatTime;
private readonly ConcurrentDictionary<string, PendingRequest> _pendingRequests;
private readonly ConcurrentQueue<ClientQueuedCommand> _queuedCommands;
```

**ConnectionManager ä¸­çš„å˜é‡**:
```csharp
private bool _isReconnecting = false; // å”¯ä¸€çš„é‡è¿çŠ¶æ€æ ‡å¿—
private bool _disposed = false;
private string _serverAddress;
private int _serverPort;
private DateTime _lastReconnectAttempt;
// ç§»é™¤ _reconnectStopped æ ‡å¿—ï¼ˆç®€åŒ–é‡è¿é€»è¾‘ï¼‰
```

### 3.2 å¿ƒè·³æœºåˆ¶ä¼˜åŒ–ï¼ˆä¿ç•™æ ¸å¿ƒé”å®šåŠŸèƒ½ï¼‰

**ä¿ç•™çš„åŠŸèƒ½**:
- âœ… å›ºå®šå¿ƒè·³é—´éš”ï¼ˆ30ç§’ï¼‰
- âœ… å¿ƒè·³å¤±è´¥è®¡æ•°
- âœ… å¤±è´¥ç±»å‹æ£€æµ‹ï¼ˆè¶…æ—¶/ç½‘ç»œé”™è¯¯/æœåŠ¡å™¨ç¹å¿™/ä¼šè¯è¿‡æœŸï¼‰
- âœ… ç®€å•é˜ˆå€¼åˆ¤æ–­ï¼ˆ5æ¬¡å¤±è´¥è§¦å‘é”å®šï¼‰
- âœ… å¿ƒè·³å¼€å§‹å’Œç»“æŸçš„æ—¶æœºç»´æŠ¤

**ç§»é™¤çš„åŠŸèƒ½**:
- âŒ å¿ƒè·³é—´éš”åŠ¨æ€è°ƒæ•´
- âŒ ç½‘ç»œè´¨é‡åˆ¤æ–­å’Œè°ƒæ•´
- âŒ æ™ºèƒ½å¤±è´¥è¿½è¸ªå™¨ï¼ˆå¤±è´¥å†å²è®°å½•ï¼‰
- âŒ å¿ƒè·³ç»Ÿè®¡ï¼ˆæˆåŠŸ/å¤±è´¥æ¬¡æ•°ï¼‰
- âŒ å»¶è¿Ÿå†å²è®°å½•

**ä¼˜åŒ–åçš„å¿ƒè·³å¾ªç¯**:
```csharp
/// <summary>
/// ä¼˜åŒ–åçš„å¿ƒè·³å¾ªç¯ï¼ˆå›ºå®šé—´éš”ï¼Œç®€å•é˜ˆå€¼åˆ¤æ–­ï¼‰
/// </summary>
private async Task HeartbeatLoopAsync(CancellationToken cancellationToken)
{
    _logger?.LogDebug("è¿›å…¥å¿ƒè·³å¾ªç¯ï¼Œå¿ƒè·³é—´éš”ï¼š{IntervalMs}ms", _heartbeatIntervalMs);

    while (!cancellationToken.IsCancellationRequested && _isHeartbeatRunning)
    {
        try
        {
            await Task.Delay(_heartbeatIntervalMs, cancellationToken).ConfigureAwait(false);

            // æ£€æŸ¥è¿æ¥çŠ¶æ€
            if (!_connectionManager.IsConnected)
            {
                _logger?.LogDebug("è¿æ¥å·²æ–­å¼€ï¼Œè·³è¿‡æœ¬æ¬¡å¿ƒè·³");
                // é‡ç½®å¿ƒè·³å¤±è´¥è®¡æ•°ï¼ˆè¿æ¥æ–­å¼€æ—¶é‡ç½®ï¼‰
                Interlocked.Exchange(ref _heartbeatFailedAttempts, 0);
                continue;
            }

            // å‘é€å¿ƒè·³
            bool success = await SendHeartbeatAsync(cancellationToken).ConfigureAwait(false);

            if (success)
            {
                // å¿ƒè·³æˆåŠŸ - é‡ç½®å¤±è´¥è®¡æ•°
                int previousFailures = Interlocked.Exchange(ref _heartbeatFailedAttempts, 0);
                _lastHeartbeatTime = DateTime.Now;

                if (previousFailures > 0)
                {
                    _logger?.LogInformation("âœ… å¿ƒè·³æ¢å¤ï¼Œä¹‹å‰è¿ç»­å¤±è´¥: {PreviousFailures}æ¬¡", previousFailures);
                }
                else
                {
                    _logger?.LogTrace("å¿ƒè·³æˆåŠŸ");
                }
            }
            else
            {
                // å¿ƒè·³å¤±è´¥ - é€’å¢è®¡æ•°
                int currentFailures = Interlocked.Increment(ref _heartbeatFailedAttempts);
                _logger?.LogWarning("âŒ å¿ƒè·³å¤±è´¥ï¼Œè¿ç»­å¤±è´¥: {CurrentFailures}/{Threshold}",
                    currentFailures, HEARTBEAT_FAILURE_THRESHOLD);

                // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°é”å®šé˜ˆå€¼
                if (currentFailures >= HEARTBEAT_FAILURE_THRESHOLD)
                {
                    _logger?.LogError("ğŸš¨ å¿ƒè·³å¤±è´¥è¾¾åˆ°é˜ˆå€¼({Threshold})ï¼Œè§¦å‘é”å®šæœºåˆ¶", HEARTBEAT_FAILURE_THRESHOLD);
                    TriggerLockout();
                }
            }
        }
        catch (OperationCanceledException)
        {
            _logger?.LogDebug("å¿ƒè·³å¾ªç¯è¢«å–æ¶ˆ");
            break;
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "å¿ƒè·³å¾ªç¯ä¸­å‘ç”Ÿå¼‚å¸¸");
            // å¼‚å¸¸æƒ…å†µä¸‹ä¹Ÿé€’å¢å¤±è´¥è®¡æ•°
            int currentFailures = Interlocked.Increment(ref _heartbeatFailedAttempts);
            if (currentFailures >= HEARTBEAT_FAILURE_THRESHOLD)
            {
                TriggerLockout();
            }
        }
    }

    _logger?.LogDebug("é€€å‡ºå¿ƒè·³å¾ªç¯");
}

/// <summary>
/// è§¦å‘é”å®šæœºåˆ¶ï¼ˆæ˜¾ç¤ºç™»å½•çª—ä½“ï¼‰
/// </summary>
private void TriggerLockout()
{
    _logger?.LogWarning("è§¦å‘å®¢æˆ·ç«¯é”å®šï¼Œæ˜¾ç¤ºç™»å½•çª—ä½“");

    // è§¦å‘é”å®šäº‹ä»¶ï¼Œç”±UIå±‚å¤„ç†
    Task.Run(() => HeartbeatFailureThresholdReached?.Invoke()).ConfigureAwait(false);
}
```

**ç®€åŒ–å‰**:
- åŠ¨æ€å¿ƒè·³é—´éš”ï¼ˆåŸºäºç½‘ç»œè´¨é‡è°ƒæ•´ï¼‰
- å¤±è´¥ç±»å‹æ£€æµ‹ï¼ˆè¶…æ—¶/ç½‘ç»œé”™è¯¯/æœåŠ¡å™¨ç¹å¿™/ä¼šè¯è¿‡æœŸï¼‰
- æ™ºèƒ½å¤±è´¥è¿½è¸ªå™¨ï¼ˆè®°å½•å¤±è´¥å†å²ï¼Œ2åˆ†é’Ÿå†…3æ¬¡åŒç±»å‹å¤±è´¥ï¼‰
- å¤æ‚çš„é˜ˆå€¼åˆ¤æ–­ï¼ˆæ™®é€šé˜ˆå€¼ + æ™ºèƒ½è¿½è¸ªå™¨ï¼‰

**ç®€åŒ–å**:
```csharp
/// <summary>
/// ç®€åŒ–çš„å¿ƒè·³å¾ªç¯
/// </summary>
private async Task HeartbeatLoopAsync(CancellationToken cancellationToken)
{
    _logger?.LogDebug("è¿›å…¥å¿ƒè·³å¾ªç¯ï¼Œå¿ƒè·³é—´éš”ï¼š{IntervalMs}ms", _heartbeatIntervalMs);

    while (!cancellationToken.IsCancellationRequested && _isHeartbeatRunning)
    {
        try
        {
            await Task.Delay(_heartbeatIntervalMs, cancellationToken).ConfigureAwait(false);

            // æ£€æŸ¥è¿æ¥çŠ¶æ€
            if (!_connectionManager.IsConnected)
            {
                _logger?.LogDebug("è¿æ¥å·²æ–­å¼€ï¼Œè·³è¿‡æœ¬æ¬¡å¿ƒè·³");
                continue;
            }

            // å‘é€å¿ƒè·³
            bool success = await SendHeartbeatAsync(cancellationToken).ConfigureAwait(false);

            if (success)
            {
                _logger?.LogTrace("å¿ƒè·³æˆåŠŸ");
                _lastHeartbeatTime = DateTime.Now;
            }
            else
            {
                _logger?.LogWarning("å¿ƒè·³å¤±è´¥");
                // è¿æ¥æ–­å¼€æ—¶ï¼ŒConnectionManagerä¼šè‡ªåŠ¨è§¦å‘é‡è¿
            }
        }
        catch (OperationCanceledException)
        {
            _logger?.LogDebug("å¿ƒè·³å¾ªç¯è¢«å–æ¶ˆ");
            break;
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "å¿ƒè·³å¾ªç¯ä¸­å‘ç”Ÿå¼‚å¸¸");
        }
    }
}
```

**ç§»é™¤çš„åŠŸèƒ½**:
- å¿ƒè·³é—´éš”åŠ¨æ€è°ƒæ•´
- å¿ƒè·³å¤±è´¥ç±»å‹æ£€æµ‹
- å¿ƒè·³å¤±è´¥è¿½è¸ªå™¨
- å¿ƒè·³å¤±è´¥é˜ˆå€¼é”å®šé€»è¾‘
- å¿ƒè·³ç»Ÿè®¡ï¼ˆæˆåŠŸ/å¤±è´¥æ¬¡æ•°ï¼‰

#### 2.3.3 é‡è¿æœºåˆ¶ç®€åŒ–

**ç®€åŒ–å‰**:
- æœ€å¤§é‡è¿æ¬¡æ•°é™åˆ¶ï¼ˆ5æ¬¡ï¼‰
- é‡è¿åœæ­¢æ ‡å¿— `_reconnectStopped`
- å¤æ‚çš„é‡è¿çŠ¶æ€åè°ƒï¼ˆå¤šä¸ªé”å’Œæ ‡å¿—ï¼‰

**ç®€åŒ–å**:
```csharp
/// <summary>
/// ç®€åŒ–çš„è‡ªåŠ¨é‡è¿é€»è¾‘
/// </summary>
private async Task ReconnectLoopAsync()
{
    int attempt = 0;

    while (!_disposed && _isReconnecting)
    {
        attempt++;

        try
        {
            // è§¦å‘é‡è¿å°è¯•äº‹ä»¶
            ReconnectAttempt?.Invoke(attempt, -1); // -1 è¡¨ç¤ºæ— æœ€å¤§æ¬¡æ•°é™åˆ¶

            // å°è¯•é‡è¿
            bool success = await _socketClient.ConnectAsync(_serverAddress, _serverPort);

            if (success)
            {
                _logger?.LogInformation("é‡è¿æˆåŠŸï¼ˆç¬¬{Attempt}æ¬¡å°è¯•ï¼‰", attempt);
                OnReconnectSucceeded();
                return; // é‡è¿æˆåŠŸï¼Œé€€å‡ºå¾ªç¯
            }
            else
            {
                _logger?.LogWarning("é‡è¿å¤±è´¥ï¼ˆç¬¬{Attempt}æ¬¡å°è¯•ï¼‰ï¼Œ{DelayMs}msåé‡è¯•",
                    attempt, _config.ReconnectDelayMs);
            }
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "é‡è¿ï¼ˆç¬¬{Attempt}æ¬¡å°è¯•ï¼‰æ—¶å‘ç”Ÿå¼‚å¸¸", attempt);
        }

        // ç­‰å¾…åç»§ç»­å°è¯•
        await Task.Delay(_config.ReconnectDelayMs, _cancellationTokenSource.Token);
    }
}
```

**ç§»é™¤çš„åŠŸèƒ½**:
- æœ€å¤§é‡è¿æ¬¡æ•°é™åˆ¶
- é‡è¿åœæ­¢æ ‡å¿—
- å¤æ‚çš„é‡è¿çŠ¶æ€åè°ƒ

**ä¿ç•™çš„åŠŸèƒ½**:
- æŒ‡æ•°é€€é¿ï¼ˆå¯é€‰ï¼‰
- æ‰‹åŠ¨åœæ­¢é‡è¿
- è¿æ¥æˆåŠŸåè‡ªåŠ¨åœæ­¢

#### 2.3.4 é”å®šé€»è¾‘ç®€åŒ–

**ç®€åŒ–å‰**:
- å¿ƒè·³å¤±è´¥è¾¾åˆ°é˜ˆå€¼ï¼ˆ3æ¬¡ï¼‰â†’ è§¦å‘é”å®šäº‹ä»¶
- æ™ºèƒ½è¿½è¸ªå™¨åˆ¤æ–­ï¼ˆ2åˆ†é’Ÿå†…3æ¬¡åŒç±»å‹å¤±è´¥ï¼‰â†’ è§¦å‘é”å®šäº‹ä»¶
- é”å®šåé‡è¿ç»§ç»­è¿è¡Œ â†’ é‡è¿æˆåŠŸ â†’ è§£é™¤é”å®š

**ç®€åŒ–å**:
- **ç§»é™¤è‡ªåŠ¨é”å®šé€»è¾‘**
- é”å®šçŠ¶æ€ä»…ç”±ç”¨æˆ·ç™»å½•çŠ¶æ€å†³å®š
- æœåŠ¡å™¨æ¢å¤åï¼Œç”¨æˆ·ç‚¹å‡»ç™»å½•æŒ‰é’®è§¦å‘é‡è¿

```csharp
/// <summary>
/// ç”¨æˆ·ç‚¹å‡»ç™»å½•æŒ‰é’®æ—¶çš„å¤„ç†
/// </summary>
public async Task<LoginResult> LoginAsync(LoginRequest request)
{
    try
    {
        _logger?.LogInformation("ç”¨æˆ·è¯·æ±‚ç™»å½•");

        // é‡ç½®æ‰€æœ‰çŠ¶æ€
        _isLoggedIn = false;

        // ç¡®ä¿è¿æ¥
        if (!_communicationService.ConnectionManager.IsConnected)
        {
            _logger?.LogInformation("å°è¯•è¿æ¥åˆ°æœåŠ¡å™¨...");
            bool connected = await _communicationService.ConnectionManager.ConnectAsync(
                request.ServerAddress, request.ServerPort);

            if (!connected)
            {
                _logger?.LogError("è¿æ¥æœåŠ¡å™¨å¤±è´¥");
                return LoginResult.Fail("è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨çŠ¶æ€");
            }
        }

        // å‘é€ç™»å½•è¯·æ±‚
        var response = await _communicationService.SendCommandAsync<LoginResponse>(loginPacket);

        if (response?.Success ?? false)
        {
            _isLoggedIn = true;
            _logger?.LogInformation("ç™»å½•æˆåŠŸ");

            // ç™»å½•æˆåŠŸåå¯åŠ¨å¿ƒè·³
            _communicationService.StartHeartbeat();

            return LoginResult.Success();
        }
        else
        {
            _logger?.LogError("ç™»å½•å¤±è´¥: {Message}", response?.Message);
            return LoginResult.Fail(response?.Message ?? "ç™»å½•å¤±è´¥");
        }
    }
    catch (Exception ex)
    {
        _logger?.LogError(ex, "ç™»å½•è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸");
        return LoginResult.Fail("ç™»å½•è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸: " + ex.Message);
    }
}
```

#### 2.3.5 äº‹ä»¶ç®€åŒ–

**ç®€åŒ–å‰**: 28ä¸ªäº‹ä»¶
**ç®€åŒ–å**: çº¦12ä¸ªæ ¸å¿ƒäº‹ä»¶

| äº‹ä»¶åç§° | æ¥æº | ç”¨é€” |
|---------|------|------|
| `ConnectionStateChanged` | ConnectionManager | è¿æ¥çŠ¶æ€å˜åŒ–ï¼ˆè¿æ¥/æ–­å¼€ï¼‰ |
| `ReconnectAttempt` | ConnectionManager | é‡è¿å°è¯•ï¼ˆä¼ é€’å°è¯•æ¬¡æ•°ï¼‰ |
| `ReconnectSucceeded` | ConnectionManager | é‡è¿æˆåŠŸ |
| `ReconnectFailed` | ConnectionManager | é‡è¿å¤±è´¥ï¼ˆå¯é€‰ï¼Œç”¨äºUIæ˜¾ç¤ºï¼‰ |
| `CommandReceived` | ClientCommunicationService | æ”¶åˆ°æœåŠ¡å™¨å‘½ä»¤ |
| `PacketReceived` | SuperSocketClient | æ”¶åˆ°åŸå§‹æ•°æ®åŒ… |
| `SocketClosed` | SuperSocketClient | Socketè¿æ¥å…³é—­ |
| `LoginStateChanged` | UserLoginService | ç™»å½•çŠ¶æ€å˜åŒ– |
| `SessionExpired` | UserLoginService | ä¼šè¯è¿‡æœŸ |
| `ErrorOccurred` | ClientEventManager | é”™è¯¯å‘ç”Ÿ |

**ç§»é™¤çš„äº‹ä»¶**:
- `HeartbeatFailed` - å¿ƒè·³å¤±è´¥ä¸éœ€è¦ç‰¹æ®Šå¤„ç†
- `HeartbeatRecovered` - å¿ƒè·³æ¢å¤ä¸éœ€è¦ç‰¹æ®Šå¤„ç†
- `HeartbeatFailureThresholdReached` - ç§»é™¤è‡ªåŠ¨é”å®šé€»è¾‘
- `ServerPushCommandReceived` - åˆå¹¶åˆ° `CommandReceived`
- `ConnectionStatusChanged` - åˆå¹¶åˆ° `ConnectionStateChanged`
- å¤šä¸ªé‡å¤çš„ `ReconnectFailed` äº‹ä»¶

### 2.4 ç®€åŒ–åçš„å®Œæ•´æµç¨‹

#### æµç¨‹1: æ­£å¸¸ç™»å½•

```
ç”¨æˆ·ç‚¹å‡»ç™»å½•
    â†“
UserLoginService.LoginAsync()
    â†“
ConnectionManager.ConnectAsync() (å¦‚æœæœªè¿æ¥)
    â†“
å‘é€ç™»å½•å‘½ä»¤
    â†“
ç­‰å¾…ç™»å½•å“åº”
    â†“
ç™»å½•æˆåŠŸ â†’ è®¾ç½® _isLoggedIn = true
    â†“
å¯åŠ¨å¿ƒè·³
    â†“
æ›´æ–°UIæ˜¾ç¤º
```

#### æµç¨‹2: è¿æ¥æ–­å¼€ + è‡ªåŠ¨é‡è¿

```
æœåŠ¡å™¨å…³é—­ / ç½‘ç»œä¸­æ–­
    â†“
SuperSocketClient.SocketClosed
    â†“
ConnectionManager.OnSocketClosed()
    â†“
è§¦å‘ ConnectionStateChanged(false)
    â†“
åœæ­¢å¿ƒè·³
    â†“
å¯åŠ¨è‡ªåŠ¨é‡è¿
    â†“
å¾ªç¯å°è¯•è¿æ¥ï¼ˆæ— é™åˆ¶æ¬¡æ•°ï¼‰
    â†“
è¿æ¥æˆåŠŸ â†’ è§¦å‘ ConnectionStateChanged(true)
    â†“
é‡è¿æˆåŠŸäº‹ä»¶
    â†“
å¦‚æœä¹‹å‰å·²ç™»å½•ï¼Œé‡æ–°å‘é€å¿ƒè·³
    â†“
UIæ˜¾ç¤º"å·²é‡æ–°è¿æ¥"
```

#### æµç¨‹3: æœåŠ¡å™¨æ¢å¤ + ç”¨æˆ·é‡æ–°ç™»å½•

```
æœåŠ¡å™¨æ¢å¤
    â†“
è‡ªåŠ¨é‡è¿ç»§ç»­è¿è¡Œ
    â†“
è¿æ¥æˆåŠŸ
    â†“
è§¦å‘ ReconnectSucceeded äº‹ä»¶
    â†“
UIæ˜¾ç¤º"æœåŠ¡å™¨å·²æ¢å¤"
    â†“
ç”¨æˆ·ç‚¹å‡»ç™»å½•æŒ‰é’®
    â†“
UserLoginService.LoginAsync()
    â†“
å‘é€ç™»å½•å‘½ä»¤
    â†“
ç™»å½•æˆåŠŸ â†’ æ¢å¤æ­£å¸¸ä½¿ç”¨
```

### 2.5 ç®€åŒ–å¸¦æ¥çš„ä¼˜åŠ¿

#### 2.5.1 ä»£ç å¤æ‚åº¦é™ä½

| æŒ‡æ ‡ | ç®€åŒ–å‰ | ç®€åŒ–å | é™ä½æ¯”ä¾‹ |
|------|--------|--------|---------|
| çŠ¶æ€å˜é‡æ•°é‡ | 26ä¸ª | 12ä¸ª | 54% |
| äº‹ä»¶æ•°é‡ | 28ä¸ª | 12ä¸ª | 57% |
| å¿ƒè·³ç›¸å…³ä»£ç è¡Œæ•° | ~500è¡Œ | ~100è¡Œ | 80% |
| é‡è¿ç›¸å…³ä»£ç è¡Œæ•° | ~400è¡Œ | ~150è¡Œ | 62% |

#### 2.5.2 ç»´æŠ¤æ€§æå‡

- **çŠ¶æ€ç®¡ç†æ¸…æ™°**: æ¯ä¸ªçŠ¶æ€åªæœ‰ä¸€ä¸ªçœŸå®æ¥æº
- **äº‹ä»¶æµç®€åŒ–**: å‡å°‘äº‹ä»¶è®¢é˜…å’Œè§¦å‘ç‚¹
- **é€»è¾‘è§£è€¦**: å¿ƒè·³ã€é‡è¿ã€é”å®šä¸å†ç´§å¯†è€¦åˆ
- **ä»£ç å¯è¯»æ€§**: å‡å°‘å¤æ‚çš„åˆ¤æ–­å’Œåè°ƒé€»è¾‘

#### 2.5.3 æ€§èƒ½æå‡

- å‡å°‘é”ç«äº‰ï¼ˆç§»é™¤å¤šä¸ªé”ï¼‰
- å‡å°‘çº¿ç¨‹åŒæ­¥å¼€é”€
- å‡å°‘å†…å­˜å ç”¨ï¼ˆç§»é™¤ç»Ÿè®¡å˜é‡å’Œå¤±è´¥è¿½è¸ªå™¨ï¼‰

#### 2.5.4 ç”¨æˆ·ä½“éªŒä¸€è‡´

- æœåŠ¡å™¨æ¢å¤åè‡ªåŠ¨é‡è¿ï¼ˆæ— æ¬¡æ•°é™åˆ¶ï¼‰
- ç™»å½•çŠ¶æ€æ¸…æ™°ï¼Œç”¨æˆ·æ˜ç¡®çŸ¥é“ä½•æ—¶éœ€è¦é‡æ–°ç™»å½•
- å‡å°‘è‡ªåŠ¨é”å®šå¸¦æ¥çš„å›°æƒ‘

## ä¸‰ã€å®æ–½è®¡åˆ’

### é˜¶æ®µ1: å‡†å¤‡å·¥ä½œï¼ˆ1å¤©ï¼‰

1. åˆ›å»ºåˆ†æ”¯ `simplify-connection-logic`
2. ç¼–å†™å•å…ƒæµ‹è¯•è¦†ç›–ç°æœ‰è¡Œä¸º
3. å¤‡ä»½å½“å‰å®ç°ï¼ˆç”¨äºå›æ»šï¼‰

### é˜¶æ®µ2: ç®€åŒ–å¿ƒè·³æœºåˆ¶ï¼ˆ2å¤©ï¼‰

1. ç§»é™¤å¿ƒè·³é—´éš”åŠ¨æ€è°ƒæ•´é€»è¾‘
2. ç§»é™¤å¿ƒè·³å¤±è´¥ç±»å‹æ£€æµ‹
3. ç§»é™¤å¿ƒè·³å¤±è´¥è¿½è¸ªå™¨
4. ç®€åŒ–å¿ƒè·³å¾ªç¯
5. ç§»é™¤ä¸å¿…è¦çš„äº‹ä»¶
6. æµ‹è¯•ï¼šå¿ƒè·³åœ¨è¿æ¥æ–­å¼€æ—¶åœæ­¢ï¼Œè¿æ¥æ¢å¤æ—¶ç»§ç»­

### é˜¶æ®µ3: ç®€åŒ–é‡è¿æœºåˆ¶ï¼ˆ2å¤©ï¼‰

1. ç§»é™¤æœ€å¤§é‡è¿æ¬¡æ•°é™åˆ¶
2. ç§»é™¤é‡è¿åœæ­¢æ ‡å¿—
3. ç®€åŒ–é‡è¿åè°ƒé€»è¾‘
4. åˆå¹¶é‡å¤çš„é‡è¿äº‹ä»¶
5. æµ‹è¯•ï¼šæœåŠ¡å™¨å…³é—­åé‡è¿æŒç»­è¿è¡Œï¼ŒæœåŠ¡å™¨æ¢å¤åè‡ªåŠ¨é‡è¿

### é˜¶æ®µ4: ç®€åŒ–é”å®šé€»è¾‘ï¼ˆ1å¤©ï¼‰

1. ç§»é™¤è‡ªåŠ¨é”å®šé€»è¾‘
2. ç§»é™¤å¿ƒè·³å¤±è´¥é˜ˆå€¼åˆ¤æ–­
3. æµ‹è¯•ï¼šç™»å½•çŠ¶æ€ç”±ç”¨æˆ·æ“ä½œå†³å®š

### é˜¶æ®µ5: çŠ¶æ€å’Œäº‹ä»¶æ¸…ç†ï¼ˆ1å¤©ï¼‰

1. ç§»é™¤å†—ä½™çš„çŠ¶æ€å˜é‡
2. ç§»é™¤é‡å¤çš„äº‹ä»¶
3. åˆå¹¶ç›¸ä¼¼äº‹ä»¶
4. æµ‹è¯•ï¼šç¡®ä¿æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

### é˜¶æ®µ6: é›†æˆæµ‹è¯•ï¼ˆ2å¤©ï¼‰

1. æµ‹è¯•æ­£å¸¸ç™»å½•æµç¨‹
2. æµ‹è¯•è¿æ¥æ–­å¼€å’Œé‡è¿æµç¨‹
3. æµ‹è¯•æœåŠ¡å™¨æ¢å¤å’Œé‡æ–°ç™»å½•æµç¨‹
4. æµ‹è¯•å„ç§å¼‚å¸¸åœºæ™¯ï¼ˆç½‘ç»œä¸­æ–­ã€æœåŠ¡å™¨å…³é—­ç­‰ï¼‰
5. æ€§èƒ½æµ‹è¯•

### é˜¶æ®µ7: ä»£ç å®¡æŸ¥å’Œä¼˜åŒ–ï¼ˆ1å¤©ï¼‰

1. ä»£ç å®¡æŸ¥
2. æ€§èƒ½ä¼˜åŒ–
3. æ–‡æ¡£æ›´æ–°
4. åˆå¹¶åˆ†æ”¯

### é˜¶æ®µ8: éƒ¨ç½²å’Œç›‘æ§ï¼ˆæŒç»­ï¼‰

1. ç°åº¦å‘å¸ƒ
2. ç›‘æ§å…³é”®æŒ‡æ ‡ï¼ˆè¿æ¥æˆåŠŸç‡ã€é‡è¿æˆåŠŸç‡ï¼‰
3. æ”¶é›†ç”¨æˆ·åé¦ˆ
4. æ ¹æ®åé¦ˆæŒç»­ä¼˜åŒ–

## å››ã€é£é™©è¯„ä¼°å’Œç¼“è§£æªæ–½

### 4.1 é£é™©è¯†åˆ«

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| ç®€åŒ–è¿‡åº¦å¯¼è‡´åŠŸèƒ½ç¼ºå¤± | é«˜ | ä½ | ä¿ç•™æ ¸å¿ƒåŠŸèƒ½ï¼Œç§»é™¤è¾¹ç¼˜ç‰¹æ€§ |
| ç”¨æˆ·ä½“éªŒä¸‹é™ | ä¸­ | ä¸­ | å……åˆ†æµ‹è¯•ï¼Œæ”¶é›†ç”¨æˆ·åé¦ˆ |
| ç°æœ‰åŠŸèƒ½å›å½’ | é«˜ | ä¸­ | å®Œæ•´çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯• |
| æ€§èƒ½é—®é¢˜ | ä½ | ä½ | æ€§èƒ½æµ‹è¯•ï¼ŒæŒç»­ç›‘æ§ |
| æ— æ³•å›æ»š | ä¸­ | ä½ | å¤‡ä»½å½“å‰å®ç°ï¼Œä½¿ç”¨ç‰¹æ€§å¼€å…³ |

### 4.2 å›æ»šè®¡åˆ’

1. å¦‚æœå‘ç°ä¸¥é‡é—®é¢˜ï¼Œç«‹å³å›æ»šåˆ°ä¹‹å‰ç‰ˆæœ¬
2. ä½¿ç”¨ git revert å¿«é€Ÿå›æ»š
3. ä¿ç•™å½“å‰å®ç°åˆ†æ”¯ï¼Œç”¨äºé—®é¢˜åˆ†æå’Œä¿®å¤

## äº”ã€æ€»ç»“

é€šè¿‡ä»¥ä¸Šåˆ†æå’Œè®¾è®¡ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š

1. **å½“å‰ç³»ç»Ÿç¡®å®å­˜åœ¨è¿‡åº¦å¤æ‚çš„é—®é¢˜**
   - 26ä¸ªçŠ¶æ€å˜é‡ï¼Œ28ä¸ªäº‹ä»¶
   - å¿ƒè·³ã€é‡è¿ã€é”å®šé€»è¾‘è¿‡åº¦è€¦åˆ
   - çŠ¶æ€åˆ†æ•£ï¼Œéš¾ä»¥ç»´æŠ¤

2. **ç®€åŒ–æ–¹æ¡ˆå¯ä»¥æ˜¾è‘—é™ä½å¤æ‚åº¦**
   - çŠ¶æ€å˜é‡å‡å°‘54%ï¼Œäº‹ä»¶å‡å°‘57%
   - å¿ƒè·³é€»è¾‘ä»£ç å‡å°‘80%ï¼Œé‡è¿é€»è¾‘ä»£ç å‡å°‘62%
   - æé«˜å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§

3. **ç®€åŒ–ä¸ä¼šå½±å“æ ¸å¿ƒåŠŸèƒ½**
   - è¿æ¥/æ–­å¼€åŠŸèƒ½ä¿ç•™
   - è‡ªåŠ¨é‡è¿åŠŸèƒ½ä¿ç•™ï¼ˆæ›´å¼ºï¼‰
   - ç™»å½•åŠŸèƒ½ä¿ç•™
   - å¿ƒè·³æ£€æµ‹åŠŸèƒ½ä¿ç•™ï¼ˆç®€åŒ–ç‰ˆï¼‰

4. **å®æ–½è®¡åˆ’æ¸…æ™°å¯è¡Œ**
   - åˆ†é˜¶æ®µå®æ–½ï¼Œæ¯é˜¶æ®µå¯æµ‹è¯•
   - é£é™©å¯æ§ï¼Œæœ‰å›æ»šè®¡åˆ’
   - æ€»è®¡çº¦10ä¸ªå·¥ä½œæ—¥

## å…­ã€å»ºè®®

åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘å»ºè®®ï¼š

1. **ç«‹å³å¯åŠ¨ç®€åŒ–å·¥ä½œ**ï¼Œå½“å‰ç³»ç»Ÿå¤æ‚åº¦å·²ç»å½±å“ç»´æŠ¤å’Œæ‰©å±•
2. **åˆ†é˜¶æ®µå®æ–½**ï¼Œæ¯é˜¶æ®µå……åˆ†æµ‹è¯•ï¼Œç¡®ä¿ç¨³å®šæ€§
3. **ä¿ç•™å¿…è¦çš„ç›‘æ§å’Œæ—¥å¿—**ï¼Œä¾¿äºé—®é¢˜å®šä½
4. **ç¼–å†™å……åˆ†çš„å•å…ƒæµ‹è¯•**ï¼Œç¡®ä¿ç®€åŒ–ä¸ä¼šå¼•å…¥å›å½’
5. **ä¸å›¢é˜Ÿå……åˆ†æ²Ÿé€š**ï¼Œç¡®ä¿å¤§å®¶ç†è§£ç®€åŒ–æ–¹æ¡ˆå’Œé¢„æœŸæ•ˆæœ

ç®€åŒ–åçš„ç³»ç»Ÿå°†æ›´åŠ æ¸…æ™°ã€ç¨³å®šã€æ˜“äºç»´æŠ¤ï¼ŒåŒæ—¶ä¿æŒæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ã€‚
