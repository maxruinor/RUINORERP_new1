# RUINORERP系统架构概述

## 1. 系统整体架构

RUINORERP是一个企业级ERP系统，采用客户端/服务器架构模式，使用C# .NET技术栈开发。系统分为两个主要部分：

1. **RUINORERP.Server** - 服务器端，负责核心业务逻辑处理、数据管理、网络通信和系统服务
2. **RUINORERP.UI** - 客户端，提供用户界面和本地业务处理

系统采用分层架构设计，从上到下包括：
- 表现层(UI层)
- 业务逻辑层(Business Layer)
- 服务层(Service Layer)
- 数据访问层(Data Access Layer)
- 基础设施层(Infrastructure Layer)

## 2. 技术架构

### 2.1 核心框架和技术
- **.NET Framework**: 主要开发平台
- **Autofac**: 依赖注入容器，用于组件解耦和服务管理
- **SuperSocket**: 网络通信框架，实现客户端与服务器间的实时通信
- **WorkflowCore**: 工作流引擎，支持复杂的业务流程自动化
- **SqlSugar**: ORM框架，简化数据库操作
- **CacheManager**: 缓存管理框架，提升系统性能

### 2.2 架构模式
- **C/S架构**: 客户端/服务器模式，保证数据安全和处理效率
- **命令模式**: 网络通信基于命令模式，便于扩展新的业务指令
- **事件驱动**: 使用事件机制处理系统内部通信
- **插件化设计**: 支持功能模块的动态加载和扩展

## 3. 核心模块分析

### 3.1 网络通信模块
服务器端使用SuperSocket框架构建网络通信服务，通过命令处理器(CommandHandlers)处理各类业务请求：
- [LoginCommandHandler](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/Network/CommandHandlers/LoginCommandHandler.cs#L10-L103): 处理用户登录认证
- [FileCommandHandler](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/Network/CommandHandlers/FileCommandHandler.cs#L10-L195): 处理文件上传下载
- [CacheCommandHandler](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/Network/CommandHandlers/CacheCommandHandler.cs#L10-L139): 处理缓存同步
- 其他业务命令处理器...

客户端通过对应的网络服务与服务器通信：
- [FileManagementService](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.UI/Network/Services/FileManagementService.cs#L9-L101): 文件管理服务

### 3.2 工作流模块
基于WorkflowCore引擎实现业务流程自动化：
- [ApprovalWorkflow](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/Workflow/WFApproval/ApprovalWorkflow.cs#L8-L42): 审批流程
- [InventorySnapshotWorkflow](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/Workflow/InventorySnapshotWorkflow.cs#L9-L33): 库存快照流程
- [DailyTaskWorkflow](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/Workflow/WFScheduled/DailyTaskWorkflow.cs#L8-L21): 日常任务流程

### 3.3 智能提醒模块
实现智能化业务提醒功能：
- [SmartReminderService](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/SmartReminder/SmartReminderService.cs#L12-L200): 提醒服务核心
- [SmartReminderMonitor](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/SmartReminder/SmartReminderMonitor.cs#L13-L110): 提醒监控器
- [SafetyStockStrategy](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/SmartReminder/ReminderRuleStrategy/SafetyStockStrategy.cs#L9-L50): 安全库存提醒策略
- [NotificationService](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/SmartReminder/NotificationService.cs#L8-L46): 通知服务

### 3.4 缓存管理模块
实现多层级缓存管理机制：
- [EntityCacheManager](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Business/Cache/EntityCacheManager.cs#L11-L128): 实体缓存管理器
- [DistributedCacheAdapter](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/Comm/DistributedCacheAdapter%20.cs#L10-L70): 分布式缓存适配器
- [MemoryCacheAdapter](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/Comm/MemoryCacheAdapter%20.cs#L9-L45): 内存缓存适配器

### 3.5 文件管理模块
提供完整的文件上传、下载和存储管理功能：
- [FileStorageService](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/Network/CoreServices/FileStorageService.cs#L11-L113): 文件存储服务
- [FileStorageManager](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/Network/Services/FileStorageManager.cs#L11-L251): 文件存储管理器
- [FileManagementHelper](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/Helpers/FileManagementHelper.cs#L8-L131): 文件管理助手

## 4. 系统启动流程

### 4.1 服务器端启动流程
1. [Program.cs](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/Program.cs#L11-L117)中的Main方法作为入口点
2. 调用[Startup.cs](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/Startup.cs#L13-L95)配置依赖注入和服务注册
3. 初始化工作流引擎
4. 启动SuperSocket网络服务
5. 显示主窗体[frmMainNew](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/frmMainNew.cs#L13-L271)

### 4.2 客户端启动流程
1. [Program.cs](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.UI/Program.cs#L14-L45)中的Main方法作为入口点
2. 调用[Startup.cs](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.UI/Startup.cs#L11-L48)配置依赖注入和服务注册
3. 初始化SuperSocket客户端连接
4. 显示登录窗体或主窗体

## 5. 依赖关系

### 5.1 服务器端项目依赖
```xml
<PackageReference Include="Autofac" Version="6.3.0" />
<PackageReference Include="AutoMapper" Version="10.1.1" />
<PackageReference Include="CacheManager.Core" Version="1.2.0" />
<PackageReference Include="CacheManager.Microsoft.Extensions.Caching.Memory" Version="1.2.0" />
<PackageReference Include="CacheManager.Serialization.Json" Version="1.2.0" />
<PackageReference Include="Microsoft.Extensions.Configuration" Version="5.0.0" />
<PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="5.0.2" />
<PackageReference Include="Newtonsoft.Json" Version="13.0.1" />
<PackageReference Include="SqlSugarCore" Version="5.0.3.5" />
<PackageReference Include="SuperSocket.Engine" Version="1.6.6.1" />
<PackageReference Include="SuperSocket.ProtoBase" Version="1.7.0.17" />
<PackageReference Include="System.Data.SqlClient" Version="4.8.3" />
<PackageReference Include="WorkflowCore" Version="3.6.2" />
```

### 5.2 客户端项目依赖
```xml
<PackageReference Include="Autofac" Version="6.3.0" />
<PackageReference Include="CacheManager.Core" Version="1.2.0" />
<PackageReference Include="CacheManager.Microsoft.Extensions.Caching.Memory" Version="1.2.0" />
<PackageReference Include="CacheManager.Serialization.Json" Version="1.2.0" />
<PackageReference Include="Newtonsoft.Json" Version="13.0.1" />
<PackageReference Include="SuperSocket.ClientEngine.Core" Version="0.10.0" />
<PackageReference Include="System.Data.SqlClient" Version="4.8.3" />
```

## 6. 数据流向

1. **客户端发起请求** -> 客户端UI层捕获用户操作
2. **请求封装与发送** -> 通过网络服务封装成命令包发送至服务器
3. **服务器接收处理** -> SuperSocket服务接收命令包并路由到对应处理器
4. **业务逻辑执行** -> 命令处理器调用相应业务服务处理请求
5. **数据持久化** -> 通过SqlSugar ORM进行数据库操作
6. **响应返回** -> 将处理结果封装成响应包返回给客户端
7. **客户端更新界面** -> 客户端接收到响应后更新UI显示

## 7. 安全机制

1. **身份认证**: 通过[LoginCommandHandler](file:///e:/CodeRepository/SynologyDrive/RUINORERP/RUINORERP.Server/Network/CommandHandlers/LoginCommandHandler.cs#L10-L103)实现用户登录验证
2. **会话管理**: 使用SessionInfo管理用户会话状态
3. **权限控制**: 基于角色的访问控制(RBAC)
4. **数据加密**: 敏感数据传输加密
5. **日志审计**: 记录关键操作日志用于审计追踪