# 费用报销单图片存储优化实施方案

## 一、实施背景

费用报销单的凭证图（EvidenceImagePath）原使用简单的路径字符串存储方式，存在以下问题：
1. 图片存储在本地，不同电脑无法共享查看
2. 缺乏统一的版本控制和去重机制
3. 删除单据时图片可能残留
4. 无法支持多张凭证图的管理

参考销售订单中已实现的文件服务器存储方案，对费用报销单进行优化改造。

## 二、技术方案

### 2.1 存储架构

```
费用报销单 (tb_FM_ExpenseClaim)
    ├── 结案凭证图 (CloseCaseImagePath) → 文件服务器
    │
    └── 费用报销单明细 (tb_FM_ExpenseClaimDetail)
            ├── 凭证图 (EvidenceImagePath) → 文件服务器
            └── 其他业务字段...
```

### 2.2 核心组件

1. **FileManagementController**：文件管理控制器
   - `UploadImageAsync`：上传文件到服务器
   - `DownloadImageAsync`：从服务器下载文件
   - `DeleteImagesAsync`：删除服务器文件
   - `ConvertToImageInfo`：转换文件信息

2. **MagicPictureBox**：自定义图片控件
   - `LoadImages`：加载单张或多张图片
   - `GetUpdatedImageBytesWithInfo`：获取变更的图片
   - `GetAllImageBytesWithInfo`：获取所有图片
   - `GetImagesNeedingUpdate`：获取需要更新的图片
   - `ClearImage`：清空图片

3. **文件服务器表结构**
   - `tb_FS_FileStorageInfo`：文件存储信息表
   - `tb_FS_BusinessRelation`：业务关联表
   - `tb_FS_FileStorageVersion`：文件版本表

## 三、实施内容

### 3.1 新增功能

#### 3.1.1 下载凭证图片

```csharp
/// <summary>
/// 下载并显示凭证图片
/// </summary>
private async Task DownloadVoucherImageAsync(tb_FM_ExpenseClaim entity, MagicPictureBox magicPicBox)
```

**功能说明**：
- 支持从文件服务器下载单张或多张凭证图片
- 自动处理图片信息转换（FileStorageInfo → ImageInfo）
- 统一的加载方法，自动处理单张和多张图片
- 完善的异常处理和日志记录

#### 3.1.2 上传凭证图片

```csharp
/// <summary>
/// 上传凭证图片
/// </summary>
private async Task<bool> UploadVoucherImageAsync(tb_FM_ExpenseClaim entity, MagicPictureBox magicPicBox,
    bool onlyUpdated = true, bool useVersionControl = false)
```

**功能说明**：
- 支持上传单张或多张凭证图片
- 支持只上传变更的图片（减少网络传输）
- 支持文件大小限制（10MB）
- 支持版本控制
- 自动哈希去重

#### 3.1.3 删除凭证图片

在 `Delete` 方法中集成图片删除功能：
```csharp
// 删除远程图片
var ctrpay = Startup.GetFromFac<FileManagementController>();
await ctrpay.DeleteImagesAsync(EditEntity, false);
```

### 3.2 修改内容

#### 3.2.1 BindData 方法

**修改前**：
```csharp
//显示结案凭证图片
LoadImageData(entity.CloseCaseImagePath);
base.BindData(entity);
```

**修改后**：
```csharp
// 异步下载并显示结案凭证图片（不阻塞BindData方法）
if (magicPictureBox1 != null)
{
    _ = Task.Run(async () =>
    {
        try
        {
            await DownloadVoucherImageAsync(entity, magicPictureBox1);
        }
        catch (Exception ex)
        {
            MainForm.Instance.logger.LogError(ex, "异步下载结案凭证图片异常");
        }
    });
}

base.BindData(entity);
```

**改进点**：
- 使用异步下载，不阻塞UI
- 使用 `Task.Run` 在后台线程执行，避免阻塞主线程
- 支持文件服务器方式
- 统一的错误处理
- **重要**：由于基类的 `BindData` 方法是同步的，不能直接使用 `await`，因此使用 `Task.Run` 在后台执行异步操作

#### 3.2.2 Save 方法

**修改前**：
```csharp
// 处理图片
bool uploadImg = await base.SaveFileToServer(sgd, EditEntity.tb_FM_ExpenseClaimDetails);
```

**修改后**：
```csharp
// 处理明细凭证图片上传（使用文件服务器方式）
bool uploadImg = await base.SaveFileToServer(sgd, EditEntity.tb_FM_ExpenseClaimDetails);
if (uploadImg)
{
    MainForm.Instance.PrintInfoLog($"明细凭证图片保存成功。");
}

// 保存成功后上传结案凭证图片（只上传变更的图片）
if (magicPictureBox1 != null)
{
    var updatedImages = magicPictureBox1.GetImagesNeedingUpdate();
    if (updatedImages.Count > 0)
    {
        await UploadVoucherImageAsync(EditEntity, magicPictureBox1);
    }
}
```

**改进点**：
- 明细凭证图使用基类的文件服务器方法
- 结案凭证图使用专门的UploadVoucherImageAsync方法
- 只上传变更的图片，提高效率
- 完善的日志反馈

#### 3.2.3 Delete 方法

**修改前**：
```csharp
// 逻辑删除，不执行删除远程图片操作
//await DeleteRemoteImages();
```

**修改后**：
```csharp
// 删除成功后，清空图片控件
if (magicPictureBox1 != null)
{
    magicPictureBox1.ClearImage();
}

// 删除远程图片
var ctrpay = Startup.GetFromFac<FileManagementController>();
await ctrpay.DeleteImagesAsync(EditEntity, false);
```

**改进点**：
- 使用统一的文件删除接口
- 支持物理删除和逻辑删除
- 清空UI控件

#### 3.2.4 魔法图片控件双击事件

**修改前**：
```csharp
private void MagicPictureBox1_DoubleClick(object sender, EventArgs e)
{
    // 单图片模式，打开文件选择对话框
    using (OpenFileDialog openFileDialog = new OpenFileDialog())
    {
        // ... 文件选择和加载逻辑
    }
}
```

**修改后**：
```csharp
/// <summary>
/// 结案凭证图片控件双击事件处理
/// </summary>
private void MagicPictureBox1_DoubleClick(object sender, EventArgs e)
{
    // MagicPictureBox已经内置了文件服务器的上传和下载功能
    // 无需额外处理，双击即可触发内置的上传/查看功能
}
```

**改进点**：
- 简化代码，移除重复逻辑
- 使用控件内置功能

### 3.3 删除内容

- `SaveImage` 方法：已不再需要，使用基类的 `SaveFileToServer`
- `DeleteRemoteImages` 方法：使用 `FileManagementController.DeleteImagesAsync` 替代
- `LoadImageData` 方法：合并到 `DownloadVoucherImageAsync` 中

## 四、技术实现说明

### 4.1 异步处理策略

#### 为什么在 BindData 中使用 Task.Run？

**问题**：
- 基类的 `BindData` 方法签名是同步的：`public virtual void BindData(T entity, ActionStatus actionStatus)`
- 无法直接在方法中使用 `await`，否则会报编译错误："await 运算符只能用于异步方法中"

**解决方案**：
```csharp
// 异步下载并显示结案凭证图片（不阻塞BindData方法）
if (magicPictureBox1 != null)
{
    _ = Task.Run(async () =>
    {
        try
        {
            await DownloadVoucherImageAsync(entity, magicPictureBox1);
        }
        catch (Exception ex)
        {
            MainForm.Instance.logger.LogError(ex, "异步下载结案凭证图片异常");
        }
    });
}
```

**技术优势**：
1. **不阻塞UI**：图片下载在后台线程执行，不会阻塞主线程
2. **保持兼容性**：不改变基类的方法签名，保持向后兼容
3. **安全处理**：使用 `try-catch` 捕获异常，防止后台线程异常导致程序崩溃
4. **性能优化**：图片加载不阻塞数据绑定，提升用户体验

**注意事项**：
- 使用 `_` 丢弃 `Task` 对象，表示我们不需要等待任务完成
- 这是 "fire and forget" 模式，适用于不需要等待结果的异步操作
- 如果需要等待图片加载完成，可以使用 `TaskCompletionSource` 或其他同步机制

### 4.2 与销售订单的对比

销售订单的 `BindData` 方法中图片下载的处理方式类似：
```csharp
// UCSaleOrder.cs:625
DownloadVoucherImageAsync(entity, magicPictureBox订金付款凭证);
```

两者都采用了后台异步下载的策略，确保不阻塞UI线程。

## 五、技术优势

### 4.1 与销售订单对比

| 功能点 | 销售订单 | 费用报销单（优化后） |
|--------|---------|---------------------|
| 图片存储方式 | 文件服务器 | 文件服务器 |
| 支持多图 | ✅ | ✅ |
| 版本控制 | ✅ | ✅ |
| 哈希去重 | ✅ | ✅ |
| 明细图片 | ✅ | ✅ |
| 主表图片 | ✅ | ✅ |
| 异步处理 | ✅ | ✅ |
| 文件大小限制 | ✅ | ✅ |

### 4.2 核心优势

1. **统一管理**：所有图片通过文件服务器统一管理
2. **去重机制**：基于哈希值的文件去重，节省存储空间
3. **版本控制**：支持文件版本管理，可追溯历史版本
4. **跨设备访问**：不同电脑可通过文件服务器访问同一图片
5. **安全性**：统一的权限控制和访问日志
6. **性能优化**：
   - 只上传变更的图片
   - 支持异步操作
   - 文件大小限制（10MB）

## 五、实施步骤

### 5.1 代码修改清单

1. ✅ 添加 `using RUINORERP.UI.Network.Services;`
2. ✅ 添加 `using RUINOR.WinFormsUI.CustomPictureBox;`
3. ✅ 添加 `DownloadVoucherImageAsync` 方法
4. ✅ 添加 `UploadVoucherImageAsync` 方法
5. ✅ 修改 `LoadImageData` 方法
6. ✅ 修改 `BindData` 方法
7. ✅ 修改 `Save` 方法
8. ✅ 修改 `Delete` 方法
9. ✅ 修改 `MagicPictureBox1_DoubleClick` 方法
10. ✅ 删除 `SaveImage` 方法
11. ✅ 删除 `DeleteRemoteImages` 方法

### 5.2 测试要点

1. **新增单据测试**
   - [ ] 新增费用报销单
   - [ ] 添加结案凭证图片（单张/多张）
   - [ ] 添加明细凭证图片
   - [ ] 保存单据
   - [ ] 验证图片上传成功

2. **加载单据测试**
   - [ ] 查询已有单据
   - [ ] 验证结案凭证图片正确加载
   - [ ] 验证明细凭证图片正确加载
   - [ ] 查看图片功能正常

3. **修改单据测试**
   - [ ] 修改凭证图片
   - [ ] 保存单据
   - [ ] 验证只上传变更的图片
   - [ ] 重新加载验证图片更新

4. **删除单据测试**
   - [ ] 删除单据
   - [ ] 验证图片已删除
   - [ ] 验证UI已清空

5. **异常场景测试**
   - [ ] 上传超大文件（>10MB）
   - [ ] 上传空文件
   - [ ] 网络异常场景
   - [ ] 文件服务器不可用

## 六、注意事项

1. **数据库兼容性**
   - `EvidenceImagePath` 字段保持不变（nvarchar(300)）
   - 字段值存储文件服务器返回的路径或ID
   - 历史数据迁移需要单独处理

2. **文件服务器配置**
   - 确保文件服务器服务正常启动
   - 配置正确的上传/下载URL
   - 检查存储路径权限

3. **性能考虑**
   - 大批量单据加载时考虑分批加载图片
   - 缩略图预览功能（可选）
   - 图片缓存机制（可选）

4. **权限控制**
   - 确保用户有上传/下载权限
   - 敏感图片访问控制（可选）

## 七、后续优化建议

1. **功能增强**
   - [ ] 支持图片压缩和格式转换
   - [ ] 支持图片预览和缩放
   - [ ] 支持拖拽上传
   - [ ] 支持批量导入

2. **性能优化**
   - [ ] 图片缓存机制
   - [ ] 懒加载图片
   - [ ] CDN加速（可选）

3. **功能扩展**
   - [ ] 支持视频文件
   - [ ] 支持文档附件
   - [ ] 支持在线预览

## 八、参考资料

- 销售订单图片处理：`UCSaleOrder.cs`
- 文件管理控制器：`FileManagementController.cs`
- 魔法图片控件：`MagicPictureBox.cs`
- 文件服务表结构：
  - `tb_FS_FileStorageInfo`
  - `tb_FS_BusinessRelation`
  - `tb_FS_FileStorageVersion`

## 九、版本历史

| 版本 | 日期 | 作者 | 说明 |
|------|------|------|------|
| V1.0 | 2025-01-18 | AI | 初始版本，基于销售订单实现费用报销单图片存储优化 |

