# ERP系统重构部署指南

## 1. 部署前准备

### 1.1 环境要求
- .NET Framework 4.8 或更高版本
- SQL Server 2016 或更高版本
- IIS 7.5 或更高版本
- 至少 4GB RAM，建议 8GB 以上
- 至少 50GB 可用磁盘空间

### 1.2 数据库备份
在部署前，务必对生产数据库进行完整备份：
```sql
BACKUP DATABASE [RUINORERP] TO DISK = N'D:\\Backups\\RUINORERP_PreDeploy_Backup.bak' WITH INIT, COMPRESSION
```

### 1.3 代码包准备
- 从源代码管理系统获取最新稳定版本
- 执行编译命令生成发布包：
  ```
  msbuild RUINORERP.sln /p:Configuration=Release /p:Platform="Any CPU"
  ```

## 2. 数据库更新

### 2.1 运行数据库迁移脚本
执行以下SQL脚本以创建操作日志表和更新索引：

```sql
-- 创建操作日志表
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'tb_OperationLog')
BEGIN
    CREATE TABLE [dbo].[tb_OperationLog]
    (
        [Log_ID] UNIQUEIDENTIFIER NOT NULL PRIMARY KEY,
        [OperationType] NVARCHAR(100) NOT NULL,
        [OperationID] NVARCHAR(100) NOT NULL,
        [SourceDocumentType] NVARCHAR(100) NULL,
        [SourceDocumentID] BIGINT NULL,
        [TargetDocumentType] NVARCHAR(100) NULL,
        [TargetDocumentID] BIGINT NULL,
        [Status] NVARCHAR(50) NOT NULL,
        [Message] NVARCHAR(MAX) NULL,
        [CreatedTime] DATETIME NOT NULL,
        [CreatedBy] NVARCHAR(100) NULL
    );
    
    -- 创建索引以提高查询性能
    CREATE INDEX IX_OperationLog_OperationID ON [dbo].[tb_OperationLog]([OperationID]);
    CREATE INDEX IX_OperationLog_SourceDocument ON [dbo].[tb_OperationLog]([SourceDocumentType], [SourceDocumentID]);
    CREATE INDEX IX_OperationLog_CreatedTime ON [dbo].[tb_OperationLog]([CreatedTime]);
END

-- 更新现有表的索引（如果需要）
IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_tb_Bill_LockStatus' AND object_id = OBJECT_ID('tb_Bill'))
BEGIN
    CREATE INDEX IX_tb_Bill_LockStatus ON tb_Bill(LockStatus, LockTime);
END
```

## 3. 应用部署

### 3.1 Web应用部署
1. 停止当前运行的ERP应用程序池
2. 将编译好的文件复制到IIS网站目录
3. 更新Web.config中的配置项：

```xml
<appSettings>
    <!-- 重试机制配置 -->
    <add key="ActionManager.DefaultRetryCount" value="3" />
    <add key="ActionManager.DefaultRetryIntervalMs" value="1000" />
    <!-- 单据锁定超时配置（毫秒） -->
    <add key="BillLock.TimeoutMs" value="300000" />
    <!-- 启用详细日志 -->
    <add key="EnableDetailedLogging" value="false" />
</appSettings>
```

4. 启动应用程序池

### 3.2 服务端部署
如果ERP系统包含Windows服务组件：
1. 停止现有服务
2. 替换服务可执行文件
3. 更新服务配置文件
4. 重启服务

## 4. 配置依赖注入

确保在应用程序启动时正确注册优化后的组件：

```csharp
// 在Global.asax或启动类中注册依赖
protected void Application_Start()
{
    // 现有初始化代码...
    
    // 注册DocumentConverterFactory和ActionManager
    container.Register<DocumentConverterFactory>(Lifetime.Singleton);
    container.Register<ActionManager>(Lifetime.Transient);
    
    // 注册日志记录器
    container.Register<ILogger<DocumentConverterFactory>>(...);
    container.Register<ILogger<ActionManager>>(...);
    
    // 注册数据库客户端
    container.Register<ISqlSugarClient>(...);
}
```

## 5. 监控系统性能

### 5.1 关键性能指标
- 单据转换操作响应时间
- 数据库锁等待时间
- 工作流执行成功率
- 系统资源使用率（CPU、内存、磁盘I/O）

### 5.2 监控工具配置

#### 5.2.1 应用程序监控
在Global.asax中添加性能监控过滤器：

```csharp
protected void Application_Start()
{
    // 注册性能监控过滤器
    GlobalFilters.Filters.Add(new PerformanceMonitorAttribute());
}
```

#### 5.2.2 数据库性能监控
创建监控存储过程以跟踪操作性能：

```sql
CREATE PROCEDURE [dbo].[sp_MonitorOperationPerformance]
    @HoursBack INT = 24
AS
BEGIN
    SELECT 
        OperationType,
        Status,
        COUNT(*) AS OperationCount,
        AVG(DATEDIFF(ms, CreatedTime, GETDATE())) AS AvgDurationMs
    FROM tb_OperationLog
    WHERE CreatedTime > DATEADD(HOUR, -@HoursBack, GETDATE())
    GROUP BY OperationType, Status
    ORDER BY OperationCount DESC;
END
```

### 5.3 性能警报设置
配置以下关键警报：
- 当操作失败率超过5%时发出警报
- 当转换操作平均响应时间超过2秒时发出警报
- 当数据库锁等待时间超过500ms时发出警报

## 6. 回滚计划

### 6.1 数据库回滚
如果部署出现问题，执行数据库回滚：

```sql
RESTORE DATABASE [RUINORERP] FROM DISK = N'D:\\Backups\\RUINORERP_PreDeploy_Backup.bak' WITH REPLACE
```

### 6.2 应用程序回滚
1. 停止当前应用程序池
2. 将备份的应用程序文件恢复到网站目录
3. 恢复原始Web.config文件
4. 重启应用程序池

## 7. 部署时间安排

建议在业务低峰期进行部署，推荐时间：
- 工作日凌晨2:00-5:00
- 周末上午8:00-12:00

## 8. 后续维护

### 8.1 定期清理操作日志
创建清理日志的作业，保留最近30天的数据：

```sql
CREATE PROCEDURE [dbo].[sp_CleanupOperationLogs]
    @RetentionDays INT = 30
AS
BEGIN
    DELETE FROM tb_OperationLog
    WHERE CreatedTime < DATEADD(DAY, -@RetentionDays, GETDATE());
END
```

### 8.2 性能调优建议
- 定期检查并优化数据库索引
- 监控并调整连接池大小
- 根据实际负载调整重试参数
- 定期分析操作日志，识别频繁失败的操作并优化

## 9. 联系人信息

- 技术负责人：[负责人姓名]
- 紧急联系人：[联系人姓名] - [电话号码]
- 支持邮箱：[support@company.com]

---

**部署完成后，请执行功能验证测试，并密切监控系统性能24小时。**