# 产品配方管理系统技术实施方案

## 项目概述
本方案旨在优化和完善现有产品配方管理系统，通过UI整合、功能增强、查询跟踪强化、成本管控完善和系统集成保障，提升用户体验和系统可靠性。

## 一、现有系统分析

### 1.1 文件结构与功能

**现有文件：**
- `UCBillOfMaterialsTracker.cs`：产品配方追溯和查询功能
- `UCBillOfMaterialsService.cs`：产品配方维护和多版本管理
- `UCBillOfMaterialsQuery.cs`：产品配方查询和筛选
- `UCBillOfMaterials.cs`：产品配方创建、编辑、复制和Excel导出

**主要功能分布：**
- 创建/编辑/复制配方：UCBillOfMaterials.cs
- 查询/筛选配方：UCBillOfMaterialsQuery.cs
- 配方追踪/分析：UCBillOfMaterialsTracker.cs
- 多版本管理：UCBillOfMaterialsService.cs

### 1.2 数据结构现状

- **BOM主表(tb_BOM_S)**：基本配方信息、状态管理、成本字段
- **BOM详情表(tb_BOM_SDetail)**：子物料信息、成本字段
- **BOM配置历史表(tb_BOMConfigHistory)**：版本管理
- **生产缴库表(tb_FinishedGoodsInv)**：关联生产订单、更新库存和成本

## 二、UI窗体整合方案

### 2.1 整合目标
将现有四个分散的配方管理文件功能整合为两个核心窗体：
1. **配方编辑窗体**：包含创建、修改、复制和维护功能
2. **配方查询窗体**：集成所有查询和跟踪相关功能

### 2.2 配方编辑窗体设计

**类名：** `UCBillOfMaterialsEditor`

**继承结构：** 继承自`BaseBillEditGeneric<tb_BOM_S, tb_BOM_SDetail>`

**功能整合：**
- 从`UCBillOfMaterials.cs`整合核心编辑功能
- 从`UCBillOfMaterialsService.cs`整合版本管理功能
- 增加模板功能和批量操作界面

**界面布局：**
- 顶部：操作工具栏（新增、修改、删除、复制、模板、导出）
- 上部：基本信息区域（BOM编号、名称、版本等）
- 中部：配方明细树形视图（支持多级展开）
- 下部：成本汇总区域
- 右侧：属性面板（当前选中项详情）

**核心方法设计：**
```csharp
public partial class UCBillOfMaterialsEditor : BaseBillEditGeneric<tb_BOM_S, tb_BOM_SDetail>
{
    // 构造函数和初始化
    public UCBillOfMaterialsEditor()
    {
        InitializeComponent();
        InitUIComponents();
    }
    
    // 核心编辑方法
    public override async Task<bool> SaveBillAsync() { ... }
    
    // 版本管理相关方法
    public async Task CreateNewVersionAsync(string reason) { ... }
    public void CompareVersions(long oldVersionId, long newVersionId) { ... }
    
    // 模板相关方法
    public async Task SaveAsTemplateAsync(string templateName) { ... }
    public async Task ApplyTemplateAsync(long templateId) { ... }
    
    // 批量操作方法
    public async Task BatchUpdateCostsAsync() { ... }
    public async Task BatchReplaceComponentsAsync(long oldComponentId, long newComponentId) { ... }
}
```

### 2.3 配方查询窗体设计

**类名：** `UCBillOfMaterialsSearch`

**继承结构：** 继承自`BaseBillQueryMC<View_BOM, tb_BOM_SDetail>`

**功能整合：**
- 从`UCBillOfMaterialsQuery.cs`整合查询功能
- 从`UCBillOfMaterialsTracker.cs`整合追溯分析功能
- 增加高级搜索和自定义查询条件保存

**界面布局：**
- 顶部：工具栏（搜索、高级搜索、保存条件、历史记录）
- 左侧：查询条件面板（可折叠）
- 中上部：主查询结果列表
- 中下部：详情预览区域
- 右侧：关系图谱/分析图表区域

**核心方法设计：**
```csharp
public partial class UCBillOfMaterialsSearch : BaseBillQueryMC<View_BOM, tb_BOM_SDetail>
{
    // 构造函数
    public UCBillOfMaterialsSearch()
    {
        InitializeComponent();
        InitQueryComponents();
    }
    
    // 查询相关方法
    protected async override void QueryAsync(bool useAutoNavQuery = false) { ... }
    public async Task SaveQueryCriteriaAsync(string criteriaName) { ... }
    public async Task LoadQueryCriteriaAsync(long criteriaId) { ... }
    
    // 分析相关方法
    public void ShowComponentUsageAnalysis(long componentId) { ... }
    public void GenerateRelationshipGraph(List<long> bomIds) { ... }
    
    // 右键菜单和快捷操作
    private void SetContextMenuStripForAdvancedActions() { ... }
}
```

### 2.4 实现步骤

1. **创建新窗体文件**
   - 创建`UCBillOfMaterialsEditor.cs`
   - 创建`UCBillOfMaterialsSearch.cs`

2. **迁移现有功能**
   - 从`UCBillOfMaterials.cs`迁移核心编辑逻辑
   - 从`UCBillOfMaterialsQuery.cs`迁移查询逻辑
   - 从`UCBillOfMaterialsTracker.cs`迁移追溯功能
   - 从`UCBillOfMaterialsService.cs`迁移版本管理

3. **整合UI组件**
   - 设计统一的工具栏和菜单结构
   - 整合查询条件面板
   - 优化树形数据展示

4. **添加导航逻辑**
   - 实现编辑窗体和查询窗体间的切换
   - 优化打开相关单据的逻辑

5. **更新菜单定义**
   - 添加新窗体到系统菜单
   - 设置适当的权限控制

## 三、配方创建功能增强技术方案

### 3.1 配方模板功能设计

#### 3.1.1 数据结构设计

```csharp
// BOM模板表实体类
public class tb_BOM_Template
{
    [SugarColumn(IsPrimaryKey = true, IsIdentity = true)]
    public int TemplateId { get; set; }
    
    public string TemplateName { get; set; }
    
    public string Description { get; set; }
    
    public string CreatedBy { get; set; }
    
    public DateTime CreatedDate { get; set; }
    
    public string LastModifiedBy { get; set; }
    
    public DateTime? LastModifiedDate { get; set; }
    
    public bool IsSystemTemplate { get; set; }
    
    public bool IsPublic { get; set; }
    
    // 导航属性
    [SugarColumn(IsIgnore = true)]
    public List<tb_BOM_TemplateDetail> TemplateDetails { get; set; }
}

// BOM模板详情表实体类
public class tb_BOM_TemplateDetail
{
    [SugarColumn(IsPrimaryKey = true, IsIdentity = true)]
    public int TemplateDetailId { get; set; }
    
    public int TemplateId { get; set; }
    
    public int ProdDetailID { get; set; }
    
    public decimal UsedQty { get; set; }
    
    public string Unit { get; set; }
    
    public decimal StandardCost { get; set; }
    
    public int? ParentDetailID { get; set; }
    
    public int SortOrder { get; set; }
    
    // 导航属性
    [SugarColumn(IsIgnore = true)]
    public tb_Product Product { get; set; }
}
```

#### 3.1.2 模板服务类设计

```csharp
public class BOMTemplateService
{
    // 保存配方为模板
    public async Task<int> SaveAsTemplateAsync(int bomId, string templateName, string description, bool isPublic)
    
    // 根据模板创建配方
    public async Task<tb_BOM_S> CreateBOMFromTemplateAsync(int templateId, tb_BOM_S bomHeader)
    
    // 获取可用模板列表
    public async Task<List<tb_BOM_Template>> GetAvailableTemplatesAsync(string userId)
    
    // 删除模板
    public async Task<bool> DeleteTemplateAsync(int templateId, string userId)
    
    // 更新模板
    public async Task<bool> UpdateTemplateAsync(tb_BOM_Template template)
}
```

### 3.2 批量导入/导出功能设计

#### 3.2.1 导入功能实现

```csharp
public class BOMImportService
{
    // 从Excel导入配方
    public async Task<ImportResult> ImportFromExcelAsync(Stream excelStream, ImportOptions options)
    
    // 验证导入数据
    public async Task<ValidationResult> ValidateImportDataAsync(List<ImportBOMItem> bomItems)
    
    // 导入预览
    public async Task<List<ImportPreviewItem>> GetImportPreviewAsync(Stream excelStream)
    
    // 处理导入结果
    private async Task<ImportResult> ProcessImportDataAsync(List<ImportBOMItem> validItems, ImportOptions options)
}

// 导入选项
public class ImportOptions
{
    public bool OverrideExisting { get; set; } = false;
    public bool AutoApproveAfterImport { get; set; } = false;
    public bool ImportAsTemplate { get; set; } = false;
    public string DefaultCreator { get; set; }
}
```

#### 3.2.2 导出功能增强

```csharp
public class BOMExportService
{
    // 导出配方到Excel（支持多配方批量导出）
    public async Task<byte[]> ExportToExcelAsync(List<int> bomIds, ExportOptions options)
    
    // 导出导入模板（用于指导用户如何填写导入数据）
    public async Task<byte[]> ExportImportTemplateAsync()
    
    // 导出配方关系结构
    public async Task<byte[]> ExportStructureAsync(int bomId)
}

// 导出选项
public class ExportOptions
{
    public bool IncludeCostDetails { get; set; } = true;
    public bool IncludeVersionHistory { get; set; } = false;
    public bool ExportAsImportFormat { get; set; } = false;
    public bool IncludeSubLevels { get; set; } = true;
}
```

### 3.3 UI交互流程优化

#### 3.3.1 快速创建配方流程

1. **一步式创建**：将原有多步骤创建流程整合为单页面向导式界面
2. **智能填充**：根据产品信息自动填充常用字段
3. **批量添加子项**：支持从最近使用列表快速添加多个子项
4. **拖放式层级调整**：允许用户通过拖放直观调整配方结构层级
5. **快捷键支持**：增加常用操作的快捷键支持

#### 3.3.2 界面组件设计

```csharp
// 快速创建配方向导组件
public partial class BOMQuickCreateWizard : KryptonForm
{
    // 初始化向导
    public BOMQuickCreateWizard(int? templateId = null)
    
    // 获取创建的配方
    public tb_BOM_S GetCreatedBOM()
    
    // 向导页面导航
    private void NavigateToPage(int pageIndex)
    
    // 验证当前页面
    private bool ValidateCurrentPage()
}

// 批量添加子项对话框
public partial class BatchAddComponentsDialog : KryptonForm
{
    // 构造函数
    public BatchAddComponentsDialog()
    
    // 获取选择的组件列表
    public List<SelectedComponent> GetSelectedComponents()
    
    // 加载最近使用的组件
    private async Task LoadRecentComponentsAsync()
    
    // 搜索组件
    private async Task SearchComponentsAsync(string keyword)
}
```

### 3.4 智能推荐功能设计

#### 3.4.1 推荐服务类

```csharp
public class BOMRecommendationService
{
    // 获取推荐组件
    public async Task<List<RecommendedComponent>> GetRecommendedComponentsAsync(int productId, int takeCount = 10)
    
    // 获取推荐比例
    public async Task<decimal> GetRecommendedRatioAsync(int parentProductId, int componentProductId)
    
    // 根据历史数据生成配方建议
    public async Task<List<RecipeSuggestion>> GenerateRecipeSuggestionsAsync(int productId)
    
    // 分析配方差异
    public async Task<RecipeDifference> AnalyzeRecipeDifferenceAsync(int bomId1, int bomId2)
}

// 推荐组件
public class RecommendedComponent
{
    public int ProductId { get; set; }
    public string ProductName { get; set; }
    public string ProductCode { get; set; }
    public decimal RecommendedQuantity { get; set; }
    public string Unit { get; set; }
    public decimal UsageFrequency { get; set; } // 使用频率分数
    public decimal AverageCost { get; set; }
}
```

#### 3.4.2 数据挖掘算法

1. **协同过滤**：基于历史配方使用模式推荐组件
2. **关联规则挖掘**：发现经常一起使用的组件组合
3. **时间序列分析**：识别季节性或趋势性的配方变化
4. **聚类分析**：对相似产品的配方进行分组，提取共同特征

### 3.5 实现步骤

1. **数据库设计与迁移**：
   - 创建BOM模板相关表结构
   - 编写数据库迁移脚本

2. **服务层实现**：
   - 实现模板服务类
   - 实现导入导出服务类
   - 实现智能推荐服务类

3. **UI层实现**：
   - 在配方编辑窗体中添加模板选择功能
   - 实现批量导入导出界面
   - 添加快速创建配方向导
   - 实现智能推荐面板

4. **集成与测试**：
   - 与现有系统功能集成
   - 编写单元测试和集成测试
   - 进行性能测试和用户体验测试

## 四、配方查询与跟踪功能强化方案

### 4.1 高级右键菜单功能设计

#### 4.1.1 菜单结构设计

```csharp
public class BOMContextMenuManager
{
    // 创建主右键菜单
    public ContextMenuStrip CreateMainContextMenu(UCBillOfMaterialsExplorer parentForm)
    
    // 创建详情右键菜单
    public ContextMenuStrip CreateDetailContextMenu(UCBillOfMaterialsExplorer parentForm)
    
    // 根据选中项动态生成菜单
    public void UpdateContextMenuItems(ContextMenuStrip menuStrip, object selectedItem, UserPermission permission)
    
    // 添加快捷操作菜单项
    private void AddQuickActionItems(ContextMenuStrip menuStrip)
    
    // 添加分析功能菜单项
    private void AddAnalysisItems(ContextMenuStrip menuStrip)
    
    // 添加版本管理菜单项
    private void AddVersionManagementItems(ContextMenuStrip menuStrip)
}
```

#### 4.1.2 菜单功能实现

```csharp
// 在UCBillOfMaterialsExplorer中实现右键菜单
private void SetContextMenuStripForSelect(object sender, DataGridViewCellMouseEventArgs e)
{
    if (e.Button == MouseButtons.Right)
    {
        // 获取选中的行和列
        kryptonDataGridViewBOM.Rows[e.RowIndex].Selected = true;
        
        // 创建上下文菜单管理器
        var menuManager = new BOMContextMenuManager();
        
        // 根据选中内容创建不同的菜单
        if (e.ColumnIndex >= 0 && e.RowIndex >= 0)
        {
            ContextMenuStrip menuStrip = e.ColumnIndex == 0 
                ? menuManager.CreateMainContextMenu(this) 
                : menuManager.CreateDetailContextMenu(this);
            
            // 显示右键菜单
            menuStrip.Show(kryptonDataGridViewBOM, e.Location);
        }
    }
}
```

### 4.2 自定义查询条件保存功能

#### 4.2.1 数据结构设计

```csharp
// 查询条件保存表
public class tb_BOMQueryCriteria
{
    [SugarColumn(IsPrimaryKey = true, IsIdentity = true)]
    public int CriteriaId { get; set; }
    
    public string UserId { get; set; }
    
    public string CriteriaName { get; set; }
    
    public string CriteriaJson { get; set; } // 存储查询条件的JSON格式
    
    public bool IsPublic { get; set; }
    
    public DateTime CreatedDate { get; set; }
    
    public DateTime? LastUsedDate { get; set; }
    
    public int UseCount { get; set; }
}
```

#### 4.2.2 查询条件管理服务

```csharp
public class BOMQueryCriteriaService
{
    // 保存查询条件
    public async Task<int> SaveQueryCriteriaAsync(string userId, string criteriaName, string criteriaJson, bool isPublic = false)
    
    // 获取用户的查询条件列表
    public async Task<List<tb_BOMQueryCriteria>> GetUserQueryCriteriaAsync(string userId)
    
    // 获取查询条件详情
    public async Task<tb_BOMQueryCriteria> GetQueryCriteriaByIdAsync(int criteriaId)
    
    // 更新查询条件
    public async Task<bool> UpdateQueryCriteriaAsync(int criteriaId, string criteriaName, string criteriaJson, bool isPublic)
    
    // 删除查询条件
    public async Task<bool> DeleteQueryCriteriaAsync(int criteriaId, string userId)
    
    // 应用查询条件
    public void ApplyQueryCriteria(string criteriaJson, UCBillOfMaterialsExplorer explorer)
}
```

#### 4.2.3 UI实现

```csharp
// 保存查询条件对话框
public partial class SaveQueryCriteriaDialog : KryptonForm
{
    public SaveQueryCriteriaDialog()
    
    // 获取保存参数
    public SaveCriteriaParams GetSaveParams()
    
    // 验证输入
    private bool ValidateInput()
}

// 在UCBillOfMaterialsExplorer中实现
private void SaveSearchCriteria()
{
    using (var dialog = new SaveQueryCriteriaDialog())
    {
        if (dialog.ShowDialog() == DialogResult.OK)
        {
            var params = dialog.GetSaveParams();
            var criteriaJson = JsonConvert.SerializeObject(GetCurrentQueryConditions());
            
            var service = new BOMQueryCriteriaService();
            service.SaveQueryCriteriaAsync(CurrentUser.UserId, params.CriteriaName, criteriaJson, params.IsPublic);
            
            // 刷新查询条件下拉列表
            LoadSearchCriteria();
        }
    }
}

private void LoadSearchCriteria()
{
    kryptonComboBoxSavedCriteria.Items.Clear();
    
    var service = new BOMQueryCriteriaService();
    var criteriaList = await service.GetUserQueryCriteriaAsync(CurrentUser.UserId);
    
    foreach (var criteria in criteriaList.OrderByDescending(c => c.LastUsedDate))
    {
        kryptonComboBoxSavedCriteria.Items.Add(new CriteriaListItem(criteria));
    }
}
```

### 4.3 配方变更历史追踪功能

#### 4.3.1 数据结构扩展

```csharp
// BOM变更历史表（扩展现有tb_BOMConfigHistory）
public class tb_BOM_ChangeHistory
{
    [SugarColumn(IsPrimaryKey = true, IsIdentity = true)]
    public long ChangeId { get; set; }
    
    public int BOM_ID { get; set; }
    
    public int BOM_S_VERID { get; set; } // 关联到tb_BOMConfigHistory
    
    public string ChangeType { get; set; } // 枚举：CREATE, MODIFY, DELETE, APPROVE, REJECT
    
    public string ChangedBy { get; set; }
    
    public DateTime ChangedDate { get; set; }
    
    public string ChangeDescription { get; set; }
    
    public string OldValues { get; set; } // JSON格式存储变更前值
    
    public string NewValues { get; set; } // JSON格式存储变更后值
    
    public string IPAddress { get; set; }
    
    public string ClientInfo { get; set; }
    
    // 导航属性
    [SugarColumn(IsIgnore = true)]
    public tb_BOM_S BOM { get; set; }
}
```

#### 4.3.2 变更历史服务类

```csharp
public class BOMChangeHistoryService
{
    // 记录BOM变更
    public async Task<long> LogBOMChangeAsync(int bomId, string changeType, string changedBy, 
                                                  object oldValues, object newValues, string description = null)
    
    // 获取BOM变更历史
    public async Task<List<tb_BOM_ChangeHistory>> GetBOMHistoryAsync(int bomId, int? limit = null)
    
    // 比较两个版本差异
    public async Task<List<PropertyChange>> CompareVersionsAsync(int bomId, int oldVersionId, int newVersionId)
    
    // 获取影响的BOM列表
    public async Task<List<tb_BOM_S>> GetAffectedBOMsAsync(int bomId)
    
    // 导出变更历史
    public async Task<byte[]> ExportHistoryAsync(int bomId, string format = "excel")
}

// 属性变更记录
public class PropertyChange
{
    public string PropertyName { get; set; }
    public string DisplayName { get; set; }
    public string OldValue { get; set; }
    public string NewValue { get; set; }
    public string ChangeType { get; set; }
}
```

#### 4.3.3 历史查看器实现

```csharp
public partial class BOMHistoryViewer : KryptonForm
{
    public BOMHistoryViewer(int bomId)
    
    // 加载历史记录
    private async Task LoadHistoryAsync()
    
    // 显示版本差异
    private void ShowVersionDifference(int oldVersionId, int newVersionId)
    
    // 导出历史记录
    private async void ExportHistoryButton_Click(object sender, EventArgs e)
    
    // 恢复到指定版本
    private async void RestoreToVersionButton_Click(object sender, EventArgs e)
}
```

### 4.4 配方使用情况分析功能

#### 4.4.1 分析服务类

```csharp
public class BOMUsageAnalysisService
{
    // 获取配方使用频率
    public async Task<BOMUsageStats> GetBOMUsageStatsAsync(int bomId, DateTime startDate, DateTime endDate)
    
    // 获取配方生产数量统计
    public async Task<List<ProductionStat>> GetProductionStatsAsync(int bomId, DateTime startDate, DateTime endDate, string interval = "month")
    
    // 获取配方成本趋势
    public async Task<List<CostTrendPoint>> GetCostTrendAsync(int bomId, DateTime startDate, DateTime endDate)
    
    // 获取配方变更影响分析
    public async Task<ChangeImpactAnalysis> GetChangeImpactAnalysisAsync(int bomId)
    
    // 获取相关生产订单
    public async Task<List<tb_ProductionOrder>> GetRelatedProductionOrdersAsync(int bomId, int limit = 50)
}

// BOM使用统计
public class BOMUsageStats
{
    public int BOMId { get; set; }
    public string BOMName { get; set; }
    public int UsageCount { get; set; }
    public decimal TotalProductionQuantity { get; set; }
    public decimal TotalMaterialCost { get; set; }
    public decimal AverageProductionCycle { get; set; }
    public List<TopProduct> TopProducts { get; set; }
}
```

#### 4.4.2 分析图表实现

```csharp
public partial class BOMUsageAnalysisForm : KryptonForm
{
    public BOMUsageAnalysisForm(int bomId)
    
    // 加载使用统计
    private async Task LoadUsageStatsAsync()
    
    // 绘制使用频率图表
    private void DrawUsageFrequencyChart(List<ProductionStat> stats)
    
    // 绘制成本趋势图表
    private void DrawCostTrendChart(List<CostTrendPoint> trendPoints)
    
    // 导出分析报告
    private async void ExportAnalysisReportAsync()
}
```

### 4.5 可视化的配方关系图谱设计

#### 4.5.1 图形数据模型

```csharp
public class BOMRelationshipGraph
{
    public List<GraphNode> Nodes { get; set; } = new List<GraphNode>();
    public List<GraphEdge> Edges { get; set; } = new List<GraphEdge>();
    
    // 添加节点
    public void AddNode(GraphNode node)
    
    // 添加边
    public void AddEdge(GraphEdge edge)
    
    // 清除所有数据
    public void Clear()
}

public class GraphNode
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Type { get; set; } // BOM, PRODUCT, MATERIAL
    public decimal Cost { get; set; }
    public int Level { get; set; }
    public NodeStatus Status { get; set; }
    public Point Position { get; set; }
}

public class GraphEdge
{
    public int SourceId { get; set; }
    public int TargetId { get; set; }
    public decimal Quantity { get; set; }
    public string Unit { get; set; }
    public decimal Cost { get; set; }
}

public enum NodeStatus { Normal, Warning, Error, Selected, Highlighted }
```

#### 4.5.2 图形绘制引擎

```csharp
public class BOMGraphRenderer
{
    // 绘制关系图谱
    public void RenderGraph(Graphics g, BOMRelationshipGraph graph, Rectangle bounds)
    
    // 自动布局算法
    public void AutoLayoutGraph(BOMRelationshipGraph graph, Rectangle bounds)
    
    // 查找节点
    public GraphNode FindNodeAt(Point point, BOMRelationshipGraph graph)
    
    // 高亮相关节点
    public void HighlightRelatedNodes(BOMRelationshipGraph graph, int nodeId, bool recursive = false)
    
    // 缩放和滚动功能
    public void Zoom(float factor, Point centerPoint)
    public void Pan(int deltaX, int deltaY)
}
```

#### 4.5.3 关系图谱窗体

```csharp
public partial class BOMRelationshipViewer : KryptonForm
{
    private BOMRelationshipGraph _graph;
    private BOMGraphRenderer _renderer;
    private int _rootBomId;
    
    public BOMRelationshipViewer(int bomId, int maxDepth = 3)
    
    // 加载关系数据
    private async Task LoadRelationshipDataAsync(int bomId, int maxDepth)
    
    // 处理绘图事件
    private void GraphPanel_Paint(object sender, PaintEventArgs e)
    
    // 处理鼠标事件
    private void GraphPanel_MouseDown(object sender, MouseEventArgs e)
    private void GraphPanel_MouseMove(object sender, MouseEventArgs e)
    private void GraphPanel_MouseUp(object sender, MouseEventArgs e)
    
    // 导出关系图
    private void ExportGraphButton_Click(object sender, EventArgs e)
    
    // 节点右键菜单
    private void ShowNodeContextMenu(GraphNode node, Point point)
}
```

### 4.6 实现步骤

1. **数据结构扩展**：
   - 创建查询条件保存表
   - 扩展BOM变更历史表
   - 设计分析结果数据模型

2. **服务层实现**：
   - 实现右键菜单管理服务
   - 实现查询条件服务
   - 实现变更历史服务
   - 实现使用情况分析服务
   - 实现图形渲染服务

3. **UI层实现**：
   - 在配方查询窗体中集成所有新功能
   - 实现各种对话框和查看器
   - 优化用户交互体验

4. **性能优化**：
   - 实现数据缓存机制
   - 优化大数据量下的查询性能
   - 实现图形渲染优化

## 五、成本管控与审计系统完善方案

### 5.1 扩展产品成本审计功能

#### 5.1.1 审计日志数据结构

```csharp
// 成本变动审计日志表
public class tb_CostAuditLog
{
    [SugarColumn(IsPrimaryKey = true, IsIdentity = true)]
    public long LogId { get; set; }
    
    public string EntityType { get; set; } // BOM, PRODUCT, MATERIAL
    public int EntityId { get; set; }
    public string EntityCode { get; set; }
    public string EntityName { get; set; }
    
    public string OperationType { get; set; } // CREATE, UPDATE, DELETE, ADJUST
    public string CostType { get; set; } // DIRECT_MATERIAL, LABOR, OVERHEAD, TOTAL
    
    public decimal OldCost { get; set; }
    public decimal NewCost { get; set; }
    public decimal CostDifference { get; set; }
    
    public string ChangeReason { get; set; }
    public string ChangedBy { get; set; }
    public DateTime ChangedDate { get; set; }
    
    public string SourceDocument { get; set; } // 来源单据类型
    public string SourceDocumentNo { get; set; } // 来源单据编号
    
    public string IPAddress { get; set; }
    public string ClientInfo { get; set; }
    
    public string AdditionalInfo { get; set; } // JSON格式存储其他相关信息
}
```

#### 5.1.2 审计服务类

```csharp
public class CostAuditService
{
    // 记录成本变动
    public async Task<long> LogCostChangeAsync(string entityType, int entityId, string entityCode, string entityName,
                                             string operationType, string costType, decimal oldCost, decimal newCost,
                                             string changeReason, string changedBy, string sourceDocument = null,
                                             string sourceDocumentNo = null, object additionalInfo = null)
    
    // 获取实体成本审计日志
    public async Task<List<tb_CostAuditLog>> GetEntityAuditLogsAsync(string entityType, int entityId, int? limit = null)
    
    // 获取成本变动统计
    public async Task<CostAuditStats> GetCostAuditStatsAsync(DateTime startDate, DateTime endDate, string entityType = null)
    
    // 导出审计日志
    public async Task<byte[]> ExportAuditLogsAsync(DateTime startDate, DateTime endDate, string format = "excel")
    
    // 生成审计报告
    public async Task<byte[]> GenerateAuditReportAsync(DateTime startDate, DateTime endDate, string reportType = "summary")
}

// 成本审计统计
public class CostAuditStats
{
    public int TotalChanges { get; set; }
    public decimal TotalCostIncrease { get; set; }
    public decimal TotalCostDecrease { get; set; }
    public decimal NetCostChange { get; set; }
    public List<CostChangeByType> ChangesByType { get; set; }
    public List<TopChangedEntity> TopChangedEntities { get; set; }
}
```

### 5.2 全流程成本变动记录

#### 5.2.1 采购入库成本记录

```csharp
// 在采购入库处理中添加成本审计
public class PurchaseReceiptCostAuditor
{
    // 记录采购入库成本变动
    public async Task LogPurchaseReceiptCostAsync(tb_PurchaseReceipt receipt, List<tb_PurchaseReceiptDetail> details)
    
    // 计算材料成本影响
    public async Task<List<MaterialCostImpact>> CalculateMaterialCostImpactAsync(List<tb_PurchaseReceiptDetail> details)
    
    // 处理采购退货成本
    public async Task LogPurchaseReturnCostAsync(tb_PurchaseReturn returnDoc, List<tb_PurchaseReturnDetail> details)
}
```

#### 5.2.2 生产缴库成本记录

```csharp
// 在生产缴库处理中添加成本审计
public class ProductionReceiptCostAuditor
{
    // 记录生产缴库成本变动
    public async Task LogProductionReceiptCostAsync(tb_ProductionReceipt receipt, List<tb_ProductionReceiptDetail> details)
    
    // 计算生产成本分布
    public async Task<ProductionCostDistribution> CalculateProductionCostDistributionAsync(int bomId, decimal quantity)
    
    // 更新产品标准成本
    public async Task UpdateProductStandardCostAsync(int productId, decimal newCost, string changeReason, string changedBy)
}
```

#### 5.2.3 盘点差异成本记录

```csharp
// 在盘点处理中添加成本审计
public class InventoryCheckCostAuditor
{
    // 记录盘点差异成本
    public async Task LogInventoryCheckCostAsync(tb_InventoryCheck checkDoc, List<tb_InventoryCheckDetail> details)
    
    // 计算盘点盈亏成本
    public async Task<InventoryCostVariance> CalculateInventoryVarianceAsync(List<tb_InventoryCheckDetail> details)
    
    // 生成盘点成本调整单
    public async Task<tb_CostAdjustmentDoc> GenerateCostAdjustmentDocAsync(tb_InventoryCheck checkDoc, InventoryCostVariance variance)
}
```

### 5.3 成本加权平均计算服务集成

#### 5.3.1 加权平均计算服务

```csharp
public class WeightedAverageCostService
{
    // 计算材料加权平均成本
    public async Task<decimal> CalculateMaterialWeightedAverageCostAsync(int materialId, bool updateStandardCost = false)
    
    // 计算BOM加权平均成本
    public async Task<decimal> CalculateBOMWeightedAverageCostAsync(int bomId, bool updateStandardCost = false)
    
    // 计算产品加权平均成本
    public async Task<decimal> CalculateProductWeightedAverageCostAsync(int productId, bool updateStandardCost = false)
    
    // 批量更新加权平均成本
    public async Task BatchUpdateWeightedAverageCostsAsync(DateTime lastUpdateTime)
    
    // 获取成本计算明细
    public async Task<CostCalculationDetails> GetCostCalculationDetailsAsync(int entityId, string entityType)
}

// 成本计算明细
public class CostCalculationDetails
{
    public int EntityId { get; set; }
    public string EntityType { get; set; }
    public decimal WeightedAverageCost { get; set; }
    public List<CostComponent> Components { get; set; }
    public List<CostTransaction> Transactions { get; set; }
}
```

#### 5.3.2 实时成本计算触发器

```csharp
public class CostCalculationTrigger
{
    // 采购入库后触发成本计算
    public async Task OnPurchaseReceiptSavedAsync(tb_PurchaseReceipt receipt)
    
    // 生产缴库后触发成本计算
    public async Task OnProductionReceiptSavedAsync(tb_ProductionReceipt receipt)
    
    // 配方变更后触发成本重新计算
    public async Task OnBOMChangedAsync(int bomId)
    
    // 库存变动后触发成本计算
    public async Task OnInventoryChangedAsync(int materialId)
    
    // 批量触发成本计算
    public async Task TriggerBatchCostCalculationAsync(List<int> entityIds, string entityType)
}
```

### 5.4 成本变动预警机制

#### 5.4.1 预警配置数据结构

```csharp
// 成本预警配置表
public class tb_CostAlertConfig
{
    [SugarColumn(IsPrimaryKey = true, IsIdentity = true)]
    public int ConfigId { get; set; }
    
    public string AlertType { get; set; } // ABSOLUTE, PERCENTAGE, TREND
    public string EntityType { get; set; } // MATERIAL, BOM, PRODUCT
    public int? EntityId { get; set; } // 可为空，表示所有该类型实体
    
    public decimal ThresholdValue { get; set; }
    public string ComparisonOperator { get; set; } // >, <, >=, <=, ==, !=
    
    public string AlertLevel { get; set; } // INFO, WARNING, ERROR, CRITICAL
    public string NotificationMethod { get; set; } // EMAIL, SYSTEM, BOTH
    
    public List<string> AlertRecipients { get; set; }
    public bool IsActive { get; set; }
    public DateTime CreatedDate { get; set; }
    public DateTime LastModifiedDate { get; set; }
}
```

#### 5.4.2 预警服务类

```csharp
public class CostAlertService
{
    // 检查成本变动是否触发预警
    public async Task<List<CostAlert>> CheckCostAlertsAsync(string entityType, int entityId, decimal oldCost, decimal newCost)
    
    // 发送成本预警
    public async Task SendCostAlertAsync(CostAlert alert)
    
    // 获取预警配置
    public async Task<List<tb_CostAlertConfig>> GetAlertConfigsAsync(string entityType = null, int? entityId = null)
    
    // 管理预警配置
    public async Task<tb_CostAlertConfig> CreateAlertConfigAsync(tb_CostAlertConfig config)
    public async Task<bool> UpdateAlertConfigAsync(tb_CostAlertConfig config)
    public async Task<bool> DeleteAlertConfigAsync(int configId)
    
    // 获取预警历史
    public async Task<List<CostAlertHistory>> GetAlertHistoryAsync(DateTime startDate, DateTime endDate, string alertLevel = null)
}

// 成本预警
public class CostAlert
{
    public int AlertId { get; set; }
    public int ConfigId { get; set; }
    public string AlertType { get; set; }
    public string EntityType { get; set; }
    public int EntityId { get; set; }
    public string EntityName { get; set; }
    public string AlertLevel { get; set; }
    public decimal OldCost { get; set; }
    public decimal NewCost { get; set; }
    public decimal CostChange { get; set; }
    public decimal CostChangePercentage { get; set; }
    public string Message { get; set; }
    public DateTime AlertTime { get; set; }
    public bool IsAcknowledged { get; set; }
}
```

### 5.5 成本趋势分析图表

#### 5.5.1 趋势数据模型

```csharp
// 成本趋势数据点
public class CostTrendPoint
{
    public DateTime Date { get; set; }
    public decimal DirectMaterialCost { get; set; }
    public decimal LaborCost { get; set; }
    public decimal OverheadCost { get; set; }
    public decimal TotalCost { get; set; }
    public string PeriodLabel { get; set; } // 用于显示
}

// 成本分析维度
public class CostAnalysisDimension
{
    public string DimensionName { get; set; }
    public string DimensionValue { get; set; }
    public decimal CostValue { get; set; }
    public decimal Percentage { get; set; }
}
```

#### 5.5.2 趋势分析服务

```csharp
public class CostTrendAnalysisService
{
    // 获取实体成本趋势
    public async Task<List<CostTrendPoint>> GetEntityCostTrendAsync(string entityType, int entityId, 
                                                                  DateTime startDate, DateTime endDate,
                                                                  string interval = "month")
    
    // 获取成本构成分析
    public async Task<List<CostAnalysisDimension>> GetCostCompositionAsync(string entityType, int entityId, 
                                                                          DateTime? analysisDate = null)
    
    // 获取成本对比分析
    public async Task<List<CostComparisonResult>> GetCostComparisonAsync(List<int> entityIds, string entityType,
                                                                       DateTime startDate, DateTime endDate)
    
    // 获取成本异常检测
    public async Task<List<CostAnomaly>> DetectCostAnomaliesAsync(string entityType, int entityId, 
                                                                DateTime startDate, DateTime endDate)
}
```

#### 5.5.3 图表展示实现

```csharp
public partial class CostTrendAnalysisForm : KryptonForm
{
    public CostTrendAnalysisForm(string entityType, int entityId)
    
    // 加载趋势数据
    private async Task LoadTrendDataAsync(DateTime startDate, DateTime endDate, string interval)
    
    // 绘制趋势图表
    private void DrawTrendChart(List<CostTrendPoint> trendPoints)
    
    // 绘制成本构成饼图
    private void DrawCostCompositionPieChart(List<CostAnalysisDimension> composition)
    
    // 导出图表
    private void ExportChartsButton_Click(object sender, EventArgs e)
    
    // 保存分析视图设置
    private void SaveAnalysisViewSettings()
}
```

### 5.6 成本模拟功能

#### 5.6.1 模拟数据模型

```csharp
// 成本模拟方案
public class CostSimulationScenario
{
    public int ScenarioId { get; set; }
    public string ScenarioName { get; set; }
    public string Description { get; set; }
    public int BaseBOMId { get; set; }
    public decimal BaseCost { get; set; }
    public List<CostSimulationChange> Changes { get; set; }
    public decimal SimulatedCost { get; set; }
    public decimal CostDifference { get; set; }
    public decimal CostDifferencePercentage { get; set; }
    public string CreatedBy { get; set; }
    public DateTime CreatedDate { get; set; }
    public bool IsSaved { get; set; }
}

// 成本模拟变更项
public class CostSimulationChange
{
    public int ChangeId { get; set; }
    public int ScenarioId { get; set; }
    public string ChangeType { get; set; } // COMPONENT_QUANTITY, COMPONENT_REPLACE, COST_ADJUST
    public int ComponentId { get; set; }
    public string ComponentName { get; set; }
    public decimal OldValue { get; set; }
    public decimal NewValue { get; set; }
    public string Unit { get; set; }
    public decimal ImpactOnCost { get; set; }
}
```

#### 5.6.2 模拟服务类

```csharp
public class CostSimulationService
{
    // 创建新的模拟方案
    public async Task<CostSimulationScenario> CreateSimulationScenarioAsync(string scenarioName, string description, int baseBOMId)
    
    // 添加模拟变更
    public async Task<CostSimulationChange> AddSimulationChangeAsync(int scenarioId, string changeType, int componentId,
                                                                   decimal oldValue, decimal newValue, string unit = null)
    
    // 计算模拟成本
    public async Task<decimal> CalculateSimulatedCostAsync(int scenarioId)
    
    // 保存模拟方案
    public async Task<CostSimulationScenario> SaveSimulationScenarioAsync(CostSimulationScenario scenario)
    
    // 获取保存的模拟方案
    public async Task<List<CostSimulationScenario>> GetSavedScenariosAsync(string userId = null)
    
    // 比较多个模拟方案
    public async Task<ScenarioComparisonResult> CompareScenariosAsync(List<int> scenarioIds)
    
    // 应用模拟方案到实际BOM
    public async Task<ApplyScenarioResult> ApplyScenarioToBOMAsync(int scenarioId, string reason, string appliedBy)
}
```

#### 5.6.3 模拟界面实现

```csharp
public partial class CostSimulationForm : KryptonForm
{
    private CostSimulationScenario _currentScenario;
    private CostSimulationService _simulationService;
    
    public CostSimulationForm(int baseBOMId)
    
    // 初始化模拟方案
    private async Task InitializeScenarioAsync(int baseBOMId)
    
    // 添加组件数量变更
    private async void AddQuantityChangeButton_Click(object sender, EventArgs e)
    
    // 添加组件替换
    private async void ReplaceComponentButton_Click(object sender, EventArgs e)
    
    // 添加成本调整
    private async void AddCostAdjustmentButton_Click(object sender, EventArgs e)
    
    // 计算模拟结果
    private async void CalculateSimulationButton_Click(object sender, EventArgs e)
    
    // 比较不同方案
    private async void CompareScenariosButton_Click(object sender, EventArgs e)
    
    // 保存当前方案
    private async void SaveScenarioButton_Click(object sender, EventArgs e)
    
    // 应用到实际BOM
    private async void ApplyToActualBOMButton_Click(object sender, EventArgs e)
}
```

### 5.7 实现步骤

1. **数据结构设计**：
   - 创建成本审计日志表
   - 设计成本预警配置表
   - 定义成本模拟相关表

2. **服务层实现**：
   - 实现审计服务
   - 实现全流程成本记录服务
   - 实现加权平均成本计算服务
   - 实现预警服务
   - 实现趋势分析服务
   - 实现成本模拟服务

3. **集成点实现**：
   - 在采购入库流程中集成成本记录
   - 在生产缴库流程中集成成本记录
   - 在盘点流程中集成成本记录
   - 在配方变更流程中集成成本重新计算

4. **UI层实现**：
   - 实现成本审计日志查看界面
   - 实现成本预警配置界面
   - 实现成本趋势分析图表界面
   - 实现成本模拟界面

5. **测试与优化**：
   - 验证各流程成本记录的完整性
   - 测试成本计算的准确性
   - 优化大数据量下的查询性能

## 六、系统集成与数据一致性保障方案

### 6.1 系统架构集成设计

#### 6.1.1 模块集成架构

```csharp
// 配方管理系统集成架构类
public class BOMSystemIntegrationManager
{
    // 初始化所有集成点
    public void InitializeIntegrations()
    
    // 获取服务实例
    public T GetServiceInstance<T>() where T : class
    
    // 注册事件监听器
    public void RegisterEventListeners()
    
    // 初始化依赖注入容器
    public void InitializeDependencyContainer()
}
```

#### 6.1.2 服务依赖管理

```csharp
// 依赖注册类
public class BOMServiceRegistry
{
    // 注册核心服务
    public static void RegisterCoreServices(IServiceCollection services)
    {
        // 注册配方相关服务
        services.AddScoped<IBOMService, BOMService>();
        services.AddScoped<IBOMTemplateService, BOMTemplateService>();
        
        // 注册查询和跟踪服务
        services.AddScoped<IBOMQueryService, BOMQueryService>();
        services.AddScoped<IBOMTrackingService, BOMTrackingService>();
        
        // 注册成本相关服务
        services.AddScoped<ICostAuditService, CostAuditService>();
        services.AddScoped<IWeightedAverageCostService, WeightedAverageCostService>();
        services.AddScoped<ICostSimulationService, CostSimulationService>();
        
        // 注册数据一致性服务
        services.AddScoped<IDataValidationService, DataValidationService>();
        services.AddScoped<ITransactionManager, TransactionManager>();
    }
}
```

### 6.2 数据验证机制

#### 6.2.1 验证规则引擎

```csharp
// 数据验证规则引擎
public class DataValidationEngine
{
    // 验证实体数据
    public ValidationResult ValidateEntity<T>(T entity) where T : class
    
    // 获取验证规则列表
    public List<ValidationRule<T>> GetValidationRules<T>() where T : class
    
    // 注册自定义验证规则
    public void RegisterValidationRule<T>(ValidationRule<T> rule) where T : class
    
    // 验证BOM结构完整性
    public ValidationResult ValidateBOMStructure(tb_BOM_S bom, List<tb_BOM_SDetail> details)
    
    // 验证成本数据一致性
    public ValidationResult ValidateCostDataConsistency(tb_BOM_S bom, List<tb_BOM_SDetail> details)
}

// 验证规则基类
public abstract class ValidationRule<T>
{
    public abstract ValidationResult Validate(T entity);
    public abstract string RuleName { get; }
    public abstract string ErrorMessage { get; }
}
```

#### 6.2.2 BOM专用验证规则

```csharp
// BOM完整性验证规则
public class BOMIntegrityValidationRule : ValidationRule<tb_BOM_S>
{
    private readonly List<tb_BOM_SDetail> _details;
    
    public BOMIntegrityValidationRule(List<tb_BOM_SDetail> details)
    {
        _details = details;
    }
    
    public override ValidationResult Validate(tb_BOM_S bom)
    {
        // 实现验证逻辑
        // 1. 检查BOM是否有至少一个组件
        // 2. 验证父子关系是否正确
        // 3. 验证所有引用的物料是否存在
    }
    
    public override string RuleName => "BOMIntegrity";
    public override string ErrorMessage => "BOM结构不完整";
}

// 成本合理性验证规则
public class BOMCostValidationRule : ValidationRule<tb_BOM_S>
{
    private readonly List<tb_BOM_SDetail> _details;
    
    public BOMCostValidationRule(List<tb_BOM_SDetail> details)
    {
        _details = details;
    }
    
    public override ValidationResult Validate(tb_BOM_S bom)
    {
        // 实现成本合理性验证
        // 1. 检查成本计算是否合理
        // 2. 验证成本是否在预期范围内
        // 3. 检查组件成本是否正确累加
    }
    
    public override string RuleName => "BOMCostValidity";
    public override string ErrorMessage => "BOM成本数据不合理";
}
```

#### 6.2.3 UI层验证实现

```csharp
// BOM编辑界面中的验证实现
public partial class UCBillOfMaterialsEditor
{
    // 表单验证
    private bool ValidateFormData()
    {
        // 创建验证引擎
        var validationEngine = new DataValidationEngine();
        
        // 收集当前表单数据
        var bomData = CollectBOMData();
        var detailData = CollectBOMDetails();
        
        // 执行验证
        var result = validationEngine.ValidateBOMStructure(bomData, detailData);
        
        // 显示验证错误
        if (!result.IsValid)
        {
            DisplayValidationErrors(result.Errors);
            return false;
        }
        
        return true;
    }
    
    // 实时字段验证
    private void txtFieldName_Validating(object sender, CancelEventArgs e)
    {
        // 执行字段级验证
    }
}
```

### 6.3 操作权限精细化管理

#### 6.3.1 权限模型设计

```csharp
// 配方管理权限模型
public class BOMPermissionModel
{
    public int PermissionId { get; set; }
    public string PermissionCode { get; set; }
    public string PermissionName { get; set; }
    public string Description { get; set; }
    public string ResourceType { get; set; }
    public string Operation { get; set; }
    public bool IsBasePermission { get; set; }
}
```

#### 6.3.2 权限服务类

```csharp
// 权限管理服务
public class BOMPermissionService
{
    // 检查用户是否有指定权限
    public async Task<bool> HasPermissionAsync(string userId, string permissionCode, int? resourceId = null)
    
    // 获取用户所有权限
    public async Task<List<BOMPermissionModel>> GetUserPermissionsAsync(string userId)
    
    // 验证操作权限
    public async Task<PermissionValidationResult> ValidateOperationAsync(string userId, string operation, int? resourceId = null)
    
    // 获取可访问的BOM列表
    public async Task<List<int>> GetAccessibleBOMIdsAsync(string userId, string operation = null)
}
```

#### 6.3.3 权限检查装饰器

```csharp
// 权限检查装饰器模式实现
public class BOMPermissionDecorator : IBOMService
{
    private readonly IBOMService _innerService;
    private readonly BOMPermissionService _permissionService;
    private readonly IUserContext _userContext;
    
    public BOMPermissionDecorator(IBOMService innerService, 
                                 BOMPermissionService permissionService,
                                 IUserContext userContext)
    {
        _innerService = innerService;
        _permissionService = permissionService;
        _userContext = userContext;
    }
    
    // 装饰器方法实现
    public async Task<tb_BOM_S> GetBOMByIdAsync(int bomId)
    {
        // 检查读取权限
        var hasPermission = await _permissionService.HasPermissionAsync(
            _userContext.CurrentUserId, "BOM_READ", bomId);
            
        if (!hasPermission)
        {
            throw new PermissionDeniedException("无权访问该配方");
        }
        
        return await _innerService.GetBOMByIdAsync(bomId);
    }
    
    // 其他方法的权限装饰实现...
}
```

#### 6.3.4 UI层权限控制

```csharp
// UI组件权限控制
public static class BOMUIPermissionController
{
    // 设置控件权限
    public static void ApplyPermissions(Control control, string userId)
    {
        // 递归处理控件
        ProcessControlPermissions(control, userId);
    }
    
    // 处理单个控件权限
    private static void ProcessControlPermissions(Control control, string userId)
    {
        // 获取控件权限标签
        var permissionTag = control.Tag as string;
        
        if (!string.IsNullOrEmpty(permissionTag))
        {
            var permissionService = new BOMPermissionService();
            var hasPermission = permissionService.HasPermissionAsync(userId, permissionTag).Result;
            
            // 根据权限设置控件可见性和可用性
            control.Visible = hasPermission;
            control.Enabled = hasPermission;
        }
        
        // 递归处理子控件
        foreach (Control childControl in control.Controls)
        {
            ProcessControlPermissions(childControl, userId);
        }
    }
}
```

### 6.4 全面的日志记录功能

#### 6.4.1 日志数据模型

```csharp
// 操作日志表
public class tb_OperationLog
{
    [SugarColumn(IsPrimaryKey = true, IsIdentity = true)]
    public long LogId { get; set; }
    
    public string OperationType { get; set; } // CREATE, UPDATE, DELETE, VIEW, EXPORT, IMPORT
    public string ModuleName { get; set; }
    public string EntityType { get; set; }
    public int? EntityId { get; set; }
    
    public string UserId { get; set; }
    public string UserName { get; set; }
    public string IPAddress { get; set; }
    public string ClientInfo { get; set; }
    
    public DateTime OperationTime { get; set; }
    public string ActionDetails { get; set; } // JSON格式存储操作详情
    public string Parameters { get; set; } // JSON格式存储参数
    
    public bool IsSuccess { get; set; }
    public string ErrorMessage { get; set; }
    public string StackTrace { get; set; }
}
```

#### 6.4.2 日志服务类

```csharp
// 操作日志服务
public class OperationLogService
{
    // 记录操作日志
    public async Task<long> LogOperationAsync(string operationType, string moduleName, string entityType,
                                          int? entityId, string userId, string userName,
                                          object parameters = null, string actionDetails = null,
                                          bool isSuccess = true, string errorMessage = null,
                                          string stackTrace = null)
    
    // 获取操作日志
    public async Task<List<tb_OperationLog>> GetOperationLogsAsync(string operationType = null,
                                                           string moduleName = null,
                                                           string entityType = null,
                                                           int? entityId = null,
                                                           string userId = null,
                                                           DateTime? startTime = null,
                                                           DateTime? endTime = null)
    
    // 导出操作日志
    public async Task<byte[]> ExportOperationLogsAsync(LogQueryCriteria criteria, string format = "excel")
    
    // 清理过期日志
    public async Task<int> CleanupOldLogsAsync(int daysToKeep)
}
```

#### 6.4.3 日志记录拦截器

```csharp
// 日志拦截器（基于AOP实现）
public class BOMOperationLogInterceptor : IInterceptor
{
    private readonly OperationLogService _logService;
    private readonly IUserContext _userContext;
    private readonly IClientInfoProvider _clientInfoProvider;
    
    public void Intercept(IInvocation invocation)
    {
        // 记录操作前信息
        var startTime = DateTime.Now;
        var parameters = GetParameters(invocation);
        
        try
        {
            // 执行原方法
            invocation.Proceed();
            
            // 记录成功日志
            LogSuccessOperation(invocation, startTime, parameters);
        }
        catch (Exception ex)
        {
            // 记录失败日志
            LogFailedOperation(invocation, startTime, parameters, ex);
            
            // 重新抛出异常
            throw;
        }
    }
    
    // 记录成功操作
    private async void LogSuccessOperation(IInvocation invocation, DateTime startTime, object parameters)
    {
        // 实现日志记录逻辑
    }
    
    // 记录失败操作
    private async void LogFailedOperation(IInvocation invocation, DateTime startTime, object parameters, Exception ex)
    {
        // 实现日志记录逻辑
    }
}
```

### 6.5 数据一致性保障机制

#### 6.5.1 事务管理

```csharp
// 事务管理器
public class BOMTransactionManager : ITransactionManager
{
    // 开始事务
    public ITransactionScope BeginTransaction()
    
    // 执行事务操作
    public async Task<T> ExecuteInTransactionAsync<T>(Func<Task<T>> operation)
    
    // 执行非返回值事务操作
    public async Task ExecuteInTransactionAsync(Func<Task> operation)
    
    // 执行分布式事务
    public async Task ExecuteDistributedTransactionAsync(List<Func<Task<bool>> operations,
                                                 List<Func<Task<bool>> compensations)
}
```

#### 6.5.2 数据同步服务

```csharp
// 数据同步服务
public class BOMDataSyncService
{
    // 同步BOM数据到相关系统
    public async Task<bool> SyncBOMDataAsync(int bomId, SyncDirection direction = SyncDirection.Full)
    
    // 检测并修复数据不一致
    public async Task<List<DataInconsistency>> DetectAndFixInconsistenciesAsync()
    
    // 执行完整数据校验
    public async Task<DataValidationReport> ValidateAllDataAsync()
    
    // 修复引用完整性
    public async Task<int> FixReferentialIntegrityAsync()
}
```

#### 6.5.3 事件驱动一致性保障

```csharp
// 事件总线
public class BOMEventBus
{
    // 注册事件处理程序
    public void RegisterHandler<TEvent>(IEventHandler<TEvent> handler) where TEvent : BOMEvent
    
    // 触发事件
    public async Task TriggerEventAsync<TEvent>(TEvent @event) where TEvent : BOMEvent
    
    // 取消注册
    public void UnregisterHandler<TEvent>(IEventHandler<TEvent> handler) where TEvent : BOMEvent
}

// 事件定义
public class BOMChangedEvent : BOMEvent
{
    public int BOMId { get; set; }
    public string ChangeType { get; set; }
    public DateTime ChangeTime { get; set; }
    public string ChangedBy { get; set; }
    public object OldData { get; set; }
    public object NewData { get; set; }
}
```

### 6.6 实现步骤

1. **系统架构设计**：
   - 设计模块集成架构
   - 定义服务依赖关系
   - 实现依赖注入机制

2. **数据验证机制实现**：
   - 创建验证规则引擎
   - 实现配方专用验证规则
   - 在UI层集成验证功能

3. **权限管理实现**：
   - 设计权限模型
   - 实现权限服务
   - 创建权限检查装饰器
   - 在UI层实现权限控制

4. **日志记录功能实现**：
   - 设计日志数据模型
   - 实现日志服务
   - 创建日志记录拦截器

5. **数据一致性保障实现**：
   - 实现事务管理器
   - 创建数据同步服务
   - 实现事件驱动机制

6. **集成测试**：
   - 验证各模块集成正确性
   - 测试数据一致性保障机制
   - 性能和安全测试