# 重复登录对话框使用说明

## 概述

`DuplicateLoginDialog` 是一个标准化的重复登录确认对话框，用于处理用户在多个地方登录时的冲突确认。该对话框遵循VS2022规范化写法，实现了代码与设计器分离，并正确使用了Krypton控件。

## 文件结构

```
RUINORERP.UI/Forms/
├── DuplicateLoginDialog.cs          # 主要逻辑代码
├── DuplicateLoginDialog.Designer.cs # 设计器生成的界面代码
└── DuplicateLoginDialogExample.cs   # 使用示例
```

## 主要特性

### 1. VS2022规范化写法
- ✅ 代码与设计器完全分离
- ✅ 使用标准的Windows Forms设计模式
- ✅ 遵循.NET编码规范
- ✅ 完整的XML文档注释

### 2. Krypton控件正确使用
- ✅ 使用正确的Krypton命名空间
- ✅ 正确的属性设置方式
- ✅ 标准的工具提示实现
- ✅ 一致的颜色和样式方案

### 3. 用户友好的界面
- ✅ 清晰的标题和消息显示
- ✅ 详细的现有会话信息列表
- ✅ 直观的操作按钮
- ✅ 键盘快捷键支持（ESC取消，Enter确认）

## 使用方法

### 基本用法

```csharp
// 创建重复登录结果数据
var duplicateLoginResult = new DuplicateLoginResult
{
    HasDuplicateLogin = true,
    Message = "您的账号已在其他地方登录，请选择处理方式",
    ExistingSessions = existingSessions,
    RequireUserConfirmation = true
};

// 显示对话框
using (var dialog = new DuplicateLoginDialog(duplicateLoginResult))
{
    var result = dialog.ShowDialog();
    if (result == DialogResult.OK)
    {
        var selectedAction = dialog.SelectedAction;
        // 处理用户选择的操作
        HandleUserChoice(selectedAction);
    }
}
```

### 异步使用（推荐）

```csharp
public async Task<DuplicateLoginAction> ShowDuplicateLoginDialogAsync(DuplicateLoginResult duplicateLoginResult)
{
    return await Task.Run(() =>
    {
        if (Application.OpenForms.Count > 0)
        {
            var mainForm = Application.OpenForms[0];
            return (DuplicateLoginAction)mainForm.Invoke(new Func<DuplicateLoginAction>(() =>
            {
                using (var dialog = new DuplicateLoginDialog(duplicateLoginResult))
                {
                    var result = dialog.ShowDialog();
                    return result == DialogResult.OK ? dialog.SelectedAction : DuplicateLoginAction.Cancel;
                }
            }));
        }
        return DuplicateLoginAction.Cancel;
    });
}
```

## 对话框界面元素

### 1. 标题区域
- 显示"登录冲突"标题
- 使用微软雅黑字体，加粗显示

### 2. 消息区域
- 显示重复登录的具体消息
- 自动换行，适应长消息

### 3. 会话信息列表
- 显示现有会话的详细信息：
  - 会话ID
  - 登录时间
  - 客户端IP
  - 设备信息
  - 状态描述
- 本地会话使用浅绿色背景标识

### 4. 操作按钮
- **强制对方下线**：踢掉其他会话，保持当前登录
- **自己下线**：取消当前登录，保持其他会话
- **取消登录**：取消本次登录操作
- **确认**：执行选择的操作

### 5. 工具提示
每个按钮都包含详细的工具提示，帮助用户理解操作含义。

## 返回值

对话框通过 `SelectedAction` 属性返回用户的选择：

```csharp
public enum DuplicateLoginAction
{
    ForceOfflineOthers,  // 强制对方下线
    OfflineSelf,         // 自己下线
    Cancel               // 取消登录
}
```

## 键盘支持

- **ESC键**：取消操作，关闭对话框
- **Enter键**：确认当前选择的操作

## 设计注意事项

### 1. 响应式布局
- 使用Anchor属性确保控件在窗体大小调整时正确布局
- 固定对话框大小，避免布局混乱

### 2. 视觉一致性
- 使用统一的颜色方案
- 本地会话用不同背景色区分
- 按钮状态变化提供视觉反馈

### 3. 无障碍性
- 支持键盘导航
- 清晰的标签和提示
- 高对比度的颜色选择

## 集成到现有系统

该对话框已正确集成到 `LoginFlowService` 中，当检测到重复登录时会自动显示：

```csharp
// 在 LoginFlowService.cs 中的调用
using var dialog = new DuplicateLoginDialog(duplicateInfo);
var result = dialog.ShowDialog();
return result == DialogResult.OK ? dialog.SelectedAction : DuplicateLoginAction.Cancel;
```

## 测试

可以使用 `DuplicateLoginDialogExample.cs` 中的示例代码进行测试：

```csharp
// 创建测试数据
var testResult = DuplicateLoginDialogExample.CreateSampleDuplicateLoginResult();

// 显示对话框
var action = await DuplicateLoginDialogExample.ShowDuplicateLoginDialogAsync(testResult);
Console.WriteLine($"用户选择了: {action}");
```

## 技术规格

- **框架**: .NET Framework 4.8
- **UI框架**: Krypton Toolkit
- **设计模式**: Windows Forms Designer Pattern
- **文档**: 完整的XML文档注释
- **线程安全**: 支持UI线程调用