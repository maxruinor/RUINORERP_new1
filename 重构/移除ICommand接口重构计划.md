# 移除ICommand接口重构计划

## 1. 前期准备

### 1.1 确认当前ICommand接口使用情况
- [ ] 查看ICommand接口定义
- [ ] 确认所有引用ICommand的关键组件
- [ ] 分析CommandId结构体与ICommand的关系

### 1.2 准备工作环境
- [ ] 创建重构分支
- [ ] 确保所有测试可运行
- [ ] 备份关键文件

## 2. 重构核心组件

### 2.1 修改CommandDispatcher
- [ ] 修改DispatchAsync方法，使其直接处理PacketModel而不是ICommand
- [ ] 更新PreprocessCommandAsync方法参数
- [ ] 修改命令查找和处理器匹配逻辑

### 2.2 更新CommandScanner
- [ ] 修改扫描逻辑，不再依赖ICommand接口
- [ ] 调整命令类型识别方式

### 2.3 调整CommandCacheManager
- [ ] 更新缓存键生成逻辑
- [ ] 修改缓存项处理方式

### 2.4 重构PacketModel
- [ ] 确保PacketModel能够独立承载所有命令数据
- [ ] 优化CommandData属性的访问方式

### 2.5 更新PriorityCommandQueue
- [ ] 确认QueuedCommand类的使用方式
- [ ] 确保与新命令处理方式兼容

## 3. 处理器适配

### 3.1 更新ICommandHandler接口
- [ ] 创建新的处理器接口或更新现有接口
- [ ] 确保向后兼容性

### 3.2 修改命令处理器实现
- [ ] 更新处理器方法签名
- [ ] 调整命令数据访问逻辑

## 4. 验证服务更新

### 4.1 修改ValidationService
- [ ] 更新验证逻辑，适应新的命令数据结构
- [ ] 调整验证规则应用方式

## 5. 测试与验证

### 5.1 单元测试
- [ ] 为修改后的组件编写单元测试
- [ ] 确保测试覆盖率

### 5.2 集成测试
- [ ] 验证组件间的交互
- [ ] 测试端到端流程

### 5.3 性能测试
- [ ] 比较重构前后的性能变化
- [ ] 确保没有性能退化

## 6. 文档更新

### 6.1 更新架构文档
- [ ] 修改ARCHITECTURE.md中的相关说明
- [ ] 更新命令处理流程文档

### 6.2 更新API文档
- [ ] 修改接口文档
- [ ] 更新使用示例

## 7. 清理工作

### 7.1 移除ICommand接口
- [ ] 在所有组件适配完成后，移除ICommand接口定义
- [ ] 清理相关引用

### 7.2 代码清理
- [ ] 删除不再需要的兼容代码
- [ ] 优化代码结构

## 8. 部署与监控

### 8.1 部署准备
- [ ] 准备部署文档
- [ ] 制定回滚计划

### 8.2 监控
- [ ] 设置监控项
- [ ] 关注系统性能和稳定性

---

## 执行顺序与依赖关系
1. 前期准备 → 2. 重构核心组件 → 3. 处理器适配 → 4. 验证服务更新 → 5. 测试与验证 → 6. 文档更新 → 7. 清理工作 → 8. 部署与监控

## 注意事项
- 每个阶段完成后进行全面测试
- 保持代码提交的原子性
- 详细记录每个修改的原因和影响
- 遇到问题及时调整计划